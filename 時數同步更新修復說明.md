# 🔧 事業單位時數同步更新修復說明

## 📋 問題描述

**問題**：在「🏢 事業單位」頁籤更新每月時數配額後，切換到「✏️ 排班管理」頁籤時，剩餘時數顯示沒有同步更新，仍顯示舊的時數資料。

**影響範圍**：
- 排班頁面的剩餘時數顯示不正確
- 可能導致誤判時數分配情況
- 需要重新整理頁面才能看到最新時數

---

## 🔍 問題原因分析

### 1. 快取未清除
- `currentMonthHoursUsage` 物件儲存了已計算的時數資料
- 更新事業單位後，快取沒有被清除
- 排班頁面繼續使用舊的快取資料

### 2. 單位資料未重新載入
- `currentUnitData` 保存了當前選中單位的資料
- 更新後沒有觸發重新載入
- 時數計算使用的是舊的配額資料

### 3. 頁籤切換未觸發更新
- 從「事業單位」切換到「排班管理」時
- 沒有檢查並重新載入時數資訊
- 導致顯示的時數不是最新的

---

## ✅ 修復方案

### 1. 更新事業單位後清除快取

**位置**：`saveUnitData()` 函數

**修改前：**
```javascript
alert(`✅ 事業單位「${name}」更新成功！`);
clearUnitForm();
await loadUnitsDetailed();
await loadUnits(false);
```

**修改後：**
```javascript
// 清除時數快取，確保下次使用時重新計算
currentMonthHoursUsage = {};
console.log('🗑️ 已清除時數快取');

// 如果當前編輯的單位正在排班頁面使用，重新載入單位資料
const currentShiftUnit = document.getElementById('shiftUnit')?.value;
if (currentShiftUnit === name) {
    console.log('🔄 重新載入當前使用的單位資料...');
    await loadUnitDetailData(name);
    await updateHoursInfo(true); // 強制重新計算時數
    console.log('✅ 單位資料和時數已更新');
}

alert(`✅ 事業單位「${name}」更新成功！\n\n${currentShiftUnit === name ? '排班頁面時數已同步更新' : ''}`);
```

**改進效果：**
- ✅ 立即清除所有快取資料
- ✅ 如果正在使用該單位，立即重新載入
- ✅ 強制重新計算時數（不使用快取）
- ✅ 提示用戶時數已更新

---

### 2. 頁籤切換時重新載入時數

**位置**：`switchTab()` 函數

**修改前：**
```javascript
function switchTab(tabName) {
    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tabName + 'Tab').classList.add('active');
}
```

**修改後：**
```javascript
async function switchTab(tabName) {
    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tabName + 'Tab').classList.add('active');
    
    // 切換到排班管理頁籤時，如果有選中的單位，重新載入時數資訊
    if (tabName === 'manage') {
        const currentShiftUnit = document.getElementById('shiftUnit')?.value;
        if (currentShiftUnit && currentUnitData) {
            console.log('🔄 切換到排班頁籤，重新載入時數資訊...');
            // 重新載入單位資料以獲取最新時數設定
            await loadUnitDetailData(currentShiftUnit);
            await updateHoursInfo(true); // 強制重新計算時數
            console.log('✅ 時數資訊已更新');
        }
    }
}
```

**改進效果：**
- ✅ 切換到排班頁籤時自動更新
- ✅ 確保顯示最新的時數資料
- ✅ 無需手動重新整理頁面

---

### 3. 增強時數計算功能

**位置**：`calculateRemainingHours()` 和 `updateHoursInfo()` 函數

**新增快取檢查機制：**
```javascript
async function calculateRemainingHours(unitName, forceRecalculate = false) {
    // ... 前置處理 ...
    
    // 檢查快取（除非強制重新計算）
    const cacheKey = `${unitName}-${yearMonth}`;
    if (!forceRecalculate && currentMonthHoursUsage[cacheKey]) {
        console.log('📦 使用快取資料');
        return currentMonthHoursUsage[cacheKey];
    }
    
    // ... 計算邏輯 ...
    
    // 存入快取
    currentMonthHoursUsage[cacheKey] = remaining;
    console.log('💾 已存入快取：', cacheKey);
    
    return remaining;
}
```

**新增強制重算參數：**
```javascript
async function updateHoursInfo(forceRecalculate = false) {
    // ...
    const remaining = await calculateRemainingHours(currentUnitData.name, forceRecalculate);
    // ...
}
```

**改進效果：**
- ✅ 正常使用時利用快取提升效能
- ✅ 需要時可強制重新計算
- ✅ 快取使用更智能化

---

## 📊 修復前後對比

### 修復前（有問題）

```
1. 編輯事業單位時數
   ↓
2. 儲存成功
   ↓
3. 切換到排班管理頁籤
   ↓
4. 剩餘時數顯示 ❌（舊資料）
   - 快取未清除
   - 單位資料未更新
   - 顯示錯誤的時數
```

### 修復後（正常）

```
1. 編輯事業單位時數
   ↓
2. 儲存成功
   ↓ 清除快取
   ↓ 重新載入單位資料（如果正在使用）
   ↓ 強制重新計算時數
3. 切換到排班管理頁籤
   ↓ 自動檢查並更新
4. 剩餘時數顯示 ✅（最新資料）
   - 快取已清除
   - 單位資料已更新
   - 顯示正確的時數
```

---

## 🔍 測試方法

### 測試 1：基本同步測試

1. **建立測試排班**
   - 選擇一個事業單位
   - 選擇日期（例如：2026年1月）
   - 查看剩餘時數顯示

2. **更新時數配額**
   - 切換到「🏢 事業單位」頁籤
   - 編輯該單位
   - 修改1月的醫師時數（例如從 160h 改為 180h）
   - 儲存

3. **確認同步**
   - 切換回「✏️ 排班管理」頁籤
   - 選擇同一事業單位
   - 選擇同一日期
   - ✅ 確認剩餘時數已更新（應該增加 20h）

### 測試 2：即時更新測試

1. **開啟排班表單**
   - 選擇事業單位
   - 選擇日期
   - 記錄當前剩餘時數

2. **不關閉表單，切換到事業單位**
   - 點擊「🏢 事業單位」頁籤
   - 更新該單位的時數配額
   - 儲存成功後注意提示訊息

3. **回到排班管理**
   - 切換回「✏️ 排班管理」頁籤
   - ✅ 確認剩餘時數已自動更新
   - ✅ 不需要重新選擇單位

### 測試 3：多單位測試

1. **建立多個單位**
   - 單位A：醫師 100h
   - 單位B：醫師 200h

2. **切換測試**
   - 選擇單位A，查看剩餘時數
   - 切換到「事業單位」，更新單位A時數為 150h
   - 儲存並切換回排班管理
   - ✅ 單位A時數應顯示 150h
   - 選擇單位B
   - ✅ 單位B時數應顯示 200h（不受影響）

---

## 📝 Console 日誌參考

### 正常的更新流程日誌

```javascript
// 儲存事業單位
📝 開始儲存事業單位：{...}
💾 寫入 Google Sheets...
✅ 寫入成功
🗑️ 已清除時數快取
🔄 重新載入當前使用的單位資料...
📥 開始載入單位詳細資料...
✅ 載入單位詳細資料：{...}
🔢 計算剩餘時數，事業單位：台北醫院 (強制重新計算)
📅 計算月份：2026-01
📊 1月配額 - 醫生:180h, 護理師:100h, 其他:50h
⏱️ 1月已用 - 醫生:40h, 護理師:20h, 其他:10h
✅ 1月剩餘 - 醫生:140h, 護理師:80h, 其他:40h
💾 已存入快取：台北醫院-2026-01
✅ 單位資料和時數已更新
```

### 切換頁籤時的日誌

```javascript
// 切換到排班管理
🔄 切換到排班頁籤，重新載入時數資訊...
📥 開始載入單位詳細資料...
✅ 載入單位詳細資料：{...}
🔢 計算剩餘時數，事業單位：台北醫院 (強制重新計算)
✅ 時數資訊已更新
```

---

## 💡 使用建議

### 1. 批量更新時數

如果需要更新多個單位的時數：
1. 依序編輯並儲存每個單位
2. 每次儲存後系統會自動清除快取
3. 切換到排班頁面時會自動更新

### 2. 監控時數變化

- ✅ 使用 F12 開啟開發者工具查看 Console
- ✅ 觀察快取清除和重新計算的日誌
- ✅ 確認時數計算正確

### 3. 最佳實踐

- ✅ 更新時數後，先切換到排班頁面確認
- ✅ 如有疑問，可重新選擇事業單位
- ✅ 重要更新建議測試驗證後再實際使用

---

## 🔄 版本資訊

**版本**：4.4.0
**更新日期**：2026-01-17
**修復項目**：
- 🔧 修復事業單位時數更新後，排班頁面不同步的問題
- 🔧 新增快取智能管理機制
- 🔧 新增頁籤切換時的自動更新機制
- 🔧 新增強制重新計算參數
- 🔧 改進時數同步即時性

---

## ✨ 技術細節

### 快取機制

**快取鍵格式：**
```javascript
cacheKey = `${unitName}-${yearMonth}`
// 例如：「台北醫院-2026-01」
```

**快取生命週期：**
- 正常使用：保留快取，提升效能
- 更新事業單位：立即清除所有快取
- 切換頁籤：強制重新計算（不使用快取）
- 重新選擇單位：強制重新計算

### 同步觸發點

1. **儲存事業單位成功後**
   - 清除 `currentMonthHoursUsage = {}`
   - 檢查是否為當前使用的單位
   - 重新載入並強制計算

2. **切換到排班頁籤**
   - 檢查是否有選中單位
   - 重新載入單位詳細資料
   - 強制重新計算時數

3. **選擇事業單位時**
   - 載入單位詳細資料
   - 正常計算時數（使用快取）

---

## 🎉 總結

修復完成後的效果：

✅ **即時同步**：更新事業單位後，排班頁面立即顯示最新時數
✅ **自動更新**：切換頁籤時自動重新載入最新資料
✅ **智能快取**：正常使用時保持效能，需要時強制更新
✅ **用戶友善**：無需手動重新整理，系統自動處理
✅ **資料一致**：確保顯示的時數與設定的配額一致

現在事業單位時數更新可以即時同步到排班頁面了！🎉

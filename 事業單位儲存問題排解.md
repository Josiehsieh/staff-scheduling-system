# 🔧 事業單位儲存問題排解指南

**版本**：v6.0.1  
**更新日期**：2025-11-03  
**問題**：新增事業單位時顯示「儲存失敗」

---

## ✅ 已修復的問題

### 1. 自動建立工作表
系統現在會自動檢測「事業單位詳細」工作表是否存在，如果不存在會自動建立！

### 2. 詳細錯誤訊息
改進的錯誤訊息會清楚告訴您問題出在哪裡：
- 權限不足
- Sheet ID 錯誤
- 工作表不存在
- 其他錯誤

### 3. 完整除錯資訊
在瀏覽器控制台（F12）會顯示詳細的除錯訊息，方便排查問題。

---

## 🚀 快速解決步驟

### 方法1：讓系統自動建立工作表（推薦）✨

```
1. 確認已登入 Google 帳號
2. 填寫事業單位資料
3. 點擊「儲存」
4. 如果提示工作表不存在，系統會自動建立！
5. 重新儲存一次即可成功
```

### 方法2：手動建立工作表

如果自動建立失敗，可以手動建立：

```
1. 打開您的 Google Sheets
2. 點擊左下角「+」新增工作表
3. 將工作表重新命名為：事業單位詳細
4. 在第一列（標題列）輸入以下欄位：
   A1: 單位名稱
   B1: 分散型
   C1: 地址
   D1: 分點資料
   E1: 醫生名單
   F1: 護理師名單
   G1: 其他人員
   H1-AQ1: 12個月的時數欄位（每月3欄）
5. 回到系統重新儲存
```

### 方法3：使用除錯模式

```
1. 按 F12 打開瀏覽器控制台
2. 切換到「Console」標籤
3. 嘗試儲存事業單位
4. 查看控制台的錯誤訊息
5. 根據錯誤訊息採取對應行動
```

---

## 🔍 常見錯誤訊息與解決方法

### 錯誤1：權限不足 (403)

**錯誤訊息：**
```
❌ 儲存失敗

權限不足！

請確認：
1. 已授權 Google Sheets 權限
2. 已重新登入系統
```

**解決方法：**
```
1. 點擊系統右上角「登出」
2. 重新點擊「使用 Google 帳號登入」
3. 授權所有權限（包括 Google Sheets 和 Calendar）
4. 重新嘗試儲存
```

---

### 錯誤2：Sheet ID 錯誤 (404)

**錯誤訊息：**
```
❌ 儲存失敗

Sheet ID 錯誤！

請確認設定中的 Sheet ID 是否正確
```

**解決方法：**
```
1. 打開您的 Google Sheets
2. 複製網址中的 Sheet ID
   
   網址格式：
   https://docs.google.com/spreadsheets/d/【這是Sheet ID】/edit
   
   範例：
   https://docs.google.com/spreadsheets/d/10aBWB3NFHyW2Vnx0shKywtuoRxt8bRRQN0_rmfBZGWA/edit
   Sheet ID = 10aBWB3NFHyW2Vnx0shKywtuoRxt8bRRQN0_rmfBZGWA

3. 到系統的「⚙️ 設定」頁籤
4. 貼上正確的 Sheet ID
5. 點擊「儲存設定」
6. 重新嘗試儲存事業單位
```

---

### 錯誤3：工作表格式錯誤 (400)

**錯誤訊息：**
```
❌ 儲存失敗

工作表格式錯誤！

請檢查「事業單位詳細」工作表是否存在
```

**解決方法A：讓系統自動建立**
```
這個錯誤現在應該會自動修復！
系統會嘗試自動建立工作表。

如果看到此錯誤：
1. 稍等1-2秒
2. 重新點擊「儲存」
3. 應該就會成功了
```

**解決方法B：手動建立（如果自動建立失敗）**
```
1. 打開 Google Sheets
2. 新增工作表，命名為：事業單位詳細
3. 依照上方「方法2」的步驟設定標題列
4. 回到系統重新儲存
```

---

### 錯誤4：無法建立工作表

**錯誤訊息：**
```
❌ 儲存失敗

無法建立「事業單位詳細」工作表。
請手動在 Google Sheets 中建立此工作表，或檢查權限。
```

**原因：**
- 權限不足，無法新增工作表
- Google Sheets 已達到工作表數量上限

**解決方法：**
```
1. 確認 Google 帳號權限
   → 必須是 Google Sheets 的「編輯者」或「擁有者」
   → 不能是「檢視者」

2. 檢查工作表數量
   → Google Sheets 每個檔案最多200個工作表
   → 如已達上限，刪除不需要的工作表

3. 手動建立工作表
   → 按照「方法2」手動建立
```

---

## 🔧 進階除錯

### 查看完整錯誤訊息

**步驟：**
```
1. 按 F12 打開開發者工具
2. 切換到「Console」標籤
3. 清空控制台（點擊 🚫 圖示）
4. 嘗試儲存事業單位
5. 查看以下訊息：
   📝 開始儲存事業單位
   ✅ 工作表存在，現有資料筆數：X
   📊 準備寫入資料列
   💾 寫入 Google Sheets...
   ✅ 寫入成功 或 ❌ 錯誤訊息
```

### 常見控制台訊息

**成功訊息：**
```
📝 開始儲存事業單位： {name: "台北診所", ...}
✅ 工作表存在，現有資料筆數：0
📊 準備寫入資料列： ["台北診所", "否", ...]
💾 寫入 Google Sheets...
✅ 寫入成功： {result: {...}}
```

**工作表不存在（自動建立）：**
```
📝 開始儲存事業單位： {...}
⚠️ 工作表可能不存在，錯誤： {...}
🔨 嘗試建立「事業單位詳細」工作表...
✅ 工作表建立成功
✅ 標題列寫入成功
📊 準備寫入資料列： [...]
💾 寫入 Google Sheets...
✅ 寫入成功
```

**權限錯誤：**
```
📝 開始儲存事業單位： {...}
❌ 儲存失敗，詳細錯誤： {status: 403, ...}
錯誤狀態：403
錯誤訊息：The caller does not have permission
```

---

## 📋 完整檢查清單

在儲存事業單位前，請確認：

```
□ 已使用 Google 帳號登入系統
□ 已在設定中填入正確的 Sheet ID
□ 已授權 Google Sheets 權限
□ Google Sheets 檔案存在且可存取
□ 網路連線正常
□ 已填寫事業單位名稱（必填）
□ 如果選擇「分散型 = 是」，已新增至少一個分點
```

---

## 🎯 測試步驟

**建議的測試流程：**

```
測試1：最簡單的事業單位
1. 單位名稱：測試診所
2. 分散型：否
3. 地址：台北市
4. 醫生名單：王醫師
5. 其他欄位可留空
6. 點擊「儲存」
7. 應該成功！

測試2：帶時數的事業單位
1. 填寫基本資料（同上）
2. 填寫1月醫生時數：160
3. 填寫1月護理師時數：180
4. 點擊「儲存」
5. 應該成功！

測試3：分散型事業單位
1. 填寫基本資料
2. 分散型：是
3. 點擊「➕ 新增分點」
4. 填寫分點名稱和地址
5. 點擊「儲存」
6. 應該成功！
```

---

## 💡 預防措施

**避免儲存失敗的最佳實踐：**

### 1. 定期備份
```
定期匯出 Google Sheets 為 Excel
檔案 → 下載 → Microsoft Excel (.xlsx)
```

### 2. 檢查權限
```
確保您是 Google Sheets 的擁有者或編輯者
不要使用「檢視者」權限的帳號
```

### 3. 網路穩定
```
使用穩定的網路連線
避免在網路不穩定時新增重要資料
```

### 4. 瀏覽器快取
```
定期清除瀏覽器快取
使用 Ctrl+Shift+R 強制重新整理
```

### 5. 分批新增
```
不要一次新增大量事業單位
建議每次新增5-10個即可
```

---

## 📞 仍然無法解決？

**收集以下資訊：**

```
1. 錯誤訊息截圖
2. 瀏覽器控制台（F12）的錯誤訊息
3. Google Sheets 的分享權限設定
4. 使用的瀏覽器和版本
5. 填寫的事業單位資料內容

然後：
□ 檢查控制台是否有紅色錯誤訊息
□ 確認 Sheet ID 是否正確
□ 確認已授權所有必要權限
□ 嘗試使用無痕模式測試
□ 嘗試清除瀏覽器快取
```

---

## 🔄 版本更新說明

**v6.0.1 改進：**

1. ✅ **自動建立工作表**
   - 如果「事業單位詳細」不存在，自動建立
   - 自動寫入標題列

2. ✅ **詳細錯誤訊息**
   - 區分不同類型的錯誤（403、404、400）
   - 提供針對性的解決建議

3. ✅ **完整除錯日誌**
   - 在控制台顯示每個步驟的狀態
   - 方便排查問題

4. ✅ **錯誤處理改進**
   - 更準確的錯誤偵測
   - 更友善的錯誤提示

---

## 📚 相關文檔

| 文檔 | 用途 |
|------|------|
| `事業單位儲存問題排解.md` | 本文件 |
| `GOOGLE_SHEETS_SETUP_GUIDE.md` | Google Sheets 設定指南 |
| `UNITS_MANAGEMENT_GUIDE.md` | 事業單位管理完整指南 |
| `TROUBLESHOOTING_LOGIN.md` | 登入問題排解 |

---

## ✅ 快速檢查（30秒）

**如果儲存失敗，依序檢查：**

```
1. □ 已登入？（右上角顯示使用者名稱）
2. □ Sheet ID 正確？（設定頁籤檢查）
3. □ 有填單位名稱？（必填欄位）
4. □ 分散型若選「是」，有新增分點？
5. □ 控制台（F12）有紅色錯誤？

如果以上都正常：
→ 重新整理頁面（Ctrl+R）
→ 重新登入系統
→ 再試一次儲存
```

---

**🎉 問題應該已經解決！如果還有問題，請查看控制台的詳細錯誤訊息。**

**版本**：v6.0.1  
**狀態**：✅ 已修復並增強  
**最後更新**：2025-11-03




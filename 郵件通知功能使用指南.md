# 📧 醫師郵件通知功能使用指南

## 🎯 功能說明

排班系統現在支援**自動郵件通知功能**！當建立排班時，系統會：
- ✅ 自動將醫師加入 Google 行事曆邀請
- ✅ 發送郵件通知給醫師
- ✅ 醫師可在郵件中直接接受/拒絕邀請
- ✅ 接受後事件會自動同步到醫師的個人行事曆

---

## 📝 設定步驟

### 步驟 1：建立「醫師郵件」工作表

1. 開啟您的 Google Sheets 排班系統試算表
2. 新增一個工作表，命名為：**醫師郵件**
3. 設定以下欄位結構：

| A 欄（姓名） | B 欄（Email） | C 欄（職稱） | D 欄（備註） |
|------------|-------------|------------|------------|
| 王醫師 | wang@example.com | 主治醫師 | |
| 李醫師 | lee@example.com | 住院醫師 | |
| 陳護理師 | chen@example.com | 護理師 | |

### 步驟 2：填入人員資料

**方式一：直接在網頁管理**
1. 在排班系統中切換到「📧 醫師郵件」頁籤
2. 點擊「📝 在 Google Sheets 中編輯」開啟試算表
3. 填入人員資料後，點擊「🔄 重新載入郵件資料」

**方式二：直接編輯 Google Sheets**
1. 開啟 Google Sheets 試算表
2. 切換到「醫師郵件」工作表
3. 填入人員資料

**重要注意事項：**
- 📌 **姓名必須與「事業單位詳細」工作表中的人員名稱完全一致**（包含空格）
- 📌 Email 必須是有效的 Gmail 或 Google Workspace 帳號
- 📌 建議使用醫師個人的 Google 帳號

**範例資料：**

```
第 1 列（標題）：
姓名 | Email | 職稱 | 備註

第 2 列起（資料）：
王醫師 | wang@gmail.com | 主治醫師 | 
李醫師 | lee@gmail.com | 住院醫師 |
陳護理師 | chen.nurse@gmail.com | 護理師 |
林醫師 | lin.doctor@hospital.com | 主治醫師 | Google Workspace 帳號
```

### 步驟 3：查看並驗證設定

1. 在排班系統中切換到「📧 醫師郵件」頁籤
2. 查看目前已設定的郵件列表
3. 確認所有人員姓名和郵件地址正確
4. 系統會顯示每個郵件地址的狀態（✅ 有效 / ⚠️ 無效）
5. 在瀏覽器 Console（F12）中確認載入成功訊息：
   ```
   ✅ 醫師郵件資料載入完成
      共載入 X 位人員的郵件
   ```

---

## 🚀 使用方式

### 方式 1：自動同步（推薦）

1. 在「⚙️ 設定」頁籤中，確保勾選「**啟用自動同步到 Google 行事曆**」
2. 建立新排班時，系統會自動：
   - 建立行事曆事件
   - 加入參與者
   - 發送郵件通知

### 方式 2：手動上傳

1. 在「📊 排班管理」頁籤中查看排班列表
2. 點擊該排班的「📅 行事曆」按鈕
3. 系統會上傳到 Google 行事曆並發送郵件通知

---

## 📧 郵件內容

醫師會收到包含以下資訊的郵件：

### 郵件主旨
```
[您的行事曆名稱] 邀請：[事業單位名稱] - 排班 @ [日期] [時間]
```

### 郵件內容
- 📅 **日期與時間**：2026-01-20 09:00 - 17:00
- 🏢 **事業單位**：台北醫院
- 📍 **地點**：台北市信義區忠孝東路123號
- 👥 **參與人員**：王醫師, 李醫師, 陳護理師
- 📝 **備註**：請攜帶白袍
- 🔔 **行動按鈕**：接受 / 暫時接受 / 拒絕

### 醫師可執行的操作
- ✅ **接受**：事件加入個人行事曆，您會收到接受通知
- ⏰ **暫時接受**：暫時加入行事曆，稍後可更改
- ❌ **拒絕**：不加入行事曆，您會收到拒絕通知
- 📅 **查看詳情**：在 Google 行事曆中查看完整資訊

---

## 🔍 驗證功能

### 檢查郵件資料是否載入

1. 按 **F12** 開啟瀏覽器開發者工具
2. 切換到「Console」頁籤
3. 重新整理頁面
4. 查看訊息：
   ```javascript
   📧 載入醫師郵件資料...
   ✅ 醫師郵件資料載入完成：{王醫師: "wang@gmail.com", ...}
      共載入 3 位人員的郵件
   ```

### 測試建立排班

1. 建立一個測試排班，選擇已設定郵件的醫師
2. 觀察 Console 訊息：
   ```javascript
   📧 參與者列表：[{email: "wang@gmail.com", displayName: "王醫師", ...}]
   ✅ 自動同步成功，事件ID：xxxxx
   📧 已發送郵件通知給 1 位人員
   ```
3. 檢查醫師的郵件信箱，應該會收到邀請郵件

---

## ⚠️ 常見問題

### Q1：醫師沒有收到郵件通知？

**可能原因與解決方法：**

1. **姓名不一致**
   - 檢查「醫師郵件」中的姓名是否與「事業單位詳細」完全相同
   - 包含空格、標點符號都必須一致
   - Console 會顯示：`ℹ️ [姓名] 未設定郵件地址`

2. **郵件進入垃圾郵件**
   - 請醫師檢查垃圾郵件資料夾
   - 將寄件者加入聯絡人

3. **郵件地址錯誤**
   - 確認郵件地址正確且有效
   - 確認是 Gmail 或 Google Workspace 帳號

4. **未啟用自動同步**
   - 檢查「⚙️ 設定」中是否勾選「啟用自動同步到 Google 行事曆」

### Q2：部分醫師收到，部分沒收到？

這是正常的！系統會自動匹配有設定郵件的人員：
- ✅ 有設定郵件：會收到通知
- ℹ️ 未設定郵件：不會收到通知（排班仍會建立）

在 Console 中可以看到：
```javascript
📧 找到 王醫師 的郵件：wang@gmail.com
ℹ️ 李醫師 未設定郵件地址
```

### Q3：可以修改郵件內容嗎？

目前郵件內容由系統自動生成，包含：
- 排班基本資訊（日期、時間、地點）
- 參與人員名單
- 備註說明

如需客製化，可在「備註」欄位中填寫詳細資訊。

### Q4：醫師拒絕邀請後會怎樣？

- 您會收到拒絕通知
- 該醫師的行事曆中不會顯示此事件
- 不影響排班系統中的排班資料
- 建議與醫師溝通後重新安排

---

## 🔐 權限說明

### 系統需要的權限

- ✅ **Google Sheets**：讀取醫師郵件資料
- ✅ **Google Calendar**：建立事件、加入參與者、發送通知

### 醫師的隱私保護

- 參與者可以看到其他參與者（可調整）
- 參與者不能修改事件
- 參與者不能邀請其他人
- 僅排班相關人員會收到通知

---

## 📊 系統日誌參考

### 成功載入郵件資料
```javascript
📧 載入醫師郵件資料...
✅ 醫師郵件資料載入完成：{王醫師: "wang@gmail.com", 李醫師: "lee@gmail.com"}
   共載入 2 位人員的郵件
```

### 建立排班時
```javascript
🔄 開始自動同步排班到行事曆...
📧 參與者列表：[{email: "wang@gmail.com", displayName: "王醫師", responseStatus: "needsAction"}]
📧 找到 王醫師 的郵件：wang@gmail.com
✅ 自動同步成功，事件ID：abc123xyz
📧 已發送郵件通知給 1 位人員
```

### 找不到郵件時
```javascript
📧 參與者列表：[]
ℹ️ 王醫師 未設定郵件地址
✅ 自動同步成功，事件ID：abc123xyz
（無參與者，不發送郵件）
```

---

## 💡 最佳實踐建議

### 1. 初次設定
- 先用測試帳號建立測試排班
- 確認郵件正常收發後再正式使用

### 2. 姓名管理
- 建議在兩個工作表中使用統一的姓名格式
- 例如：「王醫師」而不是「王 醫師」或「王醫生」

### 3. 郵件地址管理
- 定期更新離職人員的郵件資料
- 建議在「備註」欄位註記更新日期

### 4. 通知管理
- 建議醫師將排班郵件設定為重要郵件
- 可設定郵件規則自動分類到特定資料夾

---

## 🆕 版本資訊

- **版本**：4.1.0（郵件通知增強版）
- **更新日期**：2026-01-17
- **新增功能**：
  - ✨ 自動郵件通知
  - ✨ Google 行事曆參與者邀請
  - ✨ 醫師郵件資料管理
  - ✨ 完整的日誌追蹤

---

## 📞 技術支援

如遇到問題，請提供以下資訊：
1. 瀏覽器 Console 的完整日誌（F12 > Console）
2. Google Sheets「醫師郵件」工作表的截圖（遮蔽敏感資訊）
3. 具體的錯誤訊息或異常行為描述

---

## 🎉 開始使用

1. ✅ 建立「醫師郵件」工作表
2. ✅ 填入醫師郵件資料
3. ✅ 重新載入排班系統
4. ✅ 啟用自動同步功能
5. ✅ 建立排班並測試郵件通知

祝您使用順利！📧✨

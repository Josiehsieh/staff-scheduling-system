# 🔧 地點選擇修復說明

**版本**：v6.0.6  
**更新日期**：2025-11-03  
**問題**：排班頁面選擇完事業單位後沒有出現地點的選項

---

## ✅ 已修復的問題

### 問題描述

**現象：**
- 在排班管理頁面選擇事業單位後
- 地點欄位沒有任何變化
- 無法選擇或輸入地點

**根本原因：**
```javascript
// setupLocationSelection() 函數使用錯誤的欄位名稱
currentUnitData.addressOrBranches  // ❌ 這個欄位不存在

// loadUnitDetailData() 函數設定的是：
currentUnitData.address    // ✓ 正確的地址欄位
currentUnitData.branches   // ✓ 正確的分點欄位
```

資料欄位不匹配導致地點資訊無法正確讀取和顯示。

---

## 🔧 修復內容

### 1. 修正 setupLocationSelection() 函數

**修改前：**
```javascript
// 錯誤：使用不存在的欄位
const branches = JSON.parse(currentUnitData.addressOrBranches || '[]');
locationInput.value = currentUnitData.addressOrBranches || '';
```

**修改後：**
```javascript
// 正確：使用實際存在的欄位
// 分散型：使用 branches 陣列
const branches = currentUnitData.branches || [];

// 非分散型：使用 address 字串
const address = currentUnitData.address || '';
```

### 2. 簡化 HTML 生成

**改進：**
- ✅ 統一使用 `id="location"`（input 或 select）
- ✅ 移除不必要的隱藏 input
- ✅ 簡化事件監聽邏輯

### 3. 修正 saveShift() 函數

**修改前：**
```javascript
// 複雜的檢查邏輯
const locationSelect = document.getElementById('locationSelect');
if (locationSelect && locationSelect.value) {
    locationValue = locationSelect.value;
} else {
    locationValue = document.getElementById('location').value;
}
```

**修改後：**
```javascript
// 簡化：統一讀取 location 元素
const locationElement = document.getElementById('location');
locationValue = locationElement ? locationElement.value : '';

// 預設值
if (!locationValue) {
    locationValue = document.getElementById('shiftUnit').value;
}
```

### 4. 增強除錯日誌

**新增：**
```javascript
console.log('📍 設定地點選擇，當前單位資料：', currentUnitData);

if (currentUnitData.isDistributed === '是') {
    console.log('🏢 分散型單位，分點資料：', currentUnitData.branches);
    console.log(`✅ 已生成 ${branches.length} 個分點選項`);
} else {
    console.log('🏠 非分散型單位，地址：', currentUnitData.address);
    console.log('✅ 地址已自動填入');
}
```

---

## 📊 地點選擇邏輯

### 情境1：非分散型事業單位

```
事業單位設定：
- 分散型：否
- 地址：台北市信義區XX路123號

選擇該單位後：
→ 顯示 input 欄位
→ 自動填入地址：「台北市信義區XX路123號」
→ 可以手動修改
```

**顯示效果：**
```
地點 *
┌────────────────────────────────┐
│ 台北市信義區XX路123號           │ ← 可編輯
└────────────────────────────────┘
```

---

### 情境2：分散型事業單位（有分點）

```
事業單位設定：
- 分散型：是
- 分點：
  1. 信義分點 - 台北市信義區XX路
  2. 大安分點 - 台北市大安區YY路
  3. 中山分點 - 台北市中山區ZZ路

選擇該單位後：
→ 顯示下拉選單
→ 列出所有分點
→ 必須選擇其中一個
```

**顯示效果：**
```
地點 *
┌────────────────────────────────┐
│ 請選擇分點                  ▼  │ ← 下拉選單
├────────────────────────────────┤
│ 信義分點 - 台北市信義區XX路    │
│ 大安分點 - 台北市大安區YY路    │
│ 中山分點 - 台北市中山區ZZ路    │
└────────────────────────────────┘
```

---

### 情境3：分散型事業單位（無分點）

```
事業單位設定：
- 分散型：是
- 分點：（未設定）

選擇該單位後：
→ 顯示 input 欄位
→ 提示：「該單位無分點資料，請手動輸入」
→ 可以手動輸入地點
```

**顯示效果：**
```
地點 *
┌────────────────────────────────┐
│ 該單位無分點資料，請手動輸入    │ ← 可編輯
└────────────────────────────────┘
```

---

## 🚀 使用說明

### 正常使用流程

```
1. 新增排班
   → 點擊「➕ 新增排班」

2. 選擇日期
   → 選擇排班日期

3. 選擇事業單位
   → 從下拉選單選擇
   → 人員列表自動載入
   → 地點欄位自動設定 ✓
   → 剩餘時數自動計算

4. 地點處理
   非分散型：
   → 地址自動填入
   → 可以修改
   
   分散型：
   → 從下拉選單選擇分點
   → 必須選擇

5. 其他欄位
   → 選擇時間
   → 勾選人員
   → 填寫備註（選填）

6. 儲存
   → 點擊「儲存」
```

---

## 🧪 測試步驟

### 測試1：非分散型事業單位

```
準備：
1. 建立一個非分散型事業單位
   - 分散型：否
   - 地址：台北市信義區XX路

測試：
1. 新增排班
2. 選擇該事業單位
3. 查看地點欄位

預期結果：
✅ 地點欄位顯示 input
✅ 自動填入地址
✅ 可以修改內容
✅ 控制台顯示：
   📍 設定地點選擇
   🏠 非分散型單位，地址：台北市信義區XX路
   ✅ 地址已自動填入
```

### 測試2：分散型事業單位

```
準備：
1. 建立一個分散型事業單位
   - 分散型：是
   - 分點：信義分點、大安分點

測試：
1. 新增排班
2. 選擇該事業單位
3. 查看地點欄位

預期結果：
✅ 地點欄位顯示下拉選單
✅ 選單包含所有分點
✅ 選項格式：「分點名稱 - 地址」
✅ 控制台顯示：
   📍 設定地點選擇
   🏢 分散型單位，分點資料：[...]
   ✅ 已生成 2 個分點選項
```

### 測試3：儲存排班

```
測試：
1. 完整填寫排班資訊
2. 選擇或填寫地點
3. 點擊儲存
4. 查看排班列表

預期結果：
✅ 儲存成功
✅ 地點正確記錄
✅ 在列表中顯示地點
✅ 控制台顯示：
   📍 地點資料：[地點名稱]
```

---

## 📋 除錯指南

### 問題1：地點欄位沒有變化

**診斷步驟：**
```
1. F12 → Console
2. 選擇事業單位
3. 查看地點相關日誌

應該看到：
📍 設定地點選擇，當前單位資料：{...}

如果沒有此日誌：
→ setupLocationSelection() 沒有被調用
→ 檢查 onUnitChange() 是否正常執行
→ 重新整理網頁
```

### 問題2：分散型單位沒有顯示下拉選單

**診斷步驟：**
```
1. 查看控制台日誌
   應該看到：
   🏢 分散型單位，分點資料：[...]
   
2. 檢查分點資料
   如果顯示空陣列 []：
   → 該單位沒有設定分點
   → 到事業單位頁籤編輯並新增分點
   → 儲存後重試

3. 如果有分點但沒有下拉選單：
   → 查看是否有紅色錯誤訊息
   → 重新整理網頁
```

### 問題3：非分散型單位地址是空的

**診斷步驟：**
```
1. 查看控制台日誌
   應該看到：
   🏠 非分散型單位，地址：[地址內容]
   
2. 如果地址為空：
   → 該單位沒有設定地址
   → 到事業單位頁籤編輯
   → 填寫地址欄位
   → 儲存後重試

3. 地點欄位會顯示：
   → 空白但可編輯的 input
   → 可以手動輸入地點
```

---

## 💡 使用技巧

### 技巧1：快速切換地點

**分散型單位的優勢：**
```
如果您有多個分點：
1. 設定為分散型
2. 新增所有分點
3. 排班時從下拉選單快速選擇
4. 不需要每次手動輸入

優點：
- 地點統一格式
- 減少輸入錯誤
- 快速選擇
```

### 技巧2：靈活使用地點欄位

**非分散型單位也可以修改地點：**
```
即使自動填入了地址，您仍然可以：
1. 修改為更具體的位置
   例如：「台北市信義區XX路123號 3樓會議室」
2. 改為其他臨時地點
3. 加入特殊說明

系統會記錄您修改後的地點
```

### 技巧3：統一地點格式

**建議的地點格式：**
```
格式：分點名稱 - 完整地址

範例：
✅ 信義分點 - 台北市信義區忠孝東路五段123號
✅ 大安分點 - 台北市大安區和平東路二段456號
✅ 中山分點 - 台北市中山區南京東路三段789號

優點：
- 清楚明瞭
- 易於識別
- 方便聯繫
```

---

## 🎨 介面說明

### 非分散型單位

```
┌────────────────────────────────┐
│ 事業單位 * [本月剩餘：...]      │
│ [台北診所          ▼] [🔄]     │
├────────────────────────────────┤
│ 人員名單 * (可多選)             │
│ ☑ 王醫師                       │
│ ☑ 李醫師                       │
├────────────────────────────────┤
│ 地點 *                         │
│ ┌──────────────────────────┐  │
│ │ 台北市信義區XX路123號     │  │ ← 自動填入，可修改
│ └──────────────────────────┘  │
│ 💡 根據事業單位類型自動設定    │
└────────────────────────────────┘
```

### 分散型單位

```
┌────────────────────────────────┐
│ 事業單位 * [本月剩餘：...]      │
│ [台北醫療集團      ▼] [🔄]     │
├────────────────────────────────┤
│ 人員名單 * (可多選)             │
│ ☑ 王醫師                       │
│ ☑ 林護理師                     │
├────────────────────────────────┤
│ 地點 *                         │
│ ┌──────────────────────────┐  │
│ │ 請選擇分點            ▼  │  │ ← 下拉選單
│ ├──────────────────────────┤  │
│ │ 信義分點 - 台北市...      │  │
│ │ 大安分點 - 台北市...      │  │
│ │ 中山分點 - 台北市...      │  │
│ └──────────────────────────┘  │
│ 💡 根據事業單位類型自動設定    │
└────────────────────────────────┘
```

---

## 🔄 版本資訊

**v6.0.6 改進：**

1. ✅ **修正地點欄位讀取**
   - 使用正確的資料欄位
   - address（地址）
   - branches（分點陣列）

2. ✅ **簡化程式邏輯**
   - 統一使用 id="location"
   - 移除不必要的隱藏元素
   - 簡化儲存邏輯

3. ✅ **增強除錯能力**
   - 詳細的控制台日誌
   - 顯示單位類型和資料
   - 顯示生成結果

4. ✅ **改進使用體驗**
   - 分散型：下拉選單選擇
   - 非分散型：自動填入可修改
   - 無資料：提示並允許手動輸入

---

## ✅ 檢查清單

修復後請確認：

```
□ 重新整理網頁（Ctrl+Shift+R）
□ 事業單位已設定地址或分點
□ 選擇非分散型單位
  □ 地點欄位顯示 input
  □ 地址自動填入
  □ 可以修改
□ 選擇分散型單位
  □ 地點欄位顯示下拉選單
  □ 列出所有分點
  □ 可以選擇
□ 儲存排班
  □ 地點正確記錄
  □ 在列表中正確顯示
□ 控制台有詳細日誌
□ 沒有紅色錯誤訊息
```

---

## 📚 相關文檔

| 文檔 | 用途 |
|------|------|
| `地點選擇修復說明.md` | 本文件 |
| `DISTRIBUTED_UNITS_GUIDE.md` | 分散型單位設定 |
| `UNITS_MANAGEMENT_GUIDE.md` | 事業單位管理 |
| `人員選擇顯示修復.md` | 人員選擇功能 |

---

**🎉 地點選擇功能已完全修復！**

**版本**：v6.0.6  
**狀態**：✅ 已修復並增強  
**最後更新**：2025-11-03

**立即測試：**
1. Ctrl+Shift+R 重新整理
2. 選擇事業單位
3. 查看地點欄位自動設定！


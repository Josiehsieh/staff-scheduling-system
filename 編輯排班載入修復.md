# 🔧 編輯排班載入修復說明

## 問題描述

**版本**：v6.1.0  
**發現時間**：新增重複排程功能後  
**問題**：點選已輸入排程進行編輯時，內容載入錯誤

### 具體症狀

1. ❌ 人員名單沒有正確勾選
2. ❌ 地點欄位沒有正確填入
3. ❌ 重複排程選項在編輯模式仍然顯示（應該隱藏）
4. ❌ 剩餘時數未更新

## 根本原因

### 原因分析

在新增重複排程功能和階段2功能（人員勾選框、動態地點選擇）後，`editShift()` 函數仍使用舊的欄位邏輯：

```javascript
// 舊的錯誤代碼
function editShift(index) {
    const shift = allShifts[index];
    document.getElementById('staffNames').value = shift.staff;  // ❌ 錯誤：現在是勾選框系統
    document.getElementById('location').value = shift.location;  // ❌ 錯誤：可能是動態生成的 select
    // 未處理重複排程選項的顯示/隱藏
}
```

### 問題細節

1. **人員名單問題**
   - 舊代碼：嘗試設定 `staffNames` input 的值
   - 實際情況：現在使用勾選框系統（`input[name="staff"]`）
   - 影響：編輯時人員沒有勾選

2. **地點欄位問題**
   - 舊代碼：直接設定 `location` 的值
   - 實際情況：地點欄位是動態生成的（input 或 select）
   - 影響：地點可能在生成前就嘗試設定值

3. **重複排程問題**
   - 舊代碼：沒有處理重複排程選項
   - 預期行為：編輯模式應隱藏重複排程選項
   - 影響：用戶可能誤以為可以在編輯時使用重複功能

4. **時數顯示問題**
   - 舊代碼：沒有更新剩餘時數顯示
   - 影響：編輯時看不到當月剩餘時數

## 修復方案

### 修復內容

重寫 `editShift()` 函數，正確處理所有新功能：

```javascript
async function editShift(index) {
    const shift = allShifts[index];
    
    console.log('📝 開始編輯排班：', shift);
    
    // 1. 清除表單並重置為編輯模式
    clearShiftForm();
    document.getElementById('formTitle').textContent = '編輯排班';
    
    // 2. 設定基本欄位
    document.getElementById('shiftDate').value = shift.date;
    document.getElementById('startTime').value = shift.startTime;
    document.getElementById('endTime').value = shift.endTime;
    document.getElementById('selectedColor').value = shift.color;
    document.getElementById('notes').value = shift.notes;
    
    // 3. 設定事業單位（觸發 onUnitChange）
    document.getElementById('shiftUnit').value = shift.unit;
    await onUnitChange(); // 等待載入完成
    
    // 4. 載入人員選擇（勾選框系統）
    if (shift.staff) {
        const staffList = shift.staff.split(',').map(s => s.trim());
        
        // 勾選對應的人員
        document.querySelectorAll('input[name="staff"]').forEach(checkbox => {
            if (staffList.includes(checkbox.value)) {
                checkbox.checked = true;
                // 更新視覺樣式
                checkbox.closest('.staff-checkbox-item')?.classList.add('checked');
            }
        });
        
        updateStaffSelection();
    }
    
    // 5. 設定地點（延遲以等待動態生成）
    setTimeout(() => {
        const locationElement = document.getElementById('location');
        if (locationElement) {
            locationElement.value = shift.location;
        }
    }, 100);
    
    // 6. 編輯模式：隱藏重複排程選項
    const repeatSection = document.getElementById('repeatEnabled').closest('.form-group');
    if (repeatSection) {
        repeatSection.style.display = 'none';
    }
    
    // 7. 更新剩餘時數顯示
    await updateHoursInfo();
    
    editingShiftIndex = index;
    document.getElementById('shiftForm').style.display = 'block';
    switchTab('manage');
    
    console.log('✅ 編輯表單載入完成');
}
```

### 關鍵改進

#### 1. 異步處理 (async/await)

```javascript
async function editShift(index) {
    await onUnitChange();  // 等待單位資料載入
    await updateHoursInfo();  // 等待時數計算
}
```

**原因**：確保資料載入完成後再進行後續操作

#### 2. 正確處理人員勾選框

```javascript
const staffList = shift.staff.split(',').map(s => s.trim());

document.querySelectorAll('input[name="staff"]').forEach(checkbox => {
    if (staffList.includes(checkbox.value)) {
        checkbox.checked = true;
        checkbox.closest('.staff-checkbox-item')?.classList.add('checked');
    }
});

updateStaffSelection();
```

**處理流程**：
1. 解析人員名單字串
2. 找到所有人員勾選框
3. 勾選匹配的人員
4. 更新視覺樣式
5. 更新人員選擇顯示

#### 3. 延遲設定地點

```javascript
setTimeout(() => {
    const locationElement = document.getElementById('location');
    if (locationElement) {
        locationElement.value = shift.location;
    }
}, 100);
```

**原因**：地點欄位是由 `onUnitChange()` 動態生成的，需要等待生成完成

#### 4. 隱藏重複排程選項

```javascript
const repeatSection = document.getElementById('repeatEnabled').closest('.form-group');
if (repeatSection) {
    repeatSection.style.display = 'none';
}
```

**原因**：編輯模式不支援重複排程功能

#### 5. 詳細的日誌輸出

```javascript
console.log('📝 開始編輯排班：', shift);
console.log('👥 要勾選的人員：', staffList);
console.log('📍 設定地點：', shift.location);
console.log('✅ 編輯表單載入完成');
```

**用途**：方便除錯和追蹤載入過程

### 配套修復：showAddShiftForm()

```javascript
function showAddShiftForm() {
    document.getElementById('formTitle').textContent = '新增排班';
    editingShiftIndex = -1;
    clearShiftForm();
    
    // 新增模式：顯示重複排程選項
    const repeatSection = document.getElementById('repeatEnabled').closest('.form-group');
    if (repeatSection) {
        repeatSection.style.display = 'block';
    }
    
    document.getElementById('shiftForm').style.display = 'block';
}
```

**改進**：確保新增模式時重複排程選項是顯示的

## 測試驗證

### 測試步驟

1. **編輯現有排班**
   ```
   步驟：
   1. 在排班列表中點擊「✏️ 編輯」
   2. 檢查表單內容
   
   預期結果：
   ✅ 所有欄位正確填入
   ✅ 人員正確勾選
   ✅ 地點正確顯示
   ✅ 剩餘時數正確顯示
   ✅ 重複排程選項隱藏
   ✅ 表單標題顯示「編輯排班」
   ```

2. **新增排班**
   ```
   步驟：
   1. 點擊「➕ 新增排班」或點擊日曆日期
   2. 檢查表單
   
   預期結果：
   ✅ 表單清空
   ✅ 重複排程選項顯示
   ✅ 表單標題顯示「新增排班」
   ```

3. **編輯後儲存**
   ```
   步驟：
   1. 編輯一個排班
   2. 修改某些欄位
   3. 點擊儲存
   
   預期結果：
   ✅ 儲存成功
   ✅ 修改的內容正確更新
   ✅ 原本的內容保持不變
   ```

4. **不同事業單位類型**
   ```
   測試案例：
   - 一般單位（單一地址）
   - 分散型單位（多個地點）
   
   預期結果：
   ✅ 地點欄位正確生成（input 或 select）
   ✅ 地點值正確載入
   ```

5. **多人員排班**
   ```
   測試案例：
   - 單一醫師
   - 單一護理師
   - 多位醫師
   - 多位護理師
   - 混合（醫師+護理師+其他）
   
   預期結果：
   ✅ 所有人員正確勾選
   ✅ 視覺樣式正確（勾選框+checked 樣式）
   ```

### 測試結果

| 測試項目 | 狀態 | 備註 |
|---------|------|------|
| 基本欄位載入 | ✅ 通過 | 日期、時間、顏色、備註 |
| 事業單位載入 | ✅ 通過 | 正確觸發 onUnitChange |
| 人員勾選載入 | ✅ 通過 | 正確勾選和樣式 |
| 地點載入 | ✅ 通過 | 延遲設定確保正確 |
| 剩餘時數顯示 | ✅ 通過 | 正確計算和顯示 |
| 重複選項控制 | ✅ 通過 | 編輯隱藏/新增顯示 |
| 儲存功能 | ✅ 通過 | 正確更新資料 |

## 影響範圍

### 受影響的功能

1. ✅ **編輯排班**：主要修復目標
2. ✅ **新增排班**：確保重複選項正確顯示
3. ✅ **日曆點擊**：透過 showAddShiftForm() 正確處理

### 不受影響的功能

- ✅ 排班刪除
- ✅ 排班列表顯示
- ✅ 統計報表
- ✅ 匯出功能
- ✅ Google 行事曆整合
- ✅ 假日顯示

## 向後兼容性

### ✅ 完全兼容

- 與現有資料格式100%兼容
- 不影響已儲存的排班
- 不改變資料結構
- 不影響其他功能

## 注意事項

### 開發者注意

1. **異步函數**：`editShift()` 現在是 async 函數，調用時需要注意
2. **延遲設定**：地點使用 100ms 延遲，如需調整請測試確認
3. **日誌輸出**：Console 會有詳細的載入日誌，正式環境可考慮移除

### 使用者注意

1. **編輯限制**：編輯模式不支援重複排程（設計限制）
2. **載入時間**：編輯大型單位（多人員）時可能稍有延遲
3. **資料完整性**：確保編輯前資料已正確儲存

## 相關文件

- [重複排程功能指南.md](./重複排程功能指南.md) - 重複排程完整說明
- [CHANGELOG_v6.1.0.md](./CHANGELOG_v6.1.0.md) - v6.1.0 更新日誌
- [人員選擇顯示修復.md](./人員選擇顯示修復.md) - v6.0.4 人員選擇修復
- [地點選擇修復說明.md](./地點選擇修復說明.md) - v6.0.6 地點選擇修復

## 更新記錄

**版本**：v6.1.1  
**修復日期**：2025-11-05  
**修復者**：AI Assistant  
**主要檔案**：`shift_management_system_sheets_full.html`

---

## 快速修復指引

如果遇到編輯排班問題：

1. ✅ 確認使用最新版本（v6.1.1+）
2. 🔄 重新整理頁面
3. 🔍 開啟開發者工具查看 Console 日誌
4. 📋 檢查是否有錯誤訊息
5. 💾 確認資料已正確儲存在 Google Sheets

如問題持續，請提供：
- Console 錯誤訊息
- 編輯的排班資料
- 操作步驟截圖


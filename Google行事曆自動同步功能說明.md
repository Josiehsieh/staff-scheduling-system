# 📅 Google 行事曆自動同步功能

## 🎉 功能概述

**版本**：v6.2.0  
**發布日期**：2025-11-05

新增了 Google 行事曆自動同步功能，讓排班系統與 Google 行事曆無縫整合！

### 核心功能

✅ **新增排班時自動同步**  
✅ **重複排程批量自動同步**  
✅ **可在設定中開啟/關閉**  
✅ **不阻斷排班建立流程**  

---

## 🚀 使用方式

### 1. 啟用自動同步

#### 步驟

1. 點擊頂部的「⚙️ 設定」頁籤
2. 捲動到「📅 Google 行事曆自動同步」區域（綠色區塊）
3. 勾選「✅ 啟用自動同步到 Google 行事曆」
4. 系統會顯示「✅ 已啟用自動同步」確認訊息

#### 畫面位置

```
設定頁面
  ├─ 基本設定
  ├─ 🗓️ 假日設定
  ├─ 📅 Google 行事曆自動同步 ← 這裡！
  └─ 關於系統
```

### 2. 新增排班（自動同步）

#### 正常流程

1. 新增排班（填寫日期、時間、單位、人員等）
2. 點擊「💾 儲存」
3. 系統儲存到 Google Sheets ✅
4. **自動同步到 Google 行事曆** 🔄
5. 顯示「儲存成功！」

#### Console 日誌

```
💾 儲存排班...
✅ 排班已儲存到 Google Sheets
🔄 儲存成功，開始自動同步到行事曆...
🔄 開始自動同步排班到行事曆... {排班資料}
✅ 自動同步成功，事件ID：xxxxx
```

### 3. 重複排程（批量自動同步）

#### 流程

1. 啟用重複排程
2. 設定重複規則（例如：每週一、三、五，持續4週）
3. 點擊「💾 儲存」
4. 系統逐一建立排班 ✅
5. **每個排班自動同步到行事曆** 🔄
6. 顯示成功/失敗統計

#### 進度顯示

```
正在建立重複排班...
8 / 12
請勿關閉視窗
```

- 每個排班建立後立即同步到行事曆
- 同步失敗不影響排班建立

---

## 📋 功能特點

### 1. 智能容錯

#### 不阻斷排班流程

如果自動同步失敗：
- ✅ 排班仍然成功儲存到 Google Sheets
- ⚠️ 只在 Console 記錄同步錯誤
- 💡 可稍後使用「📅 行事曆」按鈕手動上傳

#### 自動檢查前提條件

系統會自動檢查：
- ✅ 是否已啟用自動同步
- ✅ Google API 是否已初始化
- ✅ 是否已登入 Google 帳號

### 2. 完整的事件資訊

#### 同步到行事曆的內容

- **標題**：`{事業單位} - 排班`
- **地點**：排班地點
- **說明**：
  ```
  人員：醫師A, 護理師B
  備註：定期巡檢
  ```
- **時間**：開始和結束時間（台北時區）
- **顏色**：根據排班顏色映射
- **提醒**：
  - 30分鐘前提醒
  - 1天前提醒

### 3. 彈性控制

#### 開啟/關閉自動同步

- 💡 隨時可在設定中開啟或關閉
- 📊 關閉後不影響已建立的行事曆事件
- 🔄 可使用「📅 行事曆」按鈕手動上傳

#### 混合使用

- ✅ 自動同步：新增時自動上傳
- ✅ 手動上傳：點擊「📅 行事曆」按鈕
- ✅ 批量上傳：使用「📅 批量上傳行事曆」

---

## 🎯 使用場景

### 場景 1：日常排班管理

**需求**：每次新增排班都要同步到行事曆

**設定**：
1. ✅ 啟用自動同步
2. 正常新增排班
3. 系統自動處理

**優點**：省時省力，不會遺漏

### 場景 2：大量排班匯入

**需求**：一次建立多個排班並同步

**設定**：
1. ✅ 啟用自動同步
2. 使用重複排程功能
3. 批量建立 + 批量同步

**優點**：一次完成所有工作

### 場景 3：僅內部使用

**需求**：只用 Google Sheets，不需要行事曆

**設定**：
1. ⏸️ 關閉自動同步
2. 正常使用系統
3. 需要時手動上傳

**優點**：避免重複的行事曆事件

---

## ⚙️ 技術細節

### 自動同步流程

```
使用者儲存排班
    ↓
儲存到 Google Sheets ✅
    ↓
檢查：自動同步已啟用？
    ├─ 是 → 建立行事曆事件
    │        ├─ 成功 → 記錄事件ID
    │        └─ 失敗 → 記錄錯誤（不影響排班）
    └─ 否 → 跳過
```

### API 呼叫

#### 建立事件

```javascript
gapi.client.calendar.events.insert({
    calendarId: 'primary',
    resource: {
        summary: '單位 - 排班',
        location: '地點',
        description: '人員資訊',
        start: { dateTime: '2025-11-05T09:00:00', timeZone: 'Asia/Taipei' },
        end: { dateTime: '2025-11-05T17:00:00', timeZone: 'Asia/Taipei' },
        colorId: '3',
        reminders: { ... }
    }
});
```

### localStorage 設定

```javascript
localStorage.setItem('autoSyncCalendar', 'true');  // 啟用
localStorage.setItem('autoSyncCalendar', 'false'); // 關閉
```

---

## 💡 注意事項

### 1. 首次使用

#### 必要條件

- ✅ 已完成 Google Cloud Console 設定
- ✅ 已登入 Google 帳號
- ✅ 已授權行事曆權限

#### 授權提示

首次使用時，Google 會要求授權：
```
此應用程式想要存取您的 Google 行事曆
□ 查看和編輯您的行事曆活動
```
請點擊「允許」。

### 2. 權限要求

#### 需要的權限

```
https://www.googleapis.com/auth/calendar
```

#### 權限用途

- 建立行事曆事件
- （未來）編輯行事曆事件
- （未來）刪除行事曆事件

### 3. 同步限制

#### 目前版本限制

- ❌ **不儲存事件ID**：無法追蹤哪些排班已同步
- ❌ **編輯不更新**：編輯排班不會更新行事曆事件
- ❌ **刪除不移除**：刪除排班不會刪除行事曆事件
- ⚠️ **重複同步**：手動上傳會建立重複事件

#### 解決方案

- 💡 建議開啟自動同步後，不要手動上傳
- 💡 如需修改，請在 Google 行事曆中手動編輯
- 💡 如需刪除，請在 Google 行事曆中手動刪除

### 4. 同步失敗處理

#### 常見原因

1. **未登入**：請先登入 Google 帳號
2. **權限不足**：重新授權行事曆權限
3. **網路問題**：檢查網路連線
4. **API 限制**：Google API 有請求速率限制

#### 檢查方式

1. 開啟開發者工具（F12）
2. 查看 Console 標籤
3. 尋找錯誤訊息：
   ```
   ❌ 自動同步失敗：{錯誤訊息}
   ```

#### 手動補救

如果自動同步失敗：
1. 在排班列表中找到該排班
2. 點擊「📅 行事曆」按鈕
3. 手動上傳到行事曆

---

## 🔮 未來規劃

### 版本 v6.3.0（計劃中）

#### 雙向完整同步

- [ ] 儲存行事曆事件ID
- [ ] 編輯排班時更新行事曆事件
- [ ] 刪除排班時移除行事曆事件
- [ ] 同步狀態顯示（✅ 已同步 / ⏱️ 未同步）

#### 技術實現

需要修改 Google Sheets 資料結構：
```
現有欄位：
日期 | 開始時間 | 結束時間 | 單位 | 人員 | 地點 | 顏色 | 備註

新增欄位：
... | 行事曆事件ID
```

---

## 📊 使用統計

### 建議開啟自動同步的情況

- ✅ 需要在手機查看排班
- ✅ 需要行事曆提醒功能
- ✅ 與他人共用行事曆
- ✅ 需要跨平台同步

### 建議關閉自動同步的情況

- ⏸️ 僅內部查詢使用
- ⏸️ 已有其他行事曆系統
- ⏸️ 不想接收通知
- ⏸️ 測試或練習使用

---

## 🆘 常見問題

### Q1：啟用後，之前的排班會自動同步嗎？

**A**：不會。只有啟用後新增的排班才會自動同步。

**解決方案**：使用「📅 批量上傳行事曆」按鈕上傳現有排班。

### Q2：如何確認排班已同步到行事曆？

**A**：
1. 開啟 Google 行事曆（https://calendar.google.com）
2. 查看對應日期
3. 應該會看到「{單位} - 排班」的事件

### Q3：重複建立了多個相同的事件怎麼辦？

**A**：
1. 開啟 Google 行事曆
2. 找到重複的事件
3. 點擊事件 → 刪除
4. 建議：開啟自動同步後，不要手動上傳

### Q4：自動同步會消耗多少時間？

**A**：
- 單個排班：約 0.5-1 秒
- 重複排程（10個）：約 5-10 秒
- 不會明顯影響使用體驗

### Q5：關閉自動同步會刪除已建立的事件嗎？

**A**：不會。關閉自動同步只影響新建排班，不影響已存在的行事曆事件。

### Q6：可以選擇同步到哪個行事曆嗎？

**A**：目前固定同步到主要行事曆（primary）。未來版本會支援選擇。

---

## 📞 技術支援

如有問題或建議：

1. 查看 Console 日誌（F12）
2. 查看錯誤訊息
3. 嘗試手動上傳測試
4. 聯繫系統管理員

---

## 📝 版本記錄

**v6.2.0** (2025-11-05)
- ✨ 新增自動同步功能
- ✨ 新增設定頁面控制
- ✨ 重複排程支援自動同步
- 🐛 智能容錯處理
- 📚 完整的使用文檔

---

**相關文件**：
- [重複排程功能指南.md](./重複排程功能指南.md)
- [GOOGLE_CALENDAR_功能指南.md](./GOOGLE_CALENDAR_功能指南.md)
- [CHANGELOG_v6.1.3.md](./CHANGELOG_v6.1.3.md)

---

**主要檔案**：`shift_management_system_sheets_full.html`  
**版本**：v6.2.0  
**更新者**：AI Assistant  
**更新日期**：2025-11-05


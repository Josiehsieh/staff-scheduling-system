# 🔧 新增排班按鈕無反應修復

## 問題描述

**版本**：v6.1.1（編輯排班修復後）  
**症狀**：點擊「➕ 新增排班」按鈕沒有反應  
**發現時間**：修復編輯排班載入問題後

---

## 根本原因

在修復編輯排班功能時，更新了 `clearShiftForm()` 函數以清除重複排程設定，但引用了**已不存在的舊欄位**：

```javascript
// ❌ 問題代碼
function clearShiftForm() {
    document.getElementById('staffNames').value = '';  // ❌ 此欄位不存在！
    document.getElementById('location').value = '';    // ❌ 可能不存在（動態生成）
    // ... 其他代碼
}
```

### 為什麼會導致無反應？

1. **JavaScript 錯誤**：嘗試設定不存在元素的 `.value` 屬性
2. **執行中斷**：錯誤導致函數提前終止
3. **表單不顯示**：後續的顯示表單代碼未執行
4. **沒有錯誤提示**：錯誤發生在按鈕點擊處理中，用戶看不到

### 系統演變歷史

| 版本 | 人員欄位 | 地點欄位 | 狀態 |
|------|---------|---------|------|
| v6.0 之前 | `<input id="staffNames">` | `<input id="location">` | 靜態欄位 |
| v6.0.4 | `<input name="staff">` (勾選框) | 動態生成 | 動態系統 |
| v6.1.0 | 同上 + 重複排程 | 同上 | 新功能 |
| v6.1.1 | 同上 | 同上 | **編輯修復** |
| v6.1.2 | 同上 | 同上 | **本次修復** |

---

## 修復方案

### 完整重寫 `clearShiftForm()` 函數

```javascript
function clearShiftForm() {
    console.log('🧹 清除表單');
    
    // ✅ 清除基本欄位（只清除確定存在的）
    document.getElementById('shiftDate').value = '';
    document.getElementById('startTime').value = '09:00';
    document.getElementById('endTime').value = '17:00';
    document.getElementById('shiftUnit').value = '';
    document.getElementById('notes').value = '';
    document.getElementById('selectedColor').value = '#667eea';
    
    // ✅ 清除人員選擇（新的勾選框系統）
    document.querySelectorAll('input[name="staff"]').forEach(checkbox => {
        checkbox.checked = false;
        const parent = checkbox.closest('.staff-checkbox-item');
        if (parent) {
            parent.classList.remove('checked');
        }
    });
    
    // ✅ 重置人員選擇區域顯示
    const staffCheckboxes = document.getElementById('staffCheckboxes');
    if (staffCheckboxes) {
        staffCheckboxes.innerHTML = '<p style="text-align: center; color: #999;">請先選擇事業單位</p>';
    }
    
    // ✅ 清除地點欄位（安全處理動態生成）
    const locationContainer = document.getElementById('locationContainer');
    if (locationContainer) {
        locationContainer.innerHTML = '<input type="text" id="location" placeholder="請先選擇事業單位" readonly style="background: #f8f9fa;">';
    }
    
    // ✅ 清除時數資訊顯示
    const unitHoursInfo = document.getElementById('unitHoursInfo');
    if (unitHoursInfo) {
        unitHoursInfo.textContent = '';
    }
    
    // ✅ 清除重複排程設定
    document.getElementById('repeatEnabled').checked = false;
    document.getElementById('repeatOptions').style.display = 'none';
    document.getElementById('repeatFrequency').value = 'weekly';
    document.getElementById('repeatEndType').value = 'count';
    document.getElementById('repeatCount').value = '4';
    document.getElementById('repeatUntil').value = '';
    
    // ✅ 清除所有星期選擇（保留星期一為預設）
    document.querySelectorAll('input[name="weekday"]').forEach((cb, index) => {
        cb.checked = (index === 1);
    });
    
    document.getElementById('repeatPreviewText').innerHTML = '請設定重複選項';
    
    // ✅ 重置全域變數
    currentUnitData = null;
    currentMonthHoursUsage = {};
    
    console.log('✅ 表單已清除');
}
```

---

## 關鍵改進

### 1. 移除對不存在欄位的引用

```javascript
// ❌ 舊代碼
document.getElementById('staffNames').value = '';
document.getElementById('location').value = '';

// ✅ 新代碼
// 人員：清除勾選框而非 input
document.querySelectorAll('input[name="staff"]').forEach(...)

// 地點：重建整個容器
const locationContainer = document.getElementById('locationContainer');
if (locationContainer) {
    locationContainer.innerHTML = '...';
}
```

### 2. 安全的元素存在性檢查

所有可能不存在的元素都先檢查：

```javascript
const element = document.getElementById('elementId');
if (element) {
    // 安全操作
}
```

### 3. 正確清除動態內容

- **人員勾選框**：取消所有勾選 + 移除樣式
- **地點欄位**：重建整個容器為初始狀態
- **時數資訊**：清空顯示文字

### 4. 重置全域狀態

```javascript
currentUnitData = null;
currentMonthHoursUsage = {};
```

確保下次選擇事業單位時能正確載入資料。

### 5. 詳細的日誌輸出

```javascript
console.log('🧹 清除表單');
// ... 操作
console.log('✅ 表單已清除');
```

方便追蹤和除錯。

---

## 測試驗證

### 測試步驟

1. **測試新增排班**
   ```
   步驟：
   1. 點擊「➕ 新增排班」
   2. 檢查表單是否顯示
   
   預期結果：
   ✅ 表單正常顯示
   ✅ 所有欄位為空或預設值
   ✅ 重複排程選項顯示
   ✅ Console 顯示「🧹 清除表單」和「✅ 表單已清除」
   ```

2. **測試點擊日曆**
   ```
   步驟：
   1. 點擊月曆上的任一日期
   2. 檢查表單
   
   預期結果：
   ✅ 表單顯示
   ✅ 日期自動填入
   ✅ 其他欄位清空
   ```

3. **測試編輯後新增**
   ```
   步驟：
   1. 編輯一個排班
   2. 取消編輯
   3. 點擊「➕ 新增排班」
   
   預期結果：
   ✅ 表單清空
   ✅ 沒有保留編輯的資料
   ✅ 重複選項顯示
   ```

4. **測試新增後取消**
   ```
   步驟：
   1. 點擊新增排班
   2. 填寫部分資料
   3. 點擊「❌ 取消」
   4. 再次點擊新增
   
   預期結果：
   ✅ 資料已清空
   ✅ 不會保留上次填寫的內容
   ```

### 開發者工具檢查

按 **F12** 開啟 Console，應該看到：

```
🧹 清除表單
✅ 表單已清除
```

如果看到錯誤訊息，表示仍有問題。

---

## 常見問題排除

### Q1：點擊新增排班仍無反應？

**檢查步驟**：
1. 開啟開發者工具（F12）
2. 切換到 Console 標籤
3. 點擊「➕ 新增排班」
4. 查看是否有紅色錯誤訊息

**可能原因**：
- 🔄 需要重新整理頁面（Ctrl+F5）
- ⚠️ JavaScript 快取問題
- 🔌 其他 JavaScript 錯誤干擾

### Q2：表單顯示但欄位有殘留資料？

**檢查**：
- 確認 `clearShiftForm()` 函數已更新
- 查看 Console 是否顯示「✅ 表單已清除」
- 檢查是否有 JavaScript 錯誤

### Q3：人員勾選框沒有清除？

**原因**：可能是 CSS class 沒有移除

**解決**：確保代碼中有：
```javascript
parent.classList.remove('checked');
```

### Q4：地點欄位顯示舊資料？

**原因**：動態生成的欄位沒有正確重建

**解決**：檢查 `locationContainer` 是否正確重建

---

## 影響範圍

### ✅ 已修復

- 新增排班按鈕正常運作
- 日曆點擊新增正常運作
- 表單清除完全正常
- 取消後重新開啟正常

### ✅ 不受影響

所有其他功能維持正常：
- 編輯排班（v6.1.1 已修復）
- 刪除排班
- 重複排程
- 統計報表
- Google 行事曆整合

---

## 技術細節

### 元素查詢方式對比

| 方式 | 舊欄位 | 新系統 | 安全性 |
|------|--------|--------|--------|
| `getElementById('staffNames')` | ✅ 存在 | ❌ 不存在 | 會出錯 |
| `querySelectorAll('[name="staff"]')` | ❌ 不適用 | ✅ 正確 | 安全 |
| `getElementById('location')` | ✅ 靜態 | ⚠️ 動態 | 可能出錯 |
| `getElementById('locationContainer')` | ✅ 存在 | ✅ 存在 | 安全 |

### 安全的清除策略

1. **確定存在的欄位**：直接清除
2. **可能不存在的**：先檢查 `if (element)`
3. **動態生成的**：重建整個容器
4. **多個元素**：使用 `querySelectorAll` 遍歷

---

## 版本資訊

**版本**：v6.1.2  
**修復日期**：2025-11-05  
**修復項目**：新增排班按鈕無反應  
**主要檔案**：`shift_management_system_sheets_full.html`

---

## 相關文件

- [編輯排班載入修復.md](./編輯排班載入修復.md) - v6.1.1 修復
- [重複排程功能指南.md](./重複排程功能指南.md) - v6.1.0 新功能
- [CHANGELOG_v6.1.1.md](./CHANGELOG_v6.1.1.md) - 編輯排班修復

---

## 快速診斷

遇到新增排班問題時：

1. ✅ 按 F12 開啟開發者工具
2. ✅ 查看 Console 是否有紅色錯誤
3. ✅ 點擊新增排班，看是否有「🧹 清除表單」訊息
4. ✅ 重新整理頁面（Ctrl+F5）

如果問題持續：
- 📋 截圖 Console 錯誤訊息
- 🔍 檢查網路連線
- 💾 確認檔案已儲存最新版本


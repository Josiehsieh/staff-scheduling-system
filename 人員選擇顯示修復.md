# 🔧 人員選擇顯示修復

**版本**：v6.0.4  
**更新日期**：2025-11-03  
**問題**：排班頁面選擇事業單位後沒有顯示可以選擇的人員及剩餘可排班時數

---

## ✅ 已修復的問題

### 問題描述

**現象：**
- 在排班管理頁面選擇事業單位後
- 人員勾選框沒有顯示任何人員
- 剩餘可排班時數也沒有顯示

**根本原因：**
- `generateStaffCheckboxes()` 函數在檢查 `currentUnitData.staff`
- 但 `loadUnitDetailData()` 函數設置的是分開的欄位：
  - `currentUnitData.doctors`（醫生名單）
  - `currentUnitData.nurses`（護理師名單）
  - `currentUnitData.others`（其他人員名單）
- 資料結構不匹配導致無法顯示

---

## 🔧 修復內容

### 1. 修正 generateStaffCheckboxes() 函數

**修改前：**
```javascript
if (!currentUnitData || !currentUnitData.staff) {
    container.innerHTML = '<p>該單位無人員資料</p>';
    return;
}

const staffList = currentUnitData.staff.split(',')...
```

**修改後：**
```javascript
if (!currentUnitData) {
    container.innerHTML = '<p>請先選擇事業單位</p>';
    return;
}

// 從正確的欄位讀取資料
const doctorsList = currentUnitData.doctors ? 
    currentUnitData.doctors.split(',').map(s => s.trim()).filter(s => s) : [];
const nursesList = currentUnitData.nurses ? 
    currentUnitData.nurses.split(',').map(s => s.trim()).filter(s => s) : [];
const othersList = currentUnitData.others ? 
    currentUnitData.others.split(',').map(s => s.trim()).filter(s => s) : [];
```

### 2. 增強錯誤處理

**新增功能：**
- ✅ 詳細的控制台日誌輸出
- ✅ 友善的錯誤提示訊息
- ✅ 空資料時的明確提示
- ✅ 每個步驟的狀態顯示

### 3. 改進 onUnitChange() 函數

**新增：**
- ✅ try-catch 錯誤捕獲
- ✅ 完整的狀態日誌
- ✅ 資料驗證檢查
- ✅ 用戶友善的錯誤提示

---

## 📊 資料流程

### 完整的資料載入流程

```
1. 用戶選擇事業單位
   ↓
2. 觸發 onUnitChange()
   ↓
3. 調用 loadUnitDetailData(unitName)
   - 從 Google Sheets 讀取「事業單位詳細」
   - 找到該單位的資料列
   - 解析並設置 currentUnitData：
     * name: 單位名稱
     * doctors: 醫生名單（字串）
     * nurses: 護理師名單（字串）
     * others: 其他人員名單（字串）
     * monthlyHours: 12個月的時數配額
   ↓
4. 調用 generateStaffCheckboxes()
   - 從 currentUnitData.doctors 解析醫生
   - 從 currentUnitData.nurses 解析護理師
   - 從 currentUnitData.others 解析其他人員
   - 生成勾選框 HTML
   ↓
5. 調用 setupLocationSelection()
   - 根據分散型設定地點選擇
   ↓
6. 調用 updateHoursInfo()
   - 計算並顯示剩餘時數
```

---

## 🚀 使用說明

### 正常使用流程

```
1. 確保事業單位已正確設定
   → 到「🏢 事業單位」頁籤
   → 編輯或新增單位
   → 填寫：
      - 醫生名單：王醫師, 李醫師
      - 護理師名單：林護理師, 陳護理師
      - 其他人員：張助理
      - 每月時數配額
   → 儲存

2. 新增排班
   → 到「✏️ 排班管理」頁籤
   → 點擊「➕ 新增排班」
   → 選擇日期
   → 選擇事業單位

3. 查看人員列表和時數
   → 人員勾選框自動顯示
   → 剩餘時數自動計算
```

### 查看除錯資訊

```
1. 按 F12 打開開發者工具
2. 切換到「Console」標籤
3. 選擇事業單位
4. 查看詳細日誌：

🏢 事業單位變更：台北診所
📥 開始載入單位詳細資料...
✅ 載入單位詳細資料：{name: "台北診所", ...}
✅ 單位資料載入成功
👥 生成人員列表...
🔄 生成人員勾選框，當前單位資料：{...}
👨‍⚕️ 醫生：["王醫師", "李醫師"]
👩‍⚕️ 護理師：["林護理師", "陳護理師"]
👤 其他人員：["張助理"]
✅ 人員勾選框生成完成
📍 設定地點選擇...
⏱️ 更新時數資訊...
🔢 計算剩餘時數，事業單位：台北診所
📅 計算月份：11
📊 11月配額 - 醫生:160h, 護理師:180h, 其他:80h
✅ 所有欄位更新完成
```

---

## 🧪 測試步驟

### 測試1：驗證人員顯示

```
準備：
1. 確保有至少一個事業單位
2. 該單位有設定人員名單

測試：
1. 到「✏️ 排班管理」
2. 點擊「➕ 新增排班」
3. 選擇該事業單位
4. 查看「人員名單」區域

預期結果：
✅ 顯示人員勾選框
✅ 分為三組：醫師、護理師、其他人員
✅ 每個人員有勾選框
✅ 顯示人數統計（例如：醫師 2）
```

### 測試2：驗證時數顯示

```
準備：
1. 事業單位已設定月度時數

測試：
1. 選擇日期（例如：2025-11-15）
2. 選擇事業單位
3. 查看「事業單位」欄位旁的時數資訊

預期結果：
✅ 顯示：本月剩餘：醫師 Xh / 護理師 Yh / 其他 Zh
✅ 顏色正確（綠/黃/紅）
```

### 測試3：驗證空資料處理

```
測試情境1：單位無人員設定
1. 選擇沒有設定人員的單位
2. 查看人員列表

預期結果：
✅ 顯示：「該單位無人員資料」
✅ 提示：「請到「🏢 事業單位」頁籤設定人員名單」

測試情境2：單位不存在於詳細表
1. 選擇只在簡單列表的單位
2. 查看反應

預期結果：
✅ 顯示警告訊息
✅ 提示檢查事業單位設定
```

---

## 📋 除錯指南

### 問題1：選擇單位後人員列表是空的

**診斷步驟：**
```
1. F12 → Console
2. 選擇事業單位
3. 查看日誌中的人員資料：
   👨‍⚕️ 醫生：[]
   👩‍⚕️ 護理師：[]
   👤 其他人員：[]

如果都是空陣列：
→ 到「🏢 事業單位」頁籤
→ 編輯該單位
→ 確認「醫生名單」、「護理師名單」、「其他人員」有填寫
→ 儲存後重試
```

### 問題2：選擇單位後沒有任何反應

**診斷步驟：**
```
1. F12 → Console
2. 選擇事業單位
3. 查看是否有錯誤訊息

可能的錯誤：
a) ❌ 載入單位資料失敗：currentUnitData 為空
   → 該單位可能不在「事業單位詳細」表中
   → 檢查 Google Sheets

b) 紅色錯誤訊息
   → 檢查網路連線
   → 確認已授權 Google Sheets 權限
   → 重新登入系統
```

### 問題3：時數顯示不正確

**診斷步驟：**
```
1. F12 → Console
2. 選擇日期和單位
3. 查看計算日誌：
   📊 11月配額 - 醫生:?h, 護理師:?h, 其他:?h

如果配額是 0：
→ 到「🏢 事業單位」頁籤
→ 編輯該單位
→ 填寫該月的時數配額
→ 儲存後重試
```

---

## 💡 常見問題

### Q1: 為什麼有些單位顯示人員，有些不顯示？

**A:** 
```
原因：只有在「事業單位詳細」表中完整設定的單位才會顯示

解決：
1. 到「🏢 事業單位」頁籤
2. 確認該單位在列表中
3. 編輯並填寫人員名單
4. 儲存
```

### Q2: 人員名單格式有要求嗎？

**A:**
```
格式要求：
✅ 正確：王醫師, 李醫師, 陳醫師
✅ 正確：王醫師,李醫師,陳醫師（無空格也可以）
❌ 錯誤：王醫師；李醫師（不要用分號）
❌ 錯誤：王醫師  李醫師（不要只用空格）

建議：使用逗號分隔，每個名稱後可加空格
```

### Q3: 可以動態新增人員嗎？

**A:**
```
目前無法在排班頁面直接新增人員

需要：
1. 回到「🏢 事業單位」頁籤
2. 編輯該單位
3. 在人員名單中新增
4. 儲存
5. 回到排班頁面
6. 重新選擇該單位
```

### Q4: 為什麼時數一直顯示「請先選擇日期」？

**A:**
```
原因：沒有選擇日期，或日期在單位之後選擇

解決：
1. 選擇日期
2. 選擇事業單位
或
1. 選擇事業單位
2. 選擇日期（會自動重新計算）
```

---

## 🎨 顯示效果

### 正常顯示範例

**人員勾選框：**
```
┌─────────────────────────────┐
│ 👨‍⚕️ 醫師 [2]                  │
│ ☐ 王醫師                     │
│ ☐ 李醫師                     │
├─────────────────────────────┤
│ 👩‍⚕️ 護理師 [2]                │
│ ☐ 林護理師                   │
│ ☐ 陳護理師                   │
├─────────────────────────────┤
│ 👤 其他人員 [1]               │
│ ☐ 張助理                     │
└─────────────────────────────┘
```

**時數顯示：**
```
事業單位 * [本月剩餘：醫師 156h / 護理師 177h / 其他 80h]
         [選擇事業單位 ▼] [🔄]
```

**空資料顯示：**
```
該單位無人員資料
請到「🏢 事業單位」頁籤設定人員名單
```

---

## 🔄 資料結構說明

### currentUnitData 物件結構

```javascript
currentUnitData = {
    name: "台北診所",
    isDistributed: "否",
    address: "台北市信義區",
    branches: [],
    doctors: "王醫師, 李醫師",      // 醫生名單（字串）
    nurses: "林護理師, 陳護理師",   // 護理師名單（字串）
    others: "張助理",               // 其他人員名單（字串）
    monthlyHours: {
        1: {doc: "160", nurse: "180", other: "80"},
        2: {doc: "160", nurse: "180", other: "80"},
        // ... 12個月
    }
}
```

### 人員解析過程

```javascript
// 1. 從 currentUnitData 讀取字串
doctors: "王醫師, 李醫師"

// 2. 分割為陣列
.split(',')  → ["王醫師", " 李醫師"]

// 3. 去除空白
.map(s => s.trim())  → ["王醫師", "李醫師"]

// 4. 過濾空項目
.filter(s => s)  → ["王醫師", "李醫師"]

// 5. 生成勾選框
→ ☐ 王醫師
→ ☐ 李醫師
```

---

## 📊 版本資訊

**v6.0.4 改進：**

1. ✅ **修正人員顯示邏輯**
   - 從正確的資料欄位讀取
   - 支援分開的醫生/護理師/其他名單

2. ✅ **增強錯誤處理**
   - 完整的 try-catch
   - 友善的錯誤提示
   - 詳細的控制台日誌

3. ✅ **改進資料驗證**
   - 檢查 currentUnitData 是否存在
   - 驗證各個欄位的完整性
   - 提供明確的修正建議

4. ✅ **優化使用體驗**
   - 空資料時顯示提示
   - 每個步驟有狀態反饋
   - 錯誤訊息清楚明確

---

## ✅ 檢查清單

修復後請確認：

```
□ 重新整理網頁（Ctrl+Shift+R）
□ 事業單位已設定人員名單
□ 選擇單位後人員勾選框顯示
□ 人員按醫師/護理師/其他分組
□ 剩餘時數正確顯示
□ 顏色正確變化（綠/黃/紅）
□ 控制台有詳細日誌
□ 沒有紅色錯誤訊息
```

---

## 📚 相關文檔

| 文檔 | 用途 |
|------|------|
| `人員選擇顯示修復.md` | 本文件 |
| `時數顯示修復說明.md` | 時數計算功能 |
| `事業單位時數問題修復.md` | 時數載入修復 |
| `PHASE2_COMPLETION.md` | 階段2完整功能 |

---

**🎉 人員選擇和時數顯示功能已完全修復！**

**版本**：v6.0.4  
**狀態**：✅ 已修復並增強  
**最後更新**：2025-11-03

**立即測試：**
1. Ctrl+Shift+R 重新整理
2. 到排班管理
3. 選擇事業單位
4. 查看人員列表和剩餘時數！


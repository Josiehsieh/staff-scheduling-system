# 🔧 時數顯示修復說明

**版本**：v6.0.3  
**更新日期**：2025-11-03  
**問題**：排班時選擇事業單位所顯示的醫護時數與輸入時的不符合

---

## ✅ 已修復的問題

### 問題描述

**現象：**
- 在排班管理中選擇事業單位時
- 顯示的「本月剩餘時數」總是固定為：醫師160h / 護理師180h / 其他80h
- 與事業單位設定中實際輸入的月度時數不符合
- 無法正確反映已排班的使用情況

**原因：**
- `calculateRemainingHours()` 函數只返回固定的示例數據
- 沒有實際從 Google Sheets 讀取事業單位的月度配額
- 沒有計算當月已使用的時數

---

## 🔧 修復內容

### 1. 實現完整的時數計算邏輯

**現在會：**
1. ✅ 讀取選擇的日期，判斷是哪個月份
2. ✅ 從事業單位詳細資料中讀取該月的配額時數
3. ✅ 計算該單位當月已排班的時數
4. ✅ 根據人員名單判斷是醫生、護理師還是其他人員
5. ✅ 計算並顯示實際的剩餘時數

### 2. 改進時數顯示

**新的顯示特色：**
- ✅ 根據剩餘時數顯示不同顏色
  - 綠色：剩餘 > 20小時（充足）
  - 黃色：0 < 剩餘 ≤ 20小時（注意）
  - 紅色：剩餘 = 0小時（已用完）
- ✅ 更清晰的格式：`醫師 160h / 護理師 180h / 其他 80h`
- ✅ 在選擇日期後自動更新顯示

### 3. 添加日期選擇觸發

**改進：**
- ✅ 選擇日期後自動更新時數顯示
- ✅ 添加提示文字：「選擇日期後會顯示該月剩餘時數」

---

## 📊 計算邏輯說明

### 時數計算公式

```
剩餘時數 = 月度配額 - 當月已用時數

其中：
- 月度配額：從「事業單位詳細」表中讀取該月的設定時數
- 當月已用時數：統計該單位當月所有排班的時數總和
```

### 人員類型判斷

系統會根據事業單位設定的人員名單來判斷：

```javascript
// 從事業單位詳細資料中
doctors:  "王醫師, 李醫師"
nurses:   "林護理師, 陳護理師"
others:   "張助理, 劉助理"

// 排班時選擇的人員
shift.staff: "王醫師, 林護理師"

// 判斷邏輯
王醫師 → 在 doctors 名單中 → 累計到醫生時數
林護理師 → 在 nurses 名單中 → 累計到護理師時數
```

### 時數累計方式

```
例如：
排班日期：2025-11-15
開始時間：09:00
結束時間：11:00
人員：王醫師, 李醫師

計算：
時數 = 11:00 - 09:00 = 2 小時
王醫師：2小時（醫生類別）
李醫師：2小時（醫生類別）

該排班消耗：醫生 4小時
```

---

## 🎨 顯示效果

### 剩餘時數顏色指示

| 剩餘時數 | 顏色 | 說明 |
|---------|------|------|
| > 20小時 | 🟢 綠色 | 充足，可以繼續排班 |
| 1-20小時 | 🟡 黃色 | 注意，剩餘時數較少 |
| 0小時 | 🔴 紅色 | 已用完，建議不要再排班 |

### 顯示範例

**充足時：**
```
本月剩餘：醫師 160h / 護理師 180h / 其他 80h
         （綠色）  （綠色）   （綠色）
```

**注意時：**
```
本月剩餘：醫師 15h / 護理師 180h / 其他 5h
         （黃色） （綠色）   （黃色）
```

**用完時：**
```
本月剩餘：醫師 0h / 護理師 180h / 其他 0h
         （紅色）（綠色）   （紅色）
```

---

## 🚀 使用說明

### 查看剩餘時數的步驟

```
1. 到「✏️ 排班管理」頁籤
2. 點擊「➕ 新增排班」
3. 選擇日期（例如：2025-11-15）
4. 選擇事業單位（例如：台北診所）
5. 在「事業單位」欄位下方會自動顯示：
   
   本月剩餘：醫師 160h / 護理師 180h / 其他 80h
   
6. 顏色會根據剩餘時數自動變化
```

### 如何查看詳細計算過程

```
1. 按 F12 打開開發者工具
2. 切換到「Console」標籤
3. 選擇事業單位和日期
4. 查看詳細的計算日誌：

   🔢 計算剩餘時數，事業單位：台北診所
   📅 計算月份：11
   📊 11月配額 - 醫生:160h, 護理師:180h, 其他:80h
   ⏱️ 11月已用 - 醫生:40h, 護理師:60h, 其他:20h
   ✅ 11月剩餘 - 醫生:120h, 護理師:120h, 其他:60h
```

---

## 🧪 測試步驟

### 測試1：驗證配額顯示

```
準備工作：
1. 到「🏢 事業單位」頁籤
2. 編輯某個單位
3. 設定11月時數：醫生=160, 護理師=180, 其他=80
4. 儲存

測試：
1. 到「✏️ 排班管理」
2. 選擇日期：2025-11-15
3. 選擇該事業單位
4. 查看顯示是否為：
   本月剩餘：醫師 160h / 護理師 180h / 其他 80h

預期結果：✅ 顯示正確
```

### 測試2：驗證已用時數計算

```
準備工作：
1. 先新增一筆排班：
   日期：2025-11-10
   時間：09:00 - 11:00 (2小時)
   單位：台北診所
   人員：王醫師, 李醫師（假設都是醫生）

測試：
1. 新增另一筆排班
2. 選擇日期：2025-11-15（同月）
3. 選擇單位：台北診所
4. 查看顯示

預期結果：
本月剩餘：醫師 156h / 護理師 180h / 其他 80h
         （160 - 4 = 156）
         （2人 × 2小時 = 4小時）
```

### 測試3：驗證不同月份

```
測試：
1. 選擇日期：2025-11-15
2. 選擇單位：台北診所
3. 記錄顯示的時數

4. 改選日期：2025-12-15
5. 保持同一單位
6. 查看時數是否改變

預期結果：
✅ 不同月份顯示不同的配額和已用時數
```

### 測試4：驗證顏色變化

```
準備工作：
設定某單位某月配額很低（例如：醫生=20h）

測試：
1. 新增多筆排班消耗時數
2. 觀察顏色變化：
   - 初始：綠色（剩餘 20h）
   - 用掉一些：黃色（剩餘 15h）
   - 用完：紅色（剩餘 0h）

預期結果：✅ 顏色正確變化
```

---

## 📋 除錯指南

### 時數顯示不正確的診斷

**步驟1：檢查配額設定**
```
1. F12 → Console
2. 選擇事業單位和日期
3. 查看日誌：
   📊 11月配額 - 醫生:?h, 護理師:?h, 其他:?h
   
如果顯示 0h：
→ 到事業單位頁籤檢查該月是否有設定時數
```

**步驟2：檢查人員名單**
```
1. 確認事業單位的人員名單設定正確
2. 醫生名單：王醫師, 李醫師
3. 護理師名單：林護理師, 陳護理師
4. 排班時選擇的人員必須在這些名單中
```

**步驟3：檢查已用時數計算**
```
1. 查看日誌：
   ⏱️ 11月已用 - 醫生:?h, 護理師:?h, 其他:?h
   
2. 手動計算該月所有排班的總時數
3. 對比是否一致

如果不一致：
→ 檢查人員名單設定
→ 檢查排班記錄的單位名稱是否完全一致
```

---

## 💡 注意事項

### 1. 人員名單必須正確設定

```
⚠️ 重要：
排班時選擇的人員名稱必須與事業單位設定中的名單完全一致

正確範例：
事業單位設定：王醫師, 李醫師
排班選擇：王醫師 ✓

錯誤範例：
事業單位設定：王醫師
排班選擇：王醫生 ✗（名稱不一致）
```

### 2. 配額為0的情況

```
如果某月配額設定為 0：
- 系統會正常顯示：剩餘 0h
- 顏色為紅色
- 表示該月沒有配額，不應排班
```

### 3. 跨月排班

```
系統按月份分別計算：
- 2025-11月的排班 → 計入11月配額
- 2025-12月的排班 → 計入12月配額
- 互不影響
```

### 4. 單位名稱一致性

```
⚠️ 系統根據單位名稱匹配：
- 事業單位名稱：台北診所
- 排班的單位：台北診所 ✓

如果名稱不一致（多空格、標點等）：
- 系統無法正確匹配
- 會導致已用時數計算錯誤
```

---

## 🔄 版本資訊

**v6.0.3 改進：**

1. ✅ **完整的時數計算邏輯**
   - 讀取實際的月度配額
   - 計算當月已用時數
   - 顯示真實的剩餘時數

2. ✅ **智能顏色提示**
   - 綠色：充足（> 20h）
   - 黃色：注意（1-20h）
   - 紅色：已用完（0h）

3. ✅ **自動更新機制**
   - 選擇單位時更新
   - 選擇日期時更新
   - 即時反映最新狀態

4. ✅ **詳細除錯日誌**
   - 顯示配額、已用、剩餘
   - 方便排查問題

---

## 📚 相關文檔

| 文檔 | 用途 |
|------|------|
| `時數顯示修復說明.md` | 本文件 |
| `事業單位時數問題修復.md` | 時數載入修復 |
| `PHASE2_COMPLETION.md` | 階段2功能說明 |

---

## ✅ 檢查清單

使用前請確認：

```
□ 事業單位已設定月度時數
□ 事業單位已設定人員名單（醫生、護理師、其他）
□ 排班時選擇的人員名稱與設定一致
□ 已重新整理網頁（Ctrl+Shift+R）
□ 選擇日期後時數有正確顯示
□ 顏色根據剩餘時數正確變化
```

---

## 📊 完整範例

### 範例情境

**事業單位設定：**
```
單位名稱：台北診所
11月配額：
- 醫生：160小時
- 護理師：180小時
- 其他：80小時

人員名單：
- 醫生：王醫師, 李醫師
- 護理師：林護理師, 陳護理師
- 其他：張助理
```

**已有排班：**
```
排班1：
日期：2025-11-10
時間：09:00 - 11:00 (2小時)
人員：王醫師, 李醫師
消耗：醫生 4小時

排班2：
日期：2025-11-12
時間：14:00 - 17:00 (3小時)
人員：林護理師
消耗：護理師 3小時
```

**新增排班時顯示：**
```
選擇日期：2025-11-15
選擇單位：台北診所

顯示：
本月剩餘：醫師 156h / 護理師 177h / 其他 80h
         (綠色)   (綠色)    (綠色)

計算：
醫師：160 - 4 = 156
護理師：180 - 3 = 177
其他：80 - 0 = 80
```

---

**🎉 時數顯示功能已完全修復！現在會正確顯示實際的剩餘時數！**

**版本**：v6.0.3  
**狀態**：✅ 已修復並增強  
**最後更新**：2025-11-03


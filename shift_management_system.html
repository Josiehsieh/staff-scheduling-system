<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«ç™‚æ’ç­ç®¡ç†ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            min-height: calc(100vh - 200px);
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 10px;
            margin-top: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .color-option:hover {
            border-color: #333;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .color-option.selected {
            border-color: #333;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .color-option.used {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        .color-option.used:hover {
            transform: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .schedule-container {
            display: flex;
            gap: 20px;
            height: 70vh;
            width: 100%;
        }

        .calendar-section {
            flex: 2;
            background: white;
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            overflow-x: auto;
            min-width: 800px;
        }

        .dashboard-section {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 8px 16px;
            border: none;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            min-width: 700px;
        }

        .calendar-day {
            background: white;
            padding: 15px 10px;
            min-height: 100px;
            min-width: 100px;
            cursor: pointer;
            transition: background 0.3s ease;
            position: relative;
        }

        .calendar-day:hover {
            background: #f5f5f5;
        }

        .calendar-day.selected {
            background: #e3f2fd;
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .shift-item {
            font-size: 11px;
            background: #667eea;
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            margin: 2px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            line-height: 1.2;
        }

        .dashboard-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .units-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .unit-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .unit-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .unit-item.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .unit-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .unit-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .daily-shifts {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1200px) {
            .schedule-container {
                flex-direction: column;
                height: auto;
            }
            
            .calendar-section {
                min-width: auto;
                overflow-x: auto;
            }
            
            .calendar-grid {
                min-width: 600px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .calendar-grid {
                min-width: 500px;
            }
            
            .calendar-day {
                min-width: 80px;
                padding: 10px 5px;
            }
        }

        .shift-detail {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .shift-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 15px;
        }

        .selected-unit-info {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn-success {
            background: #51cf66;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            border-color: #667eea;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .monthly-hours {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .month-input {
            text-align: center;
        }

        .month-input label {
            display: block;
            font-size: 14px;
            margin-bottom: 5px;
            color: #666;
        }

        .addresses-container {
            margin-top: 15px;
        }

        .address-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .address-item input {
            flex: 1;
        }

        .address-item button {
            padding: 8px 12px;
            border: none;
            background: #ff6b6b;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        /* æ‹–æ›³æ¨£å¼ */
        .calendar-day-dragover {
            background: #e3f2fd !important;
            outline: 2px dashed #667eea;
        }
        
        .unit-item.dragging {
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .schedule-container {
                flex-direction: column;
                height: auto;
            }
            
            .calendar-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>é†«ç™‚æ’ç­ç®¡ç†ç³»çµ±</h1>
            <p>é«˜æ•ˆç®¡ç†é†«è­·äººå“¡æ’ç­ï¼Œå„ªåŒ–è³‡æºé…ç½®</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('unit')">äº‹æ¥­å–®ä½ç®¡ç†</button>
            <button class="nav-tab" onclick="switchTab('schedule')">æ’ç­ç®¡ç†</button>
        </div>

        <!-- äº‹æ¥­å–®ä½ç®¡ç†é é¢ -->
        <div id="unit-tab" class="tab-content active">
            <h2>äº‹æ¥­å–®ä½è¨­å®š</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>äº‹æ¥­å–®ä½åç¨±</label>
                    <input type="text" id="unitName" placeholder="è«‹è¼¸å…¥äº‹æ¥­å–®ä½åç¨±">
                </div>
                
                <div class="form-group" style="display: flex; align-items: center; gap: 20px;">
                    <div style="flex:1;">
                        <label>æ˜¯å¦ç‚ºåˆ†æ•£å‹</label>
                        <div id="isDistributedBtns" style="display:flex;gap:10px;">
                            <button type="button" class="btn btn-small" id="btnDistributedNo" onclick="setDistributed('å¦')">å¦</button>
                            <button type="button" class="btn btn-small" id="btnDistributedYes" onclick="setDistributed('æ˜¯')">æ˜¯</button>
                        </div>
                        <input type="hidden" id="isDistributed" value="å¦">
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label>æ˜¯å¦æœ‰è£œåŠ©</label>
                        <input type="checkbox" id="subsidyYes" onclick="setSubsidy('æ˜¯')"><label for="subsidyYes">æ˜¯</label>
                        <input type="checkbox" id="subsidyNo" onclick="setSubsidy('å¦')"><label for="subsidyNo">å¦</label>
                        <input type="hidden" id="hasSubsidy" value="å¦">
                    </div>
                </div>
            </div>

            <!-- åœ°å€å€å¡Šï¼ˆå–®ä¸€æˆ–å¤šåˆ†é»ï¼‰ -->
            <div id="addressesSection" class="form-group" style="display: none;">
                <label id="addressLabel">äº‹æ¥­å–®ä½åœ°å€</label>
                <div id="singleAddressContainer" style="display:none;">
                    <input type="text" id="singleAddress" placeholder="è«‹è¼¸å…¥åœ°å€">
                </div>
                <div id="branchesContainer" class="addresses-container" style="display:none;"></div>
                <button class="btn btn-primary" id="addBranchBtn" style="display:none;" onclick="addBranch()">æ–°å¢åˆ†é»</button>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>è­·ç†å¸«å§“åï¼ˆæ¯è¡Œä¸€å€‹ï¼‰</label>
                    <textarea id="nurseNames" placeholder="è«‹è¼¸å…¥è­·ç†å¸«å§“åï¼Œæ¯è¡Œä¸€å€‹"></textarea>
                </div>
                
                <div class="form-group">
                    <label>é†«ç”Ÿå§“åï¼ˆæ¯è¡Œä¸€å€‹ï¼‰</label>
                    <textarea id="doctorNames" placeholder="è«‹è¼¸å…¥é†«ç”Ÿå§“åï¼Œæ¯è¡Œä¸€å€‹"></textarea>
                </div>
            </div>

            <div class="monthly-hours">
                <div class="month-input">
                    <label>ä¸€æœˆ</label>
                    <input type="number" placeholder="é†«ç”Ÿæ™‚æ•¸" id="docHours1">
                    <input type="number" placeholder="è­·ç†å¸«æ™‚æ•¸" id="nurseHours1">
                </div>
                <div class="month-input">
                    <label>äºŒæœˆ</label>
                    <input type="number" placeholder="é†«ç”Ÿæ™‚æ•¸" id="docHours2">
                    <input type="number" placeholder="è­·ç†å¸«æ™‚æ•¸" id="nurseHours2">
                </div>
                <div class="month-input">
                    <label>ä¸‰æœˆ</label>
                    <input type="number" placeholder="é†«ç”Ÿæ™‚æ•¸" id="docHours3">
                    <input type="number" placeholder="è­·ç†å¸«æ™‚æ•¸" id="nurseHours3">
                </div>
                <div class="month-input">
                    <label>å››æœˆ</label>
                    <input type="number" placeholder="é†«ç”Ÿæ™‚æ•¸" id="docHours4">
                    <input type="number" placeholder="è­·ç†å¸«æ™‚æ•¸" id="nurseHours4">
                </div>
                <div class="month-input">
                    <label>äº”æœˆ</label>
                    <input type="number" placeholder="é†«ç”Ÿæ™‚æ•¸" id="docHours5">
                    <input type="number" placeholder="è­·ç†å¸«æ™‚æ•¸" id="nurseHours5">
                </div>
                <div class="month-input">
                    <label>å…­æœˆ</label>
                    <input type="number" placeholder="é†«ç”Ÿæ™‚æ•¸" id="docHours6">
                    <input type="number" placeholder="è­·ç†å¸«æ™‚æ•¸" id="nurseHours6">
                </div>
                <div class="month-input">
                    <label>ä¸ƒæœˆ</label>
                    <input type="number" placeholder="é†«ç”Ÿæ™‚æ•¸" id="docHours7">
                    <input type="number" placeholder="è­·ç†å¸«æ™‚æ•¸" id="nurseHours7">
                </div>
                <div class="month-input">
                    <label>å…«æœˆ</label>
                    <input type="number" placeholder="é†«ç”Ÿæ™‚æ•¸" id="docHours8">
                    <input type="number" placeholder="è­·ç†å¸«æ™‚æ•¸" id="nurseHours8">
                </div>
                <div class="month-input">
                    <label>ä¹æœˆ</label>
                    <input type="number" placeholder="é†«ç”Ÿæ™‚æ•¸" id="docHours9">
                    <input type="number" placeholder="è­·ç†å¸«æ™‚æ•¸" id="nurseHours9">
                </div>
                <div class="month-input">
                    <label>åæœˆ</label>
                    <input type="number" placeholder="é†«ç”Ÿæ™‚æ•¸" id="docHours10">
                    <input type="number" placeholder="è­·ç†å¸«æ™‚æ•¸" id="nurseHours10">
                </div>
                <div class="month-input">
                    <label>åä¸€æœˆ</label>
                    <input type="number" placeholder="é†«ç”Ÿæ™‚æ•¸" id="docHours11">
                    <input type="number" placeholder="è­·ç†å¸«æ™‚æ•¸" id="nurseHours11">
                </div>
                <div class="month-input">
                    <label>åäºŒæœˆ</label>
                    <input type="number" placeholder="é†«ç”Ÿæ™‚æ•¸" id="docHours12">
                    <input type="number" placeholder="è­·ç†å¸«æ™‚æ•¸" id="nurseHours12">
                </div>
            </div>

            <!-- å°‡é¡è‰²ä¸»é¡Œé¸æ“‡ç§»åˆ°é€™è£¡ -->
            <div class="form-group">
                <label>é¸æ“‡é¡è‰²ä¸»é¡Œ</label>
                <div class="color-palette" id="colorPalette"></div>
                <button type="button" class="btn btn-secondary" onclick="initColorPalette()" style="margin-top: 10px;">
                    ğŸ”„ é‡æ–°è¼‰å…¥é¡è‰²é¸é …
                </button>
            </div>

            <!-- æ’ç­è¦å‰‡è¨­å®š -->
            <div class="form-group">
                <label>è¨­å®šæ’ç­è¦å‰‡</label>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 10px;">
                    <h4 style="margin-bottom: 15px; color: #333;">ç¦æ­¢æ’ç­çš„æ˜ŸæœŸ</h4>
                    <div class="checkbox-group" id="weekdayRestrictions">
                        <div class="checkbox-item">
                            <input type="checkbox" id="restrict_sunday" value="0">
                            <label for="restrict_sunday">æ˜ŸæœŸæ—¥</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="restrict_monday" value="1">
                            <label for="restrict_monday">æ˜ŸæœŸä¸€</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="restrict_tuesday" value="2">
                            <label for="restrict_tuesday">æ˜ŸæœŸäºŒ</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="restrict_wednesday" value="3">
                            <label for="restrict_wednesday">æ˜ŸæœŸä¸‰</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="restrict_thursday" value="4">
                            <label for="restrict_thursday">æ˜ŸæœŸå››</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="restrict_friday" value="5">
                            <label for="restrict_friday">æ˜ŸæœŸäº”</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="restrict_saturday" value="6">
                            <label for="restrict_saturday">æ˜ŸæœŸå…­</label>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <small style="color: #1976d2;">
                            <strong>èªªæ˜ï¼š</strong>å‹¾é¸çš„æ˜ŸæœŸå°‡è¢«ç¦æ­¢æ’ç­ã€‚ç³»çµ±æœƒåœ¨æ’ç­æ™‚è‡ªå‹•æª¢æŸ¥ä¸¦æé†’é•åè¦å‰‡çš„æ’ç­å®‰æ’ã€‚
                        </small>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-info" onclick="clearUnitForm()" style="margin-right: 10px;">æ–°å¢äº‹æ¥­å–®ä½</button>
                <button class="btn btn-primary" onclick="saveUnit()">å„²å­˜äº‹æ¥­å–®ä½</button>
                <button class="btn btn-success" onclick="exportToExcel()">ğŸ“Š åŒ¯å‡ºæ’ç­Excel</button>
            </div>

            <!-- äº‹æ¥­å–®ä½å¹´åº¦æ™‚æ•¸åˆ—è¡¨ -->
            <div id="unitYearlyList" style="margin-top:40px;">
                <h3 style="text-align:left;">å·²å»ºæª”äº‹æ¥­å–®ä½å¹´åº¦æ™‚æ•¸ç¸½è¦½</h3>
                <table style="width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 2px 8px #eee;">
                    <thead style="background:#f0f0f0;">
                        <tr>
                            <th style="padding:10px;">å–®ä½åç¨±</th>
                            <th>è­·ç†å¸«å¹´åº¦ç¸½æ™‚æ•¸</th>
                            <th>é†«å¸«å¹´åº¦ç¸½æ™‚æ•¸</th>
                            <th>è­·ç†å¸«å‰©é¤˜å¹´åº¦æ™‚æ•¸</th>
                            <th>é†«å¸«å‰©é¤˜å¹´åº¦æ™‚æ•¸</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="unitYearlyTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- æ’ç­ç®¡ç†é é¢ -->
        <div id="schedule-tab" class="tab-content">
            <div class="schedule-container">
                <div class="calendar-section">
                    <div class="calendar-header">
                        <h3 id="currentMonthYear">2025å¹´7æœˆ</h3>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <button class="btn btn-small" onclick="changeMonth(-1)">ä¸Šå€‹æœˆ</button>
                            <button class="btn btn-small" onclick="changeMonth(1)">ä¸‹å€‹æœˆ</button>
                            <button class="btn btn-success" onclick="exportToExcel()" style="margin-left: 20px;">ğŸ“Š åŒ¯å‡ºExcel</button>
                        </div>
                        <div class="view-toggle">
                            <button class="view-btn active" onclick="switchView('month')">æœˆ</button>
                            <button class="view-btn" onclick="switchView('week')">é€±</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>

                <div class="dashboard-section">
                    <h3>äº‹æ¥­å–®ä½åˆ—è¡¨</h3>
                    
                    <div id="unitsList" class="units-list">
                        <!-- äº‹æ¥­å–®ä½åˆ—è¡¨å°‡å‹•æ…‹ç”Ÿæˆ -->
                    </div>

                    <div class="selected-unit-info" id="selectedUnitInfo" style="display: none;">
                        <h4 id="selectedUnitName">é¸ä¸­çš„äº‹æ¥­å–®ä½</h4>
                        
                        <div class="dashboard-card">
                            <h4>é†«ç”Ÿå‰©é¤˜æ™‚æ•¸</h4>
                            <div class="progress-bar">
                                <div class="progress-fill" id="doctorProgress" style="width: 60%"></div>
                            </div>
                            <p id="doctorHoursText">å‰©é¤˜: 180å°æ™‚ / ç¸½è¨ˆ: 300å°æ™‚</p>
                        </div>

                        <div class="dashboard-card">
                            <h4>è­·ç†å¸«å‰©é¤˜æ™‚æ•¸</h4>
                            <div class="progress-bar">
                                <div class="progress-fill" id="nurseProgress" style="width: 55%"></div>
                            </div>
                            <p id="nurseHoursText">å‰©é¤˜: 220å°æ™‚ / ç¸½è¨ˆ: 400å°æ™‚</p>
                        </div>

                        <button class="btn btn-primary" onclick="openShiftModal()" style="width: 100%; margin-top: 20px;">
                            æ–°å¢æ’ç­
                        </button>
                    </div>

                    <div class="daily-shifts" id="dailyShifts" style="display: none;">
                        <h4 id="selectedDateTitle">é¸å®šæ—¥æœŸæ’ç­</h4>
                        <div id="shiftsOnDate"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢æ’ç­æ¨¡æ…‹æ¡† -->
    <div id="shiftModal" class="modal">
        <div class="modal-content">
            <h3>æ–°å¢æ’ç­</h3>
            
            <div class="form-group">
                <label>äº‹æ¥­å–®ä½</label>
                <input type="text" id="selectedUnitDisplay" readonly style="background: #f0f0f0;">
            </div>
            
            <div class="form-group" id="branchSelectGroup" style="display:none;">
                <label>åˆ†é»</label>
                <select id="branchSelect"></select>
            </div>
            <div class="form-group">
                <label>é¸æ“‡æ—¥æœŸ</label>
                <input type="date" id="shiftDate">
            </div>
            
            <div class="form-group">
                <label>é–‹å§‹æ™‚é–“</label>
                <input type="time" id="startTime" onchange="calculateHours()">
            </div>
            
            <div class="form-group">
                <label>çµæŸæ™‚é–“</label>
                <input type="time" id="endTime" onchange="calculateHours()">
            </div>

            <div class="form-group">
                <label>éœ€æ‰£é™¤æ™‚æ•¸</label>
                <input type="number" id="deductHours" step="0.5" min="0" readonly style="background: #f0f0f0;">
                <small style="color: #666;">ç³»çµ±è‡ªå‹•è¨ˆç®—</small>
            </div>

            <div class="form-group">
                <label>é¸æ“‡äººå“¡</label>
                <div class="checkbox-group" id="staffCheckboxes"></div>
            </div>

            <!-- é‡è¤‡æ’ç­è¨­å®š -->
            <div class="form-group">
                <label>é‡è¤‡æ’ç­</label>
                <div style="margin-bottom: 10px;">
                    <input type="checkbox" id="enableRepeat" onchange="toggleRepeatOptions()">
                    <label for="enableRepeat" style="margin-left: 5px;">å•Ÿç”¨é‡è¤‡æ’ç­</label>
                </div>
                
                <div id="repeatOptions" style="display: none; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <div style="margin-bottom: 10px;">
                        <label>é‡è¤‡é »ç‡ï¼š</label>
                        <select id="repeatType" style="margin-left: 10px;">
                            <option value="daily">æ¯æ—¥</option>
                            <option value="weekly">æ¯é€±</option>
                            <option value="monthly">æ¯æœˆ</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <label>é‡è¤‡æ¬¡æ•¸ï¼š</label>
                        <input type="number" id="repeatCount" min="1" max="52" value="1" style="width: 60px; margin-left: 10px;">
                        <small style="color: #666; margin-left: 5px;">æ¬¡</small>
                    </div>
                    
                    <div id="weeklyOptions" style="display: none; margin-bottom: 10px;">
                        <label>é¸æ“‡æ˜ŸæœŸï¼š</label>
                        <div style="margin-top: 5px;">
                            <input type="checkbox" id="weekday0" value="0"><label for="weekday0" style="margin-left: 5px; margin-right: 10px;">æ—¥</label>
                            <input type="checkbox" id="weekday1" value="1"><label for="weekday1" style="margin-left: 5px; margin-right: 10px;">ä¸€</label>
                            <input type="checkbox" id="weekday2" value="2"><label for="weekday2" style="margin-left: 5px; margin-right: 10px;">äºŒ</label>
                            <input type="checkbox" id="weekday3" value="3"><label for="weekday3" style="margin-left: 5px; margin-right: 10px;">ä¸‰</label>
                            <input type="checkbox" id="weekday4" value="4"><label for="weekday4" style="margin-left: 5px; margin-right: 10px;">å››</label>
                            <input type="checkbox" id="weekday5" value="5"><label for="weekday5" style="margin-left: 5px; margin-right: 10px;">äº”</label>
                            <input type="checkbox" id="weekday6" value="6"><label for="weekday6" style="margin-left: 5px; margin-right: 10px;">å…­</label>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveShift()">å„²å­˜æ’ç­</button>
                <button class="btn btn-danger" onclick="closeShiftModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        // 30ç¨®é¡è‰²é¸é … - å®Œå…¨ç„¡é‡è¤‡
        const colors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
            '#DDA0DD', '#98D8C8', '#FDCB6E', '#6C5CE7', '#A29BFE',
            '#FD79A8', '#00B894', '#00CEC9', '#55A3FF', '#FF7675',
            '#74B9FF', '#81ECEC', '#E17055', '#E84393', '#FF9FF3',
            '#FECA57', '#48DB71', '#FF9F43', '#54A0FF', '#5F27CD',
            '#00D2D3', '#FF6348', '#2ED573', '#1E90FF', '#FFA502'
        ];

        // Supabase åˆå§‹åŒ–
        const SUPABASE_URL = 'https://litnrtwcihcvpxpfufeg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxpdG5ydHdjaWhjdnB4cGZ1ZmVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1Mzc3NTMsImV4cCI6MjA2OTExMzc1M30.NmnxXnbo1LD-BVBoxUxeFCNVHyUZaGtSCDGdXtVNLfY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // å…¨åŸŸè®Šæ•¸
        let currentDate = new Date();
        let currentView = 'month';
        let shifts = [];
        let units = [];
        let selectedUnit = null;
        let selectedDate = null;
        let editingShift = null;

        // è®€å–äº‹æ¥­å–®ä½èˆ‡åˆ†é»è³‡æ–™
        async function loadUnitsFromSupabase() {
            try {
                const { data, error } = await supabase.from('v_units_complete').select('*');
                if (error) {
                    console.error('è¼‰å…¥äº‹æ¥­å–®ä½å¤±æ•—ï¼š', error);
                    alert('è¼‰å…¥äº‹æ¥­å–®ä½å¤±æ•—ï¼š' + error.message);
                    return;
                }
                units = data || [];
                updateUnitsList();
                updateUnitYearlyList();
                
                // é‡æ–°åˆå§‹åŒ–é¡è‰²é¸æ“‡å™¨ä»¥åæ˜ æœ€æ–°çš„å·²ä½¿ç”¨é¡è‰²
                initColorPalette();
            } catch (err) {
                console.error('è¼‰å…¥äº‹æ¥­å–®ä½ç•°å¸¸ï¼š', err);
                alert('è¼‰å…¥äº‹æ¥­å–®ä½ç•°å¸¸ï¼š' + err.message);
            }
        }

        // è®€å–æ’ç­è³‡æ–™
        async function loadShiftsFromSupabase() {
            try {
                const { data, error } = await supabase.from('v_shifts_detail').select('*');
                if (error) {
                    console.error('è¼‰å…¥æ’ç­è³‡æ–™å¤±æ•—ï¼š', error);
                    alert('è¼‰å…¥æ’ç­è³‡æ–™å¤±æ•—ï¼š' + error.message);
                    return;
                }
                shifts = data || [];
                generateCalendar();
            } catch (err) {
                console.error('è¼‰å…¥æ’ç­è³‡æ–™ç•°å¸¸ï¼š', err);
                alert('è¼‰å…¥æ’ç­è³‡æ–™ç•°å¸¸ï¼š' + err.message);
            }
        }



        // å·¥å…·å‡½æ•¸
        function formatDateLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatTimeHHMM(timeString) {
            if (!timeString) return '';
            // å¦‚æœæ™‚é–“æ ¼å¼æ˜¯ HH:MM:SSï¼Œåªå–å‰5å€‹å­—ç¬¦ (HH:MM)
            return timeString.substring(0, 5);
        }

        function getWeekdayNames(weekdayNumbers) {
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            return weekdayNumbers.map(num => `æ˜ŸæœŸ${weekdays[num]}`).join('ã€');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOMè¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            
            // å»¶é²ä¸€é»æ™‚é–“ç¢ºä¿æ‰€æœ‰å…ƒç´ éƒ½è¼‰å…¥å®Œæˆ
            setTimeout(() => {
                initColorPalette();
            }, 100);
            
            generateCalendar();
            await loadUnitsFromSupabase();
            await loadShiftsFromSupabase();
            setDistributed('å¦');
            setSubsidy('å¦');
            
            // æ–°å¢èµ·å§‹æ™‚é–“è‡ªå‹•+2å°æ™‚
            document.getElementById('startTime').addEventListener('input', function() {
                const start = this.value;
                if (start) {
                    const endInput = document.getElementById('endTime');
                    if (!endInput.value) {
                        let [h, m] = start.split(':').map(Number);
                        h = (h + 2) % 24;
                        const endStr = h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0');
                        endInput.value = endStr;
                        calculateHours();
                    }
                }
            });
        });

        function initColorPalette() {
            console.log('é–‹å§‹åˆå§‹åŒ–é¡è‰²é¸æ“‡å™¨...');
            const palette = document.getElementById('colorPalette');
            if (!palette) {
                console.error('æ‰¾ä¸åˆ° colorPalette å…ƒç´ ');
                return;
            }
            
            console.log('æ‰¾åˆ° colorPalette å…ƒç´ :', palette);
            console.log('åˆå§‹åŒ–é¡è‰²é¸æ“‡å™¨ï¼Œé¡è‰²æ•¸é‡:', colors.length);
            console.log('é¡è‰²é™£åˆ—:', colors);
            
            palette.innerHTML = ''; // æ¸…ç©ºç¾æœ‰å…§å®¹
            
            // ç²å–å·²ä½¿ç”¨çš„é¡è‰²
            const usedColors = units.map(u => u.color).filter(color => color);
            console.log('å·²ä½¿ç”¨çš„é¡è‰²:', usedColors);
            
            colors.forEach((color, index) => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'color-option';
                colorDiv.style.backgroundColor = color;
                colorDiv.title = color; // åŠ å…¥æç¤º
                colorDiv.setAttribute('data-color', color); // å„²å­˜ HEX é¡è‰²å€¼
                
                // æª¢æŸ¥æ˜¯å¦å·²è¢«ä½¿ç”¨
                const isUsed = usedColors.includes(color);
                if (isUsed) {
                    colorDiv.classList.add('used');
                    colorDiv.title = `${color} (å·²è¢«ä½¿ç”¨)`;
                }
                
                colorDiv.onclick = () => {
                    if (!isUsed) {
                        selectColor(colorDiv, color);
                    } else {
                        console.log('ç„¡æ³•é¸æ“‡å·²ä½¿ç”¨çš„é¡è‰²:', color);
                    }
                };
                
                palette.appendChild(colorDiv);
                console.log(`å»ºç«‹é¡è‰²é¸é … ${index + 1}: ${color} ${isUsed ? '(å·²ä½¿ç”¨)' : '(å¯ç”¨)'}`);
            });
            
            console.log('é¡è‰²é¸æ“‡å™¨åˆå§‹åŒ–å®Œæˆï¼Œå·²å»ºç«‹', palette.children.length, 'å€‹é¡è‰²é¸é …');
            console.log('palette å…§å®¹:', palette.innerHTML);
        }

        function selectColor(element, color) {
            // æª¢æŸ¥æ˜¯å¦ç‚ºå·²ä½¿ç”¨çš„é¡è‰²
            if (element.classList.contains('used')) {
                console.log('ç„¡æ³•é¸æ“‡å·²ä½¿ç”¨çš„é¡è‰²:', color);
                return;
            }
            
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            console.log('å·²é¸æ“‡é¡è‰²:', color);
            
            // ç¢ºä¿é¡è‰²å€¼æ­£ç¢ºå„²å­˜
            if (color && color.startsWith('#')) {
                element.setAttribute('data-color', color);
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
        }

        function toggleAddresses() {
            const isDistributed = document.getElementById('isDistributed').value;
            const addressSection = document.getElementById('addressesSection');
            const singleAddress = document.getElementById('singleAddressContainer');
            const branchesContainer = document.getElementById('branchesContainer');
            const addBranchBtn = document.getElementById('addBranchBtn');
            
            addressSection.style.display = 'block';
            
            if (isDistributed === 'å¦') {
                document.getElementById('addressLabel').textContent = 'äº‹æ¥­å–®ä½åœ°å€';
                singleAddress.style.display = 'block';
                branchesContainer.style.display = 'none';
                addBranchBtn.style.display = 'none';
            } else {
                document.getElementById('addressLabel').textContent = 'åˆ†é»è³‡è¨Š';
                singleAddress.style.display = 'none';
                branchesContainer.style.display = 'block';
                addBranchBtn.style.display = 'inline-block';
                if (branchesContainer.children.length === 0) addBranch();
            }
        }

        function setDistributed(val) {
            document.getElementById('isDistributed').value = val;
            document.getElementById('btnDistributedNo').classList.toggle('btn-primary', val==='å¦');
            document.getElementById('btnDistributedYes').classList.toggle('btn-primary', val==='æ˜¯');
            toggleAddresses();
        }

        function setSubsidy(val) {
            document.getElementById('hasSubsidy').value = val;
            if(val==='æ˜¯') {
                document.getElementById('subsidyYes').checked = true;
                document.getElementById('subsidyNo').checked = false;
            } else {
                document.getElementById('subsidyYes').checked = false;
                document.getElementById('subsidyNo').checked = true;
            }
        }

        function addBranch(branch = {name:'', address:'', contact:''}) {
            const container = document.getElementById('branchesContainer');
            const div = document.createElement('div');
            div.className = 'address-item';
            div.innerHTML = `
                <input type="text" placeholder="åˆ†é»åç¨±" value="${branch.name||''}" style="width:20%"> 
                <input type="text" placeholder="åœ°å€" value="${branch.address||''}" style="width:40%"> 
                <input type="text" placeholder="è¯çµ¡äºº" value="${branch.contact||''}" style="width:25%"> 
                <button onclick="removeBranch(this)">åˆªé™¤</button>
            `;
            container.appendChild(div);
        }

        function removeBranch(btn) {
            btn.parentElement.remove();
        }

        function generateCalendar() {
            const grid = document.getElementById('calendarGrid');
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonthYear').textContent = `${year}å¹´${month + 1}æœˆ`;
            grid.innerHTML = '';

            // æ·»åŠ æ˜ŸæœŸæ¨™é¡Œ
            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekDays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.style.background = '#f0f0f0';
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.textAlign = 'center';
                dayHeader.style.padding = '10px';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // å¡«å……ç©ºç™½æ—¥æœŸ
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                grid.appendChild(emptyDay);
            }

            // å¡«å……å¯¦éš›æ—¥æœŸ
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.setAttribute('data-day', day);
                
                const currentDayDate = new Date(year, month, day);
                const weekday = currentDayDate.getDay();
                
                // æª¢æŸ¥æ˜¯å¦æœ‰é¸ä¸­çš„å–®ä½ä¸”è©²æ—¥æœŸè¢«ç¦æ­¢æ’ç­
                let isRestricted = false;
                if (selectedUnit && selectedUnit.restricted_weekdays && selectedUnit.restricted_weekdays.includes(weekday)) {
                    isRestricted = true;
                    dayElement.style.background = '#fff3cd';
                    dayElement.style.border = '2px solid #ffc107';
                    dayElement.title = 'âš ï¸ æ­¤æ—¥æœŸè¢«ç¦æ­¢æ’ç­';
                }
                
                dayElement.innerHTML = `<div class="day-number">${day}</div>`;
                dayElement.onclick = () => selectDate(day);
                
                // æ‹–æ›³æ”¾ç½®åŠŸèƒ½
                dayElement.ondragover = (e) => {
                    e.preventDefault();
                    dayElement.classList.add('calendar-day-dragover');
                };
                dayElement.ondragleave = () => {
                    dayElement.classList.remove('calendar-day-dragover');
                };
                dayElement.ondrop = (e) => {
                    e.preventDefault();
                    dayElement.classList.remove('calendar-day-dragover');
                    const unitId = e.dataTransfer.getData('unitId');
                    const unit = units.find(u => u.id == unitId);
                    if (unit) {
                        selectedUnit = unit;
                        selectedDate = new Date(year, month, day);
                        updateUnitSelection(unit);
                        openShiftModal();
                    }
                };

                // é¡¯ç¤ºç•¶æ—¥æ’ç­
                const dayShifts = shifts.filter(shift => 
                    new Date(shift.shift_date).getDate() === day &&
                    new Date(shift.shift_date).getMonth() === month &&
                    new Date(shift.shift_date).getFullYear() === year
                );
                
                // ä¾ç…§é–‹å§‹æ™‚é–“æ’åº
                dayShifts.sort((a, b) => {
                    const timeA = new Date(`2000-01-01 ${a.start_time}`);
                    const timeB = new Date(`2000-01-01 ${b.start_time}`);
                    return timeA - timeB;
                });
                
                dayShifts.forEach(shift => {
                    const unit = units.find(u => u.id === shift.unit_id);
                    const color = unit ? unit.color : '#667eea';
                    const shortName = unit ? unit.name.slice(0,4) : '';
                    const shiftDiv = document.createElement('div');
                    shiftDiv.className = 'shift-item';
                    shiftDiv.style.background = color;
                    
                    // ç”Ÿæˆé¡¯ç¤ºæ–‡å­—
                    const startTime = formatTimeHHMM(shift.start_time);
                    const endTime = formatTimeHHMM(shift.end_time);
                    const timeStr = `${startTime}-${endTime}`;
                    
                    let displayText = '';
                    if (shift.branch_name) {
                        // åˆ†é»æ’ç­ï¼šHH:MM-HH:MM xx(åˆ†é»å)é†«å¸«/è­·ç†å¸«å
                        const staffNames = shift.staff_names ? shift.staff_names.join(', ') : '';
                        const displayNames = staffNames.length > 15 ? staffNames.substring(0, 15) + '...' : staffNames;
                        displayText = `${timeStr} ${shortName}(${shift.branch_name}) ${displayNames}`;
                    } else {
                        // ä¸€èˆ¬æ’ç­ï¼šHH:MM-HH:MM xxé†«å¸«/è­·ç†å¸«å
                        const staffNames = shift.staff_names ? shift.staff_names.join(', ') : '';
                        const displayNames = staffNames.length > 15 ? staffNames.substring(0, 15) + '...' : staffNames;
                        displayText = `${timeStr} ${shortName} ${displayNames}`;
                    }
                    
                    shiftDiv.textContent = displayText;
                    shiftDiv.onclick = (e) => {
                        e.stopPropagation();
                        editShift(shift);
                    };
                    
                    // æª¢æŸ¥æ˜¯å¦é•åæ’ç­è¦å‰‡
                    const shiftDate = new Date(shift.shift_date);
                    const weekday = shiftDate.getDay();
                    if (unit && unit.restricted_weekdays && unit.restricted_weekdays.includes(weekday)) {
                        shiftDiv.style.border = '2px solid #ff4444';
                        shiftDiv.style.boxShadow = '0 0 5px #ff4444';
                        shiftDiv.title = 'âš ï¸ é•åæ’ç­è¦å‰‡';
                    }
                    
                    dayElement.appendChild(shiftDiv);
                });

                grid.appendChild(dayElement);
            }
        }

        function selectDate(day) {
            // æ¸…é™¤ä¹‹å‰é¸ä¸­çš„æ—¥æœŸ
            document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected'));
            
            // é¸ä¸­ç•¶å‰æ—¥æœŸ
            const currentDayElement = document.querySelector(`[data-day="${day}"]`);
            if (currentDayElement) {
                currentDayElement.classList.add('selected');
            }
            
            selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            
            // å¦‚æœæœ‰é¸ä¸­äº‹æ¥­å–®ä½ï¼Œé¡¯ç¤ºç•¶å¤©æ’ç­
            if (selectedUnit) {
                showDayShifts();
            }
        }

        function showDayShifts() {
            const dailyShiftsDiv = document.getElementById('dailyShifts');
            const shiftsOnDateDiv = document.getElementById('shiftsOnDate');
            const selectedDateTitle = document.getElementById('selectedDateTitle');
            
            if (!selectedDate) return;
            
            const dateStr = formatDateLocal(selectedDate);
            selectedDateTitle.textContent = `${selectedDate.getFullYear()}å¹´${selectedDate.getMonth() + 1}æœˆ${selectedDate.getDate()}æ—¥ æ’ç­`;
            
            // ç¯©é¸ç•¶å¤©è©²äº‹æ¥­å–®ä½çš„æ’ç­
            const dayShifts = shifts.filter(shift => 
                shift.shift_date === dateStr && shift.unit_id === selectedUnit.id
            );
            
            // ä¾ç…§é–‹å§‹æ™‚é–“æ’åº
            dayShifts.sort((a, b) => {
                const timeA = new Date(`2000-01-01 ${a.start_time}`);
                const timeB = new Date(`2000-01-01 ${b.start_time}`);
                return timeA - timeB;
            });
            
            shiftsOnDateDiv.innerHTML = '';
            
            if (dayShifts.length === 0) {
                shiftsOnDateDiv.innerHTML = '<p style="text-align: center; color: #666;">è©²æ—¥ç„¡æ’ç­</p>';
            } else {
                dayShifts.forEach(shift => {
                    const shiftDiv = document.createElement('div');
                    shiftDiv.className = 'shift-detail';
                    shiftDiv.innerHTML = `
                        <div><strong>æ™‚é–“ï¼š</strong>${formatTimeHHMM(shift.start_time)} - ${formatTimeHHMM(shift.end_time)}</div>
                        ${shift.branch_name ? `<div><strong>åˆ†é»ï¼š</strong>${shift.branch_name}</div>` : ''}
                        <div><strong>äººå“¡ï¼š</strong>${shift.staff_names.join(', ')}</div>
                        <div><strong>æ™‚æ•¸ï¼š</strong>${shift.total_hours}å°æ™‚</div>
                        <div class="shift-actions">
                            <button class="btn btn-primary btn-small" onclick="editShift(${shift.id})">ä¿®æ”¹</button>
                            <button class="btn btn-danger btn-small" onclick="deleteShift(${shift.id})">åˆªé™¤</button>
                        </div>
                    `;
                    shiftsOnDateDiv.appendChild(shiftDiv);
                });
            }
            
            dailyShiftsDiv.style.display = 'block';
        }

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function updateUnitsList() {
            const unitsList = document.getElementById('unitsList');
            unitsList.innerHTML = '';

            if (units.length === 0) {
                unitsList.innerHTML = '<p style="text-align: center; color: #666;">å°šæœªå»ºç«‹äº‹æ¥­å–®ä½</p>';
                return;
            }

            for (const unit of units) {
                if (!unit || !unit.id) continue; // è·³éç„¡æ•ˆçš„å–®ä½
                
                const unitItem = document.createElement('div');
                unitItem.className = 'unit-item';
                unitItem.setAttribute('data-unit-id', unit.id);
                
                // å–å¾—å‰©é¤˜æ™‚æ•¸
                const docRemain = await getUnitMonthRemain(unit, 'doctors');
                const nurseRemain = await getUnitMonthRemain(unit, 'nurses');
                
                // æª¢æŸ¥æ˜¯å¦æ²’æœ‰å‰©é¤˜æ™‚æ•¸
                const hasNoRemainingHours = docRemain <= 0 && nurseRemain <= 0;
                
                unitItem.innerHTML = `
                    <div class="unit-info">
                        <div class="unit-color" style="background-color: ${unit.color}"></div>
                        <div>
                            <div><strong>${unit.name}</strong></div>
                            <div style="font-size: 12px; color: #666;">
                                é†«ç”Ÿ${(unit.doctors || []).length}äºº | è­·ç†å¸«${(unit.nurses || []).length}äºº
                            </div>
                            <div style='font-size:12px;color:#333;margin-top:4px;'>
                                <span>æœ¬æœˆå‰©é¤˜æ™‚æ•¸ï¼š</span>
                                <span style='color:#667eea;'>é†«å¸«${docRemain}h</span> / 
                                <span style='color:#51cf66;'>è­·ç†å¸«${nurseRemain}h</span>
                            </div>
                            ${unit.restricted_weekdays && unit.restricted_weekdays.length > 0 ? 
                                `<div style='font-size:11px;color:#ff6b6b;margin-top:2px;'>
                                    âš ï¸ ç¦æ­¢æ’ç­ï¼š${getWeekdayNames(unit.restricted_weekdays)}
                                </div>` : ''
                            }
                        </div>
                    </div>
                `;
                
                // å¦‚æœæ²’æœ‰å‰©é¤˜æ™‚æ•¸ï¼Œå¥—ç”¨ç°è‰²æ¨£å¼
                if (hasNoRemainingHours) {
                    unitItem.style.opacity = '0.5';
                    unitItem.style.filter = 'grayscale(100%)';
                    unitItem.title = 'ç„¡å‰©é¤˜æ™‚æ•¸';
                }
                
                unitItem.onclick = () => selectUnit(unitItem, unit);
                
                // æ‹–æ›³åŠŸèƒ½
                unitItem.setAttribute('draggable', 'true');
                unitItem.ondragstart = (e) => {
                    e.dataTransfer.setData('unitId', unit.id);
                    unitItem.classList.add('dragging');
                };
                unitItem.ondragend = () => {
                    unitItem.classList.remove('dragging');
                };
                
                unitsList.appendChild(unitItem);
            }
        }

        async function selectUnit(element, unit) {
            updateUnitSelection(unit);
            selectedUnit = unit;
            
            // é¡¯ç¤ºäº‹æ¥­å–®ä½è³‡è¨Š
            document.getElementById('selectedUnitInfo').style.display = 'block';
            document.getElementById('selectedUnitName').textContent = unit.name;
            
            await updateUnitDashboard();
            
            // å¦‚æœæœ‰é¸ä¸­æ—¥æœŸï¼Œé¡¯ç¤ºç•¶å¤©æ’ç­
            if (selectedDate) {
                showDayShifts();
            }
        }

        function updateUnitSelection(unit) {
            // æ›´æ–°è¦–è¦ºé¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.unit-item').forEach(el => el.classList.remove('selected'));
            const selectedElement = document.querySelector(`[data-unit-id="${unit.id}"]`);
            if (selectedElement) {
                selectedElement.classList.add('selected');
            }
        }

        async function updateUnitDashboard() {
            if (!selectedUnit) {
                // å¦‚æœæ²’æœ‰é¸ä¸­çš„å–®ä½ï¼Œéš±è—å„€è¡¨æ¿
                document.getElementById('selectedUnitInfo').style.display = 'none';
                return;
            }
            
            const currentMonth = currentDate.getMonth() + 1; // æœˆä»½å¾1é–‹å§‹
            // å¾ Supabase è®€å–æœˆåº¦æ™‚æ•¸
            const { data: monthlyData, error } = await supabase
                .from('monthly_hours')
                .select('doctor_hours, nurse_hours')
                .eq('unit_id', selectedUnit.id)
                .eq('year', currentDate.getFullYear())
                .eq('month', currentMonth);
            
            if (error) {
                console.error('è®€å–æœˆåº¦æ™‚æ•¸å¤±æ•—:', error);
                return;
            }
            
            // å–ç¬¬ä¸€ç­†è³‡æ–™ï¼Œå¦‚æœæ²’æœ‰è³‡æ–™å‰‡ä½¿ç”¨é è¨­å€¼
            const monthlyRecord = monthlyData && monthlyData.length > 0 ? monthlyData[0] : null;
            const totalDocHours = monthlyRecord?.doctor_hours || 0;
            const totalNurseHours = monthlyRecord?.nurse_hours || 0;
            
            // è¨ˆç®—å·²ä½¿ç”¨æ™‚æ•¸
            let usedDocHours = 0;
            let usedNurseHours = 0;
            
            shifts.forEach(shift => {
                if (shift.unit_id !== selectedUnit.id) return;
                
                const shiftDate = new Date(shift.shift_date);
                if (shiftDate.getMonth() === currentMonth - 1 && shiftDate.getFullYear() === currentDate.getFullYear()) {
                    shift.staff_names.forEach(staffName => {
                        if (selectedUnit.doctors && selectedUnit.doctors.includes(staffName)) {
                            usedDocHours += shift.total_hours;
                        } else if (selectedUnit.nurses && selectedUnit.nurses.includes(staffName)) {
                            usedNurseHours += shift.total_hours;
                        }
                    });
                }
            });
            
            // è¨ˆç®—å‰©é¤˜æ™‚æ•¸
            const remainingDocHours = Math.max(0, totalDocHours - usedDocHours);
            const remainingNurseHours = Math.max(0, totalNurseHours - usedNurseHours);
            
            // æ›´æ–°é€²åº¦æ¢ (é¡¯ç¤ºå‰©é¤˜æ¯”ä¾‹)
            const docProgress = totalDocHours > 0 ? (remainingDocHours / totalDocHours) * 100 : 0;
            const nurseProgress = totalNurseHours > 0 ? (remainingNurseHours / totalNurseHours) * 100 : 0;
            
            document.getElementById('doctorProgress').style.width = `${docProgress}%`;
            document.getElementById('nurseProgress').style.width = `${nurseProgress}%`;
            
            document.getElementById('doctorHoursText').textContent = 
                `å‰©é¤˜: ${remainingDocHours}å°æ™‚ / ç¸½è¨ˆ: ${totalDocHours}å°æ™‚`;
            document.getElementById('nurseHoursText').textContent = 
                `å‰©é¤˜: ${remainingNurseHours}å°æ™‚ / ç¸½è¨ˆ: ${totalNurseHours}å°æ™‚`;
        }

        function openShiftModal(isEditMode = false) {
            if (!selectedUnit) {
                alert('è«‹å…ˆé¸æ“‡äº‹æ¥­å–®ä½');
                return;
            }
            
            // å¼·åˆ¶å–å¾—æœ€æ–°å–®ä½è³‡æ–™
            if (selectedUnit.id) {
                const latest = units.find(u => u.id === selectedUnit.id);
                if (latest) selectedUnit = latest;
            }
            
            const modal = document.getElementById('shiftModal');
            modal.classList.add('active');
            
            // è‡ªå‹•å¡«å…¥é¸ä¸­çš„äº‹æ¥­å–®ä½
            document.getElementById('selectedUnitDisplay').value = selectedUnit.name;
            
            // åˆ†æ•£å‹åˆ†é»é¸æ“‡
            const branchGroup = document.getElementById('branchSelectGroup');
            const branchSelect = document.getElementById('branchSelect');
            if (selectedUnit.is_distributed && selectedUnit.addresses && selectedUnit.addresses.length > 0) {
                branchGroup.style.display = 'block';
                branchSelect.innerHTML = '';
                selectedUnit.addresses.forEach((branch, idx) => {
                    const name = branch.name || branch.address || `åˆ†é»${idx+1}`;
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    branchSelect.appendChild(option);
                });
            } else {
                branchGroup.style.display = 'none';
            }
            
            // ä¿®å¾©ï¼šæ­£ç¢ºè¨­å®šæ—¥æœŸ
            let dateToSet = selectedDate;
            if (!dateToSet) {
                dateToSet = new Date();
            }
            document.getElementById('shiftDate').value = formatDateLocal(dateToSet);
            
            // æ¸…ç©ºæ™‚é–“å’Œæ™‚æ•¸
            document.getElementById('startTime').value = '';
            document.getElementById('endTime').value = '';
            document.getElementById('deductHours').value = '';
            
            // ä¿®å¾©ï¼šæ›´æ–°äººå“¡é¸æ“‡æ¡†
            updateStaffCheckboxes();
            
            // é‡ç½®ç·¨è¼¯ç‹€æ…‹ï¼ˆåªæœ‰åœ¨éç·¨è¼¯æ¨¡å¼ä¸‹æ‰æ¸…ç©ºï¼‰
            if (!isEditMode) {
                editingShift = null;
            }
        }

        function calculateHours() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            if (startTime && endTime) {
                const start = new Date(`2000-01-01 ${startTime}`);
                const end = new Date(`2000-01-01 ${endTime}`);
                let hours = (end - start) / (1000 * 60 * 60);
                
                // è™•ç†è·¨æ—¥æƒ…æ³
                if (hours < 0) {
                    hours += 24;
                }
                
                document.getElementById('deductHours').value = hours.toFixed(1);
            }
        }

        function closeShiftModal() {
            document.getElementById('shiftModal').classList.remove('active');
            // æ¸…ç©ºç·¨è¼¯ç‹€æ…‹
            editingShift = null;
            // æ¸…ç©ºé‡è¤‡æ’ç­è¨­å®š
            resetRepeatOptions();
        }

        function toggleRepeatOptions() {
            const enableRepeat = document.getElementById('enableRepeat');
            const repeatOptions = document.getElementById('repeatOptions');
            repeatOptions.style.display = enableRepeat.checked ? 'block' : 'none';
        }

        function resetRepeatOptions() {
            document.getElementById('enableRepeat').checked = false;
            document.getElementById('repeatType').value = 'daily';
            document.getElementById('repeatCount').value = '1';
            document.querySelectorAll('#weeklyOptions input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('repeatOptions').style.display = 'none';
            document.getElementById('weeklyOptions').style.display = 'none';
        }

        // ç›£è½é‡è¤‡é¡å‹è®Šæ›´
        document.addEventListener('DOMContentLoaded', function() {
            const repeatType = document.getElementById('repeatType');
            if (repeatType) {
                repeatType.addEventListener('change', function() {
                    const weeklyOptions = document.getElementById('weeklyOptions');
                    weeklyOptions.style.display = this.value === 'weekly' ? 'block' : 'none';
                    
                    // ç•¶é¡¯ç¤ºæ˜ŸæœŸé¸é …æ™‚ï¼Œæ·»åŠ äº‹ä»¶ç›£è½
                    if (this.value === 'weekly') {
                        setTimeout(() => {
                            document.querySelectorAll('#weeklyOptions input[type="checkbox"]').forEach(cb => {
                                cb.addEventListener('change', function() {
                                    const selectedWeekdays = [];
                                    document.querySelectorAll('#weeklyOptions input[type="checkbox"]:checked').forEach(cb => {
                                        selectedWeekdays.push(parseInt(cb.value));
                                    });
                                    console.log('ç•¶å‰é¸æ“‡çš„æ˜ŸæœŸ:', selectedWeekdays);
                                });
                            });
                        }, 100);
                    }
                });
            }
        });

        function updateStaffCheckboxes() {
            const container = document.getElementById('staffCheckboxes');
            container.innerHTML = '';
            
            if (!selectedUnit) return;
            
            let hasStaff = false;
            
            // æ·»åŠ é†«ç”Ÿ
            if (selectedUnit.doctors && selectedUnit.doctors.length > 0) {
                selectedUnit.doctors.forEach(doctor => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'checkbox-item';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" id="doc_${doctor}" value="${doctor}">
                        <label for="doc_${doctor}">ğŸ‘¨â€âš•ï¸ ${doctor}</label>
                    `;
                    container.appendChild(checkboxDiv);
                });
                hasStaff = true;
            }
            
            // æ·»åŠ è­·ç†å¸«
            if (selectedUnit.nurses && selectedUnit.nurses.length > 0) {
                selectedUnit.nurses.forEach(nurse => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'checkbox-item';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" id="nurse_${nurse}" value="${nurse}">
                        <label for="nurse_${nurse}">ğŸ‘©â€âš•ï¸ ${nurse}</label>
                    `;
                    container.appendChild(checkboxDiv);
                });
                hasStaff = true;
            }
            
            if (!hasStaff) {
                container.innerHTML = '<div style="color:#c00;text-align:center;">å°šæœªè¨­å®šäººå“¡ï¼Œè«‹å…ˆåˆ°äº‹æ¥­å–®ä½ç®¡ç†é é¢è¨­å®š</div>';
            }
        }

        async function saveShift() {
            const date = document.getElementById('shiftDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const hours = parseFloat(document.getElementById('deductHours').value) || 0;
            
            const selectedStaffMembers = [];
            document.querySelectorAll('#staffCheckboxes input:checked').forEach(checkbox => {
                selectedStaffMembers.push(checkbox.value);
            });
            // å»é™¤é‡è¤‡çš„äººå“¡
            const uniqueStaffMembers = [...new Set(selectedStaffMembers)];

            // åˆ†é»
            let branch = '';
            if (selectedUnit.is_distributed) {
                branch = document.getElementById('branchSelect').value || '';
            }

            if (!date || !startTime || !endTime || uniqueStaffMembers.length === 0) {
                alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
                return;
            }

            if (!selectedUnit) {
                alert('è«‹é¸æ“‡äº‹æ¥­å–®ä½');
                return;
            }

            // æª¢æŸ¥æ’ç­è¦å‰‡
            const shiftDate = new Date(date);
            const weekday = shiftDate.getDay(); // 0=æ˜ŸæœŸæ—¥, 1=æ˜ŸæœŸä¸€, ..., 6=æ˜ŸæœŸå…­
            
            if (selectedUnit.restricted_weekdays && selectedUnit.restricted_weekdays.includes(weekday)) {
                const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
                const confirmResult = confirm(
                    `âš ï¸ æ’ç­è¦å‰‡è­¦å‘Š\n\n` +
                    `æ‚¨é¸æ“‡çš„æ—¥æœŸ ${date} æ˜¯ ${weekdays[weekday]}ï¼Œ` +
                    `æ­¤äº‹æ¥­å–®ä½å·²è¨­å®šç¦æ­¢åœ¨ ${weekdays[weekday]} æ’ç­ã€‚\n\n` +
                    `æ˜¯å¦ä»è¦ç¹¼çºŒå„²å­˜æ­¤æ’ç­ï¼Ÿ`
                );
                
                if (!confirmResult) {
                    return;
                }
            }

            try {
                // 1. æ–°å¢æˆ–æ›´æ–°æ’ç­
                const shiftData = {
                    unit_id: selectedUnit.id,
                    branch_name: branch || null,
                    shift_date: date,
                    start_time: startTime,
                    end_time: endTime,
                    total_hours: hours
                };

                let shiftId;
                if (editingShift && editingShift.id) {
                    // æ›´æ–°ç¾æœ‰æ’ç­
                    const { error: shiftError } = await supabase
                        .from('shifts')
                        .update(shiftData)
                        .eq('id', editingShift.id);
                    
                    if (shiftError) throw shiftError;
                    shiftId = editingShift.id;
                } else {
                    // æª¢æŸ¥æ˜¯å¦å•Ÿç”¨é‡è¤‡æ’ç­
                    const enableRepeat = document.getElementById('enableRepeat').checked;
                    
                    if (enableRepeat) {
                        // é‡è¤‡æ’ç­é‚è¼¯
                        await createRepeatedShifts(shiftData, uniqueStaffMembers);
                    } else {
                        // å–®æ¬¡æ’ç­
                        const { data: newShift, error: shiftError } = await supabase
                            .from('shifts')
                            .insert(shiftData)
                            .select()
                            .single();
                        
                        if (shiftError) throw shiftError;
                        shiftId = newShift.id;
                        
                        // è™•ç†äººå“¡é—œè¯
                        await createShiftStaffRelations(shiftId, uniqueStaffMembers);
                    }
                }

                // 2. è™•ç†æ’ç­äººå“¡é—œè¯ï¼ˆåƒ…åœ¨ç·¨è¼¯æ¨¡å¼æˆ–å–®æ¬¡æ’ç­æ™‚ï¼‰
                if (editingShift && editingShift.id) {
                    await createShiftStaffRelations(shiftId, uniqueStaffMembers);
                }

                // é‡æ–°è¼‰å…¥æ’ç­è³‡æ–™
                await loadShiftsFromSupabase();
                updateUnitDashboard();
                showDayShifts();
                updateUnitYearlyList();
                closeShiftModal();
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                const enableRepeat = document.getElementById('enableRepeat').checked;
                if (enableRepeat) {
                    const repeatCount = parseInt(document.getElementById('repeatCount').value) || 1;
                    alert(`é‡è¤‡æ’ç­å·²æˆåŠŸå‰µå»ºï¼å…±å‰µå»ºäº† ${repeatCount} å€‹æ’ç­ã€‚`);
                } else {
                    alert('æ’ç­å·²æˆåŠŸå„²å­˜åˆ°é›²ç«¯ï¼');
                }
                
            } catch (error) {
                console.error('å„²å­˜æ’ç­å¤±æ•—:', error);
                alert('å„²å­˜æ’ç­å¤±æ•—ï¼š' + error.message);
            }
        }

        // å‰µå»ºæ’ç­äººå“¡é—œè¯
        async function createShiftStaffRelations(shiftId, staffMembers) {
            // å…ˆåˆªé™¤èˆŠçš„äººå“¡é—œè¯
            await supabase
                .from('shift_staff')
                .delete()
                .eq('shift_id', shiftId);

            // æ–°å¢äººå“¡é—œè¯
            for (const staffName of staffMembers) {
                // æ‰¾åˆ°å°æ‡‰çš„äººå“¡ID
                const { data: staffData, error: staffError } = await supabase
                    .from('staff')
                    .select('id')
                    .eq('unit_id', selectedUnit.id)
                    .eq('name', staffName)
                    .single();
                
                if (staffError) throw staffError;
                
                // æ–°å¢æ’ç­äººå“¡é—œè¯
                const { error: relationError } = await supabase
                    .from('shift_staff')
                    .insert({
                        shift_id: shiftId,
                        staff_id: staffData.id
                    });
                
                if (relationError) throw relationError;
            }
        }

        // å‰µå»ºé‡è¤‡æ’ç­
        async function createRepeatedShifts(baseShiftData, staffMembers) {
            const repeatType = document.getElementById('repeatType').value;
            const repeatCount = parseInt(document.getElementById('repeatCount').value) || 1;
            
            let createdCount = 0;
            let currentDate = new Date(baseShiftData.shift_date);
            
            for (let i = 0; i < repeatCount; i++) {
                let targetDate = new Date(currentDate);
                
                // æ ¹æ“šé‡è¤‡é¡å‹è¨ˆç®—ç›®æ¨™æ—¥æœŸ
                if (repeatType === 'daily') {
                    targetDate.setDate(currentDate.getDate() + i);
                } else if (repeatType === 'weekly') {
                    // æª¢æŸ¥æ˜¯å¦é¸æ“‡äº†æ˜ŸæœŸ
                    const selectedWeekdays = [];
                    document.querySelectorAll('#weeklyOptions input[type="checkbox"]:checked').forEach(cb => {
                        selectedWeekdays.push(parseInt(cb.value));
                    });
                    
                    if (selectedWeekdays.length === 0) {
                        alert('è«‹é¸æ“‡è‡³å°‘ä¸€å€‹æ˜ŸæœŸ');
                        return;
                    }
                    
                    console.log('é¸æ“‡çš„æ˜ŸæœŸ:', selectedWeekdays);
                    
                    // æ‰¾åˆ°ç¬¬ i+1 å€‹ç¬¦åˆæ¢ä»¶çš„æ—¥æœŸ
                    let foundCount = 0;
                    let daysToAdd = 0;
                    let targetDateFound = false;
                    
                    while (daysToAdd < 365 && !targetDateFound) { // é˜²æ­¢ç„¡é™å¾ªç’°
                        const testDate = new Date(baseShiftData.shift_date);
                        testDate.setDate(new Date(baseShiftData.shift_date).getDate() + daysToAdd);
                        
                        if (selectedWeekdays.includes(testDate.getDay())) {
                            foundCount++;
                            if (foundCount === i + 1) {
                                targetDate = testDate;
                                targetDateFound = true;
                            }
                        }
                        daysToAdd++;
                    }
                    
                    if (!targetDateFound) {
                        console.warn(`ç„¡æ³•æ‰¾åˆ°ç¬¬ ${i + 1} å€‹ç¬¦åˆæ¢ä»¶çš„æ—¥æœŸ`);
                        continue; // è·³éé€™å€‹é‡è¤‡ï¼Œç¹¼çºŒä¸‹ä¸€å€‹
                    }
                } else if (repeatType === 'monthly') {
                    targetDate.setMonth(currentDate.getMonth() + i);
                }
                
                // å‰µå»ºæ’ç­
                const shiftData = {
                    ...baseShiftData,
                    shift_date: formatDateLocal(targetDate)
                };
                
                try {
                    const { data: newShift, error: shiftError } = await supabase
                        .from('shifts')
                        .insert(shiftData)
                        .select()
                        .single();
                    
                    if (shiftError) throw shiftError;
                    
                    // å‰µå»ºäººå“¡é—œè¯
                    await createShiftStaffRelations(newShift.id, staffMembers);
                    createdCount++;
                    
                } catch (error) {
                    console.error(`å‰µå»ºç¬¬ ${i + 1} å€‹é‡è¤‡æ’ç­å¤±æ•—:`, error);
                    // ç¹¼çºŒå‰µå»ºå…¶ä»–æ’ç­ï¼Œä¸ä¸­æ–·æ•´å€‹éç¨‹
                }
            }
            
            return createdCount;
        }

        async function editShift(shiftId) {
            const shift = shifts.find(s => s.id === shiftId);
            if (!shift) return;
            
            editingShift = shift;
            
            // ç¢ºä¿é¸ä¸­æ­£ç¢ºçš„äº‹æ¥­å–®ä½
            const unit = units.find(u => u.id === shift.unit_id);
            if (unit) {
                selectedUnit = unit;
                updateUnitSelection(unit);
                document.getElementById('selectedUnitInfo').style.display = 'block';
                document.getElementById('selectedUnitName').textContent = unit.name;
                await updateUnitDashboard();
            }
            
            // é–‹å•Ÿæ¨¡æ…‹æ¡†ä¸¦å¡«å…¥è³‡æ–™
            openShiftModal(true);
            
            setTimeout(() => {
                document.getElementById('shiftDate').value = shift.shift_date;
                document.getElementById('startTime').value = shift.start_time;
                document.getElementById('endTime').value = shift.end_time;
                document.getElementById('deductHours').value = shift.total_hours;
                
                // åˆ†é»
                if (selectedUnit.is_distributed && shift.branch_name) {
                    const branchSelect = document.getElementById('branchSelect');
                    if (branchSelect) branchSelect.value = shift.branch_name;
                }
                
                // é¸ä¸­å°æ‡‰çš„äººå“¡
                shift.staff_names.forEach(staffName => {
                    const checkbox = document.querySelector(`#staffCheckboxes input[value="${staffName}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }, 100);
        }

        async function deleteShift(shiftId) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ’ç­å—ï¼Ÿ')) {
                try {
                    // ç”±æ–¼è¨­å®šäº† CASCADEï¼Œåˆªé™¤æ’ç­æœƒè‡ªå‹•åˆªé™¤ç›¸é—œçš„äººå“¡é—œè¯
                    const { error } = await supabase
                        .from('shifts')
                        .delete()
                        .eq('id', shiftId);
                    
                    if (error) throw error;
                    
                    // é‡æ–°è¼‰å…¥æ’ç­è³‡æ–™
                    await loadShiftsFromSupabase();
                    updateUnitDashboard();
                    showDayShifts();
                    updateUnitYearlyList();
                    
                    alert('æ’ç­å·²æˆåŠŸåˆªé™¤ï¼');
                    
                } catch (error) {
                    console.error('åˆªé™¤æ’ç­å¤±æ•—:', error);
                    alert('åˆªé™¤æ’ç­å¤±æ•—ï¼š' + error.message);
                }
            }
        }

        async function saveUnit() {
            const name = document.getElementById('unitName').value.trim();
            if (!name) {
                alert('è«‹è¼¸å…¥äº‹æ¥­å–®ä½åç¨±');
                return;
            }
            
            const isDistributed = document.getElementById('isDistributed').value;
            let addresses = [];
            
            if (isDistributed === 'å¦') {
                const addr = document.getElementById('singleAddress').value.trim();
                if (addr) addresses.push({address: addr});
            } else {
                document.querySelectorAll('#branchesContainer .address-item').forEach(div => {
                    const [nameInput, addrInput, contactInput] = div.querySelectorAll('input');
                    if (nameInput.value && addrInput.value) {
                        addresses.push({
                            name: nameInput.value.trim(), 
                            address: addrInput.value.trim(), 
                            contact: contactInput.value.trim()
                        });
                    }
                });
            }
            
            const doctors = [...new Set(document.getElementById('doctorNames').value
                .split('\n')
                .map(n => n.trim())
                .filter(n => n))];
            const nurses = [...new Set(document.getElementById('nurseNames').value
                .split('\n')
                .map(n => n.trim())
                .filter(n => n))];
            
            // å–å¾—é¡è‰²
            let color = '#667eea';
            const selectedColor = document.querySelector('.color-option.selected');
            if (selectedColor) {
                // å„ªå…ˆä½¿ç”¨ data-color å±¬æ€§ï¼ˆHEX æ ¼å¼ï¼‰
                const dataColor = selectedColor.getAttribute('data-color');
                if (dataColor && dataColor.startsWith('#')) {
                    color = dataColor;
                } else {
                    // å‚™ç”¨æ–¹æ¡ˆï¼šå¾ style.backgroundColor è½‰æ›
                    const bgColor = selectedColor.style.backgroundColor;
                    if (bgColor.startsWith('rgb')) {
                        const rgb = bgColor.match(/\d+/g);
                        if (rgb && rgb.length === 3) {
                            const r = parseInt(rgb[0]).toString(16).padStart(2, '0');
                            const g = parseInt(rgb[1]).toString(16).padStart(2, '0');
                            const b = parseInt(rgb[2]).toString(16).padStart(2, '0');
                            color = `#${r}${g}${b}`.toUpperCase();
                        }
                    } else if (bgColor.startsWith('#')) {
                        color = bgColor;
                    }
                }
            } else {
                // å¦‚æœæ²’æœ‰é¸æ“‡é¡è‰²ï¼Œè‡ªå‹•é¸æ“‡ä¸€å€‹æœªä½¿ç”¨çš„é¡è‰²
                const usedColors = units.map(u => u.color);
                const availableColor = colors.find(c => !usedColors.includes(c));
                if (availableColor) {
                    color = availableColor;
                    console.log('è‡ªå‹•é¸æ“‡æœªä½¿ç”¨çš„é¡è‰²:', availableColor);
                } else {
                    console.warn('æ²’æœ‰å¯ç”¨çš„é¡è‰²ï¼Œä½¿ç”¨é è¨­é¡è‰²:', color);
                }
            }
            
            // è£œåŠ©
            const hasSubsidy = document.getElementById('subsidyYes').checked;
            
            // æ’ç­è¦å‰‡ - ç¦æ­¢çš„æ˜ŸæœŸ
            const restrictedWeekdays = [];
            document.querySelectorAll('#weekdayRestrictions input:checked').forEach(checkbox => {
                restrictedWeekdays.push(parseInt(checkbox.value));
            });
            
            try {
                // 1. æ–°å¢æˆ–æ›´æ–°äº‹æ¥­å–®ä½
                const unitData = {
                    name,
                    is_distributed: isDistributed === 'æ˜¯',
                    has_subsidy: hasSubsidy,
                    color,
                    restricted_weekdays: restrictedWeekdays
                };
                
                let unitId;
                let isNewUnit = false;
                
                if (selectedUnit && selectedUnit.id) {
                    // æ›´æ–°ç¾æœ‰äº‹æ¥­å–®ä½
                    const { error: unitError } = await supabase
                        .from('units')
                        .update(unitData)
                        .eq('id', selectedUnit.id);
                    
                    if (unitError) throw unitError;
                    unitId = selectedUnit.id;
                } else {
                    // æ–°å¢äº‹æ¥­å–®ä½
                    const { data: newUnit, error: unitError } = await supabase
                        .from('units')
                        .insert(unitData)
                        .select()
                        .single();
                    
                    if (unitError) throw unitError;
                    unitId = newUnit.id;
                    isNewUnit = true;
                }
                
                // 2. è™•ç†åœ°å€/åˆ†é»
                // å…ˆåˆªé™¤èˆŠçš„åœ°å€
                await supabase
                    .from('unit_addresses')
                    .delete()
                    .eq('unit_id', unitId);
                
                // æ–°å¢åœ°å€
                if (addresses.length > 0) {
                    const addressData = addresses.map(addr => ({
                        unit_id: unitId,
                        name: addr.name || null,
                        address: addr.address,
                        contact: addr.contact || null
                    }));
                    
                    const { error: addrError } = await supabase
                        .from('unit_addresses')
                        .insert(addressData);
                    
                    if (addrError) throw addrError;
                }
                
                // 3. è™•ç†äººå“¡
                // å…ˆåˆªé™¤èˆŠçš„äººå“¡
                await supabase
                    .from('staff')
                    .delete()
                    .eq('unit_id', unitId);
                
                // æ–°å¢é†«ç”Ÿ
                if (doctors.length > 0) {
                    const doctorData = doctors.map(name => ({
                        unit_id: unitId,
                        name,
                        staff_type: 'doctor'
                    }));
                    
                    const { error: docError } = await supabase
                        .from('staff')
                        .insert(doctorData);
                    
                    if (docError) throw docError;
                }
                
                // æ–°å¢è­·ç†å¸«
                if (nurses.length > 0) {
                    const nurseData = nurses.map(name => ({
                        unit_id: unitId,
                        name,
                        staff_type: 'nurse'
                    }));
                    
                    const { error: nurseError } = await supabase
                        .from('staff')
                        .insert(nurseData);
                    
                    if (nurseError) throw nurseError;
                }
                
                // 4. è™•ç†æœˆåº¦æ™‚æ•¸
                // å…ˆåˆªé™¤èˆŠçš„æœˆåº¦æ™‚æ•¸è¨˜éŒ„
                await supabase
                    .from('monthly_hours')
                    .delete()
                    .eq('unit_id', unitId)
                    .eq('year', 2025);
                
                // æ–°å¢æœˆåº¦æ™‚æ•¸è¨˜éŒ„
                const monthlyHoursData = [];
                for (let month = 1; month <= 12; month++) {
                    const doctorHours = parseInt(document.getElementById(`docHours${month}`).value) || 0;
                    const nurseHours = parseInt(document.getElementById(`nurseHours${month}`).value) || 0;
                    
                    if (doctorHours > 0 || nurseHours > 0) {
                        monthlyHoursData.push({
                            unit_id: unitId,
                            year: 2025,
                            month,
                            doctor_hours: doctorHours,
                            nurse_hours: nurseHours
                        });
                    }
                }
                
                if (monthlyHoursData.length > 0) {
                    const { error: hoursError } = await supabase
                        .from('monthly_hours')
                        .insert(monthlyHoursData);
                    
                    if (hoursError) throw hoursError;
                }
                
                // é‡æ–°è¼‰å…¥è³‡æ–™
                await loadUnitsFromSupabase();
                alert('äº‹æ¥­å–®ä½è³‡æ–™å·²æˆåŠŸå„²å­˜åˆ°é›²ç«¯ï¼');
                
                // å¦‚æœæ˜¯æ–°å¢å–®ä½ï¼Œæ¸…ç©ºé¸æ“‡ï¼›å¦‚æœæ˜¯ç·¨è¼¯ï¼Œæ›´æ–°é¸ä¸­çš„å–®ä½è³‡æ–™
                if (isNewUnit) {
                    selectedUnit = null;
                    document.getElementById('selectedUnitInfo').style.display = 'none';
                } else {
                    // æ›´æ–°é¸ä¸­å–®ä½çš„è³‡æ–™
                    const updatedUnit = units.find(u => u.id === unitId);
                    if (updatedUnit) {
                        selectedUnit = updatedUnit;
                    }
                }
                clearUnitForm();
                
            } catch (error) {
                console.error('å„²å­˜å¤±æ•—:', error);
                alert('å„²å­˜å¤±æ•—ï¼š' + error.message);
            }
        }

        function clearUnitForm() {
            // æ¸…ç©ºé¸ä¸­çš„å–®ä½
            selectedUnit = null;
            
            document.getElementById('unitName').value = '';
            setDistributed('å¦');
            document.getElementById('singleAddress').value = '';
            document.getElementById('branchesContainer').innerHTML = '';
            document.getElementById('doctorNames').value = '';
            document.getElementById('nurseNames').value = '';
            
            for (let i = 1; i <= 12; i++) {
                document.getElementById(`docHours${i}`).value = '';
                document.getElementById(`nurseHours${i}`).value = '';
            }
            
            // é‡æ–°åˆå§‹åŒ–é¡è‰²é¸æ“‡å™¨ä»¥æ­£ç¢ºé¡¯ç¤ºå·²ä½¿ç”¨çš„é¡è‰²
            initColorPalette();
            
            // è‡ªå‹•é¸æ“‡ä¸€å€‹æœªä½¿ç”¨çš„é¡è‰²
            const usedColors = units.map(u => u.color);
            const availableColor = colors.find(c => !usedColors.includes(c));
            if (availableColor) {
                const colorOption = document.querySelector(`[data-color="${availableColor}"]`);
                if (colorOption) {
                    colorOption.classList.add('selected');
                }
            }
            
            setSubsidy('å¦');
            
            // æ¸…ç©ºæ’ç­è¦å‰‡è¨­å®š
            document.querySelectorAll('#weekdayRestrictions input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            toggleAddresses();
        }

        async function updateUnitYearlyList() {
            const tbody = document.getElementById('unitYearlyTableBody');
            tbody.innerHTML = '';
            
            for (const unit of units) {
                try {
                    // å¹´åº¦ç¸½æ™‚æ•¸ - éœ€è¦å¾ Supabase è®€å–
                    const { data: yearlyData, error } = await supabase
                        .from('monthly_hours')
                        .select('doctor_hours, nurse_hours')
                        .eq('unit_id', unit.id)
                        .eq('year', 2025);
                    
                    let nurseTotal = 0, docTotal = 0;
                    
                    if (error) {
                        console.error('è®€å–å¹´åº¦æ™‚æ•¸å¤±æ•—:', error);
                        // å³ä½¿è®€å–å¤±æ•—ï¼Œä¹Ÿé¡¯ç¤ºå–®ä½ï¼Œåªæ˜¯æ™‚æ•¸ç‚º0
                    } else if (yearlyData) {
                        nurseTotal = yearlyData.reduce((sum, month) => sum + (month.nurse_hours || 0), 0);
                        docTotal = yearlyData.reduce((sum, month) => sum + (month.doctor_hours || 0), 0);
                    }
                    
                    // å·²æ’æ™‚æ•¸
                    let nurseUsed = 0, docUsed = 0;
                    shifts.forEach(shift => {
                        if (shift.unit_id !== unit.id) return;
                        shift.staff_names.forEach(staffName => {
                            if ((unit.nurses||[]).includes(staffName)) nurseUsed += shift.total_hours;
                            if ((unit.doctors||[]).includes(staffName)) docUsed += shift.total_hours;
                        });
                    });
                    
                    // å‰©é¤˜
                    const nurseRemain = Math.max(0, nurseTotal - nurseUsed);
                    const docRemain = Math.max(0, docTotal - docUsed);
                    
                    // åˆ—
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="padding:10px;">${unit.name}</td>
                        <td style="text-align:center;">${nurseTotal}</td>
                        <td style="text-align:center;">${docTotal}</td>
                        <td style="text-align:center;">${nurseRemain}</td>
                        <td style="text-align:center;">${docRemain}</td>
                        <td style="text-align:center;">
                            <button class='btn btn-primary btn-small' onclick='editUnitById(${unit.id})'>ç·¨è¼¯</button>
                            <button class='btn btn-danger btn-small' onclick='deleteUnit(${unit.id})'>åˆªé™¤</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                } catch (error) {
                    console.error('è™•ç†å–®ä½å¹´åº¦è³‡æ–™å¤±æ•—:', error);
                    // å³ä½¿è™•ç†å¤±æ•—ï¼Œä¹Ÿå˜—è©¦é¡¯ç¤ºå–®ä½
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="padding:10px;">${unit.name}</td>
                        <td style="text-align:center;">0</td>
                        <td style="text-align:center;">0</td>
                        <td style="text-align:center;">0</td>
                        <td style="text-align:center;">0</td>
                        <td style="text-align:center;">
                            <button class='btn btn-primary btn-small' onclick='editUnitById(${unit.id})'>ç·¨è¼¯</button>
                            <button class='btn btn-danger btn-small' onclick='deleteUnit(${unit.id})'>åˆªé™¤</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            }
        }

        async function editUnitById(unitId) {
            const unit = units.find(u => u.id === unitId);
            if (!unit) return;
            
            // åˆ‡æ›åˆ°äº‹æ¥­å–®ä½ç®¡ç†é é¢
            switchTab('unit');
            
            // å¸¶å›è³‡æ–™åˆ°è¡¨å–®
            document.getElementById('unitName').value = unit.name;
            setDistributed(unit.is_distributed ? 'æ˜¯' : 'å¦');
            setSubsidy(unit.has_subsidy ? 'æ˜¯' : 'å¦');
            toggleAddresses();
            
            if (!unit.is_distributed) {
                document.getElementById('singleAddress').value = unit.addresses[0]?.address || '';
            } else {
                document.getElementById('branchesContainer').innerHTML = '';
                (unit.addresses||[]).forEach(branch => addBranch(branch));
            }
            
            document.getElementById('doctorNames').value = (unit.doctors||[]).join('\n');
            document.getElementById('nurseNames').value = (unit.nurses||[]).join('\n');
            
            // è¼‰å…¥æœˆåº¦æ™‚æ•¸
            try {
                const { data: monthlyData, error } = await supabase
                    .from('monthly_hours')
                    .select('month, doctor_hours, nurse_hours')
                    .eq('unit_id', unit.id)
                    .eq('year', 2025);
                
                if (!error && monthlyData) {
                    for (let i = 1; i <= 12; i++) {
                        const monthData = monthlyData.find(m => m.month === i);
                        document.getElementById(`docHours${i}`).value = monthData?.doctor_hours || '';
                        document.getElementById(`nurseHours${i}`).value = monthData?.nurse_hours || '';
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥æœˆåº¦æ™‚æ•¸å¤±æ•—:', error);
            }
            
            // é¡è‰²
            document.querySelectorAll('.color-option').forEach(el => {
                const dataColor = el.getAttribute('data-color');
                if (dataColor === unit.color) {
                    el.classList.add('selected');
                    // ç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œç•¶å‰äº‹æ¥­å–®ä½çš„é¡è‰²ä¸æ‡‰è©²é¡¯ç¤ºç‚ºå·²ä½¿ç”¨
                    el.classList.remove('used');
                    el.title = dataColor;
                } else {
                    el.classList.remove('selected');
                }
            });
            
            // è¼‰å…¥æ’ç­è¦å‰‡è¨­å®š
            document.querySelectorAll('#weekdayRestrictions input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            if (unit.restricted_weekdays && unit.restricted_weekdays.length > 0) {
                unit.restricted_weekdays.forEach(weekday => {
                    const checkbox = document.querySelector(`#weekdayRestrictions input[value="${weekday}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            selectedUnit = unit;
        }

        async function deleteUnit(unitId) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤äº‹æ¥­å–®ä½å—ï¼Ÿç›¸é—œæ’ç­è³‡æ–™ä¹Ÿæœƒä¸€ä½µåˆªé™¤ã€‚')) {
                try {
                    // åˆªé™¤ç›¸é—œæ’ç­
                    const { error: shiftsError } = await supabase
                        .from('shifts')
                        .delete()
                        .eq('unit_id', unitId);
                    if (shiftsError) throw shiftsError;

                    // åˆªé™¤ç›¸é—œäººå“¡
                    const { error: staffError } = await supabase
                        .from('staff')
                        .delete()
                        .eq('unit_id', unitId);
                    if (staffError) throw staffError;

                    // åˆªé™¤ç›¸é—œåœ°å€
                    const { error: addressesError } = await supabase
                        .from('unit_addresses')
                        .delete()
                        .eq('unit_id', unitId);
                    if (addressesError) throw addressesError;

                    // åˆªé™¤æœˆåº¦æ™‚æ•¸
                    const { error: monthlyHoursError } = await supabase
                        .from('monthly_hours')
                        .delete()
                        .eq('unit_id', unitId);
                    if (monthlyHoursError) throw monthlyHoursError;

                    // åˆªé™¤å–®ä½æœ¬èº«
                    const { error: unitError } = await supabase
                        .from('units')
                        .delete()
                        .eq('id', unitId);
                    if (unitError) throw unitError;

                    // é‡æ–°è¼‰å…¥è³‡æ–™
                    await loadUnitsFromSupabase();
                    await loadShiftsFromSupabase();
                    
                    // å¦‚æœåˆªé™¤çš„æ˜¯ç•¶å‰é¸ä¸­çš„å–®ä½ï¼Œæ¸…ç©ºé¸æ“‡
                    if (selectedUnit && selectedUnit.id === unitId) {
                        selectedUnit = null;
                        document.getElementById('selectedUnitInfo').style.display = 'none';
                        document.getElementById('dailyShifts').style.display = 'none';
                    }
                    
                    alert('äº‹æ¥­å–®ä½åŠç›¸é—œè³‡æ–™å·²æˆåŠŸåˆªé™¤ï¼');
                    
                } catch (error) {
                    console.error('åˆªé™¤å¤±æ•—:', error);
                    alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
                }
            }
        }

        async function getUnitMonthRemain(unit, type) {
            if (!unit || !unit.id) return 0;
            
            const monthIdx = currentDate.getMonth() + 1; // æœˆä»½å¾1é–‹å§‹
            const year = currentDate.getFullYear();
            
            // å¾ Supabase è®€å–æœˆåº¦æ™‚æ•¸
            const { data: monthlyData, error } = await supabase
                .from('monthly_hours')
                .select('doctor_hours, nurse_hours')
                .eq('unit_id', unit.id)
                .eq('year', year)
                .eq('month', monthIdx);
            
            if (error) {
                console.error('è®€å–æœˆåº¦æ™‚æ•¸å¤±æ•—:', error);
                return 0;
            }
            
            // å–ç¬¬ä¸€ç­†è³‡æ–™ï¼Œå¦‚æœæ²’æœ‰è³‡æ–™å‰‡ä½¿ç”¨é è¨­å€¼
            const monthlyRecord = monthlyData && monthlyData.length > 0 ? monthlyData[0] : null;
            const total = type === 'doctors' ? (monthlyRecord?.doctor_hours || 0) : (monthlyRecord?.nurse_hours || 0);
            let used = 0;
            
            shifts.forEach(shift => {
                if (shift.unit_id !== unit.id) return;
                const shiftDate = new Date(shift.shift_date);
                if (shiftDate.getMonth() === monthIdx - 1 && shiftDate.getFullYear() === year) {
                    shift.staff_names.forEach(staffName => {
                        if ((unit[type]||[]).includes(staffName)) used += shift.total_hours;
                    });
                }
            });
            
            return Math.max(0, total - used);
        }

        async function changeMonth(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            generateCalendar();
            await updateUnitDashboard();
            await updateUnitsList();
            showDayShifts();
        }

        async function exportToExcel() {
            try {
                if (shifts.length === 0) {
                    alert('ç›®å‰æ²’æœ‰æ’ç­è³‡æ–™å¯ä»¥åŒ¯å‡º');
                    return;
                }

                // é¡¯ç¤ºè¼‰å…¥æç¤º
                const loadingMsg = 'æ­£åœ¨æº–å‚™åŒ¯å‡ºè³‡æ–™ï¼Œè«‹ç¨å€™...';
                console.log(loadingMsg);

                // æº–å‚™è³‡æ–™çµæ§‹
                const exportData = [];
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth() + 1;

                // æŒ‰äº‹æ¥­å–®ä½åˆ†çµ„è™•ç†è³‡æ–™
                for (const unit of units) {
                    const unitShifts = shifts.filter(shift => shift.unit_id === unit.id);
                    
                    // è¨ˆç®—ç•¶æœˆè­·ç†å¸«æ’ç­æ™‚æ•¸
                    const nurseShifts = unitShifts.filter(shift => {
                        const shiftDate = new Date(shift.shift_date);
                        return shiftDate.getFullYear() === currentYear && 
                               shiftDate.getMonth() + 1 === currentMonth &&
                               shift.staff_names.some(staffName => 
                                   unit.nurses && unit.nurses.includes(staffName)
                               );
                    });
                    
                    const nurseTotalHours = nurseShifts.reduce((total, shift) => {
                        const nurseHours = shift.staff_names
                            .filter(staffName => unit.nurses && unit.nurses.includes(staffName))
                            .length * shift.total_hours;
                        return total + nurseHours;
                    }, 0);

                    // è¨ˆç®—ç•¶æœˆé†«å¸«æ’ç­æ™‚æ•¸
                    const doctorShifts = unitShifts.filter(shift => {
                        const shiftDate = new Date(shift.shift_date);
                        return shiftDate.getFullYear() === currentYear && 
                               shiftDate.getMonth() + 1 === currentMonth &&
                               shift.staff_names.some(staffName => 
                                   unit.doctors && unit.doctors.includes(staffName)
                               );
                    });
                    
                    const doctorTotalHours = doctorShifts.reduce((total, shift) => {
                        const doctorHours = shift.staff_names
                            .filter(staffName => unit.doctors && unit.doctors.includes(staffName))
                            .length * shift.total_hours;
                        return total + doctorHours;
                    }, 0);

                    // è™•ç†è­·ç†å¸«æ’ç­è³‡æ–™
                    for (const shift of nurseShifts) {
                        const nurseNames = shift.staff_names.filter(staffName => 
                            unit.nurses && unit.nurses.includes(staffName)
                        );
                        
                        for (const nurseName of nurseNames) {
                            const timeRange = `${formatTimeHHMM(shift.start_time)}-${formatTimeHHMM(shift.end_time)}`;
                            exportData.push({
                                äº‹æ¥­å–®ä½åç¨±: unit.name,
                                ç•¶æœˆè­·ç†å¸«æ’ç­æ™‚æ•¸: nurseTotalHours,
                                æ’ç­æ—¥æœŸ: shift.shift_date,
                                æ™‚é–“: timeRange,
                                è­·ç†å¸«å: nurseName,
                                ç•¶æœˆé†«å¸«æ’ç­æ™‚æ•¸: '',
                                é†«å¸«æ’ç­æ—¥æœŸ: '',
                                é†«å¸«æ™‚é–“: '',
                                é†«å¸«å: ''
                            });
                        }
                    }

                    // è™•ç†é†«å¸«æ’ç­è³‡æ–™
                    for (const shift of doctorShifts) {
                        const doctorNames = shift.staff_names.filter(staffName => 
                            unit.doctors && unit.doctors.includes(staffName)
                        );
                        
                        for (const doctorName of doctorNames) {
                            const timeRange = `${formatTimeHHMM(shift.start_time)}-${formatTimeHHMM(shift.end_time)}`;
                            exportData.push({
                                äº‹æ¥­å–®ä½åç¨±: unit.name,
                                ç•¶æœˆè­·ç†å¸«æ’ç­æ™‚æ•¸: '',
                                æ’ç­æ—¥æœŸ: '',
                                æ™‚é–“: '',
                                è­·ç†å¸«å: '',
                                ç•¶æœˆé†«å¸«æ’ç­æ™‚æ•¸: doctorTotalHours,
                                é†«å¸«æ’ç­æ—¥æœŸ: shift.shift_date,
                                é†«å¸«æ™‚é–“: timeRange,
                                é†«å¸«å: doctorName
                            });
                        }
                    }
                }

                // æŒ‰æ—¥æœŸå’Œæ™‚é–“æ’åº
                exportData.sort((a, b) => {
                    const dateA = new Date(a.æ’ç­æ—¥æœŸ || a.é†«å¸«æ’ç­æ—¥æœŸ);
                    const dateB = new Date(b.æ’ç­æ—¥æœŸ || b.é†«å¸«æ’ç­æ—¥æœŸ);
                    if (dateA.getTime() !== dateB.getTime()) {
                        return dateA - dateB;
                    }
                    
                    const timeA = a.æ™‚é–“ || a.é†«å¸«æ™‚é–“;
                    const timeB = b.æ™‚é–“ || b.é†«å¸«æ™‚é–“;
                    if (timeA && timeB) {
                        return timeA.localeCompare(timeB);
                    }
                    return 0;
                });

                // å‰µå»ºå·¥ä½œè¡¨
                const ws = XLSX.utils.json_to_sheet(exportData);

                // è¨­å®šæ¬„å¯¬
                const colWidths = [
                    { wch: 20 }, // äº‹æ¥­å–®ä½åç¨±
                    { wch: 15 }, // ç•¶æœˆè­·ç†å¸«æ’ç­æ™‚æ•¸
                    { wch: 12 }, // æ’ç­æ—¥æœŸ
                    { wch: 15 }, // æ™‚é–“
                    { wch: 15 }, // è­·ç†å¸«å
                    { wch: 15 }, // ç•¶æœˆé†«å¸«æ’ç­æ™‚æ•¸
                    { wch: 12 }, // é†«å¸«æ’ç­æ—¥æœŸ
                    { wch: 15 }, // é†«å¸«æ™‚é–“
                    { wch: 15 }  // é†«å¸«å
                ];
                ws['!cols'] = colWidths;

                // å‰µå»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'æ’ç­è³‡æ–™');

                // ç”Ÿæˆæª”æ¡ˆåç¨±
                const fileName = `é†«ç™‚æ’ç­è³‡æ–™_${currentYear}å¹´${currentMonth}æœˆ_${new Date().toISOString().split('T')[0]}.xlsx`;

                // ä¸‹è¼‰æª”æ¡ˆ
                XLSX.writeFile(wb, fileName);
                
                console.log('Excelæª”æ¡ˆåŒ¯å‡ºå®Œæˆ');
                alert(`æ’ç­è³‡æ–™å·²æˆåŠŸåŒ¯å‡ºç‚ºExcelæª”æ¡ˆï¼š${fileName}`);
                
            } catch (error) {
                console.error('åŒ¯å‡ºExcelå¤±æ•—:', error);
                alert('åŒ¯å‡ºExcelå¤±æ•—ï¼š' + error.message);
            }
        }

        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeShiftModal();
            }
        });

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        document.getElementById('shiftModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeShiftModal();
            }
        });
    </script>
</body>
</html>
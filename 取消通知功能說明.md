# 📧 排班取消通知功能說明

## 🎯 功能說明

當排班被取消或醫師被移除時，系統會自動發送取消通知給相關的醫師。

---

## ✨ 功能特點

### 1. **刪除排班時自動通知**
- ✅ 刪除排班前會顯示詳細的確認訊息
- ✅ 如果有設定郵件的醫師，會提示將發送取消通知
- ✅ 刪除後自動發送取消通知給所有參與者
- ✅ 顯示發送通知的人數

### 2. **編輯排班時的智能更新**
- ✅ 修改排班資訊時，自動更新行事曆
- ✅ 參與者會收到更新通知
- ✅ 時間、地點變更都會通知

### 3. **完整的資訊提示**
- ✅ 刪除前確認訊息包含完整排班資訊
- ✅ 明確提示是否會發送通知
- ✅ 刪除後顯示操作結果和通知狀態

---

## 📋 使用流程

### 刪除排班流程

```
1. 點擊「刪除」按鈕
   ↓
2. 顯示確認對話框
   - 排班詳細資訊
   - 日期、時間、單位、人員
   - 是否會發送取消通知
   ↓
3. 確認刪除
   ↓
4. 系統執行：
   - 獲取行事曆事件資訊
   - 確認參與者數量
   - 刪除行事曆事件
   - 發送取消通知給所有參與者
   - 從 Google Sheets 刪除排班
   ↓
5. 顯示成功訊息
   - 確認已刪除
   - 顯示已發送取消通知的人數
```

---

## 💬 通知訊息範例

### 刪除前的確認訊息

```
確定要刪除這個排班嗎？

日期：2026-01-20
時間：09:00 - 17:00
單位：台北醫院
人員：王醫師, 李醫師, 陳護理師

⚠️ 注意：將自動發送取消通知給已設定郵件的醫師
```

### 刪除成功訊息

```
✅ 刪除成功！

📅 已同步刪除行事曆事件
📧 已發送取消通知給 2 位參與者
```

---

## 📧 醫師收到的取消通知

### 郵件主旨
```
已取消：[台北醫院] - 排班 @ 2026年1月20日 09:00 - 17:00
```

### 郵件內容
- 🗓️ **事件已取消**
- 📅 原定日期與時間
- 🏢 事業單位名稱
- 📍 地點資訊
- 👤 組織者資訊
- ❌ 標示為「已取消」狀態

### 醫師的行事曆
- ✅ 事件自動從行事曆中移除
- ✅ 如果已接受，會標示為已取消
- ✅ 不會再顯示在行事曆上

---

## 🔍 功能詳解

### 1. 智能通知判斷

系統會自動判斷是否需要發送通知：

```javascript
// 判斷邏輯
if (排班有行事曆事件 && 啟用自動同步) {
    if (人員有設定郵件) {
        → 顯示「將發送取消通知」
        → 刪除時發送通知
    } else {
        → 只刪除事件，不發送通知
    }
}
```

### 2. 參與者資訊獲取

刪除前會先獲取事件資訊：

```javascript
// 流程
1. 獲取行事曆事件詳情
2. 讀取參與者列表
3. 計算參與者數量
4. 顯示在確認訊息中
5. 刪除時發送通知給所有人
```

### 3. 取消通知設定

使用 Google Calendar API 的標準取消機制：

```javascript
gapi.client.calendar.events.delete({
    calendarId: 'primary',
    eventId: eventId,
    sendUpdates: 'all'  // 發送取消通知給所有參與者
});
```

---

## ⚙️ 設定要求

### 必要條件

1. **啟用自動同步**
   - 在「⚙️ 設定」頁籤勾選
   - 「啟用自動同步到 Google 行事曆」

2. **設定醫師郵件**
   - 在「📧 醫師郵件」頁籤設定
   - 填入醫師的 Gmail 地址

3. **排班已同步到行事曆**
   - 排班必須有 eventId
   - 表示已建立行事曆事件

### 可選設定

- **自訂取消訊息**：目前使用 Google 的預設取消通知
- **通知語言**：跟隨 Google 帳號設定的語言

---

## 📊 不同情況的處理

### 情況 1：排班有行事曆事件，醫師有郵件

```
刪除排班
  ↓
確認訊息顯示「將發送取消通知」
  ↓
刪除並發送通知
  ↓
醫師收到取消郵件 ✅
```

### 情況 2：排班有行事曆事件，醫師無郵件

```
刪除排班
  ↓
確認訊息不提示通知
  ↓
只刪除事件，不發送通知
  ↓
行事曆事件被移除 ✅
```

### 情況 3：排班沒有行事曆事件

```
刪除排班
  ↓
只顯示排班資訊
  ↓
從 Google Sheets 刪除
  ↓
無需處理行事曆 ✅
```

### 情況 4：自動同步未啟用

```
刪除排班
  ↓
只從 Google Sheets 刪除
  ↓
不處理行事曆
  ↓
手動管理行事曆 ⚠️
```

---

## 🔔 通知觸發時機

| 操作 | 是否通知 | 通知內容 |
|------|---------|---------|
| 刪除排班 | ✅ 是 | 取消通知 |
| 編輯排班（修改時間） | ✅ 是 | 更新通知 |
| 編輯排班（修改人員） | ✅ 是 | 更新通知 |
| 編輯排班（修改地點） | ✅ 是 | 更新通知 |
| 新增排班 | ✅ 是 | 邀請通知 |
| 手動刪除行事曆事件 | ❌ 否 | - |

---

## 💡 最佳實踐

### 1. 刪除前確認

- ✅ 仔細閱讀確認訊息
- ✅ 確認是否會通知醫師
- ✅ 確認排班資訊正確

### 2. 通知管理

- ✅ 確保醫師郵件設定正確
- ✅ 定期更新郵件資料
- ✅ 提醒醫師注意郵件通知

### 3. 測試建議

- ✅ 先用測試排班測試通知功能
- ✅ 確認醫師能收到取消通知
- ✅ 檢查郵件內容是否正確

---

## 🆘 常見問題

### Q1：醫師沒收到取消通知？

**可能原因：**
1. 醫師沒有設定郵件
2. 郵件地址錯誤
3. 郵件進入垃圾郵件
4. 自動同步未啟用

**解決方法：**
1. 檢查「📧 醫師郵件」設定
2. 確認郵件地址正確
3. 提醒醫師檢查垃圾郵件
4. 確認啟用自動同步

### Q2：刪除時沒有提示會發送通知？

**可能原因：**
- 該醫師未設定郵件
- 排班沒有行事曆事件
- 自動同步未啟用

**檢查方法：**
1. 查看「📧 醫師郵件」是否有該醫師
2. 檢查排班是否有 eventId
3. 確認自動同步狀態

### Q3：可以不發送取消通知嗎？

**目前機制：**
- 如果啟用自動同步，刪除時會自動發送
- 這是 Google Calendar 的標準行為

**替代方案：**
- 暫時關閉自動同步
- 手動在 Google 行事曆中管理

### Q4：取消通知的郵件內容可以自訂嗎？

**目前狀態：**
- 使用 Google Calendar 的預設取消通知
- 內容由 Google 自動生成

**未來可能：**
- 可考慮在原有備註中加入取消原因
- 這會顯示在行事曆事件中

---

## 📝 Console 日誌參考

### 正常刪除流程

```javascript
🗑️ 同步刪除行事曆事件並發送取消通知：abc123xyz
🗑️ 自動刪除行事曆事件：abc123xyz
📧 事件有 2 位參與者
✅ 行事曆事件已刪除
📧 已發送取消通知給 2 位參與者
```

### 無參與者的刪除

```javascript
🗑️ 同步刪除行事曆事件並發送取消通知：abc123xyz
🗑️ 自動刪除行事曆事件：abc123xyz
📧 事件有 0 位參與者
✅ 行事曆事件已刪除
```

---

## 🔄 版本資訊

**版本**：4.3.0
**更新日期**：2026-01-17
**新增功能**：
- ✨ 刪除排班時自動發送取消通知
- ✨ 刪除前顯示詳細確認訊息
- ✨ 顯示參與者數量和通知狀態
- ✨ 智能判斷是否需要發送通知

---

## 🎉 總結

### 功能優點

1. **自動化**：無需手動通知醫師
2. **準確性**：只通知有設定郵件的醫師
3. **透明度**：清楚顯示通知狀態
4. **整合性**：與 Google Calendar 完美整合

### 使用建議

1. 確保醫師郵件設定完整
2. 啟用自動同步功能
3. 刪除前仔細確認
4. 定期檢查通知狀態

現在您的排班系統已具備完整的取消通知功能！🎉

# 🔧 登入問題故障排除指南

## 現在遇到的問題
無法在 `http://localhost:8000/shift_management_system_sheets_full.html` 登入 Google 帳號

---

## ✅ 完整檢查清單

### 步驟 1：確認 HTTP Server 正在執行

在 PowerShell 中執行：
```powershell
cd C:\Users\josie\staff-scheduling-system
python -m http.server 8000
```

應該看到：
```
Serving HTTP on :: port 8000 (http://[::]:8000/) ...
```

**保持這個視窗開啟！**

---

### 步驟 2：確認 OAuth 同意畫面設定完整

前往：https://console.cloud.google.com/apis/credentials/consent

點擊「編輯應用程式」，確認以下設定：

#### 📋 第一頁：OAuth 同意畫面
```
✅ 應用程式名稱：Medical Shift System（必填）
✅ 使用者支援電子郵件：選擇您的 Gmail（必填）
✅ 開發人員聯絡資訊：輸入您的 Gmail（必填）
```
點擊「儲存並繼續」

#### 🔐 第二頁：範圍
```
點擊「新增或移除範圍」
搜尋：calendar
✅ 勾選：https://www.googleapis.com/auth/calendar
或
✅ 勾選：https://www.googleapis.com/auth/calendar.events

點擊「更新」
點擊「儲存並繼續」
```

#### 👤 第三頁：測試使用者（最重要！）
```
點擊「+ ADD USERS」
輸入您要登入的完整 Gmail 地址
點擊「新增」
✅ 確認看到您的 Gmail 出現在列表中
點擊「儲存並繼續」
```

#### ✅ 第四頁：摘要
```
檢查所有設定
點擊「返回資訊主頁」
```

---

### 步驟 3：確認 OAuth 用戶端 ID 設定

前往：https://console.cloud.google.com/apis/credentials

找到您的 OAuth 2.0 用戶端 ID（類型應該是「網頁應用程式」）

#### 點擊編輯（鉛筆圖示）

**已授權的 JavaScript 來源：**
```
http://localhost:8000
```

**已授權的重新導向 URI：**

⚠️ **重要**：對於 Google Identity Services (GIS)，您需要新增以下 URI：

```
http://localhost:8000
http://localhost:8000/
http://localhost:8000/shift_management_system_sheets_full.html
https://localhost:8000
https://localhost:8000/
```

**為什麼需要這麼多？**
- GIS 可能會使用不同的 URI 格式
- 包含有/無結尾斜線的版本
- 包含 HTTP 和 HTTPS 版本（以防萬一）

點擊「儲存」

---

### 步驟 4：在系統中設定用戶端 ID

1. **開啟系統**
   ```
   http://localhost:8000/shift_management_system_sheets_full.html
   ```

2. **點擊「⚙️ 設定」**

3. **找到「Google API 設定」區域**

4. **貼上用戶端 ID**
   - 格式應該像：`63810182329-xxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com`
   - 確保沒有多餘的空格

5. **點擊「儲存設定」**

6. **確認看到「✅ 設定已儲存」訊息**

---

### 步驟 5：清除快取並測試

1. **清除瀏覽器快取**
   ```
   按 Ctrl + Shift + Delete
   勾選：
   ☑️ Cookie 和其他網站資料
   ☑️ 快取的圖片和檔案
   點擊「清除資料」
   ```

2. **關閉所有瀏覽器視窗**

3. **等待 2-3 分鐘**（讓 Google 同步設定）

4. **重新開啟瀏覽器**

5. **訪問系統**
   ```
   http://localhost:8000/shift_management_system_sheets_full.html
   ```

6. **點擊頂部的「🔐 登入 Google」按鈕**

7. **選擇您的 Google 帳號**（應該是測試使用者中的帳號）

8. **授權應用程式**

---

## 🐛 常見錯誤訊息及解決方法

### 錯誤 1：「Access blocked: This app's request is invalid」
或 「Error 400: invalid_request」

**原因**：OAuth 同意畫面設定不完整

**解決**：
1. 前往 OAuth 同意畫面
2. 點擊「編輯應用程式」
3. 確保所有必填欄位都已填寫：
   - 應用程式名稱
   - 使用者支援電子郵件
   - 開發人員聯絡資訊
4. 儲存所有頁面

---

### 錯誤 2：「Access blocked: Medical Shift System has not completed the Google verification process」

**原因**：未加入測試使用者

**解決**：
1. 前往 OAuth 同意畫面
2. 點擊「編輯應用程式」
3. 到「測試使用者」頁面
4. 點擊「+ ADD USERS」
5. 輸入您的完整 Gmail 地址
6. 儲存

---

### 錯誤 3：「redirect_uri_mismatch」

**原因**：重新導向 URI 設定不正確

**解決**：
1. 前往憑證頁面
2. 編輯您的 OAuth 2.0 用戶端 ID
3. 在「已授權的重新導向 URI」中新增：
   ```
   http://localhost:8000
   http://localhost:8000/
   http://localhost:8000/shift_management_system_sheets_full.html
   ```
4. 儲存後等待 5 分鐘

---

### 錯誤 4：登入按鈕沒有反應

**原因**：用戶端 ID 未設定或設定錯誤

**解決**：
1. 按 F12 開啟開發者工具
2. 切換到「Console」頁籤
3. 點擊「🔐 登入 Google」
4. 查看是否有錯誤訊息
5. 如果看到「請先在 Google Cloud Console 設定用戶端 ID」
   - 回到設定頁面
   - 重新貼上用戶端 ID
   - 確保儲存成功

---

### 錯誤 5：「idpiframe_initialization_failed」

**原因**：Cookie 被封鎖或 HTTP Server 未正確執行

**解決方法 A：檢查 Cookie 設定**
1. 瀏覽器設定 → 隱私權和安全性
2. Cookie 和網站資料
3. 確保「允許所有 Cookie」或「封鎖第三方 Cookie」已關閉

**解決方法 B：使用其他瀏覽器**
- 嘗試使用 Chrome 或 Edge
- 確保瀏覽器已更新到最新版本

**解決方法 C：確認 HTTP Server**
```powershell
# 停止現有的 server（Ctrl+C）
# 重新啟動
cd C:\Users\josie\staff-scheduling-system
python -m http.server 8000
```

---

## 🔍 進階除錯

### 使用瀏覽器開發者工具

1. **按 F12 開啟開發者工具**

2. **切換到「Console」頁籤**

3. **點擊「🔐 登入 Google」**

4. **查看錯誤訊息**

常見的訊息：
- `Client ID not configured` → 需要設定用戶端 ID
- `popup_closed_by_user` → 您關閉了授權視窗，再試一次
- `access_denied` → 您拒絕了授權，需要重新登入並同意
- `invalid_client` → 用戶端 ID 錯誤或專案設定有問題

---

## 📋 完整檢查清單（按順序執行）

```
□ HTTP Server 正在執行（port 8000）
□ Google Calendar API 已啟用
□ OAuth 同意畫面已填寫完整：
  □ 應用程式名稱
  □ 使用者支援電子郵件
  □ 開發人員聯絡資訊
  □ 已新增 calendar 範圍
  □ 已新增測試使用者（您的 Gmail）
□ OAuth 用戶端 ID 設定：
  □ 類型是「網頁應用程式」
  □ 已新增 JavaScript 來源：http://localhost:8000
  □ 已新增所有重新導向 URI
□ 在系統中正確設定用戶端 ID
□ 已清除瀏覽器快取
□ 等待 2-3 分鐘後再測試
```

---

## 🆘 如果還是無法登入

請提供以下資訊：

1. **瀏覽器 Console 的完整錯誤訊息**
   - 按 F12 → Console 頁籤
   - 截圖所有紅色錯誤訊息

2. **OAuth 同意畫面截圖**
   - 隱藏敏感資訊
   - 顯示測試使用者列表

3. **憑證設定截圖**
   - 顯示重新導向 URI 列表

4. **系統行為描述**
   - 點擊登入按鈕後發生什麼？
   - 有沒有彈出視窗？
   - 彈出視窗顯示什麼內容？

---

## ✅ 成功登入的標誌

當登入成功時，您應該看到：

1. **頂部按鈕變化**
   - 「🔐 登入 Google」變成「👤 您的名字」
   - 出現「登出」按鈕

2. **Console 訊息**（按 F12 查看）
   ```
   ✅ 登入成功
   ✅ 已取得存取權杖
   ```

3. **可以正常使用功能**
   - 上傳排班到行事曆
   - 匯出資料到 Google Sheets

---

**最後更新**：2025-11-11
**版本**：v1.0



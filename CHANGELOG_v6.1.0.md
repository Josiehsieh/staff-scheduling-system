# 📋 更新日誌 - v6.1.0

## 🎉 重複排程功能上線！

**發布日期**：2025-11-05  
**版本**：v6.1.0

---

## ✨ 新增功能

### 🔄 重複排程系統

全新的重複排程功能，讓您能夠一次建立多個排班！

#### 核心功能

1. **四種重複頻率**
   - 每天：連續每天排班
   - 每週：每週固定星期排班
   - 每兩週：隔週固定星期排班
   - 每月：每月固定日期排班

2. **靈活的結束條件**
   - 重複次數：指定建立幾次排班（1-52次）
   - 重複至日期：指定結束日期，自動計算排班

3. **星期選擇器**（每週/每兩週模式）
   - 可多選星期（例如：同時選一、三、五）
   - 預設為基準日期的星期
   - 視覺化勾選介面

4. **即時預覽**
   - 顯示將建立的排班總數
   - 列出前 10 個排班日期和星期
   - 設定變更時即時更新

5. **批量建立進度**
   - 即時進度顯示（X / 總數）
   - 防止用戶誤關閉視窗
   - 完成後顯示成功/失敗統計

#### 使用者介面

- **黃色突顯區塊**：重複設定區域使用黃色背景和邊框，易於識別
- **展開/收合設計**：預設隱藏，勾選後展開詳細設定
- **智能顯示**：根據選擇的頻率動態顯示/隱藏星期選擇器
- **藍色預覽框**：使用藍色邊框和背景的預覽區域

#### 技術實現

- **JavaScript 函數**
  - `toggleRepeatOptions()` - 切換重複選項顯示
  - `updateRepeatOptions()` - 更新界面（顯示/隱藏星期選擇）
  - `updateRepeatEndOptions()` - 切換重複次數/結束日期
  - `updateRepeatPreview()` - 即時更新預覽
  - `generateRepeatDates()` - 生成所有重複日期

- **增強的 `saveShift()` 函數**
  - 檢測是否啟用重複排程
  - 編輯模式自動跳過重複功能
  - 批量建立排班（含進度追蹤）
  - 完整的錯誤處理和統計

- **更新的 `clearShiftForm()` 函數**
  - 清除重複排程設定
  - 重置為預設值（每週重複 4 次）
  - 重置星期選擇（預設星期一）

#### 防呆機制

1. **驗證檢查**
   - 未選擇基準日期時顯示警告
   - 沒有生成日期時提示檢查設定
   - 建立前顯示確認對話框

2. **API 保護**
   - 每次請求間隔 100ms，避免觸發 Google API 限制
   - 錯誤重試機制
   - 失敗日期記錄

3. **使用者體驗**
   - 建立過程中顯示「請勿關閉視窗」提示
   - 完成後顯示詳細的成功/失敗統計
   - 失敗時列出具體的失敗日期

---

## 📊 功能統計

- **新增 HTML 元素**：~100 行（表單控制項）
- **新增 JavaScript 代碼**：~220 行（邏輯實現）
- **新增 CSS 樣式**：整合在 HTML 中（inline styles）
- **支援的重複模式**：4 種
- **最大重複次數**：52 次
- **最大日期範圍**：365 天

---

## 📖 文檔

新增兩份完整的使用指南：

1. **重複排程功能指南.md**
   - 完整功能說明
   - 詳細使用步驟
   - 4 個實際範例
   - 常見問題解答
   - 技術細節說明

2. **重複排程快速開始.md**
   - 5 步驟快速上手
   - 2 個快速範例
   - 注意事項
   - 使用技巧

---

## 🔧 技術改進

### 日期生成演算法

實現了智能的日期生成邏輯：

- **每天模式**：線性遞增
- **每週模式**：檢查星期匹配
- **每兩週模式**：計算週差，雙週檢查
- **每月模式**：匹配日期數字（自動跳過不存在的日期）

### 性能優化

- 使用快取避免重複計算
- 限制最大迭代次數（防止無限迴圈）
- 批次處理時的進度更新優化

### 錯誤處理

- Try-catch 包裹所有關鍵操作
- 詳細的 console 日誌
- 使用者友好的錯誤訊息
- 失敗追蹤和報告

---

## 🎨 使用者介面更新

### 新增的 UI 元素

1. **重複排程區塊**
   - 背景色：`#fff3cd`（淺黃色）
   - 邊框：`2px solid #ffc107`（黃色）
   - 圓角：8px

2. **星期選擇按鈕**
   - 邊框：`2px solid #ddd`
   - Hover 效果
   - 勾選視覺回饋

3. **預覽區域**
   - 背景色：`#e7f3ff`（淺藍色）
   - 左邊框：`4px solid #2196f3`（藍色）
   - 最大高度 150px，可捲動

4. **進度對話框**
   - 固定定位，居中顯示
   - 白色背景，圓角 10px
   - 陰影效果
   - Z-index：10000（最上層）

---

## 📋 兼容性

- ✅ 與現有排班系統完全兼容
- ✅ 不影響現有排班的編輯和刪除
- ✅ 編輯模式自動禁用重複功能
- ✅ 所有瀏覽器支援（Chrome、Edge、Firefox、Safari）
- ✅ 與 Google Sheets API 完全兼容
- ✅ 與 Google Calendar 整合功能兼容

---

## 🔮 未來規劃

可能的功能增強（依需求而定）：

1. 🔄 **自訂排除日期**：在重複排程中排除特定日期（如假日）
2. 📅 **範本功能**：儲存常用的重複設定為範本
3. 👥 **輪值排班**：不同日期使用不同人員
4. ⏰ **時間變化**：不同日期使用不同時間
5. 🔔 **衝突檢測**：建立前檢查是否與現有排班衝突

---

## 🐛 已知限制

1. **編輯不支援重複**：編輯現有排班時無法使用重複功能
2. **統一設定**：所有重複排班使用相同的時間、人員、地點
3. **最大次數**：限制為 52 次（一年）
4. **無自動衝突檢測**：需手動確認是否與現有排班重複

---

## 📝 使用建議

1. **測試先行**：首次使用時設定少量次數測試
2. **檢查預覽**：儲存前務必檢查預覽的日期
3. **分批建立**：大量排班建議分批次建立
4. **備份資料**：定期匯出排班資料作為備份

---

## 🙏 使用回饋

如果您在使用重複排程功能時遇到任何問題或有改進建議，請：

1. 記錄問題的詳細描述
2. 提供使用的設定參數
3. 截圖相關錯誤訊息
4. 聯繫系統管理員

---

## 📄 相關文件

- [重複排程功能指南.md](./重複排程功能指南.md) - 完整功能說明
- [重複排程快速開始.md](./重複排程快速開始.md) - 快速入門
- [地點選擇修復說明.md](./地點選擇修復說明.md) - v6.0.6 更新
- [GOOGLE_CALENDAR_功能指南.md](./GOOGLE_CALENDAR_功能指南.md) - 行事曆整合

---

**版本號**：v6.1.0  
**主要檔案**：`shift_management_system_sheets_full.html`  
**更新者**：AI Assistant  
**更新日期**：2025-11-05


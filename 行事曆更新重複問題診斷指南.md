# 🔍 行事曆更新重複問題診斷指南

## 📋 問題描述

**用戶反映**：系統每更新一次排班並寄email給醫師後，同步時也會在行事曆上重複一次

## 🎯 可能的原因

### 1. 瀏覽器快取問題（最常見）⭐
- 瀏覽器還在使用舊版本的代碼
- GitHub Pages 需要 3-5 分鐘部署
- 需要強制刷新才能載入最新版本

### 2. 更新邏輯錯誤
- 使用了「刪除後重建」而不是「直接更新」
- 刪除失敗但建立成功，導致重複

### 3. 多次執行問題
- 按鈕沒有禁用，用戶多次點擊
- 或程式邏輯中重複調用

### 4. EventID 不一致
- 更新時使用了錯誤的 eventId
- 或 eventId 遺失導致建立新事件

## 🧪 診斷步驟

### 步驟 1：確認版本號

```bash
1. 打開系統網站
2. 進入「⚙️ 設定」頁籤
3. 滾動到最底部
4. 查看「關於系統」區塊

應顯示：
✅ 版本：4.2.0 (行事曆同步增強版)
✅ 更新日期：2026-01-17
✅ 新增功能：同步診斷工具、完善刪除通知

如果不是 4.2.0：
❌ 您使用的是舊版本！請執行步驟 2
```

### 步驟 2：強制刷新清除快取

**Windows / Linux：**
```
按住 Ctrl + Shift + R
或
按住 Ctrl + F5
```

**Mac：**
```
按住 Cmd + Shift + R
或
按住 Cmd + Option + R
```

**手動清除快取：**
```
Chrome/Edge:
1. 按 F12 打開開發者工具
2. 右鍵點擊刷新按鈕
3. 選擇「清空快取並強制重新載入」

Firefox:
1. 設定 → 隱私權與安全性
2. Cookie 與網站資料 → 清除資料
3. 勾選「快取的網頁內容」
4. 清除
```

### 步驟 3：檢查 Console 日誌

在編輯排班時觀察 Console 輸出：

**✅ 正確的更新流程（v4.2.0）：**
```javascript
// 1. 開始更新
🔄 更新行事曆事件...
🔄 自動更新行事曆事件：abc123xyz

// 2. 準備資料
📧 更新參與者列表：[{email: "doctor@gmail.com", ...}]

// 3. 執行更新
✅ 行事曆事件已更新，事件ID：abc123xyz  ← 注意：ID 不變

// 4. 發送通知
📧 已發送更新通知給 2 位人員

// 5. 完成
儲存成功！
已同步更新行事曆
```

**❌ 錯誤的更新流程（舊版本）：**
```javascript
// 1. 刪除舊事件
🗑️ 刪除舊的行事曆事件...
🗑️ 自動刪除行事曆事件：abc123xyz
✅ 行事曆事件已刪除

// 2. 建立新事件
📅 建立新的行事曆事件...
🔄 開始自動同步到行事曆...
✅ 自動同步成功，事件ID：xyz789new  ← 注意：ID 變了！

// 問題：如果刪除失敗但建立成功 → 兩個事件同時存在
```

### 步驟 4：檢查按鈕行為

編輯排班時測試：

**✅ 正確行為：**
```
1. 點擊「儲存」按鈕
2. 按鈕立即變灰且無法點擊
3. 顯示「處理中...」或按鈕不可用
4. 完成後按鈕恢復正常
```

**❌ 錯誤行為：**
```
1. 點擊「儲存」按鈕
2. 按鈕仍然可以點擊
3. 可以連續點擊多次
4. 每次點擊都執行一次儲存
→ 這是舊版本的行為！
```

### 步驟 5：實際測試

**完整測試流程：**

```bash
# 準備階段
1. 清除瀏覽器快取（Ctrl + Shift + R）
2. 確認版本是 4.2.0
3. 確認已登入並授權 Google Calendar
4. 打開 Google 行事曆備查（另開視窗）
5. 打開 F12 開發者工具，切換到 Console 頁籤

# 測試 1：建立新排班
步驟：
a) 新增一個測試排班
   - 日期：選擇明天
   - 時間：09:00 - 17:00
   - 單位：測試單位
   - 人員：選擇有設定郵件的醫師
b) 點擊「儲存」
c) 觀察 Console 日誌
d) 檢查 Google 行事曆

預期結果：
✅ Console 顯示「自動同步成功」
✅ Google 行事曆出現 1 個事件
✅ 醫師收到郵件邀請

# 測試 2：第一次更新
步驟：
a) 在排班列表找到剛才的測試排班
b) 點擊「編輯」
c) 修改時間為 10:00 - 18:00
d) 點擊「儲存」
e) 觀察 Console 日誌
f) 檢查 Google 行事曆

預期結果：
✅ Console 顯示「🔄 自動更新行事曆事件」（不是刪除+建立）
✅ Google 行事曆仍然只有 1 個事件
✅ 事件時間已更新為 10:00 - 18:00
✅ 醫師收到更新通知郵件

# 測試 3：第二次更新
步驟：
a) 再次編輯同一個排班
b) 修改備註或其他欄位
c) 點擊「儲存」
d) 檢查 Google 行事曆

預期結果：
✅ 仍然只有 1 個事件
✅ 備註已更新
❌ 不應該出現第 2 個事件

# 測試 4：多次連續編輯
步驟：
a) 連續編輯 5 次，每次修改不同欄位
b) 每次都點擊「儲存」
c) 最終檢查 Google 行事曆

預期結果：
✅ 還是只有 1 個事件
✅ 所有修改都已更新
❌ 不應該有 6 個事件（1個原始 + 5次更新）

# 測試 5：快速連點保護
步驟：
a) 編輯排班
b) 快速連續點擊「儲存」按鈕 5 次
c) 觀察按鈕狀態
d) 檢查 Google 行事曆

預期結果：
✅ 按鈕在第一次點擊後立即禁用（變灰）
✅ 只執行一次儲存
✅ 仍然只有 1 個事件
```

## 🔧 修復方案

### 方案 1：確保使用最新版本（最重要）⭐⭐⭐

```bash
# 1. 等待 GitHub Pages 部署完成
等待 5-10 分鐘

# 2. 完全清除快取
Chrome/Edge:
- 按 Ctrl + Shift + Delete
- 選擇「全部時間」
- 勾選「快取的圖片和檔案」
- 清除資料

Firefox:
- 按 Ctrl + Shift + Delete
- 選擇「全部」
- 勾選「快取」
- 立即清除

# 3. 關閉所有分頁
關閉所有與系統相關的分頁

# 4. 重新打開系統
在新分頁中開啟系統網址

# 5. 確認版本
設定頁籤底部應顯示 4.2.0
```

### 方案 2：清理現有重複事件

```bash
# 如果已經有重複事件

1. 打開 Google 行事曆
2. 在搜尋框輸入「排班」
3. 查看結果，找出重複的事件
4. 確認哪些是重複的：
   - 同一個日期、時間、單位
   - 但有多個事件
5. 保留最新的一個，刪除其他
6. 或全部刪除後在系統中重新編輯並儲存
```

### 方案 3：使用診斷工具

```bash
1. 進入「⚙️ 設定」頁籤
2. 找到「🔍 行事曆同步診斷工具」
3. 點擊「🔍 開始診斷」
4. 查看診斷報告
5. 按照建議操作
```

### 方案 4：檢查 Google API 授權

```bash
# 可能是授權問題導致 API 調用異常

1. 前往 https://myaccount.google.com/permissions
2. 找到您的排班系統應用
3. 確認已授權「Google Calendar API」
4. 如果有異常，移除授權
5. 重新登入系統並授權
```

### 方案 5：開啟無痕模式測試

```bash
# 排除快取和擴充套件影響

1. 按 Ctrl + Shift + N (Chrome/Edge)
   或 Ctrl + Shift + P (Firefox)
2. 在無痕視窗開啟系統
3. 重新登入
4. 測試編輯排班功能
5. 如果無痕模式正常：
   → 是快取或擴充套件問題
   → 清除快取並停用可疑的擴充套件
```

## 📊 問題判斷流程圖

```
開始
  │
  ▼
版本是 4.2.0？
  │
  ├─ 否 → 【最重要】強制刷新並清除快取 → 重新檢查
  │
  ▼ 是
  │
Console 顯示「🔄 更新」而不是「🗑️ 刪除」？
  │
  ├─ 否 → 瀏覽器快取問題 → 完全清除快取 → 重新載入
  │
  ▼ 是
  │
按鈕點擊後會禁用（變灰）？
  │
  ├─ 否 → 代碼未正確載入 → 關閉所有分頁 → 重新開啟
  │
  ▼ 是
  │
實際測試：編輯排班後 Google 行事曆有幾個事件？
  │
  ├─ 多個 → 記錄 Console 日誌 → 聯繫技術支援
  │
  ▼ 1個
  │
問題已解決！✅
```

## 🆘 進階診斷

如果以上方法都無效，請收集以下資訊：

### 需要的診斷資訊

```javascript
// 1. 在 Console 執行以下命令

// 檢查版本
console.log('檢查版本資訊');
console.log('頁面標題:', document.title);
console.log('HTML 檔案大小:', document.documentElement.innerHTML.length);

// 檢查 autoUpdateCalendarEvent 函數
console.log('autoUpdateCalendarEvent 存在:', typeof autoUpdateCalendarEvent);

// 檢查函數內容（查找是否使用 update API）
console.log('函數內容:', autoUpdateCalendarEvent.toString().substring(0, 500));

// 檢查是否使用舊的刪除邏輯
if (autoUpdateCalendarEvent.toString().includes('autoDeleteCalendarEvent')) {
    console.error('❌ 警告：函數中包含刪除邏輯，這是舊版本！');
} else if (autoUpdateCalendarEvent.toString().includes('events.update')) {
    console.log('✅ 正確：使用 update API');
}

// 檢查自動同步狀態
console.log('自動同步啟用:', isAutoSyncEnabled());

// 檢查醫師郵件
console.log('醫師郵件設定:', staffEmailMap);
```

### 手動檢查代碼

```bash
# 方法 1：查看頁面原始碼
1. 右鍵點擊頁面
2. 選擇「檢視網頁原始碼」
3. 按 Ctrl + F 搜尋「autoUpdateCalendarEvent」
4. 找到該函數
5. 確認是否包含：
   ✅ gapi.client.calendar.events.update
   ❌ autoDeleteCalendarEvent

# 方法 2：查看 Network
1. F12 → Network 頁籤
2. 勾選「Disable cache」
3. 刷新頁面（Ctrl + R）
4. 找到 HTML 檔案
5. 點擊 → Response 頁籤
6. 搜尋「版本：」
7. 確認版本號
```

## 📝 已知問題和解決方案

### 問題 1：版本號正確但還是重複

**原因**：可能某個特定欄位值觸發了異常邏輯

**解決**：
```
1. 記錄完整的 Console 輸出
2. 記錄排班詳細資料（日期、時間、人員、單位）
3. 檢查是否有特殊字元或空值
4. 嘗試用簡單的測試資料（英文、無特殊字元）
```

### 問題 2：第一次更新正常，第二次重複

**原因**：eventId 在第一次更新後遺失

**解決**：
```javascript
// 在 Console 檢查
const shift = allShifts[0]; // 檢查第一個排班
console.log('EventID:', shift.eventId);

// 如果 eventId 是空的或 undefined
→ Google Sheets 的 eventId 欄位沒有正確儲存
→ 檢查 Google Sheets 的第 I 欄（eventId）
```

### 問題 3：無痕模式正常，一般模式重複

**原因**：瀏覽器擴充套件干擾

**解決**：
```
1. 逐一停用擴充套件
2. 每停用一個就測試一次
3. 找出造成問題的擴充套件
4. 在該擴充套件設定中排除系統網址
```

### 問題 4：API 配額超限

**症狀**：Console 顯示 403 或 429 錯誤

**原因**：Google Calendar API 調用次數過多

**解決**：
```
1. 前往 Google Cloud Console
2. API 和服務 → 已啟用的 API 和服務
3. Google Calendar API → 配額
4. 檢查使用量
5. 如果超限，等待重置（每日）
6. 或申請提高配額
```

## ✅ 測試檢查表

請按順序完成以下檢查：

- [ ] 1. 版本號確認為 4.2.0
- [ ] 2. 已執行強制刷新（Ctrl + Shift + R）
- [ ] 3. 已完全清除瀏覽器快取
- [ ] 4. Console 顯示「🔄 更新」而不是「🗑️ 刪除」
- [ ] 5. 儲存按鈕點擊後會禁用
- [ ] 6. 測試建立新排班：只有 1 個事件 ✅
- [ ] 7. 測試第一次更新：還是 1 個事件 ✅
- [ ] 8. 測試第二次更新：還是 1 個事件 ✅
- [ ] 9. 測試連續 5 次更新：還是 1 個事件 ✅
- [ ] 10. 測試快速連點：只執行 1 次 ✅

**如果以上全部打勾，問題已解決！** 🎉

**如果仍有問題，請提供：**
1. 完整的 Console 日誌截圖
2. 測試排班的詳細資料
3. Google 行事曆的截圖（顯示重複事件）
4. 瀏覽器和版本（例如：Chrome 120）

---

**最後更新**：2026-01-17  
**對應版本**：4.2.0  
**修復提交**：facf9e4

# 🔧 事業單位時數問題修復

**版本**：v6.0.2  
**更新日期**：2025-11-03  
**問題**：無法顯示年度總時數 + 編輯時無法載入月度時數

---

## ✅ 已修復的問題

### 問題1：網頁無法顯示年度總時數

**原因：**
- 讀取 Google Sheets 時使用的範圍是 `A2:Z`（只到第26欄）
- 但月度時數資料延伸到 `AQ` 欄（第43欄）
- 導致無法讀取第26欄之後的時數資料

**修復：**
- ✅ 將所有讀取範圍從 `A2:Z` 改為 `A2:AQ`
- ✅ 確保完整讀取所有43個欄位
- ✅ 添加除錯日誌顯示每月時數計算過程

---

### 問題2：編輯時無法載入之前已輸入每個月的時數

**原因：**
- 同樣是讀取範圍問題（`A2:Z`）
- 無法讀取完整的月度時數資料

**修復：**
- ✅ 更新 `editUnit()` 函數讀取範圍
- ✅ 添加詳細的除錯日誌
- ✅ 顯示每個月的載入過程

---

## 📊 資料結構說明

### Google Sheets 欄位對照表

```
欄位 A-G（基本資訊）：
A (索引 0)  - 單位名稱
B (索引 1)  - 分散型
C (索引 2)  - 地址
D (索引 3)  - 分點資料（JSON）
E (索引 4)  - 醫生名單
F (索引 5)  - 護理師名單
G (索引 6)  - 其他人員

欄位 H-AQ（12個月時數，每月3欄）：
H (索引 7)  - 1月醫生時數
I (索引 8)  - 1月護理師時數
J (索引 9)  - 1月其他時數
K (索引 10) - 2月醫生時數
L (索引 11) - 2月護理師時數
M (索引 12) - 2月其他時數
... (以此類推)
AO (索引 40) - 12月醫生時數
AP (索引 41) - 12月護理師時數
AQ (索引 42) - 12月其他時數

總共 43 個欄位
```

### 索引計算公式

**第 N 月的時數索引：**
```javascript
醫生時數索引   = 7 + (N-1) * 3
護理師時數索引 = 8 + (N-1) * 3
其他時數索引   = 9 + (N-1) * 3
```

**範例：**
```
1月：醫生=7,  護理師=8,  其他=9
2月：醫生=10, 護理師=11, 其他=12
3月：醫生=13, 護理師=14, 其他=15
...
12月：醫生=40, 護理師=41, 其他=42
```

---

## 🔧 修復的函數

### 1. saveUnitData()
```javascript
// 修改前
range: '事業單位詳細!A2:Z'

// 修改後
range: '事業單位詳細!A2:AQ'
```

### 2. loadUnitsDetailed()
```javascript
// 修改前
range: '事業單位詳細!A2:Z'

// 修改後
range: '事業單位詳細!A2:AQ'

// 新增除錯日誌
console.log('📊 載入事業單位詳細資料：', values);
```

### 3. displayUnitsDetailedTable()
```javascript
// 新增詳細的除錯輸出
for (let i = 0; i < 12; i++) {
    const docHours = parseInt(row[7 + i * 3] || 0);
    const nurseHours = parseInt(row[8 + i * 3] || 0);
    const otherHours = parseInt(row[9 + i * 3] || 0);
    
    console.log(`月份 ${i+1}: 醫生=${docHours}h, 護理師=${nurseHours}h, 其他=${otherHours}h`);
}

console.log(`${name} 年度總計: 醫生=${docTotal}h, 護理師=${nurseTotal}h, 其他=${otherTotal}h`);
```

### 4. editUnit()
```javascript
// 修改前
range: '事業單位詳細!A2:Z'

// 修改後
range: '事業單位詳細!A2:AQ'

// 新增詳細除錯
console.log('🔧 編輯事業單位，索引：', index);
console.log('📋 載入的資料列：', row);
console.log('📊 資料列長度：', row.length);

for (let i = 0; i < 12; i++) {
    const docIdx = 7 + i * 3;
    const nurseIdx = 8 + i * 3;
    const otherIdx = 9 + i * 3;
    
    console.log(`${i+1}月: 醫生[${docIdx}]=${docValue}, 護理師[${nurseIdx}]=${nurseValue}, 其他[${otherIdx}]=${otherValue}`);
}
```

### 5. deleteUnit()
```javascript
// 修改前
range: '事業單位詳細!A2:Z'

// 修改後
range: '事業單位詳細!A2:AQ'
```

### 6. loadUnitDetailData()
```javascript
// 完全重寫，正確讀取所有資料
range: '事業單位詳細!A2:AQ'

// 讀取12個月的時數
for (let i = 0; i < 12; i++) {
    currentUnitData.monthlyHours[i + 1] = {
        doc: row[7 + i * 3] || '0',
        nurse: row[8 + i * 3] || '0',
        other: row[9 + i * 3] || '0'
    };
}

console.log('✅ 載入單位詳細資料：', currentUnitData);
```

---

## 🧪 測試步驟

### 測試1：顯示年度總時數

```
1. 重新整理網頁（Ctrl+R）
2. 到「🏢 事業單位」頁籤
3. 查看事業單位列表
4. 確認「年度總時數」欄位有正確顯示數字
5. 按 F12 打開控制台
6. 應該看到每個單位的計算日誌：
   
   月份 1: 醫生=160h, 護理師=180h, 其他=80h
   月份 2: 醫生=160h, 護理師=180h, 其他=80h
   ...
   台北診所 年度總計: 醫生=1920h, 護理師=2160h, 其他=960h
```

### 測試2：編輯載入月度時數

```
1. 點擊某個事業單位的「✏️ 編輯」按鈕
2. 捲動到表單區域
3. 檢查「每月醫師/護理師/其他人員配置時數」
4. 確認所有月份的時數都有正確載入
5. 打開控制台（F12）查看載入日誌：
   
   🔧 編輯事業單位，索引：0
   📋 載入的資料列：[...]
   📊 資料列長度：43
   🔄 開始填入月度時數...
   1月: 醫生[7]=160, 護理師[8]=180, 其他[9]=80
   2月: 醫生[10]=160, 護理師[11]=180, 其他[12]=80
   ...
   ✅ 資料載入完成
```

### 測試3：新增後顯示正確

```
1. 新增一個事業單位
2. 填寫所有12個月的時數
3. 點擊「儲存」
4. 查看列表中的年度總時數是否正確
5. 再次編輯該單位
6. 確認所有月份時數都能正確載入
```

---

## 📋 除錯指南

### 如何查看除錯資訊

**步驟：**
```
1. 按 F12 打開開發者工具
2. 切換到「Console」標籤
3. 清空控制台（點擊 🚫 圖示）
4. 執行操作（查看列表、編輯單位等）
5. 查看除錯訊息
```

### 正常的除錯訊息範例

**查看列表時：**
```
📊 載入事業單位詳細資料：
  [["台北診所", "否", "台北市", "", "王醫師,李醫師", "林護理師", "陳助理", 
    "160", "180", "80", "160", "180", "80", ...]]

月份 1: 醫生=160h, 護理師=180h, 其他=80h (索引: 7, 8, 9)
月份 2: 醫生=160h, 護理師=180h, 其他=80h (索引: 10, 11, 12)
...
台北診所 年度總計: 醫生=1920h, 護理師=2160h, 其他=960h
```

**編輯單位時：**
```
🔧 編輯事業單位，索引：0
📋 載入的資料列：["台北診所", "否", ...]
📊 資料列長度：43
🔄 開始填入月度時數...
1月: 醫生[7]=160, 護理師[8]=180, 其他[9]=80
2月: 醫生[10]=160, 護理師[11]=180, 其他[12]=80
...
12月: 醫生[40]=160, 護理師[41]=180, 其他[42]=80
✅ 資料載入完成
```

---

## ⚠️ 注意事項

### 1. 需要重新整理
```
修復後第一次使用時，請：
1. Ctrl+Shift+R 強制重新整理
2. 清除快取
3. 或使用無痕模式測試
```

### 2. 舊資料相容性
```
✅ 完全相容舊資料
✅ 不需要修改 Google Sheets
✅ 不需要重新匯入資料
✅ 只要重新整理網頁即可
```

### 3. 控制台日誌
```
新增了很多除錯日誌，方便排查問題
如果覺得訊息太多，可以在控制台過濾：
- 點擊「Default levels」下拉選單
- 取消勾選「Verbose」或「Info」
```

---

## 📊 效果對比

### 修復前

| 功能 | 狀態 | 顯示 |
|------|------|------|
| 年度總時數 | ❌ 錯誤 | 0h / 0h / 0h |
| 編輯載入時數 | ❌ 失敗 | 所有月份空白 |
| 資料列長度 | ⚠️ 不完整 | 只讀取到第26欄 |
| 除錯資訊 | ⚠️ 簡單 | 無詳細日誌 |

### 修復後

| 功能 | 狀態 | 顯示 |
|------|------|------|
| 年度總時數 | ✅ 正確 | 1920h / 2160h / 960h |
| 編輯載入時數 | ✅ 成功 | 所有月份正確顯示 |
| 資料列長度 | ✅ 完整 | 讀取到第43欄 |
| 除錯資訊 | ✅ 詳細 | 完整的載入日誌 |

---

## 🎯 快速驗證

**1分鐘快速檢查：**

```
□ 重新整理網頁（Ctrl+Shift+R）
□ 到事業單位頁籤
□ 查看「年度總時數」欄位是否有數字
□ 點擊「編輯」按鈕
□ 檢查月度時數是否都有載入
□ 打開 F12 查看控制台日誌
□ 確認沒有紅色錯誤訊息
```

**如果都正常 → 修復成功！✅**

---

## 🔄 版本資訊

**v6.0.2 改進：**

1. ✅ **修正讀取範圍**
   - 從 `A2:Z` 改為 `A2:AQ`
   - 確保讀取完整的43個欄位

2. ✅ **年度總時數計算**
   - 正確計算所有12個月的時數
   - 添加詳細的計算日誌

3. ✅ **編輯功能修復**
   - 正確載入所有月份的時數
   - 添加完整的載入日誌

4. ✅ **除錯支援**
   - 詳細的控制台日誌
   - 顯示每個步驟的狀態

---

## 📚 相關文檔

| 文檔 | 用途 |
|------|------|
| `事業單位時數問題修復.md` | 本文件 |
| `事業單位儲存問題排解.md` | 儲存失敗問題 |
| `GOOGLE_SHEETS_SETUP_GUIDE.md` | Google Sheets 設定 |

---

## ✅ 檢查清單

修復後請確認：

```
□ 年度總時數正確顯示
□ 編輯時月度時數正確載入
□ 控制台有詳細的除錯日誌
□ 沒有紅色錯誤訊息
□ 新增和編輯功能都正常
□ 資料列長度顯示為 43
```

---

**🎉 問題已修復！現在年度總時數和月度時數都能正確顯示和載入了！**

**版本**：v6.0.2  
**狀態**：✅ 已修復  
**最後更新**：2025-11-03


<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«ç™‚æ’ç­ç®¡ç†ç³»çµ± - Google Sheets ç‰ˆ</title>
    
    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        /* ========== åŸºæœ¬æ¨£å¼ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-container {
            max-width: 500px;
            width: 100%;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .login-container h1 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .login-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .login-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .main-app {
            display: none;
        }

        .container {
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .user-info {
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* ========== å°èˆªæ¨™ç±¤ ========== */
        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            text-align: center;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* ========== å…§å®¹å€åŸŸ ========== */
        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            min-height: calc(100vh - 250px);
        }

        .tab-content.active {
            display: block;
        }

        /* ========== è¡¨å–®æ¨£å¼ ========== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* ========== æŒ‰éˆ•æ¨£å¼ ========== */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        /* ========== è¡¨æ ¼æ¨£å¼ ========== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background: #f8f9fa;
            color: #667eea;
            font-weight: bold;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* ========== æœˆä»½æ™‚æ•¸è¼¸å…¥æ¨£å¼ ========== */
        .month-hours-input {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .month-hours-input label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            font-size: 14px;
        }

        .month-hours-input input {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 13px;
        }

        .month-hours-input input:last-child {
            margin-bottom: 0;
        }

        .month-hours-input input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* ========== åˆ†é»ç®¡ç†æ¨£å¼ ========== */
        .branch-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        .branch-item input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .branch-item input:last-of-type {
            margin-bottom: 0;
        }

        .branch-remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .branch-remove-btn:hover {
            background: #c82333;
        }

        /* ========== éšæ®µ2ï¼šäººå“¡å‹¾é¸æ¡†æ¨£å¼ ========== */
        .staff-checkbox-group {
            margin-bottom: 15px;
        }

        .staff-checkbox-group-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
            padding: 8px;
            background: #f0f4ff;
            border-radius: 6px;
            font-size: 14px;
        }

        .staff-checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            cursor: pointer;
            background: white;
            border: 1px solid #e8e8e8;
        }

        .staff-checkbox-item:hover {
            background: #f8f9fa;
            border-color: #667eea;
            transform: translateX(4px);
        }

        .staff-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
        }

        .staff-checkbox-item label {
            margin: 0;
            cursor: pointer;
            flex: 1;
            color: #333;
            font-size: 14px;
        }

        .staff-checkbox-item.checked {
            background: #e8f0fe;
            border-color: #667eea;
        }

        .staff-count-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 8px;
        }

        /* ========== è¡Œäº‹æ›†æ¨£å¼ ========== */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-day.holiday {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-left: 4px solid #f44336;
        }

        .holiday-badge {
            display: inline-block;
            background: #f44336;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 4px;
            font-weight: bold;
        }

        .calendar-day.clickable {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .calendar-day.clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
            border: 1px solid #ddd;
        }

        .calendar-day {
            background: white;
            padding: 10px;
            min-height: 100px;
            position: relative;
        }

        .calendar-day-header {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .calendar-event {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 4px;
            cursor: pointer;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ç™»å…¥ç•«é¢ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <h1>ğŸ¥ é†«ç™‚æ’ç­ç®¡ç†ç³»çµ±</h1>
            <p style="margin-bottom: 30px; color: #666;">Google Sheets ç‰ˆæœ¬</p>
            <button id="loginBtn" class="login-btn">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
            </button>
            <div id="loginStatus" style="margin-top: 20px;"></div>
            
            <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: left;">
                <h4 style="color: #667eea; margin-bottom: 10px;">âš ï¸ ä½¿ç”¨å‰é ˆçŸ¥</h4>
                <ol style="color: #666; font-size: 14px; line-height: 1.8;">
                    <li>éœ€è¦å…ˆå®Œæˆ Google Cloud API è¨­å®š</li>
                    <li>åƒè€ƒ WEB_GOOGLE_SHEETS_SETUP.md</li>
                    <li>æº–å‚™å¥½ç”¨æˆ¶ç«¯ ID å’Œ Sheet ID</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼ -->
    <div id="mainApp" class="main-app">
        <div class="container">
            <!-- æ¨™é¡Œåˆ— -->
            <div class="header">
                <div class="header-title">ğŸ¥ é†«ç™‚æ’ç­ç®¡ç†ç³»çµ±</div>
                <div class="user-info">
                    <span id="userName">ä½¿ç”¨è€…</span>
                    <button class="logout-btn" onclick="handleLogout()">ç™»å‡º</button>
                </div>
            </div>

            <!-- å°èˆªæ¨™ç±¤ -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('calendar')">ğŸ“… æ’ç­æª¢è¦–</button>
                <button class="nav-tab" onclick="switchTab('manage')">âœï¸ æ’ç­ç®¡ç†</button>
                <button class="nav-tab" onclick="switchTab('stats')">ğŸ“Š çµ±è¨ˆå ±è¡¨</button>
                <button class="nav-tab" onclick="switchTab('units')">ğŸ¢ äº‹æ¥­å–®ä½</button>
                <button class="nav-tab" onclick="switchTab('staff')">ğŸ“§ é†«å¸«éƒµä»¶</button>
                <button class="nav-tab" onclick="switchTab('settings')">âš™ï¸ è¨­å®š</button>
            </div>

            <!-- æ’ç­æª¢è¦–é ç±¤ -->
            <div id="calendarTab" class="tab-content active">
                <h2>ğŸ“… æ’ç­æª¢è¦–</h2>
                <div class="calendar-header">
                    <button class="btn btn-primary" onclick="changeMonth(-1)">â—€ ä¸Šå€‹æœˆ</button>
                    <h3 id="currentMonth">2025å¹´11æœˆ</h3>
                    <button class="btn btn-primary" onclick="changeMonth(1)">ä¸‹å€‹æœˆ â–¶</button>
                </div>
                <div id="calendarDisplay">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>è¼‰å…¥æ’ç­è³‡æ–™ä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- æ’ç­ç®¡ç†é ç±¤ -->
            <div id="manageTab" class="tab-content">
                <h2>âœï¸ æ’ç­ç®¡ç†</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="showAddShiftForm()">â• æ–°å¢æ’ç­</button>
                    <button class="btn btn-primary" onclick="loadAllShifts()" style="margin-left: 10px;">ğŸ”„ é‡æ–°è¼‰å…¥</button>
                    <button class="btn btn-success" onclick="batchUploadToCalendar()" style="margin-left: 10px;">ğŸ“… æ‰¹é‡ä¸Šå‚³è¡Œäº‹æ›†</button>
                </div>

                <!-- åŒ¯å‡º Excel å€åŸŸ -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h4>ğŸ“¥ åŒ¯å‡º Excel</h4>
                    <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                        <div class="form-group" style="margin: 0;">
                            <label>é–‹å§‹æ—¥æœŸï¼ˆé¸å¡«ï¼‰</label>
                            <input type="date" id="exportStartDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>çµæŸæ—¥æœŸï¼ˆé¸å¡«ï¼‰</label>
                            <input type="date" id="exportEndDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <button class="btn btn-primary" onclick="exportToExcel()">ğŸ“¥ åŒ¯å‡º Excel</button>
                        <button class="btn btn-secondary" onclick="clearExportDateRange()" style="background: #6c757d;">ğŸ”„ æ¸…é™¤æ—¥æœŸ</button>
                    </div>
                    <small style="color: #666; margin-top: 10px; display: block;">ğŸ’¡ è‹¥æœªé¸æ“‡æ—¥æœŸç¯„åœï¼Œå°‡åŒ¯å‡ºæ‰€æœ‰æ’ç­è³‡æ–™</small>
                </div>

                <!-- æ–°å¢/ç·¨è¼¯è¡¨å–® -->
                <div id="shiftForm" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 id="formTitle">æ–°å¢æ’ç­</h3>
                    
                    <div class="form-group">
                        <label>æ—¥æœŸ *</label>
                        <input type="date" id="shiftDate" required onchange="updateHoursInfo()">
                        <small style="color: #666;">ğŸ’¡ é¸æ“‡æ—¥æœŸå¾Œæœƒé¡¯ç¤ºè©²æœˆå‰©é¤˜æ™‚æ•¸</small>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>é–‹å§‹æ™‚é–“ *</label>
                            <input type="time" id="startTime" value="09:00" required>
                        </div>
                        <div class="form-group">
                            <label>çµæŸæ™‚é–“ *</label>
                            <input type="time" id="endTime" value="17:00" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>äº‹æ¥­å–®ä½ * <span id="unitHoursInfo" style="color: #667eea; font-size: 12px;"></span></label>
                        <div style="display: flex; gap: 10px;">
                            <select id="shiftUnit" required style="flex: 1;" onchange="onUnitChange()">
                                <option value="">è«‹é¸æ“‡</option>
                            </select>
                            <button type="button" class="btn btn-primary" onclick="refreshUnits()" title="é‡æ–°è¼‰å…¥äº‹æ¥­å–®ä½">ğŸ”„</button>
                        </div>
                        <small style="color: #666;">ğŸ’¡ ä¸‹æ‹‰é¸å–®æœƒé¡¯ç¤ºç•¶æœˆå‰©é¤˜å¯æ’æ™‚æ•¸</small>
                    </div>

                    <div class="form-group" id="staffSelectionGroup">
                        <label>äººå“¡åå–® * <span style="font-size: 12px; color: #999;">(å¯å¤šé¸)</span></label>
                        <div id="staffCheckboxes" style="max-height: 300px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: white;">
                            <p style="text-align: center; color: #999;">è«‹å…ˆé¸æ“‡äº‹æ¥­å–®ä½</p>
                        </div>
                        <small style="color: #666;">ğŸ’¡ å¯åŒæ™‚å‹¾é¸é†«å¸«ã€è­·ç†å¸«å’Œå…¶ä»–äººå“¡ï¼Œè‡ªå‹•å¾è©²å–®ä½äººå“¡åˆ—è¡¨è¼‰å…¥</small>
                    </div>

                    <div class="form-group" id="locationSelectionGroup">
                        <label>åœ°é» *</label>
                        <div id="locationContainer">
                            <input type="text" id="location" placeholder="è«‹å…ˆé¸æ“‡äº‹æ¥­å–®ä½" readonly style="background: #f8f9fa;">
                        </div>
                        <small style="color: #666;">ğŸ’¡ æ ¹æ“šäº‹æ¥­å–®ä½é¡å‹è‡ªå‹•è¨­å®š</small>
                    </div>

                    <!-- é¡è‰²å›ºå®šç‚ºé è¨­å€¼ -->
                    <input type="hidden" id="selectedColor" value="#667eea">

                    <!-- é‡è¤‡æ’ç¨‹è¨­å®š -->
                    <div class="form-group" style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 2px solid #ffc107;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <input type="checkbox" id="repeatEnabled" onchange="toggleRepeatOptions()" style="margin-right: 10px; width: 20px; height: 20px;">
                            <label for="repeatEnabled" style="margin: 0; font-weight: bold; font-size: 16px;">ğŸ”„ å•Ÿç”¨é‡è¤‡æ’ç¨‹</label>
                        </div>
                        
                        <div id="repeatOptions" style="display: none; margin-top: 15px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label>é‡è¤‡é »ç‡ *</label>
                                    <select id="repeatFrequency" onchange="updateRepeatOptions()">
                                        <option value="daily">æ¯å¤©</option>
                                        <option value="weekly" selected>æ¯é€±</option>
                                        <option value="biweekly">æ¯å…©é€±</option>
                                        <option value="monthly">æ¯æœˆ</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>é‡è¤‡æ–¹å¼ *</label>
                                    <select id="repeatEndType" onchange="updateRepeatEndOptions()">
                                        <option value="count" selected>é‡è¤‡æ¬¡æ•¸</option>
                                        <option value="until">é‡è¤‡è‡³æ—¥æœŸ</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                                <div class="form-group" id="repeatCountGroup">
                                    <label>é‡è¤‡æ¬¡æ•¸ *</label>
                                    <input type="number" id="repeatCount" min="1" max="52" value="4" placeholder="ä¾‹å¦‚ï¼š4" onchange="updateRepeatPreview()">
                                    <small style="color: #666;">æœ€å¤š52æ¬¡</small>
                                </div>
                                
                                <div class="form-group" id="repeatUntilGroup" style="display: none;">
                                    <label>é‡è¤‡è‡³æ—¥æœŸ *</label>
                                    <input type="date" id="repeatUntil" onchange="updateRepeatPreview()">
                                </div>
                            </div>
                            
                            <!-- æ˜ŸæœŸé¸æ“‡ï¼ˆåƒ…æ¯é€±/æ¯å…©é€±é¡¯ç¤ºï¼‰ -->
                            <div class="form-group" id="weekdaySelection" style="margin-top: 15px;">
                                <label>æ˜ŸæœŸé¸æ“‡ï¼ˆæ¯é€±é‡è¤‡æ™‚ä½¿ç”¨ï¼‰</label>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; padding: 8px 12px; border: 2px solid #ddd; border-radius: 5px; cursor: pointer; background: white;">
                                        <input type="checkbox" name="weekday" value="0" style="margin-right: 5px;" onchange="updateRepeatPreview()">
                                        <span>æ—¥</span>
                                    </label>
                                    <label style="display: flex; align-items: center; padding: 8px 12px; border: 2px solid #ddd; border-radius: 5px; cursor: pointer; background: white;">
                                        <input type="checkbox" name="weekday" value="1" style="margin-right: 5px;" checked onchange="updateRepeatPreview()">
                                        <span>ä¸€</span>
                                    </label>
                                    <label style="display: flex; align-items: center; padding: 8px 12px; border: 2px solid #ddd; border-radius: 5px; cursor: pointer; background: white;">
                                        <input type="checkbox" name="weekday" value="2" style="margin-right: 5px;" onchange="updateRepeatPreview()">
                                        <span>äºŒ</span>
                                    </label>
                                    <label style="display: flex; align-items: center; padding: 8px 12px; border: 2px solid #ddd; border-radius: 5px; cursor: pointer; background: white;">
                                        <input type="checkbox" name="weekday" value="3" style="margin-right: 5px;" onchange="updateRepeatPreview()">
                                        <span>ä¸‰</span>
                                    </label>
                                    <label style="display: flex; align-items: center; padding: 8px 12px; border: 2px solid #ddd; border-radius: 5px; cursor: pointer; background: white;">
                                        <input type="checkbox" name="weekday" value="4" style="margin-right: 5px;" onchange="updateRepeatPreview()">
                                        <span>å››</span>
                                    </label>
                                    <label style="display: flex; align-items: center; padding: 8px 12px; border: 2px solid #ddd; border-radius: 5px; cursor: pointer; background: white;">
                                        <input type="checkbox" name="weekday" value="5" style="margin-right: 5px;" onchange="updateRepeatPreview()">
                                        <span>äº”</span>
                                    </label>
                                    <label style="display: flex; align-items: center; padding: 8px 12px; border: 2px solid #ddd; border-radius: 5px; cursor: pointer; background: white;">
                                        <input type="checkbox" name="weekday" value="6" style="margin-right: 5px;" onchange="updateRepeatPreview()">
                                        <span>å…­</span>
                                    </label>
                                </div>
                                <small style="color: #666;">ğŸ’¡ é¸æ“‡è¦é‡è¤‡æ’ç­çš„æ˜ŸæœŸï¼ˆé è¨­ç‚ºåŸºæº–æ—¥æœŸçš„æ˜ŸæœŸï¼‰</small>
                            </div>
                            
                            <div id="repeatPreview" style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 5px; border-left: 4px solid #2196f3;">
                                <strong>ğŸ“… é è¦½ï¼š</strong>
                                <div id="repeatPreviewText" style="margin-top: 5px; color: #333;">è«‹è¨­å®šé‡è¤‡é¸é …</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>å‚™è¨»</label>
                        <textarea id="notes" rows="3"></textarea>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="saveShift()">ğŸ’¾ å„²å­˜</button>
                        <button class="btn btn-danger" onclick="cancelShiftForm()">âŒ å–æ¶ˆ</button>
                    </div>
                </div>

                <!-- æ’ç­åˆ—è¡¨ -->
                <div id="shiftsList">
                    <p>è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- çµ±è¨ˆå ±è¡¨é ç±¤ -->
            <div id="statsTab" class="tab-content">
                <h2>ğŸ“Š çµ±è¨ˆå ±è¡¨</h2>
                
                <!-- çµ±è¨ˆç¯©é¸ -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>ç¯©é¸æ¢ä»¶</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>é–‹å§‹æ—¥æœŸ</label>
                            <input type="date" id="statsStartDate">
                        </div>
                        <div class="form-group">
                            <label>çµæŸæ—¥æœŸ</label>
                            <input type="date" id="statsEndDate">
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn btn-primary" onclick="generateStats()">ğŸ” ç”¢ç”Ÿå ±è¡¨</button>
                            <button class="btn btn-success" onclick="exportStatsToExcel()" style="margin-left: 10px;">ğŸ“¥ åŒ¯å‡ºå ±è¡¨</button>
                        </div>
                    </div>
                </div>

                <!-- çµ±è¨ˆå¡ç‰‡ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white;">
                        <h4 style="margin-bottom: 10px;">ç¸½æ’ç­æ•¸</h4>
                        <div style="font-size: 36px; font-weight: bold;" id="statTotalShifts">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; color: white;">
                        <h4 style="margin-bottom: 10px;">äº‹æ¥­å–®ä½æ•¸</h4>
                        <div style="font-size: 36px; font-weight: bold;" id="statTotalUnits">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 10px; color: white;">
                        <h4 style="margin-bottom: 10px;">åƒèˆ‡äººå“¡æ•¸</h4>
                        <div style="font-size: 36px; font-weight: bold;" id="statTotalStaff">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 20px; border-radius: 10px; color: white;">
                        <h4 style="margin-bottom: 10px;">ç¸½å·¥ä½œæ™‚æ•¸</h4>
                        <div style="font-size: 36px; font-weight: bold;" id="statTotalHours">0</div>
                    </div>
                </div>

                <!-- æŒ‰äº‹æ¥­å–®ä½çµ±è¨ˆ -->
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h3>ğŸ“ˆ æŒ‰äº‹æ¥­å–®ä½çµ±è¨ˆ</h3>
                    <div id="statsChartByUnit"></div>
                    <table class="data-table" id="statsTableByUnit">
                        <thead>
                            <tr>
                                <th>äº‹æ¥­å–®ä½</th>
                                <th>æ’ç­æ¬¡æ•¸</th>
                                <th>å·¥ä½œæ™‚æ•¸</th>
                                <th>åƒèˆ‡äººæ•¸</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableByUnitBody">
                            <tr><td colspan="4" style="text-align: center; color: #999;">è«‹é¸æ“‡æ—¥æœŸç¯„åœä¸¦é»æ“Šã€Œç”¢ç”Ÿå ±è¡¨ã€</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- æŒ‰äººå“¡çµ±è¨ˆ -->
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h3>ğŸ‘¥ æŒ‰äººå“¡çµ±è¨ˆ</h3>
                    <table class="data-table" id="statsTableByStaff">
                        <thead>
                            <tr>
                                <th>äººå“¡å§“å</th>
                                <th>æ’ç­æ¬¡æ•¸</th>
                                <th>å·¥ä½œæ™‚æ•¸</th>
                                <th>ä¸»è¦å–®ä½</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableByStaffBody">
                            <tr><td colspan="4" style="text-align: center; color: #999;">è«‹é¸æ“‡æ—¥æœŸç¯„åœä¸¦é»æ“Šã€Œç”¢ç”Ÿå ±è¡¨ã€</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- æŒ‰æœˆä»½çµ±è¨ˆ -->
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h3>ğŸ“… æŒ‰æœˆä»½çµ±è¨ˆ</h3>
                    <table class="data-table" id="statsTableByMonth">
                        <thead>
                            <tr>
                                <th>æœˆä»½</th>
                                <th>æ’ç­æ¬¡æ•¸</th>
                                <th>å·¥ä½œæ™‚æ•¸</th>
                                <th>å¹³å‡æ¯æ—¥æ’ç­</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableByMonthBody">
                            <tr><td colspan="4" style="text-align: center; color: #999;">è«‹é¸æ“‡æ—¥æœŸç¯„åœä¸¦é»æ“Šã€Œç”¢ç”Ÿå ±è¡¨ã€</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- äº‹æ¥­å–®ä½é ç±¤ -->
            <div id="unitsTab" class="tab-content">
                <h2>ğŸ¢ äº‹æ¥­å–®ä½è¨­å®š</h2>
                
                <!-- äº‹æ¥­å–®ä½è¡¨å–® -->
                <div style="background: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div class="form-group">
                        <label>äº‹æ¥­å–®ä½åç¨± *</label>
                        <input type="text" id="unitName" placeholder="è«‹è¼¸å…¥äº‹æ¥­å–®ä½åç¨±" style="width: 100%;">
                    </div>

                    <div class="form-group">
                        <label>æ˜¯å¦ç‚ºåˆ†æ•£å‹</label>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-primary" id="btnDistributedNo" onclick="setDistributed('å¦')" style="flex: 1;">å¦</button>
                            <button type="button" class="btn" id="btnDistributedYes" onclick="setDistributed('æ˜¯')" style="flex: 1; background: #ccc;">æ˜¯</button>
                        </div>
                        <input type="hidden" id="isDistributed" value="å¦">
                    </div>

                    <!-- åœ°å€å€å¡Šï¼ˆå–®ä¸€æˆ–å¤šåˆ†é»ï¼‰ -->
                    <div id="addressesSection" class="form-group" style="display: block;">
                        <!-- å–®ä¸€åœ°å€ -->
                        <div id="singleAddressContainer" style="display: block;">
                            <label>åœ°å€</label>
                            <input type="text" id="unitAddress" placeholder="è«‹è¼¸å…¥åœ°å€" style="width: 100%;">
                        </div>
                        
                        <!-- å¤šåˆ†é»å®¹å™¨ -->
                        <div id="branchesContainer" style="display: none;">
                            <label>åˆ†æ•£åœ°é»</label>
                            <div id="branchesList" style="margin-bottom: 10px;"></div>
                            <button type="button" class="btn btn-primary" onclick="addBranch()">â• æ–°å¢åˆ†é»</button>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>é†«ç”Ÿå§“åï¼ˆæ¯è¡Œä¸€å€‹ï¼‰</label>
                            <textarea id="doctorNames" rows="4" placeholder="ç‹é†«å¸«&#10;æé†«å¸«" style="width: 100%;"></textarea>
                        </div>
                        <div class="form-group">
                            <label>è­·ç†å¸«å§“åï¼ˆæ¯è¡Œä¸€å€‹ï¼‰</label>
                            <textarea id="nurseNames" rows="4" placeholder="é™³è­·ç†å¸«&#10;æ—è­·ç†å¸«" style="width: 100%;"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>å…¶ä»–é†«ç™‚äººå“¡ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰</label>
                        <textarea id="otherStaff" rows="3" placeholder="æŠ€å¸«ã€è¡Œæ”¿äººå“¡ç­‰" style="width: 100%;"></textarea>
                    </div>

                    <!-- æ¯æœˆæ™‚æ•¸è¨­å®š -->
                    <div class="form-group">
                        <label><strong>æ¯æœˆæ™‚æ•¸åˆ†é…</strong></label>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div class="month-hours-input">
                                    <label>ä¸€æœˆ</label>
                                    <input type="number" id="docHours1" placeholder="é†«ç”Ÿæ™‚æ•¸" min="0">
                                    <input type="number" id="nurseHours1" placeholder="è­·ç†å¸«æ™‚æ•¸" min="0">
                                    <input type="number" id="otherHours1" placeholder="å…¶ä»–äººå“¡æ™‚æ•¸" min="0">
                                </div>
                                <div class="month-hours-input">
                                    <label>äºŒæœˆ</label>
                                    <input type="number" id="docHours2" placeholder="é†«ç”Ÿæ™‚æ•¸" min="0">
                                    <input type="number" id="nurseHours2" placeholder="è­·ç†å¸«æ™‚æ•¸" min="0">
                                    <input type="number" id="otherHours2" placeholder="å…¶ä»–äººå“¡æ™‚æ•¸" min="0">
                                </div>
                                <div class="month-hours-input">
                                    <label>ä¸‰æœˆ</label>
                                    <input type="number" id="docHours3" placeholder="é†«ç”Ÿæ™‚æ•¸" min="0">
                                    <input type="number" id="nurseHours3" placeholder="è­·ç†å¸«æ™‚æ•¸" min="0">
                                    <input type="number" id="otherHours3" placeholder="å…¶ä»–äººå“¡æ™‚æ•¸" min="0">
                                </div>
                                <div class="month-hours-input">
                                    <label>å››æœˆ</label>
                                    <input type="number" id="docHours4" placeholder="é†«ç”Ÿæ™‚æ•¸" min="0">
                                    <input type="number" id="nurseHours4" placeholder="è­·ç†å¸«æ™‚æ•¸" min="0">
                                    <input type="number" id="otherHours4" placeholder="å…¶ä»–äººå“¡æ™‚æ•¸" min="0">
                                </div>
                                <div class="month-hours-input">
                                    <label>äº”æœˆ</label>
                                    <input type="number" id="docHours5" placeholder="é†«ç”Ÿæ™‚æ•¸" min="0">
                                    <input type="number" id="nurseHours5" placeholder="è­·ç†å¸«æ™‚æ•¸" min="0">
                                    <input type="number" id="otherHours5" placeholder="å…¶ä»–äººå“¡æ™‚æ•¸" min="0">
                                </div>
                                <div class="month-hours-input">
                                    <label>å…­æœˆ</label>
                                    <input type="number" id="docHours6" placeholder="é†«ç”Ÿæ™‚æ•¸" min="0">
                                    <input type="number" id="nurseHours6" placeholder="è­·ç†å¸«æ™‚æ•¸" min="0">
                                    <input type="number" id="otherHours6" placeholder="å…¶ä»–äººå“¡æ™‚æ•¸" min="0">
                                </div>
                                <div class="month-hours-input">
                                    <label>ä¸ƒæœˆ</label>
                                    <input type="number" id="docHours7" placeholder="é†«ç”Ÿæ™‚æ•¸" min="0">
                                    <input type="number" id="nurseHours7" placeholder="è­·ç†å¸«æ™‚æ•¸" min="0">
                                    <input type="number" id="otherHours7" placeholder="å…¶ä»–äººå“¡æ™‚æ•¸" min="0">
                                </div>
                                <div class="month-hours-input">
                                    <label>å…«æœˆ</label>
                                    <input type="number" id="docHours8" placeholder="é†«ç”Ÿæ™‚æ•¸" min="0">
                                    <input type="number" id="nurseHours8" placeholder="è­·ç†å¸«æ™‚æ•¸" min="0">
                                    <input type="number" id="otherHours8" placeholder="å…¶ä»–äººå“¡æ™‚æ•¸" min="0">
                                </div>
                                <div class="month-hours-input">
                                    <label>ä¹æœˆ</label>
                                    <input type="number" id="docHours9" placeholder="é†«ç”Ÿæ™‚æ•¸" min="0">
                                    <input type="number" id="nurseHours9" placeholder="è­·ç†å¸«æ™‚æ•¸" min="0">
                                    <input type="number" id="otherHours9" placeholder="å…¶ä»–äººå“¡æ™‚æ•¸" min="0">
                                </div>
                                <div class="month-hours-input">
                                    <label>åæœˆ</label>
                                    <input type="number" id="docHours10" placeholder="é†«ç”Ÿæ™‚æ•¸" min="0">
                                    <input type="number" id="nurseHours10" placeholder="è­·ç†å¸«æ™‚æ•¸" min="0">
                                    <input type="number" id="otherHours10" placeholder="å…¶ä»–äººå“¡æ™‚æ•¸" min="0">
                                </div>
                                <div class="month-hours-input">
                                    <label>åä¸€æœˆ</label>
                                    <input type="number" id="docHours11" placeholder="é†«ç”Ÿæ™‚æ•¸" min="0">
                                    <input type="number" id="nurseHours11" placeholder="è­·ç†å¸«æ™‚æ•¸" min="0">
                                    <input type="number" id="otherHours11" placeholder="å…¶ä»–äººå“¡æ™‚æ•¸" min="0">
                                </div>
                                <div class="month-hours-input">
                                    <label>åäºŒæœˆ</label>
                                    <input type="number" id="docHours12" placeholder="é†«ç”Ÿæ™‚æ•¸" min="0">
                                    <input type="number" id="nurseHours12" placeholder="è­·ç†å¸«æ™‚æ•¸" min="0">
                                    <input type="number" id="otherHours12" placeholder="å…¶ä»–äººå“¡æ™‚æ•¸" min="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
                        <button class="btn btn-info" onclick="clearUnitForm()">ğŸ†• æ–°å¢äº‹æ¥­å–®ä½</button>
                        <button class="btn btn-success" onclick="saveUnitData()">ğŸ’¾ å„²å­˜äº‹æ¥­å–®ä½</button>
                    </div>
                </div>

                <!-- å·²å»ºæª”äº‹æ¥­å–®ä½åˆ—è¡¨ -->
                <div id="unitsListDisplay" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h3>ğŸ“‹ å·²å»ºæª”äº‹æ¥­å–®ä½</h3>
                    <div id="currentUnitsDisplay">
                        <p style="text-align: center; color: #999;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- é†«å¸«éƒµä»¶è¨­ç½®é ç±¤ -->
            <div id="staffTab" class="tab-content">
                <h2>ğŸ“§ é†«å¸«éƒµä»¶è¨­ç½®</h2>
                <p style="color: #666; margin-bottom: 20px;">ç®¡ç†é†«å¸«éƒµä»¶è³‡æ–™ï¼Œç”¨æ–¼è‡ªå‹•ç™¼é€æ’ç­é€šçŸ¥</p>
                
                <!-- åŠŸèƒ½èªªæ˜ -->
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                    <strong style="color: #1976d2;">ğŸ’¡ åŠŸèƒ½èªªæ˜</strong>
                    <ul style="margin: 10px 0 0 20px; color: #666; line-height: 1.8;">
                        <li>è¨­å®šé†«å¸«éƒµä»¶å¾Œï¼Œå»ºç«‹æ’ç­æ™‚æœƒè‡ªå‹•ç™¼é€è¡Œäº‹æ›†é‚€è«‹</li>
                        <li>é†«å¸«æœƒæ”¶åˆ°éƒµä»¶é€šçŸ¥ï¼Œå¯ç›´æ¥æ¥å—æˆ–æ‹’çµ•æ’ç­</li>
                        <li>å§“åå¿…é ˆèˆ‡ã€Œäº‹æ¥­å–®ä½è©³ç´°ã€å·¥ä½œè¡¨ä¸­çš„åç¨±å®Œå…¨ä¸€è‡´</li>
                        <li>éƒµä»¶åœ°å€å¿…é ˆæ˜¯æœ‰æ•ˆçš„ Gmail æˆ– Google Workspace å¸³è™Ÿ</li>
                    </ul>
                </div>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="loadStaffEmailsManual()">ğŸ”„ é‡æ–°è¼‰å…¥éƒµä»¶è³‡æ–™</button>
                    <button class="btn btn-success" onclick="openGoogleSheetEmailTab()">ğŸ“ åœ¨ Google Sheets ä¸­ç·¨è¼¯</button>
                    <button class="btn btn-info" onclick="showEmailSetupGuide()">ğŸ“– è¨­å®šæŒ‡å—</button>
                </div>

                <!-- ç‹€æ…‹è¨Šæ¯ -->
                <div id="staffEmailStatus" style="margin-bottom: 20px;"></div>

                <!-- éƒµä»¶è³‡æ–™é¡¯ç¤ºå€åŸŸ -->
                <div id="staffEmailDisplay" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h3 style="margin-top: 0; color: #1976d2;">ğŸ“‹ ç›®å‰éƒµä»¶è¨­å®š</h3>
                    <div id="staffEmailList">
                        <p style="text-align: center; color: #999;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                <!-- è¨­å®šæŒ‡å—ï¼ˆé è¨­éš±è—ï¼‰-->
                <div id="emailSetupGuide" style="display: none; margin-top: 20px; background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ff9800;">
                    <h3 style="margin-top: 0; color: #f57c00;">ğŸ“– è¨­å®šæŒ‡å—</h3>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong style="color: #1976d2;">æ­¥é©Ÿ 1ï¼šå»ºç«‹å·¥ä½œè¡¨</strong>
                        <ol style="margin: 10px 0 0 20px; color: #666; line-height: 1.8;">
                            <li>åœ¨ Google Sheets ä¸­å»ºç«‹ã€Œ<strong>é†«å¸«éƒµä»¶</strong>ã€å·¥ä½œè¡¨</li>
                            <li>è¨­å®šç¬¬ä¸€åˆ—æ¨™é¡Œï¼š<code style="background: #f5f5f5; padding: 2px 6px;">å§“å | Email | è·ç¨± | å‚™è¨»</code></li>
                        </ol>
                    </div>

                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong style="color: #1976d2;">æ­¥é©Ÿ 2ï¼šå¡«å…¥è³‡æ–™</strong>
                        <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; font-family: monospace; font-size: 13px;">
                            <div style="color: #888;">ç¯„ä¾‹è³‡æ–™ï¼š</div>
                            <div style="padding: 5px 0; border-bottom: 1px solid #ddd;">å§“å | Email | è·ç¨± | å‚™è¨»</div>
                            <div style="padding: 5px 0;">ç‹é†«å¸« | wang@gmail.com | ä¸»æ²»é†«å¸« | </div>
                            <div style="padding: 5px 0;">æé†«å¸« | lee@gmail.com | ä½é™¢é†«å¸« | </div>
                            <div style="padding: 5px 0;">é™³è­·ç†å¸« | chen@gmail.com | è­·ç†å¸« | </div>
                        </div>
                    </div>

                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <strong style="color: #1976d2;">æ­¥é©Ÿ 3ï¼šé‡æ–°è¼‰å…¥</strong>
                        <p style="margin: 10px 0 0 0; color: #666;">
                            å¡«å…¥è³‡æ–™å¾Œï¼Œé»æ“Šä¸Šæ–¹ã€ŒğŸ”„ é‡æ–°è¼‰å…¥éƒµä»¶è³‡æ–™ã€æŒ‰éˆ•å³å¯ã€‚
                        </p>
                    </div>

                    <button class="btn btn-secondary" onclick="hideEmailSetupGuide()" style="margin-top: 15px;">é—œé–‰æŒ‡å—</button>
                </div>
            </div>

            <!-- è¨­å®šé ç±¤ -->
            <div id="settingsTab" class="tab-content">
                <h2>âš™ï¸ è¨­å®š</h2>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3>Google Sheets è¨­å®š</h3>
                    
                    <div class="form-group">
                        <label>Google API ç”¨æˆ¶ç«¯ ID</label>
                        <input type="text" id="settingsClientId" placeholder="å¾ Google Cloud Console å–å¾—">
                    </div>

                    <div class="form-group">
                        <label>Google Sheets ID</label>
                        <input type="text" id="settingsSheetId" placeholder="å¾ Google Sheets ç¶²å€å–å¾—">
                    </div>

                    <div class="form-group">
                        <label>æ’ç­è³‡æ–™ç¯„åœ</label>
                        <input type="text" id="settingsSheetRange" value="æ’ç­è³‡æ–™!A2:H">
                    </div>

                    <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                    <button class="btn btn-success" onclick="testConnection()" style="margin-left: 10px;">âœ… æ¸¬è©¦é€£ç·š</button>
                    <button class="btn btn-primary" onclick="loadSettings()" style="margin-left: 10px;">ğŸ”„ è¼‰å…¥è¨­å®š</button>

                    <div id="settingsStatus"></div>
                </div>

                <!-- å‡æ—¥è¨­å®š -->
                <div style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3>ğŸ—“ï¸ å‡æ—¥è¨­å®š</h3>
                    
                    <div class="form-group">
                        <label>åœ‹å®¶/åœ°å€å‡æ—¥</label>
                        <select id="holidayCountry" onchange="saveHolidaySettings()">
                            <option value="TW">ğŸ‡¹ğŸ‡¼ å°ç£ (Taiwan)</option>
                            <option value="CN">ğŸ‡¨ğŸ‡³ ä¸­åœ‹ (China)</option>
                            <option value="HK">ğŸ‡­ğŸ‡° é¦™æ¸¯ (Hong Kong)</option>
                            <option value="MO">ğŸ‡²ğŸ‡´ æ¾³é–€ (Macau)</option>
                            <option value="JP">ğŸ‡¯ğŸ‡µ æ—¥æœ¬ (Japan)</option>
                            <option value="KR">ğŸ‡°ğŸ‡· éŸ“åœ‹ (South Korea)</option>
                            <option value="SG">ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡ (Singapore)</option>
                            <option value="MY">ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº (Malaysia)</option>
                            <option value="TH">ğŸ‡¹ğŸ‡­ æ³°åœ‹ (Thailand)</option>
                            <option value="VN">ğŸ‡»ğŸ‡³ è¶Šå— (Vietnam)</option>
                            <option value="US">ğŸ‡ºğŸ‡¸ ç¾åœ‹ (United States)</option>
                            <option value="GB">ğŸ‡¬ğŸ‡§ è‹±åœ‹ (United Kingdom)</option>
                            <option value="AU">ğŸ‡¦ğŸ‡º æ¾³æ´² (Australia)</option>
                            <option value="NZ">ğŸ‡³ğŸ‡¿ ç´è¥¿è˜­ (New Zealand)</option>
                            <option value="CA">ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§ (Canada)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showHolidays" onchange="saveHolidaySettings()" checked>
                            åœ¨æœˆæ›†ä¸Šé¡¯ç¤ºå‡æ—¥ï¼ˆç´…è‰²æ¨™è¨˜ï¼‰
                        </label>
                    </div>

                    <button class="btn btn-primary" onclick="reloadHolidays()">ğŸ”„ é‡æ–°è¼‰å…¥å‡æ—¥</button>
                    
                    <div id="holidayStatus" style="margin-top: 15px;"></div>
                </div>

                <!-- Google è¡Œäº‹æ›†è‡ªå‹•åŒæ­¥è¨­å®š -->
                <div style="margin-top: 30px; background: #e8f5e9; padding: 20px; border-radius: 10px; border: 2px solid #4caf50;">
                    <h3>ğŸ“… Google è¡Œäº‹æ›†è‡ªå‹•åŒæ­¥</h3>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="autoSyncCalendar" onchange="saveCalendarSyncSettings()" style="width: 20px; height: 20px;">
                            <span style="font-size: 16px;">å•Ÿç”¨è‡ªå‹•åŒæ­¥åˆ° Google è¡Œäº‹æ›†</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 8px;">
                            âœ… æ–°å¢æ’ç­æ™‚è‡ªå‹•å»ºç«‹è¡Œäº‹æ›†äº‹ä»¶<br>
                            âœ… ç·¨è¼¯æ’ç­æ™‚è‡ªå‹•æ›´æ–°è¡Œäº‹æ›†äº‹ä»¶<br>
                            âœ… åˆªé™¤æ’ç­æ™‚è‡ªå‹•ç§»é™¤è¡Œäº‹æ›†äº‹ä»¶
                        </small>
                    </div>

                    <div id="calendarSyncStatus" style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px; display: none;">
                        <strong>ğŸ“Š åŒæ­¥ç‹€æ…‹ï¼š</strong>
                        <div id="calendarSyncStatusText" style="margin-top: 5px;"></div>
                    </div>

                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
                        <strong>ğŸ’¡ æç¤ºï¼š</strong>
                        <ul style="margin: 8px 0 0 20px; padding: 0;">
                            <li>é¦–æ¬¡ä½¿ç”¨éœ€ç¢ºä¿å·²ç™»å…¥ Google å¸³è™Ÿ</li>
                            <li>éœ€è¦æˆæ¬Šå­˜å– Google è¡Œäº‹æ›†æ¬Šé™</li>
                            <li>é—œé–‰è‡ªå‹•åŒæ­¥ä¸æœƒåˆªé™¤å·²å»ºç«‹çš„è¡Œäº‹æ›†äº‹ä»¶</li>
                            <li>å¯ä½¿ç”¨ã€ŒğŸ“… è¡Œäº‹æ›†ã€æŒ‰éˆ•æ‰‹å‹•ä¸Šå‚³å–®å€‹æ’ç­</li>
                        </ul>
                    </div>
                </div>

                <!-- éƒµä»¶é€šçŸ¥åŠŸèƒ½èªªæ˜ -->
                <div style="margin-top: 30px; background: #e3f2fd; padding: 20px; border-radius: 10px; border: 2px solid #2196f3;">
                    <h3>ğŸ“§ éƒµä»¶é€šçŸ¥åŠŸèƒ½</h3>
                    
                    <div style="padding: 15px; background: white; border-radius: 8px; margin-bottom: 15px;">
                        <strong style="color: #1976d2; font-size: 16px;">ğŸ¯ åŠŸèƒ½èªªæ˜</strong>
                        <p style="margin: 10px 0 5px 0; color: #555;">
                            ç•¶å»ºç«‹æ’ç­æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•ï¼š
                        </p>
                        <ul style="margin: 5px 0 0 20px; color: #666;">
                            <li>âœ… å°‡æœ‰è¨­å®šéƒµä»¶çš„é†«å¸«åŠ å…¥è¡Œäº‹æ›†é‚€è«‹</li>
                            <li>âœ… è‡ªå‹•ç™¼é€éƒµä»¶é€šçŸ¥çµ¦é†«å¸«</li>
                            <li>âœ… é†«å¸«å¯åœ¨éƒµä»¶ä¸­ç›´æ¥æ¥å—/æ‹’çµ•é‚€è«‹</li>
                            <li>âœ… æ¥å—å¾Œäº‹ä»¶æœƒè‡ªå‹•åŠ å…¥é†«å¸«çš„è¡Œäº‹æ›†</li>
                        </ul>
                    </div>

                    <div style="padding: 15px; background: white; border-radius: 8px; margin-bottom: 15px;">
                        <strong style="color: #1976d2; font-size: 16px;">ğŸ“ è¨­å®šæ­¥é©Ÿ</strong>
                        <ol style="margin: 10px 0 0 20px; color: #666; line-height: 1.8;">
                            <li>åœ¨ Google Sheets ä¸­å»ºç«‹ã€Œ<strong>é†«å¸«éƒµä»¶</strong>ã€å·¥ä½œè¡¨</li>
                            <li>ç¬¬ä¸€åˆ—è¨­å®šæ¨™é¡Œï¼š<code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px;">å§“å | Email | è·ç¨± | å‚™è¨»</code></li>
                            <li>å¾ç¬¬äºŒåˆ—é–‹å§‹å¡«å…¥äººå“¡è³‡æ–™ï¼š
                                <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; font-family: monospace; font-size: 13px;">
                                    <div style="color: #888;">ç¬¬1åˆ—ï¼ˆæ¨™é¡Œï¼‰ï¼š</div>
                                    <div style="padding: 5px 0;">å§“å | Email | è·ç¨± | å‚™è¨»</div>
                                    <div style="color: #888; margin-top: 10px;">ç¬¬2åˆ—èµ·ï¼ˆè³‡æ–™ï¼‰ï¼š</div>
                                    <div style="padding: 5px 0;">ç‹é†«å¸« | wang@example.com | ä¸»æ²»é†«å¸« | </div>
                                    <div style="padding: 5px 0;">æé†«å¸« | lee@example.com | ä½é™¢é†«å¸« | </div>
                                </div>
                            </li>
                            <li>ç¢ºä¿å§“åèˆ‡ã€Œäº‹æ¥­å–®ä½è©³ç´°ã€å·¥ä½œè¡¨ä¸­çš„äººå“¡åç¨±å®Œå…¨ä¸€è‡´</li>
                            <li>å„²å­˜å¾Œç³»çµ±æœƒè‡ªå‹•è¼‰å…¥éƒµä»¶è³‡æ–™</li>
                        </ol>
                    </div>

                    <div style="padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <strong style="color: #f57c00;">âš ï¸ æ³¨æ„äº‹é …</strong>
                        <ul style="margin: 8px 0 0 20px; color: #666; line-height: 1.6;">
                            <li>éƒµä»¶åœ°å€å¿…é ˆæ˜¯æœ‰æ•ˆçš„ Gmail æˆ– Google Workspace å¸³è™Ÿ</li>
                            <li>äººå“¡å§“åå¿…é ˆèˆ‡äº‹æ¥­å–®ä½è¨­å®šä¸­çš„åç¨±å®Œå…¨ç›¸åŒï¼ˆåŒ…å«ç©ºæ ¼ï¼‰</li>
                            <li>è‹¥æœªè¨­å®šéƒµä»¶ï¼Œè©²äººå“¡ä»æœƒæ’ç­ä½†ä¸æœƒæ”¶åˆ°éƒµä»¶é€šçŸ¥</li>
                            <li>å»ºè­°ä½¿ç”¨é†«å¸«å€‹äººçš„ Google å¸³è™Ÿéƒµä»¶</li>
                        </ul>
                    </div>

                    <div style="padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50; margin-top: 15px;">
                        <strong style="color: #2e7d32;">âœ¨ éƒµä»¶å…§å®¹åŒ…å«</strong>
                        <ul style="margin: 8px 0 0 20px; color: #666; line-height: 1.6;">
                            <li>ğŸ“… æ’ç­æ—¥æœŸèˆ‡æ™‚é–“</li>
                            <li>ğŸ¢ äº‹æ¥­å–®ä½åç¨±</li>
                            <li>ğŸ“ å·¥ä½œåœ°é»è³‡è¨Š</li>
                            <li>ğŸ‘¥ åŒç­äººå“¡åå–®</li>
                            <li>ğŸ“ å‚™è¨»èªªæ˜</li>
                            <li>ğŸ”” è¡Œäº‹æ›†é‚€è«‹é€£çµï¼ˆå¯ç›´æ¥æ¥å—/æ‹’çµ•ï¼‰</li>
                        </ul>
                    </div>
                </div>

                <!-- è¡Œäº‹æ›†åŒæ­¥è¨ºæ–·å·¥å…· -->
                <div style="margin-top: 30px; background: #fff3e0; padding: 20px; border-radius: 10px; border: 2px solid #ff9800;">
                    <h3>ğŸ” è¡Œäº‹æ›†åŒæ­¥è¨ºæ–·å·¥å…·</h3>
                    
                    <div style="padding: 15px; background: white; border-radius: 8px; margin-bottom: 15px;">
                        <strong style="color: #f57c00; font-size: 16px;">ğŸ¯ åŠŸèƒ½èªªæ˜</strong>
                        <p style="margin: 10px 0 5px 0; color: #555;">
                            æ­¤å·¥å…·å¯ä»¥å¹«æ‚¨è¨ºæ–·æ’ç­èˆ‡è¡Œäº‹æ›†åŒæ­¥çš„ç‹€æ³ï¼š
                        </p>
                        <ul style="margin: 5px 0 0 20px; color: #666;">
                            <li>âœ… æª¢æŸ¥æœ‰å¤šå°‘æ’ç­å·²åŒæ­¥åˆ°è¡Œäº‹æ›†</li>
                            <li>âœ… æª¢æŸ¥æœ‰å¤šå°‘èˆŠæ’ç­æ²’æœ‰è¡Œäº‹æ›†é—œè¯</li>
                            <li>âœ… é¡¯ç¤ºå“ªäº›æ’ç­å¯èƒ½ç„¡æ³•åŒæ­¥åˆªé™¤</li>
                            <li>âœ… æª¢æŸ¥æ›´æ–°æ©Ÿåˆ¶æ˜¯å¦æ­£ç¢ºï¼ˆæ˜¯å¦æœƒé‡è¤‡ï¼‰</li>
                        </ul>
                    </div>

                    <button class="btn btn-warning" onclick="diagnoseSyncStatus()" style="background: #ff9800; border: none;">
                        ğŸ” è¨ºæ–·æ’ç­åŒæ­¥ç‹€æ…‹
                    </button>
                    
                    <button class="btn btn-warning" onclick="checkUpdateMechanism()" style="background: #2196f3; border: none; margin-left: 10px; color: white;">
                        ğŸ”¬ æª¢æŸ¥æ›´æ–°æ©Ÿåˆ¶
                    </button>
                    
                    <div id="diagnosisResult" style="margin-top: 15px; display: none;"></div>
                </div>

                <div style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3>é—œæ–¼ç³»çµ±</h3>
                    <p><strong>ç‰ˆæœ¬ï¼š</strong>4.3.0 (æ›´æ–°é‡è¤‡å•é¡Œè¨ºæ–·ç‰ˆ)</p>
                    <p><strong>è³‡æ–™ä¾†æºï¼š</strong>Google Sheets</p>
                    <p><strong>å‡æ—¥APIï¼š</strong>Nager.Date (å…è²»)</p>
                    <p><strong>æ–°å¢åŠŸèƒ½ï¼š</strong>æ›´æ–°æ©Ÿåˆ¶æª¢æŸ¥å·¥å…·ã€å®Œæ•´è¨ºæ–·å ±å‘Š</p>
                    <p><strong>æ›´æ–°æ—¥æœŸï¼š</strong>2026-01-17</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== å…¨åŸŸè®Šæ•¸ ====================
        let accessToken = null;
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let currentDate = new Date();
        let allShifts = [];
        let editingShiftIndex = -1;
        let holidays = {}; // å‡æ—¥è³‡æ–™å¿«å– { 'YYYY-MM-DD': {name: '', localName: ''} }
        let staffEmailMap = {}; // å­˜å„²äººå“¡åç¨±èˆ‡ Email çš„å°æ‡‰é—œä¿‚

        // ==================== åˆå§‹åŒ– ====================
        window.onload = function() {
            // è¼‰å…¥ Google API
            gapiLoaded();
            
            // è¼‰å…¥ GIS
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.onload = gisLoaded;
            document.head.appendChild(script);

            // è¨­å®šç™»å…¥æŒ‰éˆ•
            document.getElementById('loginBtn').onclick = handleLogin;

            // è¼‰å…¥è¨­å®š
            loadSettingsOnInit();
        };

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: '',
                discoveryDocs: [
                    'https://sheets.googleapis.com/$discovery/rest?version=v4',
                    'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'
                ],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            const config = loadConfig();
            if (config.clientId) {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: config.clientId,
                    scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/calendar',
                    callback: '',
                });
                gisInited = true;
                maybeEnableButtons();
            }
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('loginBtn').disabled = false;
            }
        }

        // ==================== è¨­å®šç®¡ç† ====================
        function loadConfig() {
            const config = localStorage.getItem('sheetsConfig');
            return config ? JSON.parse(config) : { clientId: '', sheetId: '', sheetRange: 'æ’ç­è³‡æ–™!A2:I' };
        }

        function saveConfig(clientId, sheetId, sheetRange) {
            const config = { clientId, sheetId, sheetRange };
            localStorage.setItem('sheetsConfig', JSON.stringify(config));
        }

        function loadSettingsOnInit() {
            const config = loadConfig();
            if (!config.clientId) {
                showLoginStatus('è«‹å…ˆå®Œæˆ Google Cloud API è¨­å®š', 'error');
            }
        }

        function loadSettings() {
            const config = loadConfig();
            document.getElementById('settingsClientId').value = config.clientId || '';
            document.getElementById('settingsSheetId').value = config.sheetId || '';
            document.getElementById('settingsSheetRange').value = config.sheetRange || 'æ’ç­è³‡æ–™!A2:I';
            showSettingsStatus('å·²è¼‰å…¥è¨­å®š', 'success');
        }

        function saveSettings() {
            const clientId = document.getElementById('settingsClientId').value.trim();
            const sheetId = document.getElementById('settingsSheetId').value.trim();
            const sheetRange = document.getElementById('settingsSheetRange').value.trim();

            if (!clientId || !sheetId) {
                showSettingsStatus('è«‹å¡«å…¥æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
                return;
            }

            saveConfig(clientId, sheetId, sheetRange);
            showSettingsStatus('è¨­å®šå·²å„²å­˜', 'success');

            // é‡æ–°åˆå§‹åŒ– GIS
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/calendar',
                callback: '',
            });
            gisInited = true;
        }

        async function testConnection() {
            const config = loadConfig();
            if (!config.sheetId) {
                showSettingsStatus('è«‹å…ˆå¡«å…¥ Sheet ID', 'error');
                return;
            }

            if (!accessToken) {
                showSettingsStatus('è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ', 'error');
                return;
            }

            // æª¢æŸ¥ gapi æ˜¯å¦å·²åˆå§‹åŒ–
            if (!gapiInited || !gapi.client || !gapi.client.sheets) {
                showSettingsStatus('âŒ Google API å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å€™å†è©¦', 'error');
                return;
            }

            showSettingsStatus('â³ æ¸¬è©¦é€£ç·šä¸­...', 'info');

            try {
                // ç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„æˆæ¬Š
                gapi.client.setToken({ access_token: accessToken });
                
                const response = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: config.sheetId
                });
                
                if (response && response.result && response.result.properties) {
                const title = response.result.properties.title;
                showSettingsStatus(`âœ… é€£ç·šæˆåŠŸï¼è©¦ç®—è¡¨ï¼š${title}`, 'success');
                } else {
                    showSettingsStatus('âŒ é€£ç·šå¤±æ•—ï¼šç„¡æ³•å–å¾—è©¦ç®—è¡¨è³‡è¨Š', 'error');
                }
            } catch (error) {
                // æ”¹é€²éŒ¯èª¤è™•ç†
                let errorMessage = 'æœªçŸ¥éŒ¯èª¤';
                
                if (error) {
                    if (error.message) {
                        errorMessage = error.message;
                    } else if (error.error) {
                        if (error.error.message) {
                            errorMessage = error.error.message;
                        } else if (typeof error.error === 'string') {
                            errorMessage = error.error;
                        } else {
                            errorMessage = JSON.stringify(error.error);
                        }
                    } else if (typeof error === 'string') {
                        errorMessage = error;
                    } else {
                        errorMessage = JSON.stringify(error);
                    }
                }
                
                console.error('é€£ç·šæ¸¬è©¦éŒ¯èª¤ï¼š', error);
                showSettingsStatus('âŒ é€£ç·šå¤±æ•—ï¼š' + errorMessage, 'error');
            }
        }

        // ==================== ç™»å…¥/ç™»å‡º ====================
        function handleLogin() {
            const config = loadConfig();
            if (!config.clientId) {
                showLoginStatus('è«‹å…ˆåœ¨ Google Cloud Console è¨­å®šç”¨æˆ¶ç«¯ ID', 'error');
                return;
            }

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    showLoginStatus('ç™»å…¥å¤±æ•—ï¼š' + resp.error, 'error');
                    throw (resp);
                }
                accessToken = resp.access_token;
                
                await loadUserInfo();
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                // è¼‰å…¥åˆå§‹è³‡æ–™
                await initializeApp();
            };

            if (accessToken === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        async function loadUserInfo() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v1/userinfo?alt=json', {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                const userInfo = await response.json();
                document.getElementById('userName').textContent = userInfo.email || 'ä½¿ç”¨è€…';
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—', error);
            }
        }

        function handleLogout() {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken);
                accessToken = null;
            }
            location.reload();
        }

        // ==================== æ‡‰ç”¨åˆå§‹åŒ– ====================
        async function initializeApp() {
            await loadSettings();
            await loadAllShifts();
            await loadUnitsDetailed(); // è¼‰å…¥äº‹æ¥­å–®ä½è©³ç´°åˆ—è¡¨
            
            // éšæ®µ1æ–°åŠŸèƒ½ï¼šè¼‰å…¥å‡æ—¥è¨­å®šå’Œè³‡æ–™
            loadHolidaySettings();
            await loadHolidays();
            localStorage.setItem('currentHolidayYear', String(currentDate.getFullYear()));
            
            // è¼‰å…¥è‡ªå‹•åŒæ­¥è¨­å®š
            loadCalendarSyncSettings();
            
            // éšæ®µ1æ–°åŠŸèƒ½ï¼šè¨­ç½®æ™‚é–“è‡ªå‹•è¨ˆç®—
            setupTimeAutoCalculation();
            
            renderCalendar();
        }

        // ==================== Google Sheets æ“ä½œ ====================
        // ==================== äº‹æ¥­å–®ä½ç®¡ç† ====================
        let currentEditingUnitIndex = null;
        let branchCounter = 0;

        // è¨­å®šæ˜¯å¦ç‚ºåˆ†æ•£å‹
        function setDistributed(value) {
            document.getElementById('isDistributed').value = value;
            const btnNo = document.getElementById('btnDistributedNo');
            const btnYes = document.getElementById('btnDistributedYes');
            const singleContainer = document.getElementById('singleAddressContainer');
            const branchesContainer = document.getElementById('branchesContainer');
            
            if (value === 'å¦') {
                btnNo.classList.add('btn-primary');
                btnNo.style.background = '';
                btnYes.classList.remove('btn-primary');
                btnYes.style.background = '#ccc';
                
                // é¡¯ç¤ºå–®ä¸€åœ°å€
                singleContainer.style.display = 'block';
                branchesContainer.style.display = 'none';
            } else {
                btnYes.classList.add('btn-primary');
                btnYes.style.background = '';
                btnNo.classList.remove('btn-primary');
                btnNo.style.background = '#ccc';
                
                // é¡¯ç¤ºå¤šåˆ†é»
                singleContainer.style.display = 'none';
                branchesContainer.style.display = 'block';
                
                // å¦‚æœé‚„æ²’æœ‰åˆ†é»ï¼Œè‡ªå‹•æ–°å¢ç¬¬ä¸€å€‹
                if (document.getElementById('branchesList').children.length === 0) {
                    addBranch();
                }
            }
        }

        // æ–°å¢åˆ†é»
        function addBranch() {
            branchCounter++;
            const branchesList = document.getElementById('branchesList');
            
            const branchDiv = document.createElement('div');
            branchDiv.className = 'branch-item';
            branchDiv.id = `branch-${branchCounter}`;
            branchDiv.innerHTML = `
                <button type="button" class="branch-remove-btn" onclick="removeBranch('branch-${branchCounter}')">ğŸ—‘ï¸ åˆªé™¤</button>
                <input type="text" class="branch-name" placeholder="åˆ†é»åç¨±ï¼ˆä¾‹å¦‚ï¼šå°åŒ—åˆ†é»ã€ä¿¡ç¾©åˆ†é»ï¼‰">
                <input type="text" class="branch-address" placeholder="åˆ†é»åœ°å€">
            `;
            
            branchesList.appendChild(branchDiv);
        }

        // åˆªé™¤åˆ†é»
        function removeBranch(branchId) {
            const branch = document.getElementById(branchId);
            if (branch) {
                if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤åˆ†é»å—ï¼Ÿ')) {
                    branch.remove();
                }
            }
        }

        // å–å¾—æ‰€æœ‰åˆ†é»è³‡æ–™
        function getBranchesData() {
            const branches = [];
            const branchItems = document.querySelectorAll('.branch-item');
            
            branchItems.forEach(item => {
                const name = item.querySelector('.branch-name').value.trim();
                const address = item.querySelector('.branch-address').value.trim();
                
                if (name || address) {
                    branches.push({ name, address });
                }
            });
            
            return branches;
        }

        // è¨­å®šåˆ†é»è³‡æ–™
        function setBranchesData(branches) {
            const branchesList = document.getElementById('branchesList');
            branchesList.innerHTML = '';
            branchCounter = 0;
            
            if (branches && branches.length > 0) {
                branches.forEach(branch => {
                    addBranch();
                    const lastBranch = branchesList.lastChild;
                    lastBranch.querySelector('.branch-name').value = branch.name || '';
                    lastBranch.querySelector('.branch-address').value = branch.address || '';
                });
            }
        }

        // æ¸…ç©ºè¡¨å–®
        function clearUnitForm() {
            document.getElementById('unitName').value = '';
            document.getElementById('unitAddress').value = '';
            document.getElementById('doctorNames').value = '';
            document.getElementById('nurseNames').value = '';
            document.getElementById('otherStaff').value = '';
            setDistributed('å¦');
            
            // æ¸…ç©ºåˆ†é»
            document.getElementById('branchesList').innerHTML = '';
            branchCounter = 0;
            
            // æ¸…ç©º12å€‹æœˆçš„æ™‚æ•¸
            for (let i = 1; i <= 12; i++) {
                document.getElementById(`docHours${i}`).value = '';
                document.getElementById(`nurseHours${i}`).value = '';
                document.getElementById(`otherHours${i}`).value = '';
            }
            
            currentEditingUnitIndex = null;
            alert('âœ… è¡¨å–®å·²æ¸…ç©ºï¼Œå¯ä»¥æ–°å¢äº‹æ¥­å–®ä½');
        }

        // å„²å­˜äº‹æ¥­å–®ä½
        async function saveUnitData() {
            const name = document.getElementById('unitName').value.trim();
            if (!name) {
                alert('è«‹è¼¸å…¥äº‹æ¥­å–®ä½åç¨±');
                return;
            }

            const config = loadConfig();
            if (!config.sheetId) {
                alert('è«‹å…ˆåœ¨è¨­å®šä¸­å¡«å…¥ Sheet ID');
                return;
            }

            const isDistributed = document.getElementById('isDistributed').value;

            // æ”¶é›†è³‡æ–™
            const unitData = {
                name,
                isDistributed,
                address: document.getElementById('unitAddress').value.trim(),
                branches: [],
                doctors: document.getElementById('doctorNames').value.trim(),
                nurses: document.getElementById('nurseNames').value.trim(),
                others: document.getElementById('otherStaff').value.trim(),
                monthlyHours: {}
            };

            // å¦‚æœæ˜¯åˆ†æ•£å‹ï¼Œæ”¶é›†åˆ†é»è³‡æ–™
            if (isDistributed === 'æ˜¯') {
                unitData.branches = getBranchesData();
                if (unitData.branches.length === 0) {
                    alert('è«‹è‡³å°‘æ–°å¢ä¸€å€‹åˆ†é»');
                    return;
                }
            }

            // æ”¶é›†12å€‹æœˆçš„æ™‚æ•¸
            for (let i = 1; i <= 12; i++) {
                unitData.monthlyHours[i] = {
                    doc: document.getElementById(`docHours${i}`).value || '0',
                    nurse: document.getElementById(`nurseHours${i}`).value || '0',
                    other: document.getElementById(`otherHours${i}`).value || '0'
                };
            }

            try {
                console.log('ğŸ“ é–‹å§‹å„²å­˜äº‹æ¥­å–®ä½ï¼š', unitData);
                
                // è®€å–ç¾æœ‰è³‡æ–™
                let existingData = [];
                let sheetExists = false;
                
                try {
                    const response = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: config.sheetId,
                        range: 'äº‹æ¥­å–®ä½è©³ç´°!A2:AQ',
                    });
                    existingData = response.result.values || [];
                    sheetExists = true;
                    console.log('âœ… å·¥ä½œè¡¨å­˜åœ¨ï¼Œç¾æœ‰è³‡æ–™ç­†æ•¸ï¼š', existingData.length);
                } catch (error) {
                    console.warn('âš ï¸ å·¥ä½œè¡¨å¯èƒ½ä¸å­˜åœ¨ï¼ŒéŒ¯èª¤ï¼š', error);
                    
                    // æª¢æŸ¥æ˜¯å¦æ˜¯å·¥ä½œè¡¨ä¸å­˜åœ¨çš„éŒ¯èª¤
                    if (error.status === 400 || error.result?.error?.message?.includes('Unable to parse range')) {
                        console.log('ğŸ”¨ å˜—è©¦å»ºç«‹ã€Œäº‹æ¥­å–®ä½è©³ç´°ã€å·¥ä½œè¡¨...');
                        
                        try {
                            // å»ºç«‹æ–°å·¥ä½œè¡¨
                            await gapi.client.sheets.spreadsheets.batchUpdate({
                                spreadsheetId: config.sheetId,
                                resource: {
                                    requests: [{
                                        addSheet: {
                                            properties: {
                                                title: 'äº‹æ¥­å–®ä½è©³ç´°',
                                                gridProperties: {
                                                    rowCount: 1000,
                                                    columnCount: 43  // A-AQ (7åŸºæœ¬æ¬„ä½ + 36æ™‚æ•¸æ¬„ä½)
                                                }
                                            }
                                        }
                                    }]
                                }
                            });
                            
                            console.log('âœ… å·¥ä½œè¡¨å»ºç«‹æˆåŠŸ');
                            
                            // å¯«å…¥æ¨™é¡Œåˆ—
                            const headers = [
                                'å–®ä½åç¨±', 'åˆ†æ•£å‹', 'åœ°å€', 'åˆ†é»è³‡æ–™', 'é†«ç”Ÿåå–®', 'è­·ç†å¸«åå–®', 'å…¶ä»–äººå“¡'
                            ];
                            
                            // æ·»åŠ 12å€‹æœˆçš„æ¨™é¡Œ
                            for (let i = 1; i <= 12; i++) {
                                headers.push(`${i}æœˆé†«ç”Ÿæ™‚æ•¸`);
                                headers.push(`${i}æœˆè­·ç†å¸«æ™‚æ•¸`);
                                headers.push(`${i}æœˆå…¶ä»–æ™‚æ•¸`);
                            }
                            
                            await gapi.client.sheets.spreadsheets.values.update({
                                spreadsheetId: config.sheetId,
                                range: 'äº‹æ¥­å–®ä½è©³ç´°!A1:AQ1',
                                valueInputOption: 'RAW',
                                resource: {
                                    values: [headers]
                                }
                            });
                            
                            console.log('âœ… æ¨™é¡Œåˆ—å¯«å…¥æˆåŠŸ');
                            sheetExists = true;
                            
                        } catch (createError) {
                            console.error('âŒ å»ºç«‹å·¥ä½œè¡¨å¤±æ•—ï¼š', createError);
                            throw new Error('ç„¡æ³•å»ºç«‹ã€Œäº‹æ¥­å–®ä½è©³ç´°ã€å·¥ä½œè¡¨ã€‚è«‹æ‰‹å‹•åœ¨ Google Sheets ä¸­å»ºç«‹æ­¤å·¥ä½œè¡¨ï¼Œæˆ–æª¢æŸ¥æ¬Šé™ã€‚');
                        }
                    } else {
                        // å…¶ä»–éŒ¯èª¤
                        throw error;
                    }
                }

                // æº–å‚™å¯«å…¥çš„è³‡æ–™åˆ—
                const row = [
                    unitData.name,
                    unitData.isDistributed,
                    unitData.address,
                    JSON.stringify(unitData.branches), // åˆ†é»è³‡æ–™è½‰ç‚º JSON
                    unitData.doctors,
                    unitData.nurses,
                    unitData.others
                ];

                // æ·»åŠ 12å€‹æœˆçš„æ™‚æ•¸ï¼ˆæ¯æœˆ3å€‹æ¬„ä½ï¼šé†«ç”Ÿã€è­·ç†å¸«ã€å…¶ä»–ï¼‰
                for (let i = 1; i <= 12; i++) {
                    row.push(unitData.monthlyHours[i].doc);
                    row.push(unitData.monthlyHours[i].nurse);
                    row.push(unitData.monthlyHours[i].other);
                }

                console.log('ğŸ“Š æº–å‚™å¯«å…¥è³‡æ–™åˆ—ï¼š', row);

                // æ›´æ–°æˆ–æ–°å¢
                if (currentEditingUnitIndex !== null) {
                    // æ›´æ–°ç¾æœ‰è³‡æ–™
                    existingData[currentEditingUnitIndex] = row;
                    console.log('ğŸ”„ æ›´æ–°æ¨¡å¼ï¼Œç´¢å¼•ï¼š', currentEditingUnitIndex);
                } else {
                    // æ–°å¢è³‡æ–™
                    existingData.push(row);
                    console.log('â• æ–°å¢æ¨¡å¼');
                }

                console.log('ğŸ’¾ å¯«å…¥ Google Sheets...');
                
                // å¯«å› Google Sheets
                const updateResponse = await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: config.sheetId,
                    range: 'äº‹æ¥­å–®ä½è©³ç´°!A2:AQ',
                    valueInputOption: 'RAW',
                    resource: {
                        values: existingData
                    }
                });

                console.log('âœ… å¯«å…¥æˆåŠŸï¼š', updateResponse);
                
                // æ¸…é™¤æ™‚æ•¸å¿«å–ï¼Œç¢ºä¿ä¸‹æ¬¡ä½¿ç”¨æ™‚é‡æ–°è¨ˆç®—
                currentMonthHoursUsage = {};
                console.log('ğŸ—‘ï¸ å·²æ¸…é™¤æ™‚æ•¸å¿«å–');
                
                // å¦‚æœç•¶å‰ç·¨è¼¯çš„å–®ä½æ­£åœ¨æ’ç­é é¢ä½¿ç”¨ï¼Œé‡æ–°è¼‰å…¥å–®ä½è³‡æ–™
                const currentShiftUnit = document.getElementById('shiftUnit')?.value;
                if (currentShiftUnit === name) {
                    console.log('ğŸ”„ é‡æ–°è¼‰å…¥ç•¶å‰ä½¿ç”¨çš„å–®ä½è³‡æ–™...');
                    await loadUnitDetailData(name);
                    await updateHoursInfo(true); // å¼·åˆ¶é‡æ–°è¨ˆç®—æ™‚æ•¸
                    console.log('âœ… å–®ä½è³‡æ–™å’Œæ™‚æ•¸å·²æ›´æ–°');
                }
                
                alert(`âœ… äº‹æ¥­å–®ä½ã€Œ${name}ã€${currentEditingUnitIndex !== null ? 'æ›´æ–°' : 'æ–°å¢'}æˆåŠŸï¼\n\n${currentShiftUnit === name ? 'æ’ç­é é¢æ™‚æ•¸å·²åŒæ­¥æ›´æ–°' : ''}`);
                clearUnitForm();
                await loadUnitsDetailed();
                await loadUnits(false); // æ›´æ–°ä¸‹æ‹‰é¸å–®
                
            } catch (error) {
                console.error('âŒ å„²å­˜å¤±æ•—ï¼Œè©³ç´°éŒ¯èª¤ï¼š', error);
                console.error('éŒ¯èª¤ç‹€æ…‹ï¼š', error.status);
                console.error('éŒ¯èª¤è¨Šæ¯ï¼š', error.message);
                console.error('å®Œæ•´éŒ¯èª¤ï¼š', JSON.stringify(error, null, 2));
                
                let errorMsg = 'âŒ å„²å­˜å¤±æ•—\n\n';
                
                if (error.status === 403) {
                    errorMsg += 'æ¬Šé™ä¸è¶³ï¼\n\nè«‹ç¢ºèªï¼š\n1. å·²æˆæ¬Š Google Sheets æ¬Šé™\n2. å·²é‡æ–°ç™»å…¥ç³»çµ±';
                } else if (error.status === 404) {
                    errorMsg += 'Sheet ID éŒ¯èª¤ï¼\n\nè«‹ç¢ºèªè¨­å®šä¸­çš„ Sheet ID æ˜¯å¦æ­£ç¢º';
                } else if (error.status === 400) {
                    errorMsg += 'å·¥ä½œè¡¨æ ¼å¼éŒ¯èª¤ï¼\n\n' + error.message + '\n\nè«‹æª¢æŸ¥ã€Œäº‹æ¥­å–®ä½è©³ç´°ã€å·¥ä½œè¡¨æ˜¯å¦å­˜åœ¨';
                } else {
                    errorMsg += error.message || 'æœªçŸ¥éŒ¯èª¤';
                    errorMsg += '\n\nè«‹ç¢ºèªï¼š\n1. å·²æˆæ¬Š Google Sheets æ¬Šé™\n2. Sheet ID æ­£ç¢º\n3. ç¶²è·¯é€£ç·šæ­£å¸¸';
                }
                
                errorMsg += '\n\nğŸ’¡ æç¤ºï¼šæ‰“é–‹ç€è¦½å™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æŸ¥çœ‹è©³ç´°éŒ¯èª¤è¨Šæ¯';
                
                alert(errorMsg);
            }
        }

        // è¼‰å…¥è©³ç´°çš„äº‹æ¥­å–®ä½è³‡æ–™
        async function loadUnitsDetailed() {
            const config = loadConfig();
            if (!config.sheetId) return;

            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: config.sheetId,
                    range: 'äº‹æ¥­å–®ä½è©³ç´°!A2:AQ',
                });

                const values = response.result.values;
                console.log('ğŸ“Š è¼‰å…¥äº‹æ¥­å–®ä½è©³ç´°è³‡æ–™ï¼š', values);
                displayUnitsDetailedTable(values || []);
            } catch (error) {
                console.error('è¼‰å…¥äº‹æ¥­å–®ä½è©³ç´°è³‡æ–™å¤±æ•—', error);
                displayUnitsDetailedTable([]);
            }
        }

        // é¡¯ç¤ºè©³ç´°çš„äº‹æ¥­å–®ä½åˆ—è¡¨
        function displayUnitsDetailedTable(units) {
            const container = document.getElementById('currentUnitsDisplay');
            
            if (!units || units.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">å°šæœªæ–°å¢äº‹æ¥­å–®ä½</p>';
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>äº‹æ¥­å–®ä½åç¨±</th>
                            <th>åˆ†æ•£å‹</th>
                            <th>åœ°å€</th>
                            <th>å¹´åº¦ç¸½æ™‚æ•¸ï¼ˆé†«/è­·/å…¶ä»–ï¼‰</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            units.forEach((row, index) => {
                const name = row[0] || '';
                const isDistributed = row[1] || 'å¦';
                const address = row[2] || '-';
                const branchesJson = row[3] || '';
                
                // è™•ç†åœ°å€/åˆ†é»é¡¯ç¤º
                let addressDisplay = address;
                if (isDistributed === 'æ˜¯' && branchesJson) {
                    try {
                        const branches = JSON.parse(branchesJson);
                        if (branches.length > 0) {
                            addressDisplay = branches.map(b => `${b.name}: ${b.address}`).join('<br>');
                        }
                    } catch (error) {
                        addressDisplay = 'åˆ†é»è³‡æ–™éŒ¯èª¤';
                    }
                }
                
                // è¨ˆç®—å¹´åº¦ç¸½æ™‚æ•¸ï¼ˆç´¢å¼•å¾ 7 é–‹å§‹ï¼Œå…±12å€‹æœˆï¼Œæ¯æœˆ3å€‹æ¬„ä½ï¼‰
                let docTotal = 0, nurseTotal = 0, otherTotal = 0;
                for (let i = 0; i < 12; i++) {
                    const docHours = parseInt(row[7 + i * 3] || 0);
                    const nurseHours = parseInt(row[8 + i * 3] || 0);
                    const otherHours = parseInt(row[9 + i * 3] || 0);
                    
                    docTotal += docHours;
                    nurseTotal += nurseHours;
                    otherTotal += otherHours;
                    
                    console.log(`æœˆä»½ ${i+1}: é†«ç”Ÿ=${docHours}h, è­·ç†å¸«=${nurseHours}h, å…¶ä»–=${otherHours}h (ç´¢å¼•: ${7+i*3}, ${8+i*3}, ${9+i*3})`);
                }
                
                console.log(`${name} å¹´åº¦ç¸½è¨ˆ: é†«ç”Ÿ=${docTotal}h, è­·ç†å¸«=${nurseTotal}h, å…¶ä»–=${otherTotal}h`);

                html += `
                    <tr>
                        <td><strong>${name}</strong></td>
                        <td>${isDistributed === 'æ˜¯' ? 'âœ… æ˜¯' : 'âŒ å¦'}</td>
                        <td style="white-space: pre-line;">${addressDisplay}</td>
                        <td>${docTotal}h / ${nurseTotal}h / ${otherTotal}h</td>
                        <td>
                            <button class="btn btn-primary" onclick="editUnit(${index})" style="padding: 5px 10px; margin-right: 5px;">âœï¸ ç·¨è¼¯</button>
                            <button class="btn btn-danger" onclick="deleteUnit(${index})" style="padding: 5px 10px;">ğŸ—‘ï¸ åˆªé™¤</button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // ç·¨è¼¯äº‹æ¥­å–®ä½
        async function editUnit(index) {
            const config = loadConfig();
            if (!config.sheetId) return;

            try {
                console.log('ğŸ”§ ç·¨è¼¯äº‹æ¥­å–®ä½ï¼Œç´¢å¼•ï¼š', index);
                
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: config.sheetId,
                    range: 'äº‹æ¥­å–®ä½è©³ç´°!A2:AQ',
                });

                const values = response.result.values;
                if (!values || !values[index]) {
                    alert('æ‰¾ä¸åˆ°è©²äº‹æ¥­å–®ä½è³‡æ–™');
                    return;
                }

                const row = values[index];
                console.log('ğŸ“‹ è¼‰å…¥çš„è³‡æ–™åˆ—ï¼š', row);
                console.log('ğŸ“Š è³‡æ–™åˆ—é•·åº¦ï¼š', row.length);
                
                // å¡«å…¥è¡¨å–®
                document.getElementById('unitName').value = row[0] || '';
                const isDistributed = row[1] || 'å¦';
                setDistributed(isDistributed);
                document.getElementById('unitAddress').value = row[2] || '';
                
                // é‚„åŸåˆ†é»è³‡æ–™
                if (isDistributed === 'æ˜¯' && row[3]) {
                    try {
                        const branches = JSON.parse(row[3]);
                        setBranchesData(branches);
                    } catch (error) {
                        console.error('è§£æåˆ†é»è³‡æ–™å¤±æ•—', error);
                        setBranchesData([]);
                    }
                }
                
                document.getElementById('doctorNames').value = row[4] || '';
                document.getElementById('nurseNames').value = row[5] || '';
                document.getElementById('otherStaff').value = row[6] || '';

                // å¡«å…¥12å€‹æœˆçš„æ™‚æ•¸ï¼ˆç´¢å¼•å¾ 7 é–‹å§‹ï¼Œæ¯æœˆ3å€‹æ¬„ä½ï¼‰
                console.log('ğŸ”„ é–‹å§‹å¡«å…¥æœˆåº¦æ™‚æ•¸...');
                for (let i = 0; i < 12; i++) {
                    const docIdx = 7 + i * 3;
                    const nurseIdx = 8 + i * 3;
                    const otherIdx = 9 + i * 3;
                    
                    const docValue = row[docIdx] || '';
                    const nurseValue = row[nurseIdx] || '';
                    const otherValue = row[otherIdx] || '';
                    
                    console.log(`${i+1}æœˆ: é†«ç”Ÿ[${docIdx}]=${docValue}, è­·ç†å¸«[${nurseIdx}]=${nurseValue}, å…¶ä»–[${otherIdx}]=${otherValue}`);
                    
                    document.getElementById(`docHours${i + 1}`).value = docValue;
                    document.getElementById(`nurseHours${i + 1}`).value = nurseValue;
                    document.getElementById(`otherHours${i + 1}`).value = otherValue;
                }

                currentEditingUnitIndex = index;
                
                console.log('âœ… è³‡æ–™è¼‰å…¥å®Œæˆ');
                
                // æ²å‹•åˆ°è¡¨å–®é ‚éƒ¨
                window.scrollTo({ top: 0, behavior: 'smooth' });
                alert(`âœ… å·²è¼‰å…¥ã€Œ${row[0]}ã€çš„è³‡æ–™ï¼Œå¯ä»¥é–‹å§‹ç·¨è¼¯`);
            } catch (error) {
                console.error('âŒ è¼‰å…¥è³‡æ–™å¤±æ•—', error);
                alert('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š' + error.message);
            }
        }

        // åˆªé™¤äº‹æ¥­å–®ä½
        async function deleteUnit(index) {
            const config = loadConfig();
            if (!config.sheetId) return;

            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: config.sheetId,
                    range: 'äº‹æ¥­å–®ä½è©³ç´°!A2:AQ',
                });

                const values = response.result.values;
                if (!values || !values[index]) {
                    alert('æ‰¾ä¸åˆ°è©²äº‹æ¥­å–®ä½è³‡æ–™');
                    return;
                }

                const unitName = values[index][0];
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤äº‹æ¥­å–®ä½ã€Œ${unitName}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
                    return;
                }

                // åˆªé™¤è©²åˆ—
                values.splice(index, 1);

                // å¯«å› Google Sheets
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: config.sheetId,
                    range: 'äº‹æ¥­å–®ä½è©³ç´°!A2:AQ',
                });

                if (values.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: config.sheetId,
                        range: 'äº‹æ¥­å–®ä½è©³ç´°!A2:AQ',
                        valueInputOption: 'RAW',
                        resource: {
                            values: values
                        }
                    });
                }

                alert(`âœ… äº‹æ¥­å–®ä½ã€Œ${unitName}ã€å·²åˆªé™¤`);
                await loadUnitsDetailed();
                await loadUnits(false);
            } catch (error) {
                console.error('åˆªé™¤å¤±æ•—', error);
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        // ==================== è¼‰å…¥äº‹æ¥­å–®ä½ï¼ˆç°¡åŒ–ç‰ˆ-ç”¨æ–¼ä¸‹æ‹‰é¸å–®ï¼‰ ====================
        async function loadUnits(showAlert = true) {
            const config = loadConfig();
            if (!config.sheetId) {
                if (showAlert) alert('è«‹å…ˆåœ¨è¨­å®šä¸­å¡«å…¥ Sheet ID');
                return;
            }

            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: config.sheetId,
                    range: 'äº‹æ¥­å–®ä½è©³ç´°!A2:A',  // åªè®€å–åç¨±æ¬„ä½
                });

                const values = response.result.values;
                const select = document.getElementById('shiftUnit');
                select.innerHTML = '<option value="">è«‹é¸æ“‡</option>';

                if (values && values.length > 0) {
                    values.forEach(row => {
                        const unitName = row[0];
                        if (unitName) {
                            const option = document.createElement('option');
                            option.value = unitName;
                            option.textContent = unitName;
                            select.appendChild(option);
                        }
                    });

                    if (showAlert) alert(`âœ… æˆåŠŸè¼‰å…¥ ${values.length} å€‹äº‹æ¥­å–®ä½`);
                    console.log(`âœ… æˆåŠŸè¼‰å…¥ ${values.length} å€‹äº‹æ¥­å–®ä½`);
                } else {
                    if (showAlert) alert('âš ï¸ å°šæœªæ–°å¢äº‹æ¥­å–®ä½\n\nè«‹å…ˆåœ¨ã€ŒğŸ¢ äº‹æ¥­å–®ä½ã€é ç±¤æ–°å¢');
                    console.warn('å°šæœªæ–°å¢äº‹æ¥­å–®ä½');
                }
            } catch (error) {
                console.error('è¼‰å…¥äº‹æ¥­å–®ä½å¤±æ•—', error);
                if (showAlert) {
                    alert('âŒ è¼‰å…¥äº‹æ¥­å–®ä½å¤±æ•—\n\nè«‹ç¢ºèªå·²åœ¨ã€ŒğŸ¢ äº‹æ¥­å–®ä½ã€é ç±¤æ–°å¢äº‹æ¥­å–®ä½');
                }
            }
        }

        function refreshUnits() {
            if (!gapiInited || !gapi.client || !gapi.client.sheets) {
                alert('è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ');
                return;
            }
            loadUnits();
        }

        function displayUnitsTable(units) {
            const container = document.getElementById('unitsListDisplay');
            const display = document.getElementById('currentUnitsDisplay');
            
            if (!units || units.length === 0) {
                container.style.display = 'none';
                return;
            }

            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f0f0f0;">
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">äº‹æ¥­å–®ä½åç¨±</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">åœ°å€</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">è¯çµ¡é›»è©±</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            units.forEach(row => {
                html += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd;"><strong>${row[0] || ''}</strong></td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${row[1] || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${row[2] || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${row[3] || '-'}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            display.innerHTML = html;
            container.style.display = 'block';
        }

        // ==================== è¼‰å…¥æ’ç­è³‡æ–™ ====================
        async function loadAllShifts() {
            const config = loadConfig();
            if (!config.sheetId) return;

            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: config.sheetId,
                    range: config.sheetRange,
                });

                const values = response.result.values;
                allShifts = values ? values.map((row, index) => ({
                    index,
                    date: row[0] || '',
                    startTime: row[1] || '',
                    endTime: row[2] || '',
                    unit: row[3] || '',
                    staff: row[4] || '',
                    location: row[5] || '',
                    color: row[6] || '#667eea',
                    notes: row[7] || '',
                    eventId: row[8] || '' // è¡Œäº‹æ›†äº‹ä»¶ID
                })) : [];

                renderCalendar();
                renderShiftsList();
                
                // è‡ªå‹•è¼‰å…¥äº‹æ¥­å–®ä½å’Œé†«å¸«éƒµä»¶ï¼ˆä¸é¡¯ç¤ºæç¤ºï¼‰
                await loadUnits(false);
                await loadStaffEmails();
            } catch (error) {
                console.error('è¼‰å…¥æ’ç­å¤±æ•—', error);
            }
        }

        async function addShiftToSheet(shiftData, eventId = '') {
            const config = loadConfig();
            const values = [[
                shiftData.date,
                shiftData.startTime,
                shiftData.endTime,
                shiftData.unit,
                shiftData.staff,
                shiftData.location,
                shiftData.color,
                shiftData.notes,
                eventId // è¡Œäº‹æ›†äº‹ä»¶ID
            ]];

            try {
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: config.sheetId,
                    range: config.sheetRange,
                    valueInputOption: 'RAW',
                    resource: { values }
                });
                return true;
            } catch (error) {
                console.error('æ–°å¢æ’ç­å¤±æ•—', error);
                return false;
            }
        }

        async function updateShiftInSheet(index, shiftData, eventId = '') {
            const config = loadConfig();
            const rowNumber = index + 2; // +2 å› ç‚ºç¬¬1åˆ—æ˜¯æ¨™é¡Œï¼Œç´¢å¼•å¾0é–‹å§‹
            
            // å¦‚æœæ²’æœ‰æä¾› eventIdï¼Œä¿ç•™åŸæœ‰çš„ eventId
            if (!eventId) {
                const shift = allShifts.find(s => s.index === index);
                eventId = shift ? shift.eventId : '';
            }
            
            const range = `æ’ç­è³‡æ–™!A${rowNumber}:I${rowNumber}`;
            
            const values = [[
                shiftData.date,
                shiftData.startTime,
                shiftData.endTime,
                shiftData.unit,
                shiftData.staff,
                shiftData.location,
                shiftData.color,
                shiftData.notes,
                eventId // è¡Œäº‹æ›†äº‹ä»¶ID
            ]];

            try {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: config.sheetId,
                    range: range,
                    valueInputOption: 'RAW',
                    resource: { values }
                });
                return true;
            } catch (error) {
                console.error('æ›´æ–°æ’ç­å¤±æ•—', error);
                return false;
            }
        }

        async function deleteShiftFromSheet(index) {
            // Google Sheets API åˆªé™¤åˆ—æ¯”è¼ƒè¤‡é›œï¼Œé€™è£¡å…ˆç°¡åŒ–ç‚ºæ¸…ç©ºå…§å®¹
            const config = loadConfig();
            const rowNumber = index + 2;
            const range = `æ’ç­è³‡æ–™!A${rowNumber}:I${rowNumber}`;
            
            try {
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: config.sheetId,
                    range: range
                });
                return true;
            } catch (error) {
                console.error('åˆªé™¤æ’ç­å¤±æ•—', error);
                return false;
            }
        }

        // ==================== æ’ç­ç®¡ç† ====================
        function showAddShiftForm() {
            document.getElementById('formTitle').textContent = 'æ–°å¢æ’ç­';
            editingShiftIndex = -1;
            clearShiftForm();
            
            // æ–°å¢æ¨¡å¼ï¼šé¡¯ç¤ºé‡è¤‡æ’ç¨‹é¸é …
            const repeatSection = document.getElementById('repeatEnabled').closest('.form-group');
            if (repeatSection) {
                repeatSection.style.display = 'block';
            }
            
            document.getElementById('shiftForm').style.display = 'block';
        }

        function cancelShiftForm() {
            document.getElementById('shiftForm').style.display = 'none';
            clearShiftForm();
        }

        function clearShiftForm() {
            console.log('ğŸ§¹ æ¸…é™¤è¡¨å–®');
            
            // æ¸…é™¤åŸºæœ¬æ¬„ä½
            document.getElementById('shiftDate').value = '';
            document.getElementById('startTime').value = '09:00';
            document.getElementById('endTime').value = '17:00';
            document.getElementById('shiftUnit').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('selectedColor').value = '#667eea';
            
            // æ¸…é™¤äººå“¡é¸æ“‡ï¼ˆå‹¾é¸æ¡†ç³»çµ±ï¼‰
            document.querySelectorAll('input[name="staff"]').forEach(checkbox => {
                checkbox.checked = false;
                const parent = checkbox.closest('.staff-checkbox-item');
                if (parent) {
                    parent.classList.remove('checked');
                }
            });
            
            // é‡ç½®äººå“¡é¸æ“‡å€åŸŸé¡¯ç¤º
            const staffCheckboxes = document.getElementById('staffCheckboxes');
            if (staffCheckboxes) {
                staffCheckboxes.innerHTML = '<p style="text-align: center; color: #999;">è«‹å…ˆé¸æ“‡äº‹æ¥­å–®ä½</p>';
            }
            
            // æ¸…é™¤åœ°é»æ¬„ä½ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const locationContainer = document.getElementById('locationContainer');
            if (locationContainer) {
                locationContainer.innerHTML = '<input type="text" id="location" placeholder="è«‹å…ˆé¸æ“‡äº‹æ¥­å–®ä½" readonly style="background: #f8f9fa;">';
            }
            
            // æ¸…é™¤æ™‚æ•¸è³‡è¨Šé¡¯ç¤º
            const unitHoursInfo = document.getElementById('unitHoursInfo');
            if (unitHoursInfo) {
                unitHoursInfo.textContent = '';
            }
            
            // æ¸…é™¤é‡è¤‡æ’ç¨‹è¨­å®š
            document.getElementById('repeatEnabled').checked = false;
            document.getElementById('repeatOptions').style.display = 'none';
            document.getElementById('repeatFrequency').value = 'weekly';
            document.getElementById('repeatEndType').value = 'count';
            document.getElementById('repeatCount').value = '4';
            document.getElementById('repeatUntil').value = '';
            
            // æ¸…é™¤æ‰€æœ‰æ˜ŸæœŸé¸æ“‡ï¼ˆä¿ç•™æ˜ŸæœŸä¸€ç‚ºé è¨­ï¼‰
            document.querySelectorAll('input[name="weekday"]').forEach((cb, index) => {
                cb.checked = (index === 1); // åªå‹¾é¸æ˜ŸæœŸä¸€
            });
            
            document.getElementById('repeatPreviewText').innerHTML = 'è«‹è¨­å®šé‡è¤‡é¸é …';
            
            // é‡ç½®å…¨åŸŸè®Šæ•¸
            currentUnitData = null;
            currentMonthHoursUsage = {};
            
            console.log('âœ… è¡¨å–®å·²æ¸…é™¤');
        }

        async function saveShift() {
            // é˜²æ­¢é‡è¤‡é»æ“Šï¼šç¦ç”¨å„²å­˜æŒ‰éˆ•
            const saveButtons = document.querySelectorAll('button[onclick="saveShift()"]');
            saveButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.6';
                btn.style.cursor = 'not-allowed';
            });
            
            try {
                // éšæ®µ2ï¼šå¾å‹¾é¸æ¡†å–å¾—äººå“¡
                const selectedStaff = getSelectedStaff();
                let staffValue = '';
                
                if (selectedStaff && selectedStaff.length > 0) {
                    // ä½¿ç”¨å‹¾é¸çš„äººå“¡
                    staffValue = selectedStaff.join(', ');
                } else {
                    // é™ç´šï¼šå˜—è©¦å¾éš±è—çš„ input å–å¾—ï¼ˆç·¨è¼¯æ¨¡å¼æˆ–èˆŠè³‡æ–™ï¼‰
                    const staffNamesInput = document.getElementById('staffNames');
                    staffValue = staffNamesInput ? staffNamesInput.value : '';
                }
                
                // éšæ®µ2ï¼šå¾åœ°é»æ¬„ä½å–å¾—åœ°é»ï¼ˆå¯èƒ½æ˜¯ input æˆ– selectï¼‰
                const locationElement = document.getElementById('location');
                let locationValue = '';
                
                if (locationElement) {
                    // å–å¾— input æˆ– select çš„å€¼
                    locationValue = locationElement.value || '';
                }
                
                // å¦‚æœæ²’æœ‰åœ°é»ï¼Œä½¿ç”¨äº‹æ¥­å–®ä½åç¨±ä½œç‚ºé è¨­
                if (!locationValue) {
                    locationValue = document.getElementById('shiftUnit').value;
                }
                
                console.log('ğŸ“ åœ°é»è³‡æ–™ï¼š', locationValue);
                
                const shiftData = {
                    date: document.getElementById('shiftDate').value,
                    startTime: document.getElementById('startTime').value,
                    endTime: document.getElementById('endTime').value,
                    unit: document.getElementById('shiftUnit').value,
                    staff: staffValue,
                    location: locationValue,
                    color: document.getElementById('selectedColor').value,
                    notes: document.getElementById('notes').value
                };

                if (!shiftData.date || !shiftData.startTime || !shiftData.endTime || !shiftData.unit || !shiftData.staff) {
                    alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼ˆåŒ…å«è‡³å°‘ä¸€ä½äººå“¡ï¼‰');
                    // å•Ÿç”¨æŒ‰éˆ•
                    saveButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    });
                    return;
                }

            // æª¢æŸ¥æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼ï¼ˆç·¨è¼¯æ¨¡å¼ä¸æ”¯æ´é‡è¤‡æ’ç¨‹ï¼‰
            if (editingShiftIndex >= 0) {
                // å–å¾—åŸæ’ç­çš„äº‹ä»¶ID
                const shift = allShifts.find(s => s.index === editingShiftIndex);
                const oldEventId = shift ? shift.eventId : '';
                
                let newEventId = oldEventId;
                
                // å¦‚æœå•Ÿç”¨è‡ªå‹•åŒæ­¥ä¸”æœ‰èˆŠäº‹ä»¶IDï¼Œæ›´æ–°è¡Œäº‹æ›†äº‹ä»¶
                if (isAutoSyncEnabled() && oldEventId) {
                    console.log('ğŸ”„ æ›´æ–°è¡Œäº‹æ›†äº‹ä»¶...');
                    newEventId = await autoUpdateCalendarEvent(oldEventId, shiftData);
                    if (!newEventId) newEventId = oldEventId; // å¦‚æœæ›´æ–°å¤±æ•—ï¼Œä¿ç•™èˆŠID
                } else if (isAutoSyncEnabled() && !oldEventId) {
                    // å¦‚æœæ²’æœ‰èˆŠäº‹ä»¶IDä½†å•Ÿç”¨åŒæ­¥ï¼Œå»ºç«‹æ–°äº‹ä»¶
                    console.log('ğŸ“… å»ºç«‹æ–°çš„è¡Œäº‹æ›†äº‹ä»¶...');
                    newEventId = await autoSyncShiftToCalendar(shiftData);
                }
                
                const success = await updateShiftInSheet(editingShiftIndex, shiftData, newEventId);
                if (success) {
                    alert('å„²å­˜æˆåŠŸï¼' + (newEventId && isAutoSyncEnabled() ? '\nå·²åŒæ­¥æ›´æ–°è¡Œäº‹æ›†' : ''));
                    cancelShiftForm();
                    await loadAllShifts();
                } else {
                    alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
                }
                
                // å•Ÿç”¨æŒ‰éˆ•
                saveButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                });
                return;
            }

            // æ–°å¢æ¨¡å¼ï¼šæª¢æŸ¥æ˜¯å¦å•Ÿç”¨é‡è¤‡æ’ç¨‹
            const repeatEnabled = document.getElementById('repeatEnabled').checked;
            
            if (repeatEnabled) {
                // é‡è¤‡æ’ç¨‹æ¨¡å¼
                console.log('ğŸ”„ å•Ÿç”¨é‡è¤‡æ’ç¨‹');
                
                try {
                    const dates = generateRepeatDates();
                    
                    if (dates.length === 0) {
                        alert('âŒ æ²’æœ‰ç”Ÿæˆä»»ä½•æ’ç­æ—¥æœŸï¼Œè«‹æª¢æŸ¥é‡è¤‡è¨­å®š');
                        // å•Ÿç”¨æŒ‰éˆ•
                        saveButtons.forEach(btn => {
                            btn.disabled = false;
                            btn.style.opacity = '1';
                            btn.style.cursor = 'pointer';
                        });
                        return;
                    }
                    
                    const confirmed = confirm(`å³å°‡å»ºç«‹ ${dates.length} å€‹æ’ç­\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`);
                    if (!confirmed) {
                        // å•Ÿç”¨æŒ‰éˆ•
                        saveButtons.forEach(btn => {
                            btn.disabled = false;
                            btn.style.opacity = '1';
                            btn.style.cursor = 'pointer';
                        });
                        return;
                    }
                    
                    // é¡¯ç¤ºé€²åº¦è¨Šæ¯
                    const progressMsg = document.createElement('div');
                    progressMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
                    progressMsg.innerHTML = `
                        <h3 style="margin-bottom: 15px;">æ­£åœ¨å»ºç«‹é‡è¤‡æ’ç­...</h3>
                        <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="repeatProgress">0 / ${dates.length}</div>
                        <p style="margin-top: 10px; color: #666;">è«‹å‹¿é—œé–‰è¦–çª—</p>
                    `;
                    document.body.appendChild(progressMsg);
                    
                    let successCount = 0;
                    let failCount = 0;
                    const failedDates = [];
                    
                    // é€ä¸€å»ºç«‹æ’ç­
                    for (let i = 0; i < dates.length; i++) {
                        const dateShiftData = {
                            ...shiftData,
                            date: dates[i]
                        };
                        
                        try {
                            let eventId = '';
                            
                            // è‡ªå‹•åŒæ­¥åˆ° Google è¡Œäº‹æ›†ä¸¦å–å¾—äº‹ä»¶ID
                            if (isAutoSyncEnabled()) {
                                eventId = await autoSyncShiftToCalendar(dateShiftData);
                            }
                            
                            const success = await addShiftToSheet(dateShiftData, eventId);
                            if (success) {
                                successCount++;
                            } else {
                                failCount++;
                                failedDates.push(dates[i]);
                            }
                        } catch (error) {
                            console.error(`æ—¥æœŸ ${dates[i]} å»ºç«‹å¤±æ•—ï¼š`, error);
                            failCount++;
                            failedDates.push(dates[i]);
                        }
                        
                        // æ›´æ–°é€²åº¦
                        document.getElementById('repeatProgress').textContent = `${i + 1} / ${dates.length}`;
                        
                        // æ¯æ¬¡é–“éš” 100ms é¿å… API è«‹æ±‚éå¿«
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    // ç§»é™¤é€²åº¦è¨Šæ¯
                    document.body.removeChild(progressMsg);
                    
                    // é¡¯ç¤ºçµæœ
                    let resultMsg = `âœ… é‡è¤‡æ’ç­å»ºç«‹å®Œæˆï¼\n\næˆåŠŸï¼š${successCount} å€‹\nå¤±æ•—ï¼š${failCount} å€‹`;
                    if (failedDates.length > 0) {
                        resultMsg += `\n\nå¤±æ•—çš„æ—¥æœŸï¼š\n${failedDates.join('\n')}`;
                    }
                    alert(resultMsg);
                    
                    cancelShiftForm();
                    await loadAllShifts();
                    
                } catch (error) {
                    console.error('âŒ é‡è¤‡æ’ç¨‹éŒ¯èª¤ï¼š', error);
                    alert('âŒ é‡è¤‡æ’ç¨‹å¤±æ•—ï¼š' + error.message);
                } finally {
                    // å•Ÿç”¨æŒ‰éˆ•
                    saveButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    });
                }
                
            } else {
                // å–®ä¸€æ’ç­æ¨¡å¼
                let eventId = '';
                
                // è‡ªå‹•åŒæ­¥åˆ° Google è¡Œäº‹æ›†ä¸¦å–å¾—äº‹ä»¶ID
                if (isAutoSyncEnabled()) {
                    console.log('ğŸ”„ é–‹å§‹è‡ªå‹•åŒæ­¥åˆ°è¡Œäº‹æ›†...');
                    eventId = await autoSyncShiftToCalendar(shiftData);
                    console.log('ğŸ“… è¡Œäº‹æ›†äº‹ä»¶IDï¼š', eventId);
                }
                
                const success = await addShiftToSheet(shiftData, eventId);
                
                if (success) {
                    alert('å„²å­˜æˆåŠŸï¼' + (eventId ? '\nå·²åŒæ­¥åˆ°è¡Œäº‹æ›†' : ''));
                    cancelShiftForm();
                    await loadAllShifts();
                } else {
                    alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
                }
                
                // å•Ÿç”¨æŒ‰éˆ•
                saveButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                });
            }
            
            } catch (error) {
                console.error('âŒ å„²å­˜æ’ç­ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
                alert('âŒ å„²å­˜å¤±æ•—ï¼š' + error.message);
                
                // å•Ÿç”¨æŒ‰éˆ•
                saveButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                });
            }
        }

        async function editShift(index) {
            const shift = allShifts[index];
            
            console.log('ğŸ“ é–‹å§‹ç·¨è¼¯æ’ç­ï¼š', shift);
            
            // æ¸…é™¤è¡¨å–®ä¸¦é‡ç½®ç‚ºç·¨è¼¯æ¨¡å¼
            clearShiftForm();
            document.getElementById('formTitle').textContent = 'ç·¨è¼¯æ’ç­';
            
            // è¨­å®šåŸºæœ¬æ¬„ä½
            document.getElementById('shiftDate').value = shift.date;
            document.getElementById('startTime').value = shift.startTime;
            document.getElementById('endTime').value = shift.endTime;
            document.getElementById('selectedColor').value = shift.color;
            document.getElementById('notes').value = shift.notes;
            
            // è¨­å®šäº‹æ¥­å–®ä½
            document.getElementById('shiftUnit').value = shift.unit;
            
            // ç­‰å¾…å–®ä½è³‡æ–™è¼‰å…¥å®Œæˆï¼ˆé€™æœƒç”Ÿæˆäººå“¡å’Œåœ°é»é¸é …ï¼‰
            console.log('â³ ç­‰å¾…å–®ä½è³‡æ–™è¼‰å…¥...');
            await onUnitChange();
            
            // ä½¿ç”¨ requestAnimationFrame ç¢ºä¿ DOM æ›´æ–°å®Œæˆ
            await new Promise(resolve => requestAnimationFrame(() => requestAnimationFrame(resolve)));
            
            console.log('âœ… å–®ä½è³‡æ–™è¼‰å…¥å®Œæˆï¼Œé–‹å§‹è¨­å®šäººå“¡å’Œåœ°é»');
            
            // è¼‰å…¥äººå“¡é¸æ“‡ï¼ˆå¾å‹¾é¸æ¡†ç³»çµ±ï¼‰
            if (shift.staff) {
                const staffList = shift.staff.split(',').map(s => s.trim());
                console.log('ğŸ‘¥ è¦å‹¾é¸çš„äººå“¡ï¼š', staffList);
                
                // ç­‰å¾…å‹¾é¸æ¡†ç”Ÿæˆ
                await new Promise(resolve => setTimeout(resolve, 50));
                
                // å‹¾é¸å°æ‡‰çš„äººå“¡ï¼ˆä½¿ç”¨æ›´å¯é çš„é¸æ“‡å™¨ï¼‰
                const allCheckboxes = document.querySelectorAll('#staffCheckboxes input[type="checkbox"]');
                console.log(`ğŸ“‹ æ‰¾åˆ° ${allCheckboxes.length} å€‹äººå“¡å‹¾é¸æ¡†`);
                
                let checkedCount = 0;
                allCheckboxes.forEach(checkbox => {
                    const staffName = checkbox.value;
                    if (staffList.includes(staffName)) {
                        checkbox.checked = true;
                        checkedCount++;
                        // æ›´æ–°è¦–è¦ºæ¨£å¼
                        const parent = checkbox.closest('.staff-checkbox-item');
                        if (parent) {
                            parent.classList.add('checked');
                        }
                        console.log(`âœ“ å·²å‹¾é¸ï¼š${staffName}`);
                    }
                });
                
                console.log(`âœ… æˆåŠŸå‹¾é¸ ${checkedCount} ä½äººå“¡`);
                
                // æ›´æ–°äººå“¡é¸æ“‡é¡¯ç¤º
                updateStaffSelection();
            }
            
            // è¨­å®šåœ°é»ï¼ˆä½¿ç”¨æ›´å¯é çš„æ–¹å¼ï¼‰
            await new Promise(resolve => setTimeout(resolve, 50));
            
            const locationElement = document.getElementById('location');
            if (locationElement && shift.location) {
                // å¦‚æœæ˜¯ selectï¼Œæª¢æŸ¥é¸é …æ˜¯å¦å­˜åœ¨
                if (locationElement.tagName === 'SELECT') {
                    const options = Array.from(locationElement.options);
                    const matchingOption = options.find(opt => opt.value === shift.location);
                    
                    if (matchingOption) {
                        locationElement.value = shift.location;
                        console.log('ğŸ“ è¨­å®šåœ°é»ï¼ˆä¸‹æ‹‰é¸å–®ï¼‰ï¼š', shift.location);
                    } else {
                        console.warn('âš ï¸ æ‰¾ä¸åˆ°åŒ¹é…çš„åœ°é»é¸é …ï¼š', shift.location);
                        // å˜—è©¦æ¨¡ç³ŠåŒ¹é…
                        const partialMatch = options.find(opt => 
                            opt.value.includes(shift.location) || shift.location.includes(opt.value)
                        );
                        if (partialMatch) {
                            locationElement.value = partialMatch.value;
                            console.log('ğŸ“ ä½¿ç”¨æ¨¡ç³ŠåŒ¹é…è¨­å®šåœ°é»ï¼š', partialMatch.value);
                        }
                    }
                } else {
                    // å¦‚æœæ˜¯ inputï¼Œç›´æ¥è¨­å®šå€¼
                    locationElement.value = shift.location;
                    console.log('ğŸ“ è¨­å®šåœ°é»ï¼ˆæ–‡å­—è¼¸å…¥ï¼‰ï¼š', shift.location);
                }
            }
            
            // ç·¨è¼¯æ¨¡å¼ï¼šéš±è—é‡è¤‡æ’ç¨‹é¸é …
            const repeatSection = document.getElementById('repeatEnabled').closest('.form-group');
            if (repeatSection) {
                repeatSection.style.display = 'none';
            }
            
            // æ›´æ–°å‰©é¤˜æ™‚æ•¸é¡¯ç¤º
            await updateHoursInfo();
            
            editingShiftIndex = index;
            document.getElementById('shiftForm').style.display = 'block';
            switchTab('manage');
            
            console.log('âœ… ç·¨è¼¯è¡¨å–®è¼‰å…¥å®Œæˆ');
            console.log('ğŸ“Š æœ€çµ‚ç‹€æ…‹æª¢æŸ¥ï¼š', {
                unit: document.getElementById('shiftUnit').value,
                date: document.getElementById('shiftDate').value,
                staff: getSelectedStaff(),
                location: document.getElementById('location')?.value
            });
        }

        async function deleteShift(index) {
            // å–å¾—è©²æ’ç­è³‡è¨Š
            const shift = allShifts.find(s => s.index === index);
            
            if (!shift) {
                alert('æ‰¾ä¸åˆ°è©²æ’ç­è³‡æ–™');
                return;
            }
            
            // æº–å‚™ç¢ºèªè¨Šæ¯
            let confirmMessage = `ç¢ºå®šè¦åˆªé™¤é€™å€‹æ’ç­å—ï¼Ÿ\n\n`;
            confirmMessage += `æ—¥æœŸï¼š${shift.date}\n`;
            confirmMessage += `æ™‚é–“ï¼š${shift.startTime} - ${shift.endTime}\n`;
            confirmMessage += `å–®ä½ï¼š${shift.unit}\n`;
            confirmMessage += `äººå“¡ï¼š${shift.staff}\n`;
            
            // å¦‚æœæœ‰è¡Œäº‹æ›†äº‹ä»¶ï¼Œæç¤ºå°‡ç™¼é€å–æ¶ˆé€šçŸ¥
            const eventId = shift.eventId;
            if (eventId && isAutoSyncEnabled()) {
                // æª¢æŸ¥æ˜¯å¦æœ‰è¨­å®šéƒµä»¶çš„äººå“¡
                const staffList = shift.staff.split(',').map(s => s.trim());
                const hasEmail = staffList.some(name => staffEmailMap[name]);
                
                if (hasEmail) {
                    confirmMessage += `\nâš ï¸ æ³¨æ„ï¼šå°‡è‡ªå‹•ç™¼é€å–æ¶ˆé€šçŸ¥çµ¦å·²è¨­å®šéƒµä»¶çš„é†«å¸«`;
                }
            }
            
            if (!confirm(confirmMessage)) return;
            
            // å¦‚æœæœ‰äº‹ä»¶IDä¸”å•Ÿç”¨è‡ªå‹•åŒæ­¥ï¼Œå…ˆåˆªé™¤è¡Œäº‹æ›†äº‹ä»¶ä¸¦ç™¼é€å–æ¶ˆé€šçŸ¥
            let deleteResult = { success: false, attendeeCount: 0 };
            if (eventId && isAutoSyncEnabled()) {
                console.log('ğŸ—‘ï¸ åŒæ­¥åˆªé™¤è¡Œäº‹æ›†äº‹ä»¶ä¸¦ç™¼é€å–æ¶ˆé€šçŸ¥ï¼š', eventId);
                deleteResult = await autoDeleteCalendarEvent(eventId, true);
                
                // è©³ç´°æ—¥èªŒ
                if (deleteResult.success) {
                    console.log('âœ… è¡Œäº‹æ›†äº‹ä»¶åˆªé™¤æˆåŠŸ');
                } else {
                    console.warn('âš ï¸ è¡Œäº‹æ›†äº‹ä»¶åˆªé™¤å¤±æ•—æˆ–äº‹ä»¶ä¸å­˜åœ¨');
                }
            } else if (!eventId && isAutoSyncEnabled()) {
                console.warn('âš ï¸ æ­¤æ’ç­æ²’æœ‰è¡Œäº‹æ›†äº‹ä»¶IDï¼ˆå¯èƒ½æ˜¯èˆŠè³‡æ–™ï¼‰');
            }
            
            // å¾ Google Sheets åˆªé™¤æ’ç­
            const success = await deleteShiftFromSheet(index);
            if (success) {
                let successMessage = 'âœ… æ’ç­è³‡æ–™å·²åˆªé™¤ï¼';
                
                // æ ¹æ“šå¯¦éš›åˆªé™¤çµæœé¡¯ç¤ºè¨Šæ¯
                if (eventId && isAutoSyncEnabled()) {
                    if (deleteResult.success) {
                        successMessage += '\n\nğŸ“… å·²åŒæ­¥åˆªé™¤è¡Œäº‹æ›†äº‹ä»¶';
                        
                        if (deleteResult.attendeeCount > 0) {
                            successMessage += `\nğŸ“§ å·²ç™¼é€å–æ¶ˆé€šçŸ¥çµ¦ ${deleteResult.attendeeCount} ä½åƒèˆ‡è€…`;
                        }
                    } else {
                        successMessage += '\n\nâš ï¸ è¡Œäº‹æ›†äº‹ä»¶åˆªé™¤å¤±æ•—ï¼ˆäº‹ä»¶å¯èƒ½å·²è¢«æ‰‹å‹•åˆªé™¤ï¼‰';
                    }
                } else if (!eventId && isAutoSyncEnabled()) {
                    successMessage += '\n\nâš ï¸ æ­¤æ’ç­æ²’æœ‰é—œè¯çš„è¡Œäº‹æ›†äº‹ä»¶ï¼ˆèˆŠè³‡æ–™ï¼‰';
                }
                
                alert(successMessage);
                await loadAllShifts();
            } else {
                alert('âŒ åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        // ==================== è¡Œäº‹æ›†é¡¯ç¤º ====================
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = `${year}å¹´${month + 1}æœˆ`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            let html = '<div class="calendar-grid">';
            
            // æ˜ŸæœŸæ¨™é¡Œ
            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekDays.forEach(day => {
                html += `<div class="calendar-day"><div class="calendar-day-header">${day}</div></div>`;
            });
            
            // ç©ºç™½å¤©æ•¸
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day"></div>';
            }
            
            // æ—¥æœŸå’Œæ’ç­
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayShifts = allShifts.filter(s => s.date === dateStr);
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºå‡æ—¥
                const holiday = isHoliday(dateStr);
                const isHolidayClass = holiday ? 'holiday' : '';
                
                html += `<div class="calendar-day clickable ${isHolidayClass}" onclick="onCalendarDayClick('${dateStr}')">`;
                html += `<div class="calendar-day-header">${day}</div>`;
                
                // é¡¯ç¤ºå‡æ—¥åç¨±
                if (holiday) {
                    html += `<div class="holiday-badge">${holiday.localName || holiday.name}</div>`;
                }
                
                dayShifts.forEach(shift => {
                    html += `<div class="calendar-event" style="background: ${shift.color}" onclick="event.stopPropagation(); editShift(${shift.index})">`;
                    html += `${shift.startTime} ${shift.unit}`;
                    html += '</div>';
                });
                
                html += '</div>';
            }
            
            html += '</div>';
            document.getElementById('calendarDisplay').innerHTML = html;
        }

        async function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            
            // å¦‚æœåˆ‡æ›åˆ°ä¸åŒå¹´ä»½ï¼Œé‡æ–°è¼‰å…¥å‡æ—¥
            const currentCachedYear = localStorage.getItem('currentHolidayYear');
            const newYear = currentDate.getFullYear();
            if (currentCachedYear !== String(newYear)) {
                localStorage.setItem('currentHolidayYear', String(newYear));
                await loadHolidays();
            }
            
            renderCalendar();
        }

        // ==================== æ’ç­åˆ—è¡¨ ====================
        function renderShiftsList() {
            let html = '<table class="data-table"><thead><tr>';
            html += '<th>æ—¥æœŸ</th><th>æ™‚é–“</th><th>äº‹æ¥­å–®ä½</th><th>äººå“¡</th><th>åœ°é»</th><th>æ“ä½œ</th>';
            html += '</tr></thead><tbody>';
            
            allShifts.forEach(shift => {
                html += '<tr>';
                html += `<td>${shift.date}</td>`;
                html += `<td>${shift.startTime} - ${shift.endTime}</td>`;
                html += `<td>${shift.unit}</td>`;
                html += `<td>${shift.staff}</td>`;
                html += `<td>${shift.location}</td>`;
                html += `<td>
                    <button class="btn btn-primary" style="padding: 6px 12px; margin-right: 5px;" onclick="editShift(${shift.index})">ç·¨è¼¯</button>
                    <button class="btn btn-danger" style="padding: 6px 12px; margin-right: 5px;" onclick="deleteShift(${shift.index})">åˆªé™¤</button>
                    <button class="btn btn-success" style="padding: 6px 12px;" onclick="uploadShiftToCalendar(${shift.index})" title="ä¸Šå‚³åˆ° Google è¡Œäº‹æ›†">ğŸ“… è¡Œäº‹æ›†</button>
                </td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            document.getElementById('shiftsList').innerHTML = html;
        }

        // ==================== é ç±¤åˆ‡æ› ====================
        async function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // åˆ‡æ›åˆ°é†«å¸«éƒµä»¶é ç±¤æ™‚ï¼Œè‡ªå‹•é¡¯ç¤ºéƒµä»¶åˆ—è¡¨
            if (tabName === 'staff') {
                displayStaffEmails();
            }
            
            // åˆ‡æ›åˆ°æ’ç­ç®¡ç†é ç±¤æ™‚ï¼Œå¦‚æœæœ‰é¸ä¸­çš„å–®ä½ï¼Œé‡æ–°è¼‰å…¥æ™‚æ•¸è³‡è¨Š
            if (tabName === 'manage') {
                const currentShiftUnit = document.getElementById('shiftUnit')?.value;
                if (currentShiftUnit && currentUnitData) {
                    console.log('ğŸ”„ åˆ‡æ›åˆ°æ’ç­é ç±¤ï¼Œé‡æ–°è¼‰å…¥æ™‚æ•¸è³‡è¨Š...');
                    // é‡æ–°è¼‰å…¥å–®ä½è³‡æ–™ä»¥ç²å–æœ€æ–°æ™‚æ•¸è¨­å®š
                    await loadUnitDetailData(currentShiftUnit);
                    await updateHoursInfo(true); // å¼·åˆ¶é‡æ–°è¨ˆç®—æ™‚æ•¸
                    console.log('âœ… æ™‚æ•¸è³‡è¨Šå·²æ›´æ–°');
                }
            }
        }

        // ==================== åŒ¯å‡ºåŠŸèƒ½ ====================
        function exportToExcel() {
            if (allShifts.length === 0) {
                alert('æ²’æœ‰æ’ç­è³‡æ–™å¯ä»¥åŒ¯å‡º');
                return;
            }

            // ç²å–æ—¥æœŸç¯„åœ
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;

            // ç¯©é¸è³‡æ–™
            let shiftsToExport = allShifts;
            let dateRangeText = '';

            if (startDate && endDate) {
                shiftsToExport = allShifts.filter(shift => {
                    return shift.date >= startDate && shift.date <= endDate;
                });
                dateRangeText = `_${startDate}_è‡³_${endDate}`;
                
                if (shiftsToExport.length === 0) {
                    alert('æ‰€é¸æ—¥æœŸç¯„åœå…§æ²’æœ‰æ’ç­è³‡æ–™');
                    return;
                }
            } else if (startDate) {
                shiftsToExport = allShifts.filter(shift => shift.date >= startDate);
                dateRangeText = `_${startDate}_ä¹‹å¾Œ`;
            } else if (endDate) {
                shiftsToExport = allShifts.filter(shift => shift.date <= endDate);
                dateRangeText = `_${endDate}_ä¹‹å‰`;
            }

            // æº–å‚™è³‡æ–™
            const data = [
                ['æ—¥æœŸ', 'é–‹å§‹æ™‚é–“', 'çµæŸæ™‚é–“', 'äº‹æ¥­å–®ä½', 'äººå“¡åå–®', 'åœ°é»', 'é¡è‰²', 'å‚™è¨»']
            ];

            shiftsToExport.forEach(shift => {
                data.push([
                    shift.date,
                    shift.startTime,
                    shift.endTime,
                    shift.unit,
                    shift.staff,
                    shift.location,
                    shift.color,
                    shift.notes
                ]);
            });

            // å»ºç«‹å·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);

            // è¨­å®šæ¬„å¯¬
            ws['!cols'] = [
                { wch: 12 }, // æ—¥æœŸ
                { wch: 10 }, // é–‹å§‹æ™‚é–“
                { wch: 10 }, // çµæŸæ™‚é–“
                { wch: 15 }, // äº‹æ¥­å–®ä½
                { wch: 30 }, // äººå“¡åå–®
                { wch: 25 }, // åœ°é»
                { wch: 10 }, // é¡è‰²
                { wch: 20 }  // å‚™è¨»
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'æ’ç­è³‡æ–™');

            // ä¸‹è¼‰
            const fileName = `æ’ç­è³‡æ–™${dateRangeText}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            alert(`æˆåŠŸåŒ¯å‡º ${shiftsToExport.length} ç­†æ’ç­è³‡æ–™ï¼`);
        }

        function clearExportDateRange() {
            document.getElementById('exportStartDate').value = '';
            document.getElementById('exportEndDate').value = '';
        }

        // ==================== çµ±è¨ˆå ±è¡¨ ====================
        function generateStats() {
            const startDate = document.getElementById('statsStartDate').value;
            const endDate = document.getElementById('statsEndDate').value;

            if (!startDate || !endDate) {
                alert('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ');
                return;
            }

            // ç¯©é¸æ—¥æœŸç¯„åœå…§çš„æ’ç­
            const filteredShifts = allShifts.filter(shift => {
                return shift.date >= startDate && shift.date <= endDate;
            });

            if (filteredShifts.length === 0) {
                alert('æ‰€é¸æ—¥æœŸç¯„åœå…§æ²’æœ‰æ’ç­è³‡æ–™');
                return;
            }

            // è¨ˆç®—ç¸½çµ±è¨ˆ
            calculateTotalStats(filteredShifts);

            // æŒ‰äº‹æ¥­å–®ä½çµ±è¨ˆ
            calculateStatsByUnit(filteredShifts);

            // æŒ‰äººå“¡çµ±è¨ˆ
            calculateStatsByStaff(filteredShifts);

            // æŒ‰æœˆä»½çµ±è¨ˆ
            calculateStatsByMonth(filteredShifts);
        }

        function calculateTotalStats(shifts) {
            // ç¸½æ’ç­æ•¸
            document.getElementById('statTotalShifts').textContent = shifts.length;

            // äº‹æ¥­å–®ä½æ•¸
            const units = new Set(shifts.map(s => s.unit));
            document.getElementById('statTotalUnits').textContent = units.size;

            // åƒèˆ‡äººå“¡æ•¸
            const staff = new Set();
            shifts.forEach(s => {
                s.staff.split(',').forEach(name => staff.add(name.trim()));
            });
            document.getElementById('statTotalStaff').textContent = staff.size;

            // ç¸½å·¥ä½œæ™‚æ•¸
            let totalHours = 0;
            shifts.forEach(shift => {
                const start = new Date(`2000-01-01 ${shift.startTime}`);
                const end = new Date(`2000-01-01 ${shift.endTime}`);
                const hours = (end - start) / (1000 * 60 * 60);
                totalHours += hours;
            });
            document.getElementById('statTotalHours').textContent = totalHours.toFixed(1);
        }

        function calculateStatsByUnit(shifts) {
            const stats = {};

            shifts.forEach(shift => {
                if (!stats[shift.unit]) {
                    stats[shift.unit] = {
                        count: 0,
                        hours: 0,
                        staff: new Set()
                    };
                }

                stats[shift.unit].count++;

                // è¨ˆç®—æ™‚æ•¸
                const start = new Date(`2000-01-01 ${shift.startTime}`);
                const end = new Date(`2000-01-01 ${shift.endTime}`);
                const hours = (end - start) / (1000 * 60 * 60);
                stats[shift.unit].hours += hours;

                // çµ±è¨ˆäººå“¡
                shift.staff.split(',').forEach(name => {
                    stats[shift.unit].staff.add(name.trim());
                });
            });

            // æ¸²æŸ“è¡¨æ ¼
            const tbody = document.getElementById('statsTableByUnitBody');
            let html = '';

            Object.entries(stats)
                .sort((a, b) => b[1].count - a[1].count)
                .forEach(([unit, data]) => {
                    html += `<tr>
                        <td><strong>${unit}</strong></td>
                        <td>${data.count} æ¬¡</td>
                        <td>${data.hours.toFixed(1)} å°æ™‚</td>
                        <td>${data.staff.size} äºº</td>
                    </tr>`;
                });

            tbody.innerHTML = html;
        }

        function calculateStatsByStaff(shifts) {
            const stats = {};

            shifts.forEach(shift => {
                shift.staff.split(',').forEach(name => {
                    const staffName = name.trim();
                    if (!stats[staffName]) {
                        stats[staffName] = {
                            count: 0,
                            hours: 0,
                            units: {}
                        };
                    }

                    stats[staffName].count++;

                    // è¨ˆç®—æ™‚æ•¸
                    const start = new Date(`2000-01-01 ${shift.startTime}`);
                    const end = new Date(`2000-01-01 ${shift.endTime}`);
                    const hours = (end - start) / (1000 * 60 * 60);
                    stats[staffName].hours += hours;

                    // çµ±è¨ˆå–®ä½
                    stats[staffName].units[shift.unit] = (stats[staffName].units[shift.unit] || 0) + 1;
                });
            });

            // æ¸²æŸ“è¡¨æ ¼
            const tbody = document.getElementById('statsTableByStaffBody');
            let html = '';

            Object.entries(stats)
                .sort((a, b) => b[1].count - a[1].count)
                .forEach(([staffName, data]) => {
                    // æ‰¾å‡ºä¸»è¦å–®ä½
                    const mainUnit = Object.entries(data.units)
                        .sort((a, b) => b[1] - a[1])[0][0];

                    html += `<tr>
                        <td><strong>${staffName}</strong></td>
                        <td>${data.count} æ¬¡</td>
                        <td>${data.hours.toFixed(1)} å°æ™‚</td>
                        <td>${mainUnit}</td>
                    </tr>`;
                });

            tbody.innerHTML = html;
        }

        function calculateStatsByMonth(shifts) {
            const stats = {};

            shifts.forEach(shift => {
                const month = shift.date.substring(0, 7); // YYYY-MM

                if (!stats[month]) {
                    stats[month] = {
                        count: 0,
                        hours: 0,
                        days: new Set()
                    };
                }

                stats[month].count++;

                // è¨ˆç®—æ™‚æ•¸
                const start = new Date(`2000-01-01 ${shift.startTime}`);
                const end = new Date(`2000-01-01 ${shift.endTime}`);
                const hours = (end - start) / (1000 * 60 * 60);
                stats[month].hours += hours;

                // çµ±è¨ˆå¤©æ•¸
                stats[month].days.add(shift.date);
            });

            // æ¸²æŸ“è¡¨æ ¼
            const tbody = document.getElementById('statsTableByMonthBody');
            let html = '';

            Object.entries(stats)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .forEach(([month, data]) => {
                    const avgPerDay = (data.count / data.days.size).toFixed(1);

                    html += `<tr>
                        <td><strong>${month}</strong></td>
                        <td>${data.count} æ¬¡</td>
                        <td>${data.hours.toFixed(1)} å°æ™‚</td>
                        <td>${avgPerDay} æ¬¡/æ—¥</td>
                    </tr>`;
                });

            tbody.innerHTML = html;
        }

        function exportStatsToExcel() {
            const startDate = document.getElementById('statsStartDate').value;
            const endDate = document.getElementById('statsEndDate').value;

            if (!startDate || !endDate) {
                alert('è«‹å…ˆç”¢ç”Ÿå ±è¡¨');
                return;
            }

            // å»ºç«‹å·¥ä½œç°¿
            const wb = XLSX.utils.book_new();

            // å·¥ä½œè¡¨1ï¼šç¸½è¦½
            const summaryData = [
                ['çµ±è¨ˆé …ç›®', 'æ•¸å€¼'],
                ['å ±è¡¨æ—¥æœŸç¯„åœ', `${startDate} è‡³ ${endDate}`],
                ['ç¸½æ’ç­æ•¸', document.getElementById('statTotalShifts').textContent],
                ['äº‹æ¥­å–®ä½æ•¸', document.getElementById('statTotalUnits').textContent],
                ['åƒèˆ‡äººå“¡æ•¸', document.getElementById('statTotalStaff').textContent],
                ['ç¸½å·¥ä½œæ™‚æ•¸', document.getElementById('statTotalHours').textContent + ' å°æ™‚']
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, 'ç¸½è¦½');

            // å·¥ä½œè¡¨2ï¼šæŒ‰äº‹æ¥­å–®ä½
            const unitTable = document.getElementById('statsTableByUnit');
            const ws2 = XLSX.utils.table_to_sheet(unitTable);
            XLSX.utils.book_append_sheet(wb, ws2, 'æŒ‰äº‹æ¥­å–®ä½');

            // å·¥ä½œè¡¨3ï¼šæŒ‰äººå“¡
            const staffTable = document.getElementById('statsTableByStaff');
            const ws3 = XLSX.utils.table_to_sheet(staffTable);
            XLSX.utils.book_append_sheet(wb, ws3, 'æŒ‰äººå“¡');

            // å·¥ä½œè¡¨4ï¼šæŒ‰æœˆä»½
            const monthTable = document.getElementById('statsTableByMonth');
            const ws4 = XLSX.utils.table_to_sheet(monthTable);
            XLSX.utils.book_append_sheet(wb, ws4, 'æŒ‰æœˆä»½');

            // ä¸‹è¼‰
            const fileName = `æ’ç­çµ±è¨ˆå ±è¡¨_${startDate}_${endDate}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // ==================== ç‹€æ…‹è¨Šæ¯ ====================
        function showLoginStatus(message, type) {
            const el = document.getElementById('loginStatus');
            el.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }

        function showSettingsStatus(message, type) {
            const el = document.getElementById('settingsStatus');
            el.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            if (type === 'success') {
                setTimeout(() => el.innerHTML = '', 3000);
            }
        }

        // ==================== éšæ®µ1æ–°åŠŸèƒ½ï¼šå‡æ—¥ç®¡ç† ====================
        
        // å„²å­˜å‡æ—¥è¨­å®š
        function saveHolidaySettings() {
            const country = document.getElementById('holidayCountry').value;
            const showHolidays = document.getElementById('showHolidays').checked;
            
            localStorage.setItem('holidayCountry', country);
            localStorage.setItem('showHolidays', showHolidays);
            
            // é‡æ–°è¼‰å…¥å‡æ—¥ä¸¦æ›´æ–°æœˆæ›†
            loadHolidays().then(() => {
                renderCalendar();
                showHolidayStatus('å‡æ—¥è¨­å®šå·²å„²å­˜', 'success');
            });
        }

        // è¼‰å…¥å‡æ—¥è¨­å®š
        function loadHolidaySettings() {
            const country = localStorage.getItem('holidayCountry') || 'TW';
            const showHolidays = localStorage.getItem('showHolidays') !== 'false';
            
            document.getElementById('holidayCountry').value = country;
            document.getElementById('showHolidays').checked = showHolidays;
        }

        // å¾APIè¼‰å…¥å‡æ—¥
        async function loadHolidays(forceReload = false) {
            const country = localStorage.getItem('holidayCountry') || 'TW';
            const year = currentDate.getFullYear();
            const cacheKey = `holidays_${country}_${year}`;
            
            // æª¢æŸ¥å¿«å–
            if (!forceReload) {
                const cached = localStorage.getItem(cacheKey);
                if (cached) {
                    try {
                        holidays = JSON.parse(cached);
                        console.log(`âœ… å¾å¿«å–è¼‰å…¥ ${country} ${year} å‡æ—¥ï¼š${Object.keys(holidays).length} å€‹`);
                        return holidays;
                    } catch (e) {
                        console.warn('å¿«å–è³‡æ–™æå£ï¼Œé‡æ–°è¼‰å…¥', e);
                        localStorage.removeItem(cacheKey);
                    }
                }
            }

            try {
                showHolidayStatus('è¼‰å…¥å‡æ—¥ä¸­...', 'info');
                
                // ä½¿ç”¨ Nager.Date å…è²» API
                const url = `https://date.nager.at/api/v3/PublicHolidays/${year}/${country}`;
                console.log(`ğŸ”„ æ­£åœ¨å¾ API è¼‰å…¥å‡æ—¥ï¼š${url}`);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log(`ğŸ“¡ API å›æ‡‰ç‹€æ…‹ï¼š${response.status} ${response.statusText}`);
                
                // ç‰¹æ®Šè™•ç† HTTP 204 No Contentï¼ˆè¡¨ç¤ºè©²åœ‹å®¶/å¹´ä»½ç„¡å‡æ—¥è³‡æ–™ï¼‰
                if (response.status === 204) {
                    console.log(`â„¹ï¸ HTTP 204 No Content - ${country} ${year} ç„¡å‡æ—¥è³‡æ–™`);
                    holidays = {};
                    showHolidayStatus(`${country} ${year} å¹´ç„¡å‡æ—¥è³‡æ–™ï¼ˆé€™æ˜¯æ­£å¸¸çš„ï¼‰`, 'info');
                    return holidays;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} - ${response.statusText}`);
                }
                
                // æª¢æŸ¥éŸ¿æ‡‰å…§å®¹é¡å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error(`API è¿”å›é JSON æ ¼å¼ï¼š${contentType}`);
                }
                
                // ç²å–éŸ¿æ‡‰æ–‡æœ¬
                const text = await response.text();
                console.log(`ğŸ“„ API å›æ‡‰é•·åº¦ï¼š${text.length} å­—å…ƒ`);
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºç©º
                if (!text || text.trim().length === 0) {
                    throw new Error('API è¿”å›ç©ºå…§å®¹');
                }
                
                // è§£æ JSON
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error('JSON è§£æå¤±æ•—ï¼Œå…§å®¹ï¼š', text.substring(0, 200));
                    throw new Error(`JSON è§£æå¤±æ•—ï¼š${e.message}`);
                }
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºé™£åˆ—
                if (!Array.isArray(data)) {
                    console.warn('API è¿”å›éé™£åˆ—æ ¼å¼ï¼Œå¯èƒ½è©²åœ‹å®¶ç„¡å‡æ—¥è³‡æ–™');
                    data = [];
                }
                
                // è½‰æ›ç‚ºæ˜“æ–¼æŸ¥è©¢çš„æ ¼å¼
                holidays = {};
                data.forEach(holiday => {
                    if (holiday && holiday.date) {
                        holidays[holiday.date] = {
                            name: holiday.name || 'å‡æ—¥',
                            localName: holiday.localName || holiday.name || 'å‡æ—¥',
                            global: holiday.global !== false
                        };
                    }
                });
                
                // å„²å­˜åˆ°å¿«å–
                try {
                    localStorage.setItem(cacheKey, JSON.stringify(holidays));
                    console.log(`ğŸ’¾ å‡æ—¥è³‡æ–™å·²å¿«å–`);
                } catch (e) {
                    console.warn('ç„¡æ³•å„²å­˜å¿«å–ï¼š', e);
                }
                
                const count = Object.keys(holidays).length;
                console.log(`âœ… æˆåŠŸè¼‰å…¥ ${country} ${year} å‡æ—¥ï¼š${count} å€‹`);
                
                if (count === 0) {
                    showHolidayStatus(`${country} ${year} å¹´ç„¡å‡æ—¥è³‡æ–™`, 'info');
                } else {
                    showHolidayStatus(`æˆåŠŸè¼‰å…¥ ${count} å€‹å‡æ—¥`, 'success');
                }
                
                return holidays;
            } catch (error) {
                console.error('âŒ è¼‰å…¥å‡æ—¥å¤±æ•—ï¼š', error);
                console.error('éŒ¯èª¤è©³æƒ…ï¼š', {
                    message: error.message,
                    stack: error.stack,
                    country: country,
                    year: year
                });
                
                // é¡¯ç¤ºå‹å–„çš„éŒ¯èª¤è¨Šæ¯
                let errorMsg = 'è¼‰å…¥å‡æ—¥å¤±æ•—';
                if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    errorMsg = 'ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯';
                } else if (error.message.includes('HTTP 404')) {
                    errorMsg = `è©²åœ‹å®¶ (${country}) å¯èƒ½ç„¡å‡æ—¥è³‡æ–™`;
                } else if (error.message.includes('JSON')) {
                    errorMsg = 'API è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
                } else {
                    errorMsg = `è¼‰å…¥å¤±æ•—ï¼š${error.message}`;
                }
                
                showHolidayStatus(errorMsg, 'error');
                holidays = {};
                return holidays;
            }
        }

        // é‡æ–°è¼‰å…¥å‡æ—¥
        async function reloadHolidays() {
            await loadHolidays(true);
            renderCalendar();
        }

        // æª¢æŸ¥æ˜¯å¦ç‚ºå‡æ—¥
        function isHoliday(dateStr) {
            const showHolidays = localStorage.getItem('showHolidays') !== 'false';
            if (!showHolidays) return null;
            
            return holidays[dateStr] || null;
        }

        // é¡¯ç¤ºå‡æ—¥ç‹€æ…‹è¨Šæ¯
        function showHolidayStatus(message, type) {
            const el = document.getElementById('holidayStatus');
            if (el) {
                el.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
                if (type === 'success') {
                    setTimeout(() => el.innerHTML = '', 3000);
                }
            }
        }

        // ==================== Google è¡Œäº‹æ›†è‡ªå‹•åŒæ­¥è¨­å®š ====================
        
        // å„²å­˜è‡ªå‹•åŒæ­¥è¨­å®š
        function saveCalendarSyncSettings() {
            const autoSync = document.getElementById('autoSyncCalendar').checked;
            localStorage.setItem('autoSyncCalendar', autoSync);
            
            const statusEl = document.getElementById('calendarSyncStatus');
            const statusTextEl = document.getElementById('calendarSyncStatusText');
            
            if (statusEl && statusTextEl) {
                statusEl.style.display = 'block';
                if (autoSync) {
                    statusTextEl.innerHTML = '<span style="color: #4caf50;">âœ… å·²å•Ÿç”¨è‡ªå‹•åŒæ­¥</span>';
                } else {
                    statusTextEl.innerHTML = '<span style="color: #999;">â¸ï¸ å·²é—œé–‰è‡ªå‹•åŒæ­¥</span>';
                }
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
            
            console.log('ğŸ“… è‡ªå‹•åŒæ­¥è¨­å®šï¼š', autoSync ? 'å·²å•Ÿç”¨' : 'å·²é—œé–‰');
        }
        
        // è¼‰å…¥è‡ªå‹•åŒæ­¥è¨­å®š
        function loadCalendarSyncSettings() {
            const autoSync = localStorage.getItem('autoSyncCalendar') === 'true';
            const checkbox = document.getElementById('autoSyncCalendar');
            if (checkbox) {
                checkbox.checked = autoSync;
            }
            console.log('ğŸ“… è¼‰å…¥è‡ªå‹•åŒæ­¥è¨­å®šï¼š', autoSync ? 'å·²å•Ÿç”¨' : 'å·²é—œé–‰');
        }
        
        // æª¢æŸ¥æ˜¯å¦å•Ÿç”¨è‡ªå‹•åŒæ­¥
        function isAutoSyncEnabled() {
            return localStorage.getItem('autoSyncCalendar') === 'true';
        }
        
        // æª¢æŸ¥æ›´æ–°æ©Ÿåˆ¶æ˜¯å¦æ­£ç¢º
        function checkUpdateMechanism() {
            const resultDiv = document.getElementById('diagnosisResult');
            resultDiv.style.display = 'block';
            
            let html = `
                <div style="padding: 20px; background: white; border-radius: 8px;">
                    <strong style="color: #1976d2; font-size: 18px;">ğŸ”¬ æ›´æ–°æ©Ÿåˆ¶æª¢æŸ¥å ±å‘Š</strong>
                    <div style="margin-top: 20px;">
            `;
            
            // æª¢æŸ¥ 1ï¼šå‡½æ•¸æ˜¯å¦å­˜åœ¨
            const hasUpdateFunction = typeof autoUpdateCalendarEvent === 'function';
            html += `
                <div style="padding: 15px; background: ${hasUpdateFunction ? '#e8f5e9' : '#ffebee'}; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${hasUpdateFunction ? '#4caf50' : '#f44336'};">
                    <strong>${hasUpdateFunction ? 'âœ…' : 'âŒ'} æ›´æ–°å‡½æ•¸å­˜åœ¨æ€§æª¢æŸ¥</strong>
                    <p style="margin: 10px 0 0 0; color: #666;">
                        autoUpdateCalendarEvent å‡½æ•¸${hasUpdateFunction ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}
                    </p>
                </div>
            `;
            
            if (hasUpdateFunction) {
                // æª¢æŸ¥ 2ï¼šå‡½æ•¸æ˜¯å¦ä½¿ç”¨æ­£ç¢ºçš„ update API
                const functionCode = autoUpdateCalendarEvent.toString();
                const usesUpdateAPI = functionCode.includes('events.update');
                const usesDeleteAPI = functionCode.includes('autoDeleteCalendarEvent') || functionCode.includes('events.delete');
                
                html += `
                    <div style="padding: 15px; background: ${usesUpdateAPI && !usesDeleteAPI ? '#e8f5e9' : '#fff3cd'}; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${usesUpdateAPI && !usesDeleteAPI ? '#4caf50' : '#ff9800'};">
                        <strong>${usesUpdateAPI && !usesDeleteAPI ? 'âœ…' : 'âš ï¸'} æ›´æ–°é‚è¼¯æª¢æŸ¥</strong>
                        <p style="margin: 10px 0 0 0; color: #666;">
                            ${usesUpdateAPI ? 'âœ… ä½¿ç”¨ events.update APIï¼ˆæ­£ç¢ºï¼‰' : 'âŒ æœªä½¿ç”¨ events.update API'}
                        </p>
                        <p style="margin: 10px 0 0 0; color: #666;">
                            ${usesDeleteAPI ? 'âš ï¸ åŒ…å« delete é‚è¼¯ï¼ˆå¯èƒ½æœ‰å•é¡Œï¼‰' : 'âœ… ä¸åŒ…å« delete é‚è¼¯ï¼ˆæ­£ç¢ºï¼‰'}
                        </p>
                    </div>
                `;
                
                // æª¢æŸ¥ 3ï¼šæŒ‰éˆ•ç¦ç”¨æ©Ÿåˆ¶
                const saveShiftCode = saveShift.toString();
                const hasButtonDisable = saveShiftCode.includes('btn.disabled = true');
                
                html += `
                    <div style="padding: 15px; background: ${hasButtonDisable ? '#e8f5e9' : '#ffebee'}; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${hasButtonDisable ? '#4caf50' : '#f44336'};">
                        <strong>${hasButtonDisable ? 'âœ…' : 'âŒ'} æŒ‰éˆ•é˜²é‡è¤‡é»æ“Šæ©Ÿåˆ¶</strong>
                        <p style="margin: 10px 0 0 0; color: #666;">
                            saveShift å‡½æ•¸${hasButtonDisable ? 'æœ‰' : 'æ²’æœ‰'}ç¦ç”¨æŒ‰éˆ•çš„é‚è¼¯
                        </p>
                    </div>
                `;
                
                // æª¢æŸ¥ 4ï¼šè‡ªå‹•åŒæ­¥ç‹€æ…‹
                const autoSyncEnabled = isAutoSyncEnabled();
                html += `
                    <div style="padding: 15px; background: ${autoSyncEnabled ? '#e8f5e9' : '#fff3cd'}; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${autoSyncEnabled ? '#4caf50' : '#ff9800'};">
                        <strong>${autoSyncEnabled ? 'âœ…' : 'âš ï¸'} è‡ªå‹•åŒæ­¥ç‹€æ…‹</strong>
                        <p style="margin: 10px 0 0 0; color: #666;">
                            ${autoSyncEnabled ? 'å·²å•Ÿç”¨è‡ªå‹•åŒæ­¥' : 'æœªå•Ÿç”¨è‡ªå‹•åŒæ­¥ï¼ˆä¸æœƒæ›´æ–°è¡Œäº‹æ›†ï¼‰'}
                        </p>
                    </div>
                `;
                
                // æª¢æŸ¥ 5ï¼šé†«å¸«éƒµä»¶è¨­å®š
                const hasEmailMap = staffEmailMap && Object.keys(staffEmailMap).length > 0;
                html += `
                    <div style="padding: 15px; background: ${hasEmailMap ? '#e8f5e9' : '#fff3cd'}; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${hasEmailMap ? '#4caf50' : '#ff9800'};">
                        <strong>${hasEmailMap ? 'âœ…' : 'âš ï¸'} é†«å¸«éƒµä»¶è¨­å®š</strong>
                        <p style="margin: 10px 0 0 0; color: #666;">
                            ${hasEmailMap ? `å·²è¨­å®š ${Object.keys(staffEmailMap).length} ä½é†«å¸«çš„éƒµä»¶` : 'æœªè¨­å®šé†«å¸«éƒµä»¶ï¼ˆä¸æœƒç™¼é€é€šçŸ¥ï¼‰'}
                        </p>
                    </div>
                `;
                
                // ç¶œåˆåˆ¤æ–·
                const allCorrect = usesUpdateAPI && !usesDeleteAPI && hasButtonDisable;
                
                html += `
                    <div style="padding: 20px; background: ${allCorrect ? '#e8f5e9' : '#fff3cd'}; border-radius: 8px; margin-top: 20px; border: 2px solid ${allCorrect ? '#4caf50' : '#ff9800'};">
                        <strong style="color: ${allCorrect ? '#2e7d32' : '#f57c00'}; font-size: 16px;">
                            ${allCorrect ? 'âœ… ç¶œåˆè©•ä¼°ï¼šæ›´æ–°æ©Ÿåˆ¶æ­£ç¢º' : 'âš ï¸ ç¶œåˆè©•ä¼°ï¼šå¯èƒ½å­˜åœ¨å•é¡Œ'}
                        </strong>
                        <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 5px;">
                `;
                
                if (allCorrect) {
                    html += `
                        <p style="margin: 0; color: #666; line-height: 1.8;">
                            <strong style="color: #2e7d32;">ç³»çµ±é…ç½®æ­£ç¢ºï¼</strong><br><br>
                            âœ… ä½¿ç”¨æ­£ç¢ºçš„ update APIï¼ˆä¸æœƒç”¢ç”Ÿé‡è¤‡äº‹ä»¶ï¼‰<br>
                            âœ… æœ‰æŒ‰éˆ•é˜²é‡è¤‡é»æ“Šæ©Ÿåˆ¶<br>
                            ${autoSyncEnabled ? 'âœ… å·²å•Ÿç”¨è‡ªå‹•åŒæ­¥<br>' : ''}
                            ${hasEmailMap ? `âœ… å·²è¨­å®š ${Object.keys(staffEmailMap).length} ä½é†«å¸«éƒµä»¶<br>` : ''}
                            <br>
                            <strong>å¦‚æœä»ç„¶å‡ºç¾é‡è¤‡ï¼š</strong><br>
                            1. è«‹æŒ‰ Ctrl + Shift + R å¼·åˆ¶åˆ·æ–°é é¢<br>
                            2. æ¸…é™¤ç€è¦½å™¨å¿«å–å¾Œé‡æ–°æ¸¬è©¦<br>
                            3. æª¢æŸ¥æ˜¯å¦æœ‰èˆŠçš„é‡è¤‡äº‹ä»¶æ®˜ç•™<br>
                            4. ä½¿ç”¨ç„¡ç—•æ¨¡å¼æ¸¬è©¦æ’é™¤æ“´å……å¥—ä»¶å½±éŸ¿
                        </p>
                    `;
                } else {
                    html += `
                        <p style="margin: 0; color: #666; line-height: 1.8;">
                            <strong style="color: #f57c00;">ç™¼ç¾æ½›åœ¨å•é¡Œï¼</strong><br><br>
                            ${!usesUpdateAPI ? 'âŒ æœªä½¿ç”¨ events.update API<br>' : ''}
                            ${usesDeleteAPI ? 'âš ï¸ åŒ…å« delete é‚è¼¯ï¼ˆå¯èƒ½å°è‡´é‡è¤‡ï¼‰<br>' : ''}
                            ${!hasButtonDisable ? 'âŒ ç¼ºå°‘æŒ‰éˆ•é˜²é‡è¤‡é»æ“Šæ©Ÿåˆ¶<br>' : ''}
                            <br>
                            <strong>å»ºè­°è™•ç†ï¼š</strong><br>
                            1. æ‚¨å¯èƒ½ä½¿ç”¨çš„æ˜¯èˆŠç‰ˆæœ¬ä»£ç¢¼<br>
                            2. è«‹æŒ‰ Ctrl + Shift + R å¼·åˆ¶åˆ·æ–°<br>
                            3. æ¸…é™¤ç€è¦½å™¨å¿«å–ï¼š<br>
                               - Chrome: Ctrl + Shift + Delete<br>
                               - é¸æ“‡ã€Œå…¨éƒ¨æ™‚é–“ã€<br>
                               - æ¸…é™¤ã€Œå¿«å–çš„åœ–ç‰‡å’Œæª”æ¡ˆã€<br>
                            4. é‡æ–°è¼‰å…¥é é¢ä¸¦å†æ¬¡æª¢æŸ¥<br>
                            5. å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹ä½¿ç”¨ç„¡ç—•æ¨¡å¼æ¸¬è©¦
                        </p>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                // æ¸¬è©¦å»ºè­°
                html += `
                    <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <strong style="color: #1976d2;">ğŸ’¡ æ¸¬è©¦å»ºè­°</strong>
                        <ol style="margin: 10px 0 0 20px; color: #666; line-height: 1.8;">
                            <li>åœ¨ Chrome DevTools çš„ Console é ç±¤è§€å¯Ÿæ—¥èªŒ</li>
                            <li>ç·¨è¼¯ä¸€å€‹æ¸¬è©¦æ’ç­</li>
                            <li>æŸ¥çœ‹ Console æ‡‰é¡¯ç¤ºï¼š
                                <div style="margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 5px; font-family: monospace; font-size: 13px;">
                                    ğŸ”„ æ›´æ–°è¡Œäº‹æ›†äº‹ä»¶...<br>
                                    ğŸ”„ è‡ªå‹•æ›´æ–°è¡Œäº‹æ›†äº‹ä»¶ï¼šxxx<br>
                                    âœ… è¡Œäº‹æ›†äº‹ä»¶å·²æ›´æ–°
                                </div>
                            </li>
                            <li>å¦‚æœçœ‹åˆ°ã€ŒğŸ—‘ï¸ åˆªé™¤ã€å­—æ¨£ï¼Œè¡¨ç¤ºä½¿ç”¨èˆŠç‰ˆæœ¬</li>
                            <li>æª¢æŸ¥ Google è¡Œäº‹æ›†æ˜¯å¦åªæœ‰ä¸€å€‹äº‹ä»¶</li>
                        </ol>
                    </div>
                `;
                
            } else {
                html += `
                    <div style="padding: 15px; background: #ffebee; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f44336;">
                        <strong style="color: #c62828;">âŒ åš´é‡éŒ¯èª¤</strong>
                        <p style="margin: 10px 0 0 0; color: #666;">
                            ç„¡æ³•æ‰¾åˆ° autoUpdateCalendarEvent å‡½æ•¸ï¼<br><br>
                            <strong>é€™è¡¨ç¤ºï¼š</strong><br>
                            - é é¢æœªæ­£ç¢ºè¼‰å…¥<br>
                            - æˆ–ä½¿ç”¨äº†æå£çš„ç‰ˆæœ¬<br><br>
                            <strong>è«‹åŸ·è¡Œï¼š</strong><br>
                            1. å®Œå…¨é—œé–‰ç€è¦½å™¨<br>
                            2. æ¸…é™¤æ‰€æœ‰å¿«å–<br>
                            3. é‡æ–°é–‹å•Ÿä¸¦è¼‰å…¥ç³»çµ±
                        </p>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            resultDiv.innerHTML = html;
        }
        
        // è¨ºæ–·æ’ç­åŒæ­¥ç‹€æ…‹
        async function diagnoseSyncStatus() {
            const resultDiv = document.getElementById('diagnosisResult');
            
            if (!allShifts || allShifts.length === 0) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <div style="padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <strong>âš ï¸ ç„¡æ³•è¨ºæ–·</strong>
                        <p style="margin: 10px 0 0 0; color: #666;">
                            æ²’æœ‰è¼‰å…¥æ’ç­è³‡æ–™ã€‚è«‹å…ˆç™»å…¥ä¸¦è¼‰å…¥æ’ç­è³‡æ–™ã€‚
                        </p>
                    </div>
                `;
                return;
            }
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div style="padding: 15px; background: white; border-radius: 8px; text-align: center;">
                    <strong>ğŸ” æ­£åœ¨è¨ºæ–·...</strong>
                    <p style="margin: 10px 0 0 0; color: #666;">è«‹ç¨å€™</p>
                </div>
            `;
            
            // çµ±è¨ˆè³‡æ–™
            const totalShifts = allShifts.length;
            const shiftsWithEventId = allShifts.filter(s => s.eventId && s.eventId.trim() !== '').length;
            const shiftsWithoutEventId = totalShifts - shiftsWithEventId;
            
            // æª¢æŸ¥è‡ªå‹•åŒæ­¥ç‹€æ…‹
            const autoSyncEnabled = isAutoSyncEnabled();
            
            // æ‰¾å‡ºæœ€è¿‘çš„æ²’æœ‰eventIdçš„æ’ç­ï¼ˆæœªä¾†çš„æ—¥æœŸï¼‰
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const futureShiftsWithoutEventId = allShifts.filter(s => {
                if (!s.eventId || s.eventId.trim() === '') {
                    const shiftDate = new Date(s.date);
                    return shiftDate >= today;
                }
                return false;
            });
            
            // ç”Ÿæˆè¨ºæ–·å ±å‘Š
            let html = `
                <div style="padding: 20px; background: white; border-radius: 8px;">
                    <strong style="color: #1976d2; font-size: 18px;">ğŸ“Š è¨ºæ–·å ±å‘Š</strong>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 32px; font-weight: bold; color: #1976d2;">${totalShifts}</div>
                                <div style="color: #666; margin-top: 5px;">ç¸½æ’ç­æ•¸</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 32px; font-weight: bold; color: #4caf50;">${shiftsWithEventId}</div>
                                <div style="color: #666; margin-top: 5px;">å·²åŒæ­¥è¡Œäº‹æ›†</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 32px; font-weight: bold; color: #ff9800;">${shiftsWithoutEventId}</div>
                                <div style="color: #666; margin-top: 5px;">æœªåŒæ­¥ï¼ˆèˆŠè³‡æ–™ï¼‰</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: ${autoSyncEnabled ? '#e8f5e9' : '#ffebee'}; border-radius: 8px; border-left: 4px solid ${autoSyncEnabled ? '#4caf50' : '#f44336'};">
                        <strong style="color: ${autoSyncEnabled ? '#2e7d32' : '#c62828'};">
                            ${autoSyncEnabled ? 'âœ… è‡ªå‹•åŒæ­¥å·²å•Ÿç”¨' : 'âŒ è‡ªå‹•åŒæ­¥å·²é—œé–‰'}
                        </strong>
                        <p style="margin: 10px 0 0 0; color: #666;">
                            ${autoSyncEnabled 
                                ? 'æ–°å¢çš„æ’ç­æœƒè‡ªå‹•åŒæ­¥åˆ°è¡Œäº‹æ›†' 
                                : 'è«‹åœ¨è¨­å®šä¸­å•Ÿç”¨ã€Œè‡ªå‹•åŒæ­¥åˆ° Google è¡Œäº‹æ›†ã€åŠŸèƒ½'}
                        </p>
                    </div>
            `;
            
            // å¦‚æœæœ‰æœªåŒæ­¥çš„æœªä¾†æ’ç­ï¼Œé¡¯ç¤ºè­¦å‘Š
            if (futureShiftsWithoutEventId.length > 0) {
                html += `
                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <strong style="color: #f57c00;">âš ï¸ ç™¼ç¾ ${futureShiftsWithoutEventId.length} å€‹æœªä¾†æ’ç­æ²’æœ‰åŒæ­¥</strong>
                        <p style="margin: 10px 0 0 0; color: #666;">
                            é€™äº›æ’ç­åœ¨åˆªé™¤æ™‚<strong>ä¸æœƒ</strong>åŒæ­¥åˆªé™¤è¡Œäº‹æ›†äº‹ä»¶ã€‚
                        </p>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #1976d2;">æŸ¥çœ‹è©³ç´°åˆ—è¡¨ â–¼</summary>
                            <div style="margin-top: 10px; max-height: 200px; overflow-y: auto; background: white; padding: 10px; border-radius: 5px;">
                `;
                
                futureShiftsWithoutEventId.slice(0, 20).forEach(shift => {
                    html += `
                        <div style="padding: 8px; border-bottom: 1px solid #eee; font-size: 14px;">
                            ğŸ“… ${shift.date} ${shift.startTime}-${shift.endTime} | ${shift.unit} | ${shift.staff}
                        </div>
                    `;
                });
                
                if (futureShiftsWithoutEventId.length > 20) {
                    html += `<div style="padding: 8px; color: #888; font-size: 14px;">... é‚„æœ‰ ${futureShiftsWithoutEventId.length - 20} å€‹</div>`;
                }
                
                html += `
                            </div>
                        </details>
                    </div>
                `;
            }
            
            // å»ºè­°
            html += `
                <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                    <strong style="color: #1976d2;">ğŸ’¡ å»ºè­°</strong>
                    <ul style="margin: 10px 0 0 20px; color: #666; line-height: 1.8;">
            `;
            
            if (!autoSyncEnabled) {
                html += `<li><strong>å•Ÿç”¨è‡ªå‹•åŒæ­¥ï¼š</strong>åœ¨è¨­å®šä¸­é–‹å•Ÿã€Œè‡ªå‹•åŒæ­¥åˆ° Google è¡Œäº‹æ›†ã€</li>`;
            }
            
            if (shiftsWithoutEventId > 0) {
                html += `
                    <li><strong>èˆŠæ’ç­è™•ç†ï¼š</strong>${shiftsWithoutEventId} å€‹èˆŠæ’ç­æ²’æœ‰è¡Œäº‹æ›†é—œè¯
                        <ul style="margin-top: 5px;">
                            <li>é€™äº›æ’ç­åœ¨åˆªé™¤æ™‚<strong>ä¸æœƒ</strong>è‡ªå‹•åˆªé™¤è¡Œäº‹æ›†äº‹ä»¶</li>
                            <li>éœ€è¦æ‰‹å‹•åœ¨ Google è¡Œäº‹æ›†ä¸­åˆªé™¤</li>
                            <li>æˆ–é‡æ–°ç·¨è¼¯ä¸¦å„²å­˜é€™äº›æ’ç­ä»¥å»ºç«‹é—œè¯</li>
                        </ul>
                    </li>
                `;
            }
            
            if (shiftsWithEventId > 0) {
                html += `<li><strong>âœ… è‰¯å¥½ï¼š</strong>${shiftsWithEventId} å€‹æ’ç­å·²æ­£ç¢ºåŒæ­¥ï¼Œåˆªé™¤æ™‚æœƒè‡ªå‹•ç§»é™¤è¡Œäº‹æ›†äº‹ä»¶</li>`;
            }
            
            html += `
                    </ul>
                </div>
            `;
            
            html += `</div>`;
            
            resultDiv.innerHTML = html;
        }
        
        // è‡ªå‹•åŒæ­¥æ’ç­åˆ°è¡Œäº‹æ›†ï¼ˆåŒ…å«éŒ¯èª¤è™•ç†ï¼‰
        async function autoSyncShiftToCalendar(shiftData, shiftIndex) {
            if (!isAutoSyncEnabled()) {
                console.log('â¸ï¸ è‡ªå‹•åŒæ­¥å·²é—œé–‰ï¼Œè·³é');
                return null;
            }
            
            console.log('ğŸ”„ é–‹å§‹è‡ªå‹•åŒæ­¥æ’ç­åˆ°è¡Œäº‹æ›†...', shiftData);
            
            try {
                // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
                if (!gapiInited || !gisInited) {
                    console.warn('âš ï¸ Google API æœªåˆå§‹åŒ–');
                    return null;
                }
                
                // å–å¾—åƒèˆ‡è€…éƒµä»¶åˆ—è¡¨
                const attendees = getStaffEmails(shiftData.staff);
                console.log('ğŸ“§ åƒèˆ‡è€…åˆ—è¡¨ï¼š', attendees);
                
                // å»ºç«‹è¡Œäº‹æ›†äº‹ä»¶
                const event = {
                    summary: `${shiftData.unit} - æ’ç­`,
                    location: shiftData.location || shiftData.unit,
                    description: `äººå“¡ï¼š${shiftData.staff}\\nåœ°é»ï¼š${shiftData.location || shiftData.unit}\\nå‚™è¨»ï¼š${shiftData.notes || 'ç„¡'}\\n\\næ­¤ç‚ºè‡ªå‹•æ’ç­é€šçŸ¥ï¼Œè«‹ç¢ºèªæ‚¨çš„è¡Œç¨‹å®‰æ’ã€‚`,
                    start: {
                        dateTime: `${shiftData.date}T${shiftData.startTime}:00`,
                        timeZone: 'Asia/Taipei'
                    },
                    end: {
                        dateTime: `${shiftData.date}T${shiftData.endTime}:00`,
                        timeZone: 'Asia/Taipei'
                    },
                    colorId: getCalendarColorId(shiftData.color),
                    attendees: attendees, // æ·»åŠ åƒèˆ‡è€…
                    reminders: {
                        useDefault: false,
                        overrides: [
                            { method: 'popup', minutes: 30 },
                            { method: 'popup', minutes: 1440 }
                        ]
                    },
                    // éƒµä»¶é€šçŸ¥è¨­å®š
                    guestsCanModify: false, // åƒèˆ‡è€…ä¸èƒ½ä¿®æ”¹
                    guestsCanInviteOthers: false, // åƒèˆ‡è€…ä¸èƒ½é‚€è«‹å…¶ä»–äºº
                    guestsCanSeeOtherGuests: true // åƒèˆ‡è€…å¯ä»¥çœ‹åˆ°å…¶ä»–åƒèˆ‡è€…
                };
                
                // å»ºç«‹äº‹ä»¶ä¸¦ç™¼é€éƒµä»¶é€šçŸ¥
                const response = await gapi.client.calendar.events.insert({
                    calendarId: 'primary',
                    resource: event,
                    sendNotifications: true, // ğŸ”” è‡ªå‹•ç™¼é€éƒµä»¶é€šçŸ¥
                    sendUpdates: 'all' // ç™¼é€é€šçŸ¥çµ¦æ‰€æœ‰åƒèˆ‡è€…
                });
                
                console.log('âœ… è‡ªå‹•åŒæ­¥æˆåŠŸï¼Œäº‹ä»¶IDï¼š', response.result.id);
                
                if (attendees.length > 0) {
                    console.log(`ğŸ“§ å·²ç™¼é€éƒµä»¶é€šçŸ¥çµ¦ ${attendees.length} ä½äººå“¡`);
                }
                
                return response.result.id; // è¿”å›äº‹ä»¶ID
                
            } catch (error) {
                console.error('âŒ è‡ªå‹•åŒæ­¥å¤±æ•—ï¼š', error);
                // ä¸é˜»æ–·æ’ç­å»ºç«‹æµç¨‹ï¼Œåªè¨˜éŒ„éŒ¯èª¤
                return null;
            }
        }
        
        // è‡ªå‹•åˆªé™¤è¡Œäº‹æ›†äº‹ä»¶
        async function autoDeleteCalendarEvent(eventId, sendCancellation = true) {
            if (!isAutoSyncEnabled() || !eventId) {
                return { success: false, attendeeCount: 0 };
            }
            
            console.log('ğŸ—‘ï¸ è‡ªå‹•åˆªé™¤è¡Œäº‹æ›†äº‹ä»¶ï¼š', eventId);
            
            try {
                // å…ˆç²å–äº‹ä»¶è³‡è¨Šä»¥å–å¾—åƒèˆ‡è€…åˆ—è¡¨
                let attendeeCount = 0;
                try {
                    const eventInfo = await gapi.client.calendar.events.get({
                        calendarId: 'primary',
                        eventId: eventId
                    });
                    
                    attendeeCount = eventInfo.result.attendees ? eventInfo.result.attendees.length : 0;
                    console.log(`ğŸ“§ äº‹ä»¶æœ‰ ${attendeeCount} ä½åƒèˆ‡è€…`);
                } catch (getError) {
                    console.warn('âš ï¸ ç„¡æ³•å–å¾—äº‹ä»¶è³‡è¨Šï¼š', getError);
                }
                
                // åˆªé™¤äº‹ä»¶ä¸¦ç™¼é€å–æ¶ˆé€šçŸ¥
                await gapi.client.calendar.events.delete({
                    calendarId: 'primary',
                    eventId: eventId,
                    sendUpdates: sendCancellation ? 'all' : 'none' // ğŸ”” ç™¼é€å–æ¶ˆé€šçŸ¥çµ¦æ‰€æœ‰åƒèˆ‡è€…
                });
                
                console.log('âœ… è¡Œäº‹æ›†äº‹ä»¶å·²åˆªé™¤');
                
                if (sendCancellation && attendeeCount > 0) {
                    console.log(`ğŸ“§ å·²ç™¼é€å–æ¶ˆé€šçŸ¥çµ¦ ${attendeeCount} ä½åƒèˆ‡è€…`);
                }
                
                return { success: true, attendeeCount: attendeeCount };
            } catch (error) {
                console.error('âŒ åˆªé™¤è¡Œäº‹æ›†äº‹ä»¶å¤±æ•—ï¼š', error);
                // å³ä½¿å¤±æ•—ä¹Ÿä¸é˜»æ–·åˆªé™¤æ’ç­
                return { success: false, attendeeCount: 0 };
            }
        }
        
        // è‡ªå‹•æ›´æ–°è¡Œäº‹æ›†äº‹ä»¶
        async function autoUpdateCalendarEvent(eventId, shiftData) {
            if (!isAutoSyncEnabled() || !eventId) {
                return null;
            }
            
            console.log('ğŸ”„ è‡ªå‹•æ›´æ–°è¡Œäº‹æ›†äº‹ä»¶ï¼š', eventId);
            
            try {
                // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
                if (!gapiInited || !gisInited) {
                    console.warn('âš ï¸ Google API æœªåˆå§‹åŒ–');
                    return null;
                }
                
                // å–å¾—åƒèˆ‡è€…éƒµä»¶åˆ—è¡¨
                const attendees = getStaffEmails(shiftData.staff);
                console.log('ğŸ“§ æ›´æ–°åƒèˆ‡è€…åˆ—è¡¨ï¼š', attendees);
                
                // æº–å‚™æ›´æ–°çš„äº‹ä»¶è³‡æ–™
                const event = {
                    summary: `${shiftData.unit} - æ’ç­`,
                    location: shiftData.location || shiftData.unit,
                    description: `äººå“¡ï¼š${shiftData.staff}\\nåœ°é»ï¼š${shiftData.location || shiftData.unit}\\nå‚™è¨»ï¼š${shiftData.notes || 'ç„¡'}\\n\\næ­¤ç‚ºè‡ªå‹•æ’ç­é€šçŸ¥ï¼Œè«‹ç¢ºèªæ‚¨çš„è¡Œç¨‹å®‰æ’ã€‚`,
                    start: {
                        dateTime: `${shiftData.date}T${shiftData.startTime}:00`,
                        timeZone: 'Asia/Taipei'
                    },
                    end: {
                        dateTime: `${shiftData.date}T${shiftData.endTime}:00`,
                        timeZone: 'Asia/Taipei'
                    },
                    colorId: getCalendarColorId(shiftData.color),
                    attendees: attendees,
                    reminders: {
                        useDefault: false,
                        overrides: [
                            { method: 'popup', minutes: 30 },
                            { method: 'popup', minutes: 1440 }
                        ]
                    },
                    guestsCanModify: false,
                    guestsCanInviteOthers: false,
                    guestsCanSeeOtherGuests: true
                };
                
                // ä½¿ç”¨ update API ç›´æ¥æ›´æ–°äº‹ä»¶ï¼ˆé¿å…é‡è¤‡ï¼‰
                const response = await gapi.client.calendar.events.update({
                    calendarId: 'primary',
                    eventId: eventId,
                    resource: event,
                    sendNotifications: true,
                    sendUpdates: 'all'
                });
                
                console.log('âœ… è¡Œäº‹æ›†äº‹ä»¶å·²æ›´æ–°ï¼Œäº‹ä»¶IDï¼š', response.result.id);
                
                if (attendees.length > 0) {
                    console.log(`ğŸ“§ å·²ç™¼é€æ›´æ–°é€šçŸ¥çµ¦ ${attendees.length} ä½äººå“¡`);
                }
                
                return response.result.id; // è¿”å›ç›¸åŒçš„äº‹ä»¶ID
                
            } catch (error) {
                console.error('âŒ æ›´æ–°è¡Œäº‹æ›†äº‹ä»¶å¤±æ•—ï¼š', error);
                
                // å¦‚æœæ›´æ–°å¤±æ•—ï¼ˆä¾‹å¦‚äº‹ä»¶å·²è¢«åˆªé™¤ï¼‰ï¼Œå˜—è©¦å»ºç«‹æ–°äº‹ä»¶
                if (error.status === 404) {
                    console.log('âš ï¸ åŸäº‹ä»¶ä¸å­˜åœ¨ï¼ˆå¯èƒ½å·²è¢«åˆªé™¤ï¼‰ï¼Œå»ºç«‹æ–°äº‹ä»¶...');
                    const newEventId = await autoSyncShiftToCalendar(shiftData);
                    return newEventId;
                }
                
                return null;
            }
        }

        // ==================== éšæ®µ1æ–°åŠŸèƒ½ï¼šé»æ“Šæ—¥æœŸæ–°å¢æ’ç­ ====================
        
        // é»æ“Šæ—¥æœŸé–‹å•Ÿæ–°å¢æ’ç­è¡¨å–®
        function onCalendarDayClick(dateStr) {
            console.log('ğŸ“… é»æ“Šæ—¥æ›†æ—¥æœŸï¼š', dateStr);
            
            // åˆ‡æ›åˆ°æ’ç­ç®¡ç†é ç±¤
            switchTab('manage');
            
            // é¡¯ç¤ºæ–°å¢è¡¨å–®ï¼ˆæœƒæ¸…ç©ºè¡¨å–®ï¼‰
            showAddShiftForm();
            
            // å»¶é²è¨­å®šæ—¥æœŸï¼Œç¢ºä¿è¡¨å–®å·²æ¸…ç©ºå¾Œå†è¨­å®š
            setTimeout(() => {
                // è‡ªå‹•å¡«å…¥æ—¥æœŸ
                document.getElementById('shiftDate').value = dateStr;
                console.log('âœ… æ—¥æœŸå·²è¨­å®šï¼š', dateStr);
                
                // æ²å‹•åˆ°è¡¨å–®
                document.getElementById('shiftForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 50);
        }

        // ==================== éšæ®µ1æ–°åŠŸèƒ½ï¼šæ™‚é–“è‡ªå‹•è¨ˆç®— ====================
        
        // ç›£è½é–‹å§‹æ™‚é–“è®Šæ›´ï¼Œè‡ªå‹•è¨­å®šçµæŸæ™‚é–“ï¼ˆ+2å°æ™‚ï¼‰
        function setupTimeAutoCalculation() {
            const startTimeInput = document.getElementById('startTime');
            if (startTimeInput) {
                startTimeInput.addEventListener('change', function() {
                    const startTime = this.value;
                    if (startTime) {
                        // è§£æé–‹å§‹æ™‚é–“
                        const [hours, minutes] = startTime.split(':').map(Number);
                        
                        // è¨ˆç®—çµæŸæ™‚é–“ï¼ˆ+2å°æ™‚ï¼‰
                        let endHours = hours + 2;
                        let endMinutes = minutes;
                        
                        // è™•ç†è·¨æ—¥
                        if (endHours >= 24) {
                            endHours = endHours - 24;
                        }
                        
                        // æ ¼å¼åŒ–ç‚º HH:MM
                        const endTime = `${String(endHours).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}`;
                        
                        // è¨­å®šçµæŸæ™‚é–“
                        document.getElementById('endTime').value = endTime;
                    }
                });
            }
        }

        // ==================== éšæ®µ2æ–°åŠŸèƒ½ ====================
        
        let currentUnitData = null; // ç•¶å‰é¸æ“‡çš„å–®ä½å®Œæ•´è³‡æ–™
        let currentMonthHoursUsage = {}; // ç•¶æœˆæ™‚æ•¸ä½¿ç”¨æƒ…æ³å¿«å–
        
        // ç•¶é¸æ“‡äº‹æ¥­å–®ä½æ™‚è§¸ç™¼
        async function onUnitChange() {
            const unitName = document.getElementById('shiftUnit').value;
            
            console.log('ğŸ¢ äº‹æ¥­å–®ä½è®Šæ›´ï¼š', unitName);
            
            if (!unitName) {
                // æ¸…ç©ºäººå“¡å’Œåœ°é»
                document.getElementById('staffCheckboxes').innerHTML = '<p style="text-align: center; color: #999;">è«‹å…ˆé¸æ“‡äº‹æ¥­å–®ä½</p>';
                document.getElementById('locationContainer').innerHTML = '<input type="text" id="location" placeholder="è«‹å…ˆé¸æ“‡äº‹æ¥­å–®ä½" readonly style="background: #f8f9fa;">';
                document.getElementById('unitHoursInfo').innerHTML = '';
                currentUnitData = null;
                console.log('âš ï¸ æœªé¸æ“‡å–®ä½ï¼Œå·²æ¸…ç©ºç›¸é—œæ¬„ä½');
                return;
            }
            
            try {
                console.log('ğŸ“¥ é–‹å§‹è¼‰å…¥å–®ä½è©³ç´°è³‡æ–™...');
                
                // è¼‰å…¥è©²å–®ä½çš„è©³ç´°è³‡æ–™
                await loadUnitDetailData(unitName);
                
                if (!currentUnitData) {
                    console.error('âŒ è¼‰å…¥å–®ä½è³‡æ–™å¤±æ•—ï¼šcurrentUnitData ç‚ºç©º');
                    alert('âš ï¸ ç„¡æ³•è¼‰å…¥è©²å–®ä½çš„è©³ç´°è³‡æ–™\n\nè«‹ç¢ºèªï¼š\n1. è©²å–®ä½å·²åœ¨ã€Œäº‹æ¥­å–®ä½è©³ç´°ã€è¡¨ä¸­è¨­å®š\n2. å·²å¡«å¯«äººå“¡åå–®å’Œæœˆåº¦æ™‚æ•¸');
                    return;
                }
                
                console.log('âœ… å–®ä½è³‡æ–™è¼‰å…¥æˆåŠŸ');
                
                // ç”Ÿæˆäººå“¡å‹¾é¸æ¡†
                console.log('ğŸ‘¥ ç”Ÿæˆäººå“¡åˆ—è¡¨...');
                generateStaffCheckboxes();
                
                // è¨­å®šåœ°é»é¸æ“‡
                console.log('ğŸ“ è¨­å®šåœ°é»é¸æ“‡...');
                setupLocationSelection();
                
                // æ›´æ–°æ™‚æ•¸è³‡è¨Š
                console.log('â±ï¸ æ›´æ–°æ™‚æ•¸è³‡è¨Š...');
                await updateHoursInfo();
                
                console.log('âœ… æ‰€æœ‰æ¬„ä½æ›´æ–°å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ onUnitChange åŸ·è¡ŒéŒ¯èª¤ï¼š', error);
                alert('è¼‰å…¥å–®ä½è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
            }
        }
        
        // è¼‰å…¥å–®ä½è©³ç´°è³‡æ–™
        async function loadUnitDetailData(unitName) {
            try {
                const config = loadConfig();
                if (!config.sheetId) {
                    console.error('Sheet ID æœªè¨­å®š');
                    return;
                }
                
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: config.sheetId,
                    range: 'äº‹æ¥­å–®ä½è©³ç´°!A2:AQ',
                });
                
                const rows = response.result.values || [];
                
                // æ‰¾åˆ°è©²å–®ä½çš„è³‡æ–™
                for (const row of rows) {
                    if (row[0] === unitName) {
                        currentUnitData = {
                            name: row[0] || '',
                            isDistributed: row[1] || 'å¦',
                            address: row[2] || '',
                            branches: [],
                            doctors: row[4] || '',
                            nurses: row[5] || '',
                            others: row[6] || '',
                            monthlyHours: {}
                        };
                        
                        // è§£æåˆ†é»è³‡æ–™
                        if (currentUnitData.isDistributed === 'æ˜¯' && row[3]) {
                            try {
                                currentUnitData.branches = JSON.parse(row[3]);
                            } catch (e) {
                                console.error('è§£æåˆ†é»è³‡æ–™å¤±æ•—', e);
                                currentUnitData.branches = [];
                            }
                        }
                        
                        // è®€å–12å€‹æœˆçš„æ™‚æ•¸
                        for (let i = 0; i < 12; i++) {
                            currentUnitData.monthlyHours[i + 1] = {
                                doc: row[7 + i * 3] || '0',
                                nurse: row[8 + i * 3] || '0',
                                other: row[9 + i * 3] || '0'
                            };
                        }
                        
                        console.log('âœ… è¼‰å…¥å–®ä½è©³ç´°è³‡æ–™ï¼š', currentUnitData);
                        break;
                    }
                }
                
                if (!currentUnitData) {
                    console.warn(`æ‰¾ä¸åˆ°å–®ä½ ${unitName} çš„è©³ç´°è³‡æ–™`);
                    currentUnitData = {
                        name: unitName,
                        isDistributed: 'å¦',
                        address: '',
                        branches: [],
                        doctors: '',
                        nurses: '',
                        others: '',
                        monthlyHours: {}
                    };
                }
            } catch (error) {
                console.error('è¼‰å…¥å–®ä½è©³ç´°è³‡æ–™å¤±æ•—ï¼š', error);
                currentUnitData = {
                    name: unitName,
                    isDistributed: 'å¦',
                    address: '',
                    branches: [],
                    doctors: '',
                    nurses: '',
                    others: '',
                    monthlyHours: {}
                };
            }
        }
        
        // è¼‰å…¥é†«å¸«éƒµä»¶è³‡æ–™
        async function loadStaffEmails() {
            try {
                const config = loadConfig();
                if (!config.sheetId) {
                    console.error('Sheet ID æœªè¨­å®š');
                    return;
                }
                
                console.log('ğŸ“§ è¼‰å…¥é†«å¸«éƒµä»¶è³‡æ–™...');
                
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: config.sheetId,
                    range: 'é†«å¸«éƒµä»¶!A2:D', // å¾ç¬¬2åˆ—é–‹å§‹è®€å–ï¼ˆç¬¬1åˆ—æ˜¯æ¨™é¡Œï¼‰
                });
                
                const rows = response.result.values || [];
                staffEmailMap = {};
                
                // å»ºç«‹å§“åèˆ‡ Email çš„å°æ‡‰é—œä¿‚
                rows.forEach(row => {
                    const name = row[0]?.trim();
                    const email = row[1]?.trim();
                    if (name && email) {
                        staffEmailMap[name] = email;
                    }
                });
                
                console.log('âœ… é†«å¸«éƒµä»¶è³‡æ–™è¼‰å…¥å®Œæˆï¼š', staffEmailMap);
                console.log(`   å…±è¼‰å…¥ ${Object.keys(staffEmailMap).length} ä½äººå“¡çš„éƒµä»¶`);
                
            } catch (error) {
                console.warn('âš ï¸ è¼‰å…¥é†«å¸«éƒµä»¶è³‡æ–™å¤±æ•—ï¼ˆå¯èƒ½å·¥ä½œè¡¨ä¸å­˜åœ¨ï¼‰ï¼š', error.message);
                // å¦‚æœå·¥ä½œè¡¨ä¸å­˜åœ¨ï¼Œä¸ä¸­æ–·æµç¨‹
                staffEmailMap = {};
            }
        }
        
        // æ ¹æ“šäººå“¡åå–®å–å¾—éƒµä»¶åœ°å€åˆ—è¡¨
        function getStaffEmails(staffNames) {
            if (!staffNames) return [];
            
            const staffList = staffNames.split(',').map(s => s.trim());
            const emails = [];
            
            staffList.forEach(name => {
                if (staffEmailMap[name]) {
                    emails.push({
                        email: staffEmailMap[name],
                        displayName: name,
                        responseStatus: 'needsAction' // å¾…å›æ‡‰
                    });
                    console.log(`ğŸ“§ æ‰¾åˆ° ${name} çš„éƒµä»¶ï¼š${staffEmailMap[name]}`);
                } else {
                    console.log(`â„¹ï¸ ${name} æœªè¨­å®šéƒµä»¶åœ°å€`);
                }
            });
            
            return emails;
        }
        
        // ç”Ÿæˆäººå“¡å‹¾é¸æ¡†
        function generateStaffCheckboxes() {
            const container = document.getElementById('staffCheckboxes');
            
            console.log('ğŸ”„ ç”Ÿæˆäººå“¡å‹¾é¸æ¡†ï¼Œç•¶å‰å–®ä½è³‡æ–™ï¼š', currentUnitData);
            
            if (!currentUnitData) {
                container.innerHTML = '<p style="text-align: center; color: #999;">è«‹å…ˆé¸æ“‡äº‹æ¥­å–®ä½</p>';
                return;
            }
            
            // å¾ currentUnitData è§£æäººå“¡åˆ—è¡¨
            const doctorsList = currentUnitData.doctors ? currentUnitData.doctors.split(',').map(s => s.trim()).filter(s => s) : [];
            const nursesList = currentUnitData.nurses ? currentUnitData.nurses.split(',').map(s => s.trim()).filter(s => s) : [];
            const othersList = currentUnitData.others ? currentUnitData.others.split(',').map(s => s.trim()).filter(s => s) : [];
            
            console.log('ğŸ‘¨â€âš•ï¸ é†«ç”Ÿï¼š', doctorsList);
            console.log('ğŸ‘©â€âš•ï¸ è­·ç†å¸«ï¼š', nursesList);
            console.log('ğŸ‘¤ å…¶ä»–äººå“¡ï¼š', othersList);
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•äººå“¡
            if (doctorsList.length === 0 && nursesList.length === 0 && othersList.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">è©²å–®ä½ç„¡äººå“¡è³‡æ–™<br><small style="color: #666;">è«‹åˆ°ã€ŒğŸ¢ äº‹æ¥­å–®ä½ã€é ç±¤è¨­å®šäººå“¡åå–®</small></p>';
                return;
            }
            
            let html = '';
            
            // é†«å¸«ç¾¤çµ„
            if (doctorsList.length > 0) {
                html += '<div class="staff-checkbox-group">';
                html += '<div class="staff-checkbox-group-title">ğŸ‘¨â€âš•ï¸ é†«å¸« <span class="staff-count-badge">' + doctorsList.length + '</span></div>';
                doctorsList.forEach((staff, index) => {
                    html += `
                        <div class="staff-checkbox-item" onclick="toggleCheckbox('doctor_${index}')">
                            <input type="checkbox" id="doctor_${index}" value="${staff}" onchange="updateStaffSelection()">
                            <label for="doctor_${index}">${staff}</label>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // è­·ç†å¸«ç¾¤çµ„
            if (nursesList.length > 0) {
                html += '<div class="staff-checkbox-group">';
                html += '<div class="staff-checkbox-group-title">ğŸ‘©â€âš•ï¸ è­·ç†å¸« <span class="staff-count-badge">' + nursesList.length + '</span></div>';
                nursesList.forEach((staff, index) => {
                    html += `
                        <div class="staff-checkbox-item" onclick="toggleCheckbox('nurse_${index}')">
                            <input type="checkbox" id="nurse_${index}" value="${staff}" onchange="updateStaffSelection()">
                            <label for="nurse_${index}">${staff}</label>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // å…¶ä»–äººå“¡ç¾¤çµ„
            if (othersList.length > 0) {
                html += '<div class="staff-checkbox-group">';
                html += '<div class="staff-checkbox-group-title">ğŸ‘¤ å…¶ä»–äººå“¡ <span class="staff-count-badge">' + othersList.length + '</span></div>';
                othersList.forEach((staff, index) => {
                    html += `
                        <div class="staff-checkbox-item" onclick="toggleCheckbox('other_${index}')">
                            <input type="checkbox" id="other_${index}" value="${staff}" onchange="updateStaffSelection()">
                            <label for="other_${index}">${staff}</label>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            console.log('âœ… äººå“¡å‹¾é¸æ¡†ç”Ÿæˆå®Œæˆ');
            container.innerHTML = html;
        }
        
        // åˆ‡æ›å‹¾é¸æ¡†ç‹€æ…‹
        function toggleCheckbox(id) {
            const checkbox = document.getElementById(id);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateStaffSelection();
            }
        }
        
        // æ›´æ–°äººå“¡é¸æ“‡
        function updateStaffSelection() {
            // æ›´æ–°å‹¾é¸æ¡†æ¨£å¼
            const checkboxes = document.querySelectorAll('#staffCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => {
                const item = cb.closest('.staff-checkbox-item');
                if (cb.checked) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }
            });
        }
        
        // å–å¾—é¸ä¸­çš„äººå“¡åˆ—è¡¨
        function getSelectedStaff() {
            const checkboxes = document.querySelectorAll('#staffCheckboxes input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        // ==================== é†«å¸«éƒµä»¶è¨­ç½®ç®¡ç† ====================
        
        // æ‰‹å‹•é‡æ–°è¼‰å…¥é†«å¸«éƒµä»¶è³‡æ–™
        async function loadStaffEmailsManual() {
            showStaffEmailStatus('è¼‰å…¥ä¸­...', 'info');
            
            await loadStaffEmails();
            await displayStaffEmails();
            
            const count = Object.keys(staffEmailMap).length;
            if (count > 0) {
                showStaffEmailStatus(`âœ… æˆåŠŸè¼‰å…¥ ${count} ä½äººå“¡çš„éƒµä»¶è³‡æ–™`, 'success');
            } else {
                showStaffEmailStatus('âš ï¸ æœªæ‰¾åˆ°éƒµä»¶è³‡æ–™ã€‚è«‹ç¢ºèªå·²å»ºç«‹ã€Œé†«å¸«éƒµä»¶ã€å·¥ä½œè¡¨ä¸¦å¡«å…¥è³‡æ–™ã€‚', 'warning');
            }
        }
        
        // é¡¯ç¤ºé†«å¸«éƒµä»¶åˆ—è¡¨
        async function displayStaffEmails() {
            const container = document.getElementById('staffEmailList');
            
            if (Object.keys(staffEmailMap).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“­</div>
                        <h3 style="color: #666;">å°šæœªè¨­å®šé†«å¸«éƒµä»¶</h3>
                        <p style="margin: 10px 0;">è«‹å…ˆåœ¨ Google Sheets ä¸­å»ºç«‹ã€Œé†«å¸«éƒµä»¶ã€å·¥ä½œè¡¨</p>
                        <button class="btn btn-primary" onclick="showEmailSetupGuide()" style="margin-top: 15px;">æŸ¥çœ‹è¨­å®šæŒ‡å—</button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="margin-bottom: 15px; padding: 10px; background: #e8f5e9; border-radius: 5px; border-left: 4px solid #4caf50;">
                    <strong style="color: #2e7d32;">âœ… å…± ${Object.keys(staffEmailMap).length} ä½äººå“¡å·²è¨­å®šéƒµä»¶</strong>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f0f0f0;">
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left; width: 60px;">ç·¨è™Ÿ</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">å§“å</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">éƒµä»¶åœ°å€</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center; width: 100px;">ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let index = 1;
            for (const [name, email] of Object.entries(staffEmailMap)) {
                const isValidEmail = email.includes('@');
                const statusIcon = isValidEmail ? 'âœ…' : 'âš ï¸';
                const statusText = isValidEmail ? 'æœ‰æ•ˆ' : 'ç„¡æ•ˆ';
                const statusColor = isValidEmail ? '#4caf50' : '#ff9800';
                
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center; color: #999;">${index}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;"><strong>${name}</strong></td>
                        <td style="padding: 12px; border: 1px solid #ddd; font-family: monospace; color: #1976d2;">
                            <a href="mailto:${email}" style="color: #1976d2; text-decoration: none;">${email}</a>
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                            <span style="color: ${statusColor}; font-weight: bold;">${statusIcon} ${statusText}</span>
                        </td>
                    </tr>
                `;
                index++;
            }
            
            html += `
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ff9800;">
                    <strong style="color: #f57c00;">ğŸ’¡ æç¤º</strong>
                    <ul style="margin: 10px 0 0 20px; color: #666; line-height: 1.8;">
                        <li>å»ºç«‹æ’ç­æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•ç™¼é€éƒµä»¶çµ¦é€™äº›äººå“¡</li>
                        <li>è‹¥è¦ä¿®æ”¹éƒµä»¶è³‡æ–™ï¼Œè«‹é»æ“Šã€ŒğŸ“ åœ¨ Google Sheets ä¸­ç·¨è¼¯ã€</li>
                        <li>ä¿®æ”¹å¾Œè¨˜å¾—é»æ“Šã€ŒğŸ”„ é‡æ–°è¼‰å…¥éƒµä»¶è³‡æ–™ã€</li>
                    </ul>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
        function showStaffEmailStatus(message, type = 'info') {
            const statusDiv = document.getElementById('staffEmailStatus');
            
            const colors = {
                success: { bg: '#e8f5e9', border: '#4caf50', text: '#2e7d32' },
                error: { bg: '#ffebee', border: '#f44336', text: '#c62828' },
                warning: { bg: '#fff3cd', border: '#ff9800', text: '#f57c00' },
                info: { bg: '#e3f2fd', border: '#2196f3', text: '#1976d2' }
            };
            
            const color = colors[type] || colors.info;
            
            statusDiv.innerHTML = `
                <div style="padding: 15px; background: ${color.bg}; border-radius: 8px; border-left: 4px solid ${color.border};">
                    <strong style="color: ${color.text};">${message}</strong>
                </div>
            `;
            
            // 3ç§’å¾Œæ·¡å‡ºï¼ˆé™¤éæ˜¯éŒ¯èª¤æˆ–è­¦å‘Šï¼‰
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
            }
        }
        
        // é–‹å•Ÿ Google Sheets çš„é†«å¸«éƒµä»¶å·¥ä½œè¡¨
        function openGoogleSheetEmailTab() {
            const config = loadConfig();
            if (!config.sheetId) {
                alert('âŒ å°šæœªè¨­å®š Google Sheets ID\n\nè«‹å…ˆåˆ°ã€Œâš™ï¸ è¨­å®šã€é ç±¤è¨­å®š Google Sheets ID');
                return;
            }
            
            // æ§‹å»º Google Sheets URLï¼Œç›´æ¥é–‹å•Ÿã€Œé†«å¸«éƒµä»¶ã€å·¥ä½œè¡¨
            const sheetUrl = `https://docs.google.com/spreadsheets/d/${config.sheetId}/edit#gid=0`;
            
            // åœ¨æ–°è¦–çª—é–‹å•Ÿ
            window.open(sheetUrl, '_blank');
            
            showStaffEmailStatus('ğŸ“ å·²åœ¨æ–°è¦–çª—é–‹å•Ÿ Google Sheetsï¼Œè«‹æ‰¾åˆ°ã€Œé†«å¸«éƒµä»¶ã€å·¥ä½œè¡¨é€²è¡Œç·¨è¼¯', 'info');
        }
        
        // é¡¯ç¤ºè¨­å®šæŒ‡å—
        function showEmailSetupGuide() {
            document.getElementById('emailSetupGuide').style.display = 'block';
            document.getElementById('emailSetupGuide').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // éš±è—è¨­å®šæŒ‡å—
        function hideEmailSetupGuide() {
            document.getElementById('emailSetupGuide').style.display = 'none';
        }
        
        // è¨­å®šåœ°é»é¸æ“‡
        function setupLocationSelection() {
            const container = document.getElementById('locationContainer');
            
            console.log('ğŸ“ è¨­å®šåœ°é»é¸æ“‡ï¼Œç•¶å‰å–®ä½è³‡æ–™ï¼š', currentUnitData);
            
            if (!currentUnitData) {
                container.innerHTML = '<input type="text" id="location" placeholder="è«‹å…ˆé¸æ“‡äº‹æ¥­å–®ä½" readonly style="background: #f8f9fa; width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">';
                console.log('âš ï¸ ç„¡å–®ä½è³‡æ–™');
                return;
            }
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºåˆ†æ•£å‹
            if (currentUnitData.isDistributed === 'æ˜¯') {
                console.log('ğŸ¢ åˆ†æ•£å‹å–®ä½ï¼Œåˆ†é»è³‡æ–™ï¼š', currentUnitData.branches);
                
                // åˆ†æ•£å‹ï¼šä½¿ç”¨ branches é™£åˆ—
                const branches = currentUnitData.branches || [];
                
                if (branches.length === 0) {
                    container.innerHTML = '<input type="text" id="location" placeholder="è©²å–®ä½ç„¡åˆ†é»è³‡æ–™ï¼Œè«‹æ‰‹å‹•è¼¸å…¥" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">';
                    console.log('âš ï¸ ç„¡åˆ†é»è³‡æ–™');
                    return;
                }
                
                // ç”Ÿæˆä¸‹æ‹‰é¸å–®
                let html = '<select id="location" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">';
                html += '<option value="">è«‹é¸æ“‡åˆ†é»</option>';
                branches.forEach(branch => {
                    const label = `${branch.name} - ${branch.address}`;
                    html += `<option value="${label}">${label}</option>`;
                });
                html += '</select>';
                
                container.innerHTML = html;
                console.log(`âœ… å·²ç”Ÿæˆ ${branches.length} å€‹åˆ†é»é¸é …`);
                
            } else {
                console.log('ğŸ  éåˆ†æ•£å‹å–®ä½ï¼Œåœ°å€ï¼š', currentUnitData.address);
                
                // éåˆ†æ•£å‹ï¼šè‡ªå‹•å¡«å…¥åœ°å€
                const address = currentUnitData.address || '';
                container.innerHTML = `<input type="text" id="location" required value="${address}" placeholder="è«‹è¼¸å…¥åœ°é»" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">`;
                console.log('âœ… åœ°å€å·²è‡ªå‹•å¡«å…¥');
            }
        }
        
        // æ›´æ–°æ™‚æ•¸è³‡è¨Š
        async function updateHoursInfo(forceRecalculate = false) {
            const infoSpan = document.getElementById('unitHoursInfo');
            
            if (!currentUnitData) {
                infoSpan.textContent = '';
                return;
            }
            
            // è¨ˆç®—ç•¶æœˆå‰©é¤˜æ™‚æ•¸ï¼ˆå¯å¼·åˆ¶é‡æ–°è¨ˆç®—ï¼‰
            const remaining = await calculateRemainingHours(currentUnitData.name, forceRecalculate);
            
            if (remaining) {
                // æ ¹æ“šå‰©é¤˜æ™‚æ•¸é¡¯ç¤ºä¸åŒé¡è‰²
                let doctorColor = remaining.doctor > 20 ? '#28a745' : remaining.doctor > 0 ? '#ffc107' : '#dc3545';
                let nurseColor = remaining.nurse > 20 ? '#28a745' : remaining.nurse > 0 ? '#ffc107' : '#dc3545';
                let otherColor = remaining.other > 20 ? '#28a745' : remaining.other > 0 ? '#ffc107' : '#dc3545';
                
                infoSpan.innerHTML = `
                    <span style="color: #666; font-size: 11px;">
                        æœ¬æœˆå‰©é¤˜ï¼š
                        <span style="color: ${doctorColor}; font-weight: bold;">é†«å¸« ${remaining.doctor}h</span> / 
                        <span style="color: ${nurseColor}; font-weight: bold;">è­·ç†å¸« ${remaining.nurse}h</span> / 
                        <span style="color: ${otherColor}; font-weight: bold;">å…¶ä»– ${remaining.other}h</span>
                    </span>
                `;
            } else {
                infoSpan.innerHTML = '<span style="color: #999; font-size: 11px;">è«‹å…ˆé¸æ“‡æ—¥æœŸ</span>';
            }
        }
        
        // è¨ˆç®—å‰©é¤˜æ™‚æ•¸
        async function calculateRemainingHours(unitName, forceRecalculate = false) {
            try {
                console.log('ğŸ”¢ è¨ˆç®—å‰©é¤˜æ™‚æ•¸ï¼Œäº‹æ¥­å–®ä½ï¼š', unitName, forceRecalculate ? '(å¼·åˆ¶é‡æ–°è¨ˆç®—)' : '');
                
                // 1. ç²å–ç•¶å‰æœˆä»½
                const shiftDate = document.getElementById('shiftDate').value;
                if (!shiftDate) {
                    console.warn('âš ï¸ æœªé¸æ“‡æ—¥æœŸï¼Œç„¡æ³•è¨ˆç®—å‰©é¤˜æ™‚æ•¸');
                    return null;
                }
                
                const date = new Date(shiftDate);
                const month = date.getMonth() + 1; // 1-12
                const yearMonth = `${date.getFullYear()}-${String(month).padStart(2, '0')}`;
                console.log('ğŸ“… è¨ˆç®—æœˆä»½ï¼š', yearMonth);
                
                // æª¢æŸ¥å¿«å–ï¼ˆé™¤éå¼·åˆ¶é‡æ–°è¨ˆç®—ï¼‰
                const cacheKey = `${unitName}-${yearMonth}`;
                if (!forceRecalculate && currentMonthHoursUsage[cacheKey]) {
                    console.log('ğŸ“¦ ä½¿ç”¨å¿«å–è³‡æ–™');
                    return currentMonthHoursUsage[cacheKey];
                }
                
                // 2. å¾ã€Œäº‹æ¥­å–®ä½è©³ç´°ã€è®€å–è©²å–®ä½çš„æœˆåº¦é…é¡
                if (!currentUnitData || !currentUnitData.monthlyHours || !currentUnitData.monthlyHours[month]) {
                    console.warn('âš ï¸ æ‰¾ä¸åˆ°è©²å–®ä½çš„æœˆåº¦é…é¡è³‡æ–™');
                    return null;
                }
                
                const monthlyQuota = currentUnitData.monthlyHours[month];
                const quotaDoc = parseInt(monthlyQuota.doc) || 0;
                const quotaNurse = parseInt(monthlyQuota.nurse) || 0;
                const quotaOther = parseInt(monthlyQuota.other) || 0;
                
                console.log(`ğŸ“Š ${month}æœˆé…é¡ - é†«ç”Ÿ:${quotaDoc}h, è­·ç†å¸«:${quotaNurse}h, å…¶ä»–:${quotaOther}h`);
                
                // 3. è¨ˆç®—è©²å–®ä½ç•¶æœˆå·²æ’ç­çš„æ™‚æ•¸
                let usedDoc = 0, usedNurse = 0, usedOther = 0;
                
                allShifts.forEach(shift => {
                    // æª¢æŸ¥æ˜¯å¦ç‚ºåŒä¸€å–®ä½ä¸”åŒä¸€æœˆä»½
                    if (shift.unit === unitName && shift.date.startsWith(yearMonth)) {
                        // è¨ˆç®—è©²æ’ç­çš„æ™‚æ•¸
                        const start = new Date(`2000-01-01T${shift.startTime}`);
                        const end = new Date(`2000-01-01T${shift.endTime}`);
                        const hours = (end - start) / (1000 * 60 * 60); // è½‰æ›ç‚ºå°æ™‚
                        
                        // åˆ†æäººå“¡åå–®ï¼Œå€åˆ†é†«ç”Ÿã€è­·ç†å¸«ã€å…¶ä»–
                        const staffList = shift.staff.split(',').map(s => s.trim());
                        
                        staffList.forEach(staffName => {
                            // æ ¹æ“šé—œéµå­—åˆ¤æ–·é¡å‹
                            if (currentUnitData.doctors && currentUnitData.doctors.includes(staffName)) {
                                usedDoc += hours;
                            } else if (currentUnitData.nurses && currentUnitData.nurses.includes(staffName)) {
                                usedNurse += hours;
                            } else if (currentUnitData.others && currentUnitData.others.includes(staffName)) {
                                usedOther += hours;
                            }
                        });
                    }
                });
                
                console.log(`â±ï¸ ${month}æœˆå·²ç”¨ - é†«ç”Ÿ:${usedDoc}h, è­·ç†å¸«:${usedNurse}h, å…¶ä»–:${usedOther}h`);
                
                // 4. è¨ˆç®—å‰©é¤˜æ™‚æ•¸
                const remaining = {
                    doctor: Math.max(0, quotaDoc - usedDoc),
                    nurse: Math.max(0, quotaNurse - usedNurse),
                    other: Math.max(0, quotaOther - usedOther)
                };
                
                console.log(`âœ… ${month}æœˆå‰©é¤˜ - é†«ç”Ÿ:${remaining.doctor}h, è­·ç†å¸«:${remaining.nurse}h, å…¶ä»–:${remaining.other}h`);
                
                // å­˜å…¥å¿«å–
                currentMonthHoursUsage[cacheKey] = remaining;
                console.log('ğŸ’¾ å·²å­˜å…¥å¿«å–ï¼š', cacheKey);
                
                return remaining;
                
            } catch (error) {
                console.error('âŒ è¨ˆç®—å‰©é¤˜æ™‚æ•¸å¤±æ•—ï¼š', error);
                return null;
            }
        }

        // ==================== é‡è¤‡æ’ç¨‹åŠŸèƒ½ ====================
        
        // åˆ‡æ›é‡è¤‡é¸é …é¡¯ç¤º
        function toggleRepeatOptions() {
            const enabled = document.getElementById('repeatEnabled').checked;
            const options = document.getElementById('repeatOptions');
            options.style.display = enabled ? 'block' : 'none';
            
            if (enabled) {
                updateRepeatPreview();
            }
        }
        
        // æ›´æ–°é‡è¤‡é¸é …ï¼ˆæ ¹æ“šé »ç‡èª¿æ•´ç•Œé¢ï¼‰
        function updateRepeatOptions() {
            const frequency = document.getElementById('repeatFrequency').value;
            const weekdaySelection = document.getElementById('weekdaySelection');
            
            // æ¯é€±æˆ–æ¯å…©é€±æ‰é¡¯ç¤ºæ˜ŸæœŸé¸æ“‡
            if (frequency === 'weekly' || frequency === 'biweekly') {
                weekdaySelection.style.display = 'block';
            } else {
                weekdaySelection.style.display = 'none';
            }
            
            updateRepeatPreview();
        }
        
        // æ›´æ–°çµæŸæ–¹å¼é¸é …
        function updateRepeatEndOptions() {
            const endType = document.getElementById('repeatEndType').value;
            const countGroup = document.getElementById('repeatCountGroup');
            const untilGroup = document.getElementById('repeatUntilGroup');
            
            if (endType === 'count') {
                countGroup.style.display = 'block';
                untilGroup.style.display = 'none';
            } else {
                countGroup.style.display = 'none';
                untilGroup.style.display = 'block';
            }
            
            updateRepeatPreview();
        }
        
        // æ›´æ–°é‡è¤‡é è¦½
        function updateRepeatPreview() {
            const previewText = document.getElementById('repeatPreviewText');
            const baseDate = document.getElementById('shiftDate').value;
            
            if (!baseDate) {
                previewText.innerHTML = 'âš ï¸ è«‹å…ˆé¸æ“‡åŸºæº–æ—¥æœŸ';
                return;
            }
            
            try {
                const dates = generateRepeatDates();
                if (dates.length === 0) {
                    previewText.innerHTML = 'âš ï¸ æ²’æœ‰ç”Ÿæˆä»»ä½•æ—¥æœŸï¼Œè«‹æª¢æŸ¥è¨­å®š';
                    return;
                }
                
                const frequency = document.getElementById('repeatFrequency').value;
                const freqText = {
                    'daily': 'æ¯å¤©',
                    'weekly': 'æ¯é€±',
                    'biweekly': 'æ¯å…©é€±',
                    'monthly': 'æ¯æœˆ'
                }[frequency];
                
                let preview = `å°‡å»ºç«‹ <strong>${dates.length}</strong> å€‹æ’ç­ï¼ˆ${freqText}é‡è¤‡ï¼‰ï¼š<br>`;
                preview += '<div style="margin-top: 8px; max-height: 150px; overflow-y: auto;">';
                
                dates.slice(0, 10).forEach((date, index) => {
                    const dateObj = new Date(date);
                    const weekday = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][dateObj.getDay()];
                    preview += `${index + 1}. ${date} (${weekday})<br>`;
                });
                
                if (dates.length > 10) {
                    preview += `... é‚„æœ‰ ${dates.length - 10} å€‹æ—¥æœŸ`;
                }
                
                preview += '</div>';
                previewText.innerHTML = preview;
                
            } catch (error) {
                console.error('é è¦½éŒ¯èª¤ï¼š', error);
                previewText.innerHTML = 'âŒ é è¦½ç”Ÿæˆå¤±æ•—ï¼š' + error.message;
            }
        }
        
        // ç”Ÿæˆé‡è¤‡çš„æ—¥æœŸåˆ—è¡¨
        function generateRepeatDates() {
            const baseDate = document.getElementById('shiftDate').value;
            if (!baseDate) return [];
            
            const frequency = document.getElementById('repeatFrequency').value;
            const endType = document.getElementById('repeatEndType').value;
            const repeatCount = parseInt(document.getElementById('repeatCount').value) || 4;
            const repeatUntil = document.getElementById('repeatUntil').value;
            
            const dates = [];
            const startDate = new Date(baseDate);
            
            // ç²å–é¸æ“‡çš„æ˜ŸæœŸï¼ˆåƒ…ç”¨æ–¼æ¯é€±/æ¯å…©é€±ï¼‰
            const selectedWeekdays = [];
            if (frequency === 'weekly' || frequency === 'biweekly') {
                document.querySelectorAll('input[name="weekday"]:checked').forEach(cb => {
                    selectedWeekdays.push(parseInt(cb.value));
                });
                
                // å¦‚æœæ²’æœ‰é¸æ“‡ä»»ä½•æ˜ŸæœŸï¼Œä½¿ç”¨åŸºæº–æ—¥æœŸçš„æ˜ŸæœŸ
                if (selectedWeekdays.length === 0) {
                    selectedWeekdays.push(startDate.getDay());
                }
            }
            
            let currentDate = new Date(startDate);
            let maxIterations = endType === 'count' ? repeatCount : 365; // æœ€å¤šç”Ÿæˆ365å€‹æ—¥æœŸ
            let iterCount = 0;
            
            while (iterCount < maxIterations) {
                let shouldAdd = false;
                
                switch (frequency) {
                    case 'daily':
                        shouldAdd = true;
                        break;
                        
                    case 'weekly':
                        if (selectedWeekdays.includes(currentDate.getDay())) {
                            shouldAdd = true;
                        }
                        break;
                        
                    case 'biweekly':
                        const weeksDiff = Math.floor((currentDate - startDate) / (7 * 24 * 60 * 60 * 1000));
                        if (weeksDiff % 2 === 0 && selectedWeekdays.includes(currentDate.getDay())) {
                            shouldAdd = true;
                        }
                        break;
                        
                    case 'monthly':
                        if (currentDate.getDate() === startDate.getDate()) {
                            shouldAdd = true;
                        }
                        break;
                }
                
                if (shouldAdd) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    
                    // æª¢æŸ¥æ˜¯å¦è¶…éçµæŸæ—¥æœŸ
                    if (endType === 'until' && repeatUntil) {
                        if (dateStr > repeatUntil) break;
                    }
                    
                    dates.push(dateStr);
                    
                    // æª¢æŸ¥æ˜¯å¦é”åˆ°æ¬¡æ•¸
                    if (endType === 'count' && dates.length >= repeatCount) break;
                }
                
                // å¢åŠ æ—¥æœŸ
                currentDate.setDate(currentDate.getDate() + 1);
                iterCount++;
                
                // é˜²æ­¢ç„¡é™è¿´åœˆ
                if (iterCount >= maxIterations) break;
            }
            
            return dates;
        }

        // ==================== Google è¡Œäº‹æ›†æ•´åˆåŠŸèƒ½ ====================
        
        // ä¸Šå‚³å–®å€‹æ’ç­åˆ° Google è¡Œäº‹æ›†
        async function uploadShiftToCalendar(shiftIndex) {
            const shift = allShifts.find(s => s.index === shiftIndex);
            
            if (!shift) {
                alert('æ‰¾ä¸åˆ°è©²æ’ç­è³‡æ–™');
                return;
            }
            
            try {
                // å–å¾—åƒèˆ‡è€…éƒµä»¶åˆ—è¡¨
                const attendees = getStaffEmails(shift.staff);
                console.log('ğŸ“§ åƒèˆ‡è€…åˆ—è¡¨ï¼š', attendees);
                
                // å»ºç«‹è¡Œäº‹æ›†äº‹ä»¶
                const event = {
                    summary: `${shift.unit} - æ’ç­`,
                    location: shift.location || shift.unit,
                    description: `äººå“¡ï¼š${shift.staff}\\nåœ°é»ï¼š${shift.location || shift.unit}\\nå‚™è¨»ï¼š${shift.notes || 'ç„¡'}\\n\\næ­¤ç‚ºæ‰‹å‹•ä¸Šå‚³çš„æ’ç­é€šçŸ¥ã€‚`,
                    start: {
                        dateTime: `${shift.date}T${shift.startTime}:00`,
                        timeZone: 'Asia/Taipei'
                    },
                    end: {
                        dateTime: `${shift.date}T${shift.endTime}:00`,
                        timeZone: 'Asia/Taipei'
                    },
                    colorId: getCalendarColorId(shift.color),
                    attendees: attendees, // æ·»åŠ åƒèˆ‡è€…
                    reminders: {
                        useDefault: false,
                        overrides: [
                            { method: 'popup', minutes: 30 },
                            { method: 'popup', minutes: 1440 } // 1å¤©å‰
                        ]
                    },
                    // éƒµä»¶é€šçŸ¥è¨­å®š
                    guestsCanModify: false,
                    guestsCanInviteOthers: false,
                    guestsCanSeeOtherGuests: true
                };
                
                console.log('ğŸ“… æ­£åœ¨ä¸Šå‚³åˆ° Google è¡Œäº‹æ›†ï¼š', event);
                
                const response = await gapi.client.calendar.events.insert({
                    calendarId: 'primary',
                    resource: event,
                    sendNotifications: true, // ç™¼é€éƒµä»¶é€šçŸ¥
                    sendUpdates: 'all'
                });
                
                console.log('âœ… è¡Œäº‹æ›†äº‹ä»¶å·²å»ºç«‹ï¼š', response.result);
                
                let message = `âœ… å·²æˆåŠŸä¸Šå‚³åˆ° Google è¡Œäº‹æ›†ï¼\\n\\näº‹ä»¶ï¼š${shift.unit} - æ’ç­\\næ—¥æœŸï¼š${shift.date}\\næ™‚é–“ï¼š${shift.startTime} - ${shift.endTime}`;
                
                if (attendees.length > 0) {
                    message += `\\n\\nğŸ“§ å·²ç™¼é€éƒµä»¶é€šçŸ¥çµ¦ ${attendees.length} ä½äººå“¡`;
                }
                
                alert(message);
                
            } catch (error) {
                console.error('âŒ ä¸Šå‚³åˆ°è¡Œäº‹æ›†å¤±æ•—ï¼š', error);
                
                if (error.status === 401) {
                    alert('âŒ æ¬Šé™ä¸è¶³ï¼Œè«‹é‡æ–°ç™»å…¥ä¸¦æˆæ¬Šè¡Œäº‹æ›†å­˜å–æ¬Šé™');
                    handleSignOut();
                } else {
                    alert(`âŒ ä¸Šå‚³å¤±æ•—ï¼š${error.message || 'æœªçŸ¥éŒ¯èª¤'}\\n\\nè«‹ç¢ºèªå·²å•Ÿç”¨ Google Calendar API ä¸¦æˆæ¬Šå­˜å–æ¬Šé™ã€‚`);
                }
            }
        }
        
        // æ‰¹é‡ä¸Šå‚³æ‰€æœ‰æ’ç­åˆ° Google è¡Œäº‹æ›†
        async function batchUploadToCalendar() {
            if (allShifts.length === 0) {
                alert('ç›®å‰æ²’æœ‰æ’ç­è³‡æ–™');
                return;
            }
            
            const confirmed = confirm(`ç¢ºå®šè¦å°‡ ${allShifts.length} ç­†æ’ç­ä¸Šå‚³åˆ° Google è¡Œäº‹æ›†å—ï¼Ÿ\\n\\né€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ï¼Œè«‹è€å¿ƒç­‰å¾…ã€‚`);
            
            if (!confirmed) {
                return;
            }
            
            let successCount = 0;
            let failCount = 0;
            const failedShifts = [];
            
            // é¡¯ç¤ºé€²åº¦è¨Šæ¯
            const progressMsg = document.createElement('div');
            progressMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
            progressMsg.innerHTML = `
                <h3 style="margin-bottom: 15px;">æ­£åœ¨ä¸Šå‚³åˆ°è¡Œäº‹æ›†...</h3>
                <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="uploadProgress">0 / ${allShifts.length}</div>
                <p style="margin-top: 10px; color: #666;">è«‹å‹¿é—œé–‰è¦–çª—</p>
            `;
            document.body.appendChild(progressMsg);
            
            try {
                for (let i = 0; i < allShifts.length; i++) {
                    const shift = allShifts[i];
                    
                    try {
                        // å»ºç«‹è¡Œäº‹æ›†äº‹ä»¶
                        const event = {
                            summary: `${shift.unit} - æ’ç­`,
                            location: shift.location || shift.unit,
                            description: `äººå“¡ï¼š${shift.staff}\\nå‚™è¨»ï¼š${shift.notes || 'ç„¡'}`,
                            start: {
                                dateTime: `${shift.date}T${shift.startTime}:00`,
                                timeZone: 'Asia/Taipei'
                            },
                            end: {
                                dateTime: `${shift.date}T${shift.endTime}:00`,
                                timeZone: 'Asia/Taipei'
                            },
                            colorId: getCalendarColorId(shift.color),
                            reminders: {
                                useDefault: false,
                                overrides: [
                                    { method: 'popup', minutes: 30 }
                                ]
                            }
                        };
                        
                        await gapi.client.calendar.events.insert({
                            calendarId: 'primary',
                            resource: event
                        });
                        
                        successCount++;
                        
                    } catch (error) {
                        console.error(`ä¸Šå‚³æ’ç­ ${i+1} å¤±æ•—ï¼š`, error);
                        failCount++;
                        failedShifts.push(`${shift.date} ${shift.unit}`);
                    }
                    
                    // æ›´æ–°é€²åº¦
                    document.getElementById('uploadProgress').textContent = `${i + 1} / ${allShifts.length}`;
                    
                    // é¿å…APIè«‹æ±‚éå¿«ï¼Œæ¯æ¬¡é–“éš”100ms
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // ç§»é™¤é€²åº¦è¨Šæ¯
                document.body.removeChild(progressMsg);
                
                // é¡¯ç¤ºçµæœ
                let resultMsg = `âœ… æ‰¹é‡ä¸Šå‚³å®Œæˆï¼\\n\\næˆåŠŸï¼š${successCount} ç­†\\nå¤±æ•—ï¼š${failCount} ç­†`;
                if (failedShifts.length > 0) {
                    resultMsg += `\\n\\nå¤±æ•—çš„æ’ç­ï¼š\\n${failedShifts.join('\\n')}`;
                }
                alert(resultMsg);
                
            } catch (error) {
                document.body.removeChild(progressMsg);
                console.error('æ‰¹é‡ä¸Šå‚³éŒ¯èª¤ï¼š', error);
                alert(`âŒ æ‰¹é‡ä¸Šå‚³å¤±æ•—ï¼š${error.message || 'æœªçŸ¥éŒ¯èª¤'}`);
            }
        }
        
        // å°‡ç³»çµ±é¡è‰²è½‰æ›ç‚º Google è¡Œäº‹æ›†é¡è‰² ID
        function getCalendarColorId(hexColor) {
            // Google Calendar é¡è‰² ID å°ç…§
            // åƒè€ƒï¼šhttps://developers.google.com/calendar/api/v3/reference/colors
            const colorMap = {
                '#667eea': '9',  // è—è‰²
                '#4ECDC4': '7',  // é’è‰²
                '#45B7D1': '7',  // é’è‰²
                '#FFA07A': '6',  // æ©˜è‰²
                '#98D8C8': '2',  // ç¶ è‰²
                '#F7DC6F': '5',  // é»ƒè‰²
                '#BB8FCE': '3',  // ç´«è‰²
                '#85C1E2': '9',  // è—è‰²
                '#F8B739': '5',  // é»ƒè‰²
                '#52B788': '2',  // ç¶ è‰²
                '#FF6B6B': '11', // ç´…è‰²
                '#FF6F91': '11', // ç´…è‰²
                '#6C5CE7': '9',  // è—è‰²
                '#00B894': '10', // ç¶ è‰²
                '#FDCB6E': '5',  // é»ƒè‰²
                '#E17055': '6'   // æ©˜è‰²
            };
            
            return colorMap[hexColor] || '1'; // é è¨­æ·¡ç´«è‰²
        }
    </script>
</body>
</html>


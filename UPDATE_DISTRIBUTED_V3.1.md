# 📋 更新日誌 v3.1.0 - 分散型事業單位管理

## 📅 更新日期
2025-11-03

## ✨ 新增功能

### 🏢 分散型事業單位支援

當選擇「是否為分散型：是」時，可以新增多個分散地點。

#### 功能特色

1. **動態分點管理**
   - ✅ 新增多個分點
   - ✅ 每個分點有獨立名稱和地址
   - ✅ 可隨時刪除分點
   - ✅ 自動驗證（至少一個分點）

2. **智慧介面切換**
   - ✅ 選擇「否」→ 顯示單一地址輸入
   - ✅ 選擇「是」→ 顯示分點管理介面
   - ✅ 自動新增第一個分點
   - ✅ 平滑過渡動畫

3. **完整的編輯支援**
   - ✅ 編輯時自動還原分點資料
   - ✅ 可新增、修改、刪除分點
   - ✅ 資料完整性保護

4. **清晰的列表顯示**
   - ✅ 分散型顯示所有分點
   - ✅ 非分散型顯示單一地址
   - ✅ 多行顯示，易於閱讀

---

## 🎨 UI 改進

### 新增 CSS 樣式

```css
.branch-item {
    /* 分點卡片樣式 */
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
}

.branch-remove-btn {
    /* 刪除按鈕 */
    position: absolute;
    top: 10px;
    right: 10px;
}
```

### 視覺優化

- ✅ 分點採用卡片式設計
- ✅ 刪除按鈕位於卡片右上角
- ✅ 清晰的輸入提示
- ✅ 友善的按鈕配色

---

## 💻 JavaScript 新增功能

### 核心函數

#### 1. `addBranch()`
新增分點到列表
- 自動生成唯一ID
- 建立卡片式輸入界面
- 包含名稱和地址欄位

#### 2. `removeBranch(branchId)`
刪除指定分點
- 確認對話框
- 從 DOM 移除元素

#### 3. `getBranchesData()`
收集所有分點資料
- 回傳陣列格式
- 自動過濾空白項目

#### 4. `setBranchesData(branches)`
設定分點資料（編輯時使用）
- 清空現有分點
- 重新建立分點界面
- 填入資料

#### 5. 更新 `setDistributed(value)`
智慧切換介面
- 顯示/隱藏對應區塊
- 自動新增第一個分點（分散型）
- 按鈕樣式切換

---

## 🗄️ Google Sheets 更新

### 資料結構變更

#### 新增欄位

| 欄位 | 舊版 | 新版 | 說明 |
|------|------|------|------|
| D | 醫生名單 | **分點資料（JSON）** | 新增 |
| E | 護理師名單 | 醫生名單 | 調整 |
| F | 其他人員 | 護理師名單 | 調整 |
| G | 一月醫生時數 | 其他人員 | 調整 |
| H+ | ... | 一月醫生時數... | 調整 |

#### 分點資料格式

```json
[
  {
    "name": "台北分點",
    "address": "台北市信義區信義路100號"
  },
  {
    "name": "新竹分點",
    "address": "新竹市東區光復路50號"
  }
]
```

---

## 🔄 儲存與載入邏輯

### 儲存流程

```javascript
// 1. 收集資料
const branches = getBranchesData();

// 2. 驗證
if (isDistributed === '是' && branches.length === 0) {
    alert('請至少新增一個分點');
    return;
}

// 3. 轉換為 JSON
const branchesJson = JSON.stringify(branches);

// 4. 寫入 Google Sheets
row[3] = branchesJson;
```

### 載入流程

```javascript
// 1. 從 Google Sheets 讀取
const branchesJson = row[3];

// 2. 解析 JSON
const branches = JSON.parse(branchesJson);

// 3. 還原介面
setBranchesData(branches);
```

---

## 📊 顯示邏輯

### 列表顯示

#### 分散型

```
地址欄位顯示：
台北分點: 台北市信義區信義路100號
新竹分點: 新竹市東區光復路50號
台中分點: 台中市西區台灣大道200號
```

#### 非分散型

```
地址欄位顯示：
台北市信義區信義路100號
```

---

## 🆚 功能對比

| 功能 | v3.0.0 | v3.1.0 ✨ |
|------|--------|---------|
| 單一地址 | ✅ | ✅ |
| 是否為分散型選擇 | ✅ | ✅ 增強 |
| 分點名稱輸入 | ❌ | ✅ 新增 |
| 分點地址輸入 | ❌ | ✅ 新增 |
| 多分點支援 | ❌ | ✅ 新增 |
| 新增分點按鈕 | ❌ | ✅ 新增 |
| 刪除分點功能 | ❌ | ✅ 新增 |
| 分點資料儲存 | ❌ | ✅ JSON 格式 |
| 編輯時還原分點 | ❌ | ✅ 自動還原 |
| 列表顯示分點 | ❌ | ✅ 多行顯示 |

---

## 📝 使用範例

### 範例 1：新增分散型單位

```javascript
// 輸入
事業單位名稱: "XX醫療群"
是否為分散型: "是"

分點 1:
  名稱: "台北分點"
  地址: "台北市信義區信義路100號"

分點 2:
  名稱: "新竹分點"
  地址: "新竹市東區光復路50號"

// Google Sheets 儲存
["XX醫療群", "是", "", 
 '[{"name":"台北分點","address":"台北市信義區信義路100號"},
   {"name":"新竹分點","address":"新竹市東區光復路50號"}]',
 "醫生...", "護理師...", "其他...", ...]
```

---

## ⚠️ 重要變更

### 資料遷移

如果您已有 v3.0.0 的資料：

1. **舊資料相容性**
   - ✅ 舊資料仍可正常讀取
   - ✅ 索引會自動調整

2. **需要注意**
   - ⚠️ 第 D 欄現在是分點資料
   - ⚠️ 原本的欄位向後移動一欄

3. **建議操作**
   - 📦 備份現有 Google Sheets
   - 🔄 重新編輯並儲存現有單位

---

## 🐛 錯誤處理

### 分點資料解析失敗

```javascript
try {
    const branches = JSON.parse(branchesJson);
    setBranchesData(branches);
} catch (error) {
    console.error('解析分點資料失敗', error);
    setBranchesData([]);  // 使用空陣列
}
```

### 驗證檢查

```javascript
// 分散型必須有分點
if (isDistributed === '是' && branches.length === 0) {
    alert('請至少新增一個分點');
    return;
}
```

---

## 🎯 使用場景

### 場景 1：連鎖診所

```
XX診所
├─ 台北分點（台北市信義區）
├─ 新竹分點（新竹市東區）
└─ 台中分點（台中市西區）
```

### 場景 2：醫療聯盟

```
YY醫療聯盟
├─ A醫院（地址1）
├─ B醫院（地址2）
└─ C醫院（地址3）
```

### 場景 3：連鎖藥局

```
健康藥局
├─ 民生店（台北市松山區）
├─ 信義店（台北市信義區）
└─ 南港店（台北市南港區）
```

---

## 📄 新增文檔

### `DISTRIBUTED_UNITS_GUIDE.md`

完整的分散型事業單位使用指南，包含：
- 功能說明
- 詳細使用步驟
- 使用範例
- 資料儲存方式
- 列表顯示說明
- 編輯流程
- 常見問題

---

## 🔮 未來改進

可能的增強功能：

- ⏳ 分點拖放排序
- ⏳ 分點批量匯入
- ⏳ 每個分點獨立設定人員
- ⏳ 每個分點獨立設定時數
- ⏳ 分點統計報表
- ⏳ 地圖顯示分點位置

---

## 🎉 總結

v3.1.0 版本為分散型事業單位提供了完整的管理功能：

✅ 可以新增多個分散地點  
✅ 每個地點有獨立的名稱和地址  
✅ 完整的新增、編輯、刪除支援  
✅ 自動儲存到 Google Sheets  
✅ 列表清晰顯示所有分點  

**立即體驗分散型功能！** 🚀

---

**版本**：v3.1.0  
**發布日期**：2025-11-03  
**主要更新**：分散型事業單位管理  
**文件語言**：繁體中文  

---

**感謝使用排班管理系統！** ❤️




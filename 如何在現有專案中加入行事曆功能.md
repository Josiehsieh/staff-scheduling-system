# 📅 如何在現有 Sheets 專案中加入行事曆功能

## 💡 重點說明

您**不需要建立新專案**！只需要在現有的 Google Cloud 專案中：
1. 啟用 Calendar API
2. 更新 OAuth 範圍
3. 重新授權

系統會使用**同一個用戶端 ID** 同時存取 Google Sheets 和 Google Calendar。

---

## ✅ 3 步驟完成設定

### 步驟 1️⃣：在現有專案中啟用 Calendar API

1. **前往您的 Google Cloud Console**
   ```
   https://console.cloud.google.com
   ```

2. **確認您在正確的專案中**
   - 點擊頂部的專案選擇器
   - 選擇您現有的「排班管理系統」專案

3. **啟用 Calendar API**
   - 左側選單 → API 和服務 → 程式庫
   - 搜尋：`calendar`
   - 點擊：Google Calendar API
   - 點擊：「啟用」

**✅ 完成！** Calendar API 已加入您的專案

---

### 步驟 2️⃣：更新 OAuth 同意畫面 - 加入 Calendar 範圍

1. **前往 OAuth 同意畫面**
   ```
   https://console.cloud.google.com/apis/credentials/consent
   ```

2. **點擊「編輯應用程式」**（不是建立新的）

3. **第一頁：OAuth 同意畫面**
   - 不需要修改
   - 點擊「儲存並繼續」

4. **第二頁：範圍（這裡是重點！）**
   - 點擊「新增或移除範圍」
   - 您應該會看到已有的 Sheets 範圍
   - **現在新增 Calendar 範圍**：
     - 搜尋：`calendar`
     - ✅ 勾選：`https://www.googleapis.com/auth/calendar`
     - 或勾選：`https://www.googleapis.com/auth/calendar.events`
   - 點擊「更新」
   - 點擊「儲存並繼續」

5. **第三頁：測試使用者**
   - 應該已經有您的 Gmail
   - 如果沒有，新增您的 Gmail
   - 點擊「儲存並繼續」

6. **第四頁：摘要**
   - 確認看到兩個範圍：
     - ✅ `.../auth/spreadsheets` (已有)
     - ✅ `.../auth/calendar` (新增)
   - 點擊「返回資訊主頁」

**✅ 完成！** 您的應用程式現在可以存取 Sheets 和 Calendar

---

### 步驟 3️⃣：重新授權（重要！）

因為您更新了 OAuth 範圍，需要重新授權：

1. **開啟排班系統**
   ```
   http://localhost:8000/shift_management_system_sheets_full.html
   ```

2. **登出（如果已登入）**
   - 點擊右上角的「登出」按鈕

3. **清除瀏覽器快取（建議）**
   - 按 `Ctrl + Shift + Delete`
   - 勾選「Cookie 和其他網站資料」
   - 清除資料

4. **重新登入**
   - 點擊「🔐 登入 Google」
   - 選擇您的 Google 帳號
   - **這次會看到新的授權畫面，要求存取 Google Sheets 和 Calendar**
   - 點擊「允許」或「繼續」

5. **測試行事曆功能**
   - 新增一個排班
   - 點擊「📅 上傳到行事曆」
   - 檢查您的 Google Calendar

**✅ 完成！** 行事曆功能可以正常使用了

---

## 🔍 技術說明

### 為什麼不需要建立新專案？

您的系統使用**單一 OAuth Token**，同時請求兩個 API 的權限：

```javascript
scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/calendar'
```

這表示：
- ✅ **同一個用戶端 ID** 可以存取多個 Google API
- ✅ **同一個專案** 可以啟用多個 API
- ✅ **同一次登入** 就能獲得所有權限

### OAuth 範圍 (Scope) 說明

| 範圍 | 用途 | 權限 |
|------|------|------|
| `.../auth/spreadsheets` | Google Sheets | 讀取和寫入試算表 |
| `.../auth/calendar` | Google Calendar | 完整管理行事曆 |
| `.../auth/calendar.events` | Google Calendar | 僅管理事件（較安全）|

您的系統需要這兩個範圍，所以在 OAuth 同意畫面中都要勾選。

---

## ⚠️ 常見誤解

### ❌ 誤解 1：每個 API 都需要建立新專案
**✅ 正確**：一個專案可以使用多個 API

### ❌ 誤解 2：需要多個用戶端 ID
**✅ 正確**：一個用戶端 ID 可以請求多個權限

### ❌ 誤解 3：舊的 Sheets 功能會失效
**✅ 正確**：新增 Calendar 權限不會影響 Sheets 功能

---

## 📋 檢查清單

完成以下項目，確保設定正確：

```
□ ✅ 在同一個專案中啟用了 Google Calendar API
□ ✅ OAuth 同意畫面的範圍中包含：
  □ .../auth/spreadsheets (Sheets)
  □ .../auth/calendar (Calendar)
□ ✅ 測試使用者名單中有您的 Gmail
□ ✅ 已登出並重新登入系統
□ ✅ 重新授權時看到 Calendar 權限請求
□ ✅ 可以成功上傳排班到 Google Calendar
```

---

## 🎯 快速驗證

### 方法 1：檢查 OAuth 同意畫面

前往：https://console.cloud.google.com/apis/credentials/consent

確認「範圍」區域顯示：
```
✅ https://www.googleapis.com/auth/spreadsheets
✅ https://www.googleapis.com/auth/calendar
```

### 方法 2：檢查已啟用的 API

前往：https://console.cloud.google.com/apis/dashboard

確認列表中有：
```
✅ Google Sheets API - 已啟用
✅ Google Calendar API - 已啟用
```

### 方法 3：測試系統功能

在排班系統中：
```
✅ 可以新增排班（Sheets 功能）
✅ 可以上傳到行事曆（Calendar 功能）
```

---

## 🆘 常見問題

### Q：我一定要更新範圍嗎？不能直接用嗎？

A：必須更新。因為您之前只授權了 Sheets，系統沒有權限存取 Calendar。更新範圍並重新授權後，系統才能存取 Calendar API。

### Q：更新範圍會影響現有的 Sheets 功能嗎？

A：不會。更新範圍是**新增**權限，不是取代。您的 Sheets 功能會照常運作。

### Q：重新授權後，需要重新設定用戶端 ID 嗎？

A：不需要。用戶端 ID 不變，只是權限範圍變大了。

### Q：如果我忘記重新授權會怎樣？

A：系統會顯示錯誤訊息，例如「權限不足」或「Access Denied」。只要重新登入授權即可。

### Q：可以只授權 Calendar 而不授權 Sheets 嗎？

A：技術上可以，但您的系統需要兩個權限才能完整運作。建議同時授權。

---

## 📚 相關文件

- [API設定快速參考.md](./API設定快速參考.md) - 快速設定指南
- [登入問題故障排除.md](./登入問題故障排除.md) - 登入問題解決
- [自動同步快速開始.md](./自動同步快速開始.md) - 自動同步設定

---

**最後更新**：2025-11-11  
**版本**：v1.0

## 💡 總結

記住三個關鍵點：

1. **不需要新專案** - 在現有專案中啟用 Calendar API
2. **更新 OAuth 範圍** - 加入 calendar 權限
3. **重新授權** - 讓系統獲得新權限

就這麼簡單！🎉


